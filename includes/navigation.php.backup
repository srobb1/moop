<?php
/**
 * Navigation Utility Functions
 * Provides centralized back button and navigation rendering across all pages
 * 
 * RECOMMENDED USAGE:
 * 
 * Method 1 - Smart Auto-Detection (for pages that can infer context from GET params):
 *   $nav_context = autoDetectPageContext();
 *   echo render_navigation_buttons($nav_context);
 * 
 * Method 2 - Standardized Builder (explicit, type-safe):
 *   $nav_context = buildNavContext('organism', [
 *       'organism' => $organism_name,
 *       'group' => $group_name,
 *       'parent' => $parent_uniquename
 *   ]);
 *   echo render_navigation_buttons($nav_context);
 * 
 * Method 3 - Legacy Direct Array (still supported):
 *   $nav_context = [
 *       'page' => 'organism',
 *       'organism' => $organism_name,
 *       'group' => $group_name
 *   ];
 *   echo render_navigation_buttons($nav_context);
 */

/**
 * Format organism name by replacing underscores with spaces
 */
function formatOrganismName($organism_name) {
    return str_replace('_', ' ', htmlspecialchars($organism_name));
}

/**
 * Automatically detect page context from GET parameters
 * Examines current request parameters and infers the page type and context
 * 
 * @return array - Navigation context array with detected values
 */
function autoDetectPageContext() {
    $context = [];
    
    // Extract common parameters
    $organism = $_GET['organism'] ?? null;
    $assembly = $_GET['assembly'] ?? null;
    $group = $_GET['group'] ?? null;
    $parent = $_GET['parent'] ?? null;
    $uniquename = $_GET['uniquename'] ?? null;
    
    // Determine page type based on parameters
    if ($uniquename) {
        $context['page'] = 'parent';
        $context['organism'] = $organism;
    } elseif ($assembly) {
        $context['page'] = 'assembly';
        $context['organism'] = $organism;
        $context['assembly'] = $assembly;
    } elseif ($organism && $group) {
        $context['page'] = 'organism';
        $context['organism'] = $organism;
        $context['group'] = $group;
    } elseif ($organism) {
        $context['page'] = 'organism';
        $context['organism'] = $organism;
    } elseif ($group) {
        $context['page'] = 'group';
        $context['group'] = $group;
    } else {
        // Default page type
        $context['page'] = 'unknown';
    }
    
    // Add optional parent context (cross-page navigation)
    if ($parent) {
        $context['parent'] = $parent;
    }
    
    return $context;
}

/**
 * Build standardized navigation context
 * Factory function for creating properly structured nav contexts
 * 
 * @param string $page_type - Page type: 'organism', 'group', 'assembly', 'parent', 'tool', 'admin_tool', 'multi_search', 'access_denied'
 * @param array $params - Named parameters for the context
 *        Common params: organism, assembly, group, parent, genus, species, display_name, tool, organisms
 * @return array - Standardized navigation context
 */
function buildNavContext($page_type, $params = []) {
    $context = [
        'page' => $page_type
    ];
    
    // Map allowed parameters by page type
    $allowed_params = [
        'organism' => ['organism', 'group', 'assembly', 'parent', 'multi_search'],
        'group' => ['group'],
        'assembly' => ['organism', 'assembly', 'parent'],
        'parent' => ['organism', 'genus', 'species', 'multi_search'],
        'tool' => ['organism', 'assembly', 'group', 'parent', 'display_name', 'multi_search'],
        'admin_tool' => ['tool'],
        'multi_search' => ['organisms'],
        'access_denied' => []
    ];
    
    // Add allowed parameters for this page type
    $allowed = $allowed_params[$page_type] ?? [];
    foreach ($allowed as $param) {
        if (isset($params[$param])) {
            $context[$param] = $params[$param];
        }
    }
    
    return $context;
}

/**
 * Render navigation buttons with smart back button logic
 * 
 * @param array $page_context - Context information about current page
 *        Keys: page, organism, group, assembly, parent, genus, species, display_name, organisms
 * @param array $options - Rendering options
 *        Keys: include_home (bool, default true), btn_class (string, default 'btn-secondary')
 * @return string - HTML for navigation buttons
 */
function render_navigation_buttons($page_context = [], $options = []) {
    global $site;
    
    // Set defaults
    $include_home = $options['include_home'] ?? true;
    $btn_class = $options['btn_class'] ?? 'btn-secondary';
    
    // Get page type
    $page_type = $page_context['page'] ?? 'unknown';
    
    $html = '<div class="navigation-buttons-container mb-3">';
    
    switch ($page_type) {
        case 'organism':
            $html .= renderOrganismNav($page_context, $btn_class);
            break;
        case 'group':
            $html .= renderGroupNav($page_context, $btn_class);
            break;
        case 'assembly':
            $html .= renderAssemblyNav($page_context, $btn_class);
            break;
        case 'parent':
            $html .= renderParentNav($page_context, $btn_class);
            break;
        case 'tool':
            $html .= renderToolNav($page_context, $btn_class);
            break;
        case 'admin_tool':
            $html .= renderAdminToolNav($page_context, $btn_class);
            break;
        case 'multi_search':
            $html .= renderMultiSearchNav($page_context, $btn_class);
            break;
        case 'access_denied':
            $html .= renderAccessDeniedNav($page_context, $btn_class);
            break;
        default:
            $include_home = true;
    }
    
    // Always include home button unless explicitly disabled
    if ($include_home) {
        $html .= sprintf(
            '<a href="/%s/index.php" class="btn %s btn-navigation"><i class="fa fa-home"></i> Home</a>',
            htmlspecialchars($site),
            htmlspecialchars($btn_class)
        );
    }
    
    $html .= '</div>';
    return $html;
}

/**
 * Render back buttons for organism display page
 */
function renderOrganismNav($context, $btn_class) {
    global $site;
    $html = '';
    
    // Back to multi-organism search (if came from multi-search)
    if (!empty($context['multi_search'])) {
        $organisms = $context['multi_search'];
        // Build URL with organisms array
        $url = '/' . htmlspecialchars($site) . '/tools/multi_organism_search.php';
        if (is_array($organisms) && !empty($organisms)) {
            $query_params = [];
            foreach ($organisms as $org) {
                $query_params[] = 'organisms[]=' . urlencode($org);
            }
            if (!empty($query_params)) {
                $url .= '?' . implode('&', $query_params);
            }
        }
        $html .= sprintf(
            '<a href="%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to Multi-Organism Search</a>',
            $url,
            htmlspecialchars($btn_class)
        );
    }
    
    // Back to group (if came from group)
    if (!empty($context['group'])) {
        $html .= sprintf(
            '<a href="/%s/tools/groups_display.php?group=%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to %s</a>',
            htmlspecialchars($site),
            urlencode($context['group']),
            htmlspecialchars($btn_class),
            htmlspecialchars($context['group'])
        );
    }
    
    // Back to parent (if viewing from parent context)
    if (!empty($context['parent'])) {
        $html .= sprintf(
            '<a href="/%s/tools/parent_display.php?organism=%s&uniquename=%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to %s</a>',
            htmlspecialchars($site),
            urlencode($context['organism']),
            urlencode($context['parent']),
            htmlspecialchars($btn_class),
            htmlspecialchars($context['parent'])
        );
    }
    
    return $html;
}

/**
 * Render back buttons for group display page
 */
function renderGroupNav($context, $btn_class) {
    // Groups typically go to home (no parent page)
    return '';
}

/**
 * Render back buttons for assembly display page
 */
function renderAssemblyNav($context, $btn_class) {
    global $site;
    $html = '';
    
    // Back to parent (if came from parent)
    if (!empty($context['parent'])) {
        $html .= sprintf(
            '<a href="/%s/tools/parent_display.php?organism=%s&uniquename=%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to %s</a>',
            htmlspecialchars($site),
            urlencode($context['organism']),
            urlencode($context['parent']),
            htmlspecialchars($btn_class),
            htmlspecialchars($context['parent'])
        );
    }
    
    // Back to organism (default)
    if (!empty($context['organism'])) {
        $organism_display = formatOrganismName($context['organism']);
        $html .= sprintf(
            '<a href="/%s/tools/organism_display.php?organism=%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to %s</a>',
            htmlspecialchars($site),
            urlencode($context['organism']),
            htmlspecialchars($btn_class),
            $organism_display
        );
    }
    
    return $html;
}

/**
 * Render back buttons for parent/feature display page
 */
function renderParentNav($context, $btn_class) {
    global $site;
    $html = '';
    
    // Priority 0: Back to multi-organism search (if came from multi-search)
    if (!empty($context['multi_search'])) {
        $organisms = $context['multi_search'];
        $url = '/' . htmlspecialchars($site) . '/tools/multi_organism_search.php';
        if (is_array($organisms) && !empty($organisms)) {
            $query_params = [];
            foreach ($organisms as $org) {
                $query_params[] = 'organisms[]=' . urlencode($org);
            }
            if (!empty($query_params)) {
                $url .= '?' . implode('&', $query_params);
            }
        }
        $html .= sprintf(
            '<a href="%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to Multi-Organism Search</a>',
            $url,
            htmlspecialchars($btn_class)
        );
        return $html;
    }
    
    // Build organism display link text
    $organism_text = '';
    if (!empty($context['genus']) && !empty($context['species'])) {
        $organism_text = htmlspecialchars($context['genus'] . ' ' . $context['species']);
    } else {
        $organism_text = 'Organism';
    }
    
    if (!empty($context['organism'])) {
        $html .= sprintf(
            '<a href="/%s/tools/organism_display.php?organism=%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to %s</a>',
            htmlspecialchars($site),
            urlencode($context['organism']),
            htmlspecialchars($btn_class),
            $organism_text
        );
    }
    
    return $html;
}

/**
 * Render back buttons for tool pages
 * Smart hierarchy: multi_search -> assembly -> organism -> group -> home
 */
function renderToolNav($context, $btn_class) {
    global $site;
    $html = '';
    
    // Priority 0: Back to multi-organism search (if came from multi-search)
    if (!empty($context['multi_search'])) {
        $organisms = $context['multi_search'];
        // Build URL with organisms array
        $url = '/' . htmlspecialchars($site) . '/tools/multi_organism_search.php';
        if (is_array($organisms) && !empty($organisms)) {
            $query_params = [];
            foreach ($organisms as $org) {
                $query_params[] = 'organisms[]=' . urlencode($org);
            }
            if (!empty($query_params)) {
                $url .= '?' . implode('&', $query_params);
            }
        }
        $html .= sprintf(
            '<a href="%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to Multi-Organism Search</a>',
            $url,
            htmlspecialchars($btn_class)
        );
        return $html;
    }
    
    // Priority 1: Back to group (check explicit context first)
    if (!empty($context['group'])) {
        $display_label = $context['display_name'] ?: htmlspecialchars($context['group']);
        $html .= sprintf(
            '<a href="/%s/tools/groups_display.php?group=%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to %s</a>',
            htmlspecialchars($site),
            urlencode($context['group']),
            htmlspecialchars($btn_class),
            $display_label
        );
        return $html;
    }
    
    // Priority 2: Back to assembly (check explicit context)
    if (!empty($context['assembly']) && !empty($context['organism'])) {
        $display_label = $context['display_name'] ?: formatOrganismName($context['assembly']);
        $html .= sprintf(
            '<a href="/%s/tools/assembly_display.php?organism=%s&assembly=%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to %s</a>',
            htmlspecialchars($site),
            urlencode($context['organism']),
            urlencode($context['assembly']),
            htmlspecialchars($btn_class),
            $display_label
        );
        return $html;
    }
    
    // Priority 3: Back to organism (check explicit context)
    if (!empty($context['organism'])) {
        $display_label = $context['display_name'] ?: formatOrganismName($context['organism']);
        $html .= sprintf(
            '<a href="/%s/tools/organism_display.php?organism=%s" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to %s</a>',
            htmlspecialchars($site),
            urlencode($context['organism']),
            htmlspecialchars($btn_class),
            $display_label
        );
        return $html;
    }
    
    // Fallback: home is added by default in render_navigation_buttons
    return $html;
}

/**
 * Render back buttons for admin tool pages
 */
function renderAdminToolNav($context, $btn_class) {
    global $site;
    $html = sprintf(
        '<a href="/%s/admin/admin.php" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to Admin</a>',
        htmlspecialchars($site),
        htmlspecialchars($btn_class)
    );
    return $html;
}

/**
 * Render back buttons for multi-organism search page
 */
function renderMultiSearchNav($context, $btn_class) {
    global $site;
    $html = '';
    
    // Back to phylogenetic tree (home page phylo selector)
    $html .= sprintf(
        '<button onclick="location.reload();" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Back to Selection</button>',
        htmlspecialchars($btn_class)
    );
    
    return $html;
}

/**
 * Render back buttons for access denied page
 */
function renderAccessDeniedNav($context, $btn_class) {
    // Access denied shows: back button (via JS) and home
    $html = sprintf(
        '<button onclick="javascript:history.back();" class="btn %s btn-navigation"><i class="fa fa-arrow-left"></i> Go Back</button>',
        htmlspecialchars($btn_class)
    );
    return $html;
}
?>
