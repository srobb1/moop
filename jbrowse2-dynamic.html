<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JBrowse2 - Dynamic Assembly Loader</title>
    <script src="/moop/jbrowse2/static/js/main.9f05d716.js"></script>
    <link rel="stylesheet" href="/moop/jbrowse2/static/css/main.css" />
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
        #loading { text-align: center; padding: 50px; }
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error { color: #d32f2f; background: #ffebee; padding: 20px; border-radius: 4px; }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root">
        <div id="loading">
            <div class="loading-spinner"></div>
            <p>Loading JBrowse2 with your accessible assemblies...</p>
        </div>
    </div>

    <script>
        // Fetch dynamic config based on user authentication
        async function loadJBrowse2() {
            try {
                // Get user's accessible assemblies
                const response = await fetch('/moop/api/jbrowse2/get-config.php');
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const config = await response.json();

                if (!config.assemblies || config.assemblies.length === 0) {
                    document.getElementById('root').innerHTML = `
                        <div class="error">
                            <h2>No Assemblies Available</h2>
                            <p>You don't have access to any assemblies.</p>
                            <p><a href="/moop/">Return to MOOP</a></p>
                        </div>
                    `;
                    return;
                }

                // Log for debugging
                console.log('Loaded assemblies:', config.assemblies);
                console.log('User access level:', config.userAccessLevel);

                // Initialize JBrowse2 with dynamic config
                // Note: This requires JBrowse2 to support config via API
                // For now, we'll create a basic interface

                const root = document.getElementById('root');
                root.innerHTML = `
                    <div style="padding: 20px;">
                        <h1>JBrowse2 Genome Browser</h1>
                        <p>Your access level: <strong>${config.userAccessLevel}</strong></p>
                        <h2>Available Assemblies (${config.assemblies.length})</h2>
                        <div id="assembly-list"></div>
                    </div>
                `;

                const list = document.getElementById('assembly-list');
                config.assemblies.forEach(assembly => {
                    const item = document.createElement('div');
                    item.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 4px;';
                    item.innerHTML = `
                        <h3>${assembly.displayName}</h3>
                        <p><strong>Aliases:</strong> ${assembly.aliases.join(', ')}</p>
                        <p><strong>Access Level:</strong> ${assembly.accessLevel}</p>
                        <button onclick="openAssembly('${assembly.name}')" 
                                style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            View Genome
                        </button>
                    `;
                    list.appendChild(item);
                });

                // Store config globally for assembly selection
                window.jbrowse2Config = config;

            } catch (error) {
                document.getElementById('root').innerHTML = `
                    <div class="error">
                        <h2>Error Loading Configuration</h2>
                        <p>${error.message}</p>
                        <p><a href="/moop/">Return to MOOP</a></p>
                    </div>
                `;
                console.error('Error:', error);
            }
        }

        // Open an assembly in JBrowse2
        function openAssembly(assemblyName) {
            // This would integrate with actual JBrowse2 to open the assembly
            // For now, create a session
            const assembly = window.jbrowse2Config.assemblies.find(a => a.name === assemblyName);
            
            if (!assembly || !assembly.sequence) {
                alert('Assembly configuration incomplete');
                return;
            }

            // Create a session that would be passed to JBrowse2
            const session = {
                name: `${assembly.displayName} Session`,
                view: {
                    type: 'LinearGenomeView',
                    assemblies: [assemblyName],
                    tracks: []
                }
            };

            console.log('Opening assembly session:', session);
            
            // In a full implementation, this would:
            // 1. Initialize the JBrowse2 LinearGenomeView
            // 2. Load the assembly configuration
            // 3. Load available tracks for the user
            
            alert(`Would open: ${assembly.displayName}\n\nFull JBrowse2 integration coming soon.`);
        }

        // Load when page is ready
        document.addEventListener('DOMContentLoaded', loadJBrowse2);
    </script>
</body>
</html>
