<?php
/**
 * APPLICATION CONFIGURATION - DEFAULT VALUES
 * 
 * This file defines DEFAULT site-wide settings and paths.
 * These values can be overridden by config/config_editable.json (which contains current values).
 * 
 * Configuration is loaded by ConfigManager in this order:
 * 1. Load defaults from site_config.php (this file)
 * 2. Merge overrides from config_editable.json (if it exists)
 * 3. Result is the active configuration
 * 
 * ⚠️  IMPORTANT FOR NEW ADMINS:
 * - DO NOT edit this file to change settings
 * - Use the Admin Dashboard -> "Manage Site Configuration" instead
 * - That tool updates config_editable.json with the current values
 * - Editable settings: siteTitle, admin_email, sequence_types
 * - Structural settings (paths, site, root_path) are NOT editable for safety
 * 
 * For multi-site deployments:
 * - 'site' is the directory name (e.g., 'moop', 'simrbase') 
 * - CHANGE THIS to deploy for a different site directory
 * - Derived paths are calculated automatically from root_path + site
 * - All absolute paths use root_path as base
 * - All URLs use /site as the web root (e.g., /moop/images, /simrbase/images)
 */

// Calculate derived paths from root_path and site (no need to edit these)
$root_path = '/var/www/html';
$site = 'moop';  // CHANGE THIS to deploy for a different site directory
$site_path = "$root_path/$site";
$images_dir = 'images';

// Load secrets (API keys, credentials)
$secrets = [];
$secrets_file = __DIR__ . '/secrets.php';
if (file_exists($secrets_file)) {
    $secrets = require $secrets_file;
}

return [
    // ======== REQUIRED: Server Paths ========
    // These must exist on your server, or the app won't function
    // These are STRUCTURAL and cannot be edited through the admin interface
    'root_path' => $root_path,
    'site' => $site,
    'site_path' => $site_path,
    'organism_data' => "$site_path/organisms",
    
    // ======== REQUIRED: Directory Names ========
    'images_dir' => $images_dir,
    'images_path' => "$site/$images_dir",  // Web path for <img src>
    'absolute_images_path' => "$site_path/$images_dir",  // Filesystem path
    
    // ======== REQUIRED: Metadata ========
    'metadata_path' => "$site_path/metadata",
    
    // ======== REQUIRED: Documentation ========
    'docs_path' => "$site_path/docs",
    
    // ======== OPTIONAL: Appearance ========
    // EDITABLE in Admin Dashboard: Use "Manage Site Configuration" to change these
    'siteTitle' => 'SIMRbase',  // Changed in config_editable.json if customized
    'header_img' => 'header_img.png',
    'banners_path' => "$site_path/images/banners",
    'favicon_filename' => 'favicon.ico',  // Changed in config_editable.json if customized
    'custom_css_path' => "$site_path/css/custom.css",
    
    // ======== OPTIONAL: Contact ========
    // EDITABLE in Admin Dashboard: Use "Manage Site Configuration" to change these
    'admin_email' => 'admin@example.com',  // Changed in config_editable.json if customized
    
    // ======== OPTIONAL: Files ========
    'users_file' => "$root_path/users.json",
    'error_log_file' => "$site_path/logs/error.log",
    
    // ======== OPTIONAL: IP-Based Auto-Login ========
    // IP ranges for automatic login with full access (development/local testing)
    // Format: Array of ranges with 'start' and 'end' IP addresses
    // Leave empty array to disable IP-based auto-login
    // Example: ['127.0.0.0', '127.0.0.255'] for localhost range
    'auto_login_ip_ranges' => [
        [
            'start' => '127.0.0.11',
            'end' => '127.0.0.11',
        ],
    ],
    
    // ======== DATA CONFIGURATION ========
    // DEFAULT sequence file types and display labels
    // EDITABLE in Admin Dashboard: Use "Manage Site Configuration" to:
    //   - Enable/disable sequence types for users
    //   - Customize display labels (e.g., "Transcript" instead of "mRNA")
    //   - Customize badge colors (Bootstrap CSS classes like bg-info, bg-success, etc.)
    // File patterns are read-only (tied to actual filenames in organism directories)
    // Current values come from config_editable.json if customized, otherwise defaults below
    'sequence_types' => [
        'protein' => [
            'pattern' => 'protein.aa.fa',
            'label' => 'Protein',
            'color' => 'bg-info',  // Bootstrap class for badge color
        ],
        'transcript' => [
            'pattern' => 'transcript.nt.fa',
            'label' => 'mRNA',
            'color' => 'bg-feature-mrna',  // Bootstrap class for badge color
        ],
        'cds' => [
            'pattern' => 'cds.nt.fa',
            'label' => 'CDS',
            'color' => 'bg-success',  // Bootstrap class for badge color
        ],
        'genome' => [
            'pattern' => 'genome.fa',
            'label' => 'GENOME',
            'color' => 'bg-warning text-dark',  // Bootstrap class for badge color (can include text-dark for contrast)
        ]
    ],
    
    // ======== ASSEMBLY ANNOTATION FILE ========
    // Primary annotation GFF file pattern in organism directories
    // Located in: /organisms/{organism}/{assembly}/
    // The JBrowse setup script creates symlink and compressed version
    'annotation_file' => 'genomic.gff',
    
    // ======== BLAST TOOL SAMPLE SEQUENCES ========
    // Sample sequences for users to test BLAST functionality
    'blast_sample_sequences' => [
        'protein' => '>A0A7N2L231_QUELO Histone H4 OS=Quercus lobata (Valley Oak)
MSGRGKGGKGLGKGGAKRHRKVLRDNIQGITKPAIRRLARRGGVKRISGLIYEETRGVLK
IFLENVIRDAVTYTEHARRKTVTAMDVVYALKRQGRTLYGFGG',
        'nucleotide' => '>ENSRNOT00000066367.5 H2ac25-201 cdna:protein_coding
GCTCAGTCTAGCCTCCCTCCTGATCATATATAAGAGCTTGCTGGCGCTTACAGATTCGTT
TTTTGCCAGCTTTCTTCTGTTTCTGTACTTTTGGTCGTTAGGGGAAGATGTCTGGTCGTG
GCAAGCAGGGCGGCAAAGCTCGTGCAAAAGCGAAGTCTCGCTCATCCCGCGCTGGCCTGC
AGTTTCCAGTGGGCCGTGTGCACCGCCTTCTCCGTAAGGGCAACTACTCGGAGCGGGTGG
GCGCCGGCGCTCCGGTGTACCTAGCGGCTGTGCTGGAATACCTGACTGCTGAGATCCTGG
AGCTGGCTGGGAATGCGGCCCGCGATAATAAGAAGACGCGGATTATCCCGCGCCACCTGC
AGTTGGCCATCCGCAACGACGAGGAGCTCAACAAGCTGCTGGGCCGCGTGACCATCGCGC
AGGGCGGCGTCCTGCCCAACATCCAGGCGGTGTTGCTGCCCAAGAAGACGGAGAGCCACC
ACAAGGCCAAGGGCAAGTGAGGCCCTGCTGGTCGTTAGAGCAACTTTACGGACACCAAAG
GCTCTTTTCAGAGCCACCCCCAACCTCATTAGGAAGTGCTGTACACTGAGCCTGTCGCCA
GTTACTGGCCGGCCAGGATCTCCCGACTCCTTTCCATGCGTTCCGGCATCCCAGTGCGAC
GCCTGGGGAGCTCATGGGAGGCTAACGGCTTCGCCTGCGGTATCGTGGCCTGAGCCTTTG
TAGTGCAACGTTAATAGCTGTATTGGTGACTGTCCTTGTCCAATGAAGGCAGGAGCCCAG
CTCCTACGGGTAGTAAACATACTGTCACAACTATAGTGTTCGCATGGTGGATAGTACCCA
AATGCGTCCACAACAGTTATCAATCAA',
    ],
    
    // ======== SAMPLE FEATURE IDS FOR SEQUENCE RETRIEVAL ========
    // Default sample feature IDs for users to test sequence retrieval
    'sample_feature_ids' => [
        'ACA1_PVKU01000001.1_000001.1',
        'ACA1_PVKU01005411.1_000003.1',
    ],
    
    // ======== BLAST+ TOOL PATHS ========
    // Paths to BLAST+ binaries
    // Default: Use tool name only (assumes binaries are in system PATH)
    // For custom installations: Use full path (e.g., '/opt/blast/bin/blastn')
    // For conda environments: Ensure conda env is activated before running web server
    'blast_tools' => [
        'blastn' => 'blastn',
        'blastp' => 'blastp',
        'blastx' => 'blastx',
        'tblastn' => 'tblastn',
        'tblastx' => 'tblastx',
        'makeblastdb' => 'makeblastdb',
        'blastdbcmd' => 'blastdbcmd',
        'blast_formatter' => 'blast_formatter',
    ],
    
    // ======== GALAXY INTEGRATION ========
    // Configuration for UseGalaxy.org integration
    'galaxy_settings' => [
        'enabled' => true,
        'url' => 'https://usegalaxy.org',
        'api_key' => $secrets['galaxy']['api_key'] ?? null,  // Load from secrets.php
        'mode' => 'shared',  // 'shared' or 'per_user' (per_user support planned for future)
        
        'tools' => [
            'mafft' => [
                'id' => 'toolshed.g2.bx.psu.edu/repos/rnateam/mafft/rbc_mafft/7.221.1',
                'name' => 'MAFFT',
                'description' => 'Fast multiple sequence alignment',
                'category' => 'alignment',
                'default_options' => [
                    'method' => 'auto',
                    'flavour' => 'nofft',
                    'maxiterate' => '0',
                ]
            ],
            'clustalw' => [
                'id' => 'toolshed.g2.bx.psu.edu/repos/devteam/clustalw/clustalw/2.1+galaxy1',
                'name' => 'ClustalW',
                'description' => 'Classic multiple sequence alignment',
                'category' => 'alignment',
                'default_options' => [
                    'output_format' => 'fasta',
                ]
            ],
            'raxml' => [
                'id' => 'toolshed.g2.bx.psu.edu/repos/iuc/raxml/raxml/8.2.12+galaxy0',
                'name' => 'RAxML',
                'description' => 'Phylogenetic inference',
                'category' => 'phylogenetics',
            ],
        ]
    ],
    
    // ======== JBROWSE2 CONFIGURATION ========
    // JBrowse2 genome browser integration
    'jbrowse2' => [
        'enabled' => true,
        'base_url' => "/$site/jbrowse2/",           // Relative to web root - works with any deployment
        'api_endpoint' => '/api/jbrowse2/assembly.php',
        'config_file' => "$site_path/jbrowse2/config.json",
        'data_directory' => "$site_path/data/genomes/",
        'genomes_directory' => "$site_path/data/genomes/",
        'tracks_directory' => "$site_path/data/tracks/",
        'certs_directory' => "$site_path/certs/",
        'jwt_private_key' => "$site_path/certs/jwt_private_key.pem",
        'jwt_public_key' => "$site_path/certs/jwt_public_key.pem",
        'token_expiration' => 3600,  // 1 hour in seconds
        'default_assembly' => 'GCA_004027475.1',
        'default_organism' => 'Anoura_caudifer',
        
        /**
         * Trusted Tracks Servers (URL Whitelist)
         * 
         * URLs in this list will ALWAYS have JWT tokens attached.
         * Do NOT include external public servers (UCSC, Ensembl, NCBI).
         * 
         * These should be servers YOU control and manage that:
         * - Validate JWT tokens using your public key
         * - Run tracks.php or equivalent authentication
         * - Are part of your infrastructure
         * 
         * Examples:
         * - 'https://moop.example.com'      (your main MOOP server)
         * - 'https://tracks.yourlab.edu'    (your remote tracks server)
         * - 'http://localhost'              (for development)
         */
        'trusted_tracks_servers' => [
            // Add your trusted servers here
            // 'https://tracks.yourlab.edu',
        ],
        
        /**
         * Log warnings for misconfigured tracks
         * 
         * If true, logs warnings when external URLs have access_level != PUBLIC
         * Helps identify tracks that might be misconfigured
         */
        'warn_on_external_private_tracks' => true,
    ],
    
    // ======== JBROWSE2 REMOTE TRACKS SERVER ========
    // Configuration for separate tracks server (future deployment)
    // When deploying to remote server:
    // 1. Set 'enabled' => true
    // 2. Set 'url' to remote server hostname
    // 3. Copy jwt_public_key.pem to remote server
    // 4. Copy track data to remote server
    // 5. Configure nginx/Apache on remote server
    'tracks_server' => [
        'enabled' => false,                                        // Set to true when remote server deployed
        'url' => '',                                               // e.g., 'https://tracks.example.com/'
        'validate_jwt' => true,                                    // Require JWT tokens for track access
        'sync_method' => 'manual',                                 // 'manual', 'rsync', 'nfs'
        'sync_schedule' => '',                                     // e.g., 'daily', 'weekly'
        'notes' => 'Reference genomes (/data/genomes/) always stay on MOOP server. 
                    Track data (/data/tracks/) can be synced to remote server for performance.',
    ],
];

