#!/bin/bash
# Add MCScan Anchors Synteny Track to JBrowse2
# For orthologs visualization between two assemblies

set -e

# Source common configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../../config/config.sh"

usage() {
    cat << EOF
Usage: $0 -1 ASSEMBLY1 -2 ASSEMBLY2 -t TRACK_ID -n TRACK_NAME -f ANCHORS_FILE -b1 BED1_FILE -b2 BED2_FILE [-c CATEGORY]

Add an MCScan anchors synteny track to JBrowse2

Required:
    -1    First assembly name (target genome)
    -2    Second assembly name (query genome - orthologs displayed here)
    -t    Track ID (unique identifier)
    -n    Track name (display name)
    -f    Path to .anchors file (MCScan output)
    -b1   Path to BED file for assembly 1
    -b2   Path to BED file for assembly 2

Optional:
    -c    Category (default: "Synteny")
    -r1   Remote URL for anchors file
    -r2   Remote URL for BED1 file
    -r3   Remote URL for BED2 file

Example:
    $0 -1 Nvec200 -2 Nvec100 -t nvec_orthologs -n "Nvec100 Orthologs on Nvec200" \\
       -f genome1.genome2.anchors -b1 genome1.bed -b2 genome2.bed

Notes:
    - Generated by MCScanX or jcvi
    - BED files contain gene coordinates
    - Track shows orthologous gene pairs
    - Both assemblies must already be loaded in JBrowse2
EOF
    exit 1
}

# Parse arguments
ASSEMBLY1=""
ASSEMBLY2=""
TRACK_ID=""
TRACK_NAME=""
ANCHORS_FILE=""
BED1_FILE=""
BED2_FILE=""
CATEGORY="Synteny"
REMOTE_ANCHORS=""
REMOTE_BED1=""
REMOTE_BED2=""

while getopts "1:2:t:n:f:b:c:r:h" opt; do
    case $opt in
        1) ASSEMBLY1="$OPTARG" ;;
        2) ASSEMBLY2="$OPTARG" ;;
        t) TRACK_ID="$OPTARG" ;;
        n) TRACK_NAME="$OPTARG" ;;
        f) ANCHORS_FILE="$OPTARG" ;;
        b) 
            if [[ -z "$BED1_FILE" ]]; then
                BED1_FILE="$OPTARG"
            else
                BED2_FILE="$OPTARG"
            fi
            ;;
        c) CATEGORY="$OPTARG" ;;
        r)
            if [[ -z "$REMOTE_ANCHORS" ]]; then
                REMOTE_ANCHORS="$OPTARG"
            elif [[ -z "$REMOTE_BED1" ]]; then
                REMOTE_BED1="$OPTARG"
            else
                REMOTE_BED2="$OPTARG"
            fi
            ;;
        h) usage ;;
        *) usage ;;
    esac
done

# Validate required arguments
if [[ -z "$ASSEMBLY1" ]] || [[ -z "$ASSEMBLY2" ]] || [[ -z "$TRACK_ID" ]] || [[ -z "$TRACK_NAME" ]] || [[ -z "$ANCHORS_FILE" ]] || [[ -z "$BED1_FILE" ]] || [[ -z "$BED2_FILE" ]]; then
    echo "ERROR: Missing required arguments"
    usage
fi

# Setup URIs
if [[ -n "$REMOTE_ANCHORS" ]]; then
    ANCHORS_URI="$REMOTE_ANCHORS"
    BED1_URI="$REMOTE_BED1"
    BED2_URI="$REMOTE_BED2"
    echo "Using remote files"
else
    # Validate local files exist
    if [[ ! -f "$ANCHORS_FILE" ]]; then
        echo "ERROR: Anchors file not found: $ANCHORS_FILE"
        exit 1
    fi
    if [[ ! -f "$BED1_FILE" ]]; then
        echo "ERROR: BED1 file not found: $BED1_FILE"
        exit 1
    fi
    if [[ ! -f "$BED2_FILE" ]]; then
        echo "ERROR: BED2 file not found: $BED2_FILE"
        exit 1
    fi

    # Setup paths
    JBROWSE_DIR="$JBROWSE_DATA_DIR"
    TRACKS_DIR="$JBROWSE_DIR/tracks/synteny/mcscan"
    mkdir -p "$TRACKS_DIR"

    # Copy files
    ANCHORS_NAME=$(basename "$ANCHORS_FILE")
    BED1_NAME=$(basename "$BED1_FILE")
    BED2_NAME=$(basename "$BED2_FILE")
    
    cp "$ANCHORS_FILE" "$TRACKS_DIR/"
    cp "$BED1_FILE" "$TRACKS_DIR/"
    cp "$BED2_FILE" "$TRACKS_DIR/"

    ANCHORS_URI="tracks/synteny/mcscan/${ANCHORS_NAME}"
    BED1_URI="tracks/synteny/mcscan/${BED1_NAME}"
    BED2_URI="tracks/synteny/mcscan/${BED2_NAME}"
fi

# Generate track configuration
CONFIG_FILE="$JBROWSE_DIR/config.json"

# Create track JSON
TRACK_JSON=$(cat <<EOF
{
  "type": "SyntenyTrack",
  "trackId": "${TRACK_ID}",
  "name": "${TRACK_NAME}",
  "category": ["${CATEGORY}"],
  "assemblyNames": ["${ASSEMBLY1}", "${ASSEMBLY2}"],
  "adapter": {
    "type": "MCScanAnchorsAdapter",
    "mcscanAnchorsLocation": {
      "uri": "${ANCHORS_URI}",
      "locationType": "UriLocation"
    },
    "bed1Location": {
      "uri": "${BED1_URI}",
      "locationType": "UriLocation"
    },
    "bed2Location": {
      "uri": "${BED2_URI}",
      "locationType": "UriLocation"
    },
    "assemblyNames": ["${ASSEMBLY1}", "${ASSEMBLY2}"]
  }
}
EOF
)

# Add track to config.json
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "ERROR: JBrowse config not found: $CONFIG_FILE"
    exit 1
fi

# Check if track already exists
if grep -q "\"trackId\": \"${TRACK_ID}\"" "$CONFIG_FILE"; then
    echo "WARNING: Track ${TRACK_ID} already exists, skipping"
    exit 0
fi

# Verify assemblies exist
if ! grep -q "\"name\": \"${ASSEMBLY1}\"" "$CONFIG_FILE"; then
    echo "ERROR: Assembly ${ASSEMBLY1} not found in JBrowse config"
    exit 1
fi

if ! grep -q "\"name\": \"${ASSEMBLY2}\"" "$CONFIG_FILE"; then
    echo "ERROR: Assembly ${ASSEMBLY2} not found in JBrowse config"
    exit 1
fi

# Insert track into config
python3 - <<PYTHON_SCRIPT
import json
import sys

config_file = "${CONFIG_FILE}"
track_json = '''${TRACK_JSON}'''

try:
    with open(config_file, 'r') as f:
        config = json.load(f)
    
    track = json.loads(track_json)
    
    if 'tracks' not in config:
        config['tracks'] = []
    
    config['tracks'].append(track)
    
    with open(config_file, 'w') as f:
        json.dump(config, f, indent=2)
    
    print(f"✅ Added MCScan synteny track: ${TRACK_NAME}")
    sys.exit(0)
    
except Exception as e:
    print(f"ERROR: {e}", file=sys.stderr)
    sys.exit(1)
PYTHON_SCRIPT

if [[ $? -eq 0 ]]; then
    echo "✅ Successfully added MCScan synteny track: $TRACK_NAME"
    echo "   Track ID: $TRACK_ID"
    echo "   Assemblies: $ASSEMBLY1 <-> $ASSEMBLY2"
    echo "   Anchors: $ANCHORS_URI"
else
    echo "❌ Failed to add MCScan synteny track"
    exit 1
fi
