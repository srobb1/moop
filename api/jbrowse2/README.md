# JBrowse2 API - System Architecture

## Overview
This is a **permission-based, dynamic JBrowse2 configuration system** that generates configs on-the-fly based on user access levels.

## Active Endpoints

### Config Generation (Dynamic)

**1. config.php** - PRIMARY CONFIG GENERATOR ‚≠ê
- **Status**: Currently used by all assemblies
- **Purpose**: Generates JBrowse2 configs dynamically from metadata files
- **Best for**: < 1000 tracks per assembly
- **Performance**: ~500ms for 500 tracks, 200KB gzipped

**Endpoints:**
- `GET /api/jbrowse2/config.php` 
  - Returns assembly list (filtered by user permissions)
- `GET /api/jbrowse2/config.php?organism=X&assembly=Y`
  - Returns full JBrowse2 config with tracks (filtered by user permissions)

**Features:**
- ‚úÖ Dynamically generates configs from metadata files
- ‚úÖ Filters assemblies/tracks by user access level (PUBLIC, IP_IN_RANGE, COLLABORATOR, ADMIN)
- ‚úÖ Adds JWT tokens to track URLs for secure access
- ‚úÖ Supports gzip compression for 500+ tracks

**2. config-optimized.php** - OPTIMIZED CONFIG GENERATOR (AVAILABLE)
- **Status**: Available for future use when needed
- **Purpose**: Lazy-loading via track URIs for large track sets
- **Best for**: > 1000 tracks per assembly
- **Performance**: ~200ms regardless of track count, < 50KB
- **Usage**: Same as config.php, plus individual track endpoint

### File Serving (Secure Proxy)

**3. tracks.php** - TRACK FILE SERVER üîí
- **Status**: **CRITICAL INFRASTRUCTURE** - Required for JBrowse2 to function
- **Purpose**: Serves actual track data files with security validation
- **Files Served**: BigWig, BAM, GFF, BED, CRAM, MAF, etc.

**Endpoint:**
- `GET /api/jbrowse2/tracks.php?file=path/to/file.bw&token=JWT`

**Security Features:**
- ‚úÖ JWT token validation per request
- ‚úÖ Organism/assembly access control
- ‚úÖ Directory traversal protection
- ‚úÖ Whitelisted IP bypass

**Technical Features:**
- ‚úÖ HTTP range request support (efficient streaming)
- ‚úÖ Works on remote track servers
- ‚úÖ No MOOP session database required
- ‚úÖ Can log file access

**Data Location**: `/data/tracks/`

---

## How It Works (User Flow)

### Step 1: User Opens Browser
```
User ‚Üí http://localhost:8000/moop/jbrowse2.php
```

### Step 2: JavaScript Loads Assembly List
```javascript
// jbrowse2-loader.js calls:
fetch('/moop/api/jbrowse2/config.php')
```
**Returns:**
```json
{
  "assemblies": [
    {
      "name": "Nematostella_vectensis_GCA_033964005.1",
      "displayName": "Nematostella vectensis (GCA_033964005.1)",
      "accessLevel": "PUBLIC",
      ...
    }
  ],
  "userAccessLevel": "PUBLIC"
}
```

### Step 3: User Selects Assembly
```javascript
// Iframe loads with:
fetch('/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1')
```

### Step 4: Config.php Generates Dynamic Config
1. **Loads assembly definition** from:
   ```
   /metadata/jbrowse2-configs/assemblies/Nematostella_vectensis_GCA_033964005.1.json
   ```

2. **Loads track definitions** from:
   ```
   /metadata/jbrowse2-configs/tracks/Nematostella_vectensis/GCA_033964005.1/*/*.json
   ```

3. **Filters tracks** based on user access level:
   ```
   User: PUBLIC
   Shows: PUBLIC tracks only
   
   User: IP_IN_RANGE
   Shows: PUBLIC + IP_IN_RANGE tracks
   
   User: COLLABORATOR
   Shows: PUBLIC + tracks for assemblies they have access to
   
   User: ADMIN
   Shows: ALL tracks
   ```

4. **Adds JWT tokens** to track URLs (for remote access)

5. **Returns complete config** with plugins, tracks, etc.

---

## Data Sources

### Pre-Generated Config Files (Permission-Filtered)
These are generated by `tools/jbrowse/generate_tracks_from_sheet.php`:

```
jbrowse2/configs/{AssemblyName}/
‚îú‚îÄ‚îÄ PUBLIC.json          # Config for anonymous users
‚îú‚îÄ‚îÄ IP_IN_RANGE.json     # Config for whitelisted IPs
‚îú‚îÄ‚îÄ COLLABORATOR.json    # Config for collaborators
‚îî‚îÄ‚îÄ ADMIN.json           # Config for admins (all tracks)
```

**Current Status:** ‚ùå **NOT USED ANYMORE**
- These were used by the old system
- Now `config.php` generates configs dynamically from metadata

**Action:** Consider removing or updating the generator script

### Metadata Files (ACTIVE SOURCE)
Generated by `php tools/jbrowse/generate_tracks_from_sheet.php`:

```
metadata/jbrowse2-configs/
‚îú‚îÄ‚îÄ assemblies/
‚îÇ   ‚îú‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1.json
‚îÇ   ‚îî‚îÄ‚îÄ Anoura_caudifer_GCA_004027475.1.json
‚îÇ
‚îî‚îÄ‚îÄ tracks/
    ‚îú‚îÄ‚îÄ Nematostella_vectensis/
    ‚îÇ   ‚îî‚îÄ‚îÄ GCA_033964005.1/
    ‚îÇ       ‚îú‚îÄ‚îÄ gene_models/
    ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ncbi_annotation.json
    ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ apollo_annotation.json
    ‚îÇ       ‚îú‚îÄ‚îÄ alignments/
    ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ long_reads.json
    ‚îÇ       ‚îî‚îÄ‚îÄ maf/
    ‚îÇ           ‚îî‚îÄ‚îÄ test_maf.json
    ‚îÇ
    ‚îî‚îÄ‚îÄ Anoura_caudifer/
        ‚îî‚îÄ‚îÄ GCA_004027475.1/
            ‚îî‚îÄ‚îÄ ...
```

**Each track JSON contains:**
```json
{
  "trackId": "unique-id",
  "type": "QuantitativeTrack",
  "name": "Display Name",
  "category": ["Category", "Subcategory"],
  "assemblyNames": ["Assembly_Name"],
  "adapter": {
    "type": "BigWigAdapter",
    "bigWigLocation": {
      "uri": "/path/to/file.bw"
    }
  },
  "metadata": {
    "access_level": "PUBLIC",
    "description": "..."
  }
}
```

---

## Track URL Security

### JWT Token System
For **remote track access**, URLs get JWT tokens:

```json
{
  "adapter": {
    "bigWigLocation": {
      "uri": "/path/to/file.bw",
      "locationType": "UriLocation",
      "baseUri": "http://example.com",
      "internetAccountPreAuthorization": {
        "internetAccountType": "ExternalToken",
        "authInfo": {
          "token": "jwt-token-here"
        }
      }
    }
  }
}
```

**Whitelisted IPs:** No JWT token needed
**Remote users:** JWT token required

---

## Access Level Hierarchy

```
ADMIN (4)           ‚Üí Can see ALL tracks
    ‚Üì
IP_IN_RANGE (3)     ‚Üí Can see PUBLIC + IP_IN_RANGE tracks
    ‚Üì
COLLABORATOR (2)    ‚Üí Can see PUBLIC + tracks for assemblies they have access to
    ‚Üì
PUBLIC (1)          ‚Üí Can see PUBLIC tracks only
```

**Determined by:** `lib/functions_access.php::get_access_level()`

---

## Key Functions

### In `config.php`:

- `generateAssemblyList($user_access_level)`
  - Returns filtered list of assemblies user can access
  
- `generateAssemblyConfig($organism, $assembly, $user_access_level)`
  - Returns full config with tracks for specific assembly
  
- `loadFilteredTracks($organism, $assembly, $user_access_level)`
  - Loads and filters tracks based on permissions
  
- `addTokensToTrack($track, $organism, $assembly, $access_level, $is_whitelisted)`
  - Adds JWT tokens to track URLs (if needed)

### Helper Functions:

- `lib/functions_access.php::get_access_level()` 
  - Returns: 'PUBLIC', 'IP_IN_RANGE', 'COLLABORATOR', 'ADMIN'
  
- `lib/functions_access.php::canUserAccessAssembly($user_level, $assembly_level, $organism, $assembly)`
  - Checks if user can access specific assembly
  
- `lib/jbrowse/track_token.php::generate_track_jwt($organism, $assembly, $user_level)`
  - Generates JWT token for track access

---

## Archived Files

### `archive/assembly.php`
- **Old endpoint** that was merged into `config.php`
- **Status:** Obsolete (moved 2026-02-14)
- **Reason:** Functionality merged into unified `config.php` endpoint

---

## Testing

### Test as PUBLIC user:
```bash
curl "http://localhost/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1"
```

### Test as ADMIN:
```bash
# Login as admin first, then:
curl "http://localhost/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1" \
  --cookie "PHPSESSID=your-session-id"
```

### Check what tracks PUBLIC sees:
```bash
curl "http://localhost/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1" | \
  jq '.tracks[].name'
```

---

## Adding New Tracks

1. **Add track to Google Sheet:**
   ```
   https://docs.google.com/spreadsheets/d/1Md23wIYo08cjtsOZMBy5UIsNaaxTxT8ijG-QLC3CjIo/edit
   ```

2. **Run generator script:**
   ```bash
   php tools/jbrowse/generate_tracks_from_sheet.php
   ```

3. **Tracks auto-appear** based on user permissions (no restart needed!)

---

## Performance Notes

- ‚úÖ **Gzip compression** enabled for large configs
- ‚úÖ **JWT tokens** cached per session
- ‚úÖ **Configs** cached for 5 minutes
- ‚úÖ Handles **500+ tracks** efficiently

---

## Future Improvements

1. **Remove unused pre-generated configs:**
   - Delete `jbrowse2/configs/` directory (or update generator)
   
2. **Implement Redis caching:**
   - Cache generated configs per (assembly + access_level)
   
3. **Add config versioning:**
   - Track when metadata changes, invalidate caches

---

## Summary

‚úÖ **ACTIVE:** `config.php` (single endpoint for everything)
‚úÖ **ACTIVE:** Metadata files in `metadata/jbrowse2-configs/`
‚úÖ **ACTIVE:** Track generator script reads Google Sheet
‚ùå **OBSOLETE:** `assembly.php` (archived)
‚ùå **OBSOLETE:** Pre-generated configs in `jbrowse2/configs/` (not used)

**The system is clean, permission-based, and dynamically generates everything!**
