# JBrowse2 API - System Architecture

## Overview
This is a **permission-based, dynamic JBrowse2 configuration system** that generates configs on-the-fly based on user access levels.

## Active Files

### 1. `config.php` - THE SINGLE ENDPOINT ⭐
**This is the ONLY active API endpoint** for JBrowse2 configurations.

**Endpoints:**
- `GET /api/jbrowse2/config.php` 
  - Returns assembly list (filtered by user permissions)
  
- `GET /api/jbrowse2/config.php?organism=X&assembly=Y`
  - Returns full JBrowse2 config with tracks (filtered by user permissions)

**Features:**
- ✅ Dynamically generates configs from metadata files
- ✅ Filters assemblies/tracks by user access level (PUBLIC, IP_IN_RANGE, COLLABORATOR, ADMIN)
- ✅ Adds JWT tokens to track URLs for secure access
- ✅ Supports gzip compression for 500+ tracks
- ✅ Caches configs per access level

---

## How It Works (User Flow)

### Step 1: User Opens Browser
```
User → http://localhost:8000/moop/jbrowse2.php
```

### Step 2: JavaScript Loads Assembly List
```javascript
// jbrowse2-loader.js calls:
fetch('/moop/api/jbrowse2/config.php')
```
**Returns:**
```json
{
  "assemblies": [
    {
      "name": "Nematostella_vectensis_GCA_033964005.1",
      "displayName": "Nematostella vectensis (GCA_033964005.1)",
      "accessLevel": "PUBLIC",
      ...
    }
  ],
  "userAccessLevel": "PUBLIC"
}
```

### Step 3: User Selects Assembly
```javascript
// Iframe loads with:
fetch('/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1')
```

### Step 4: Config.php Generates Dynamic Config
1. **Loads assembly definition** from:
   ```
   /metadata/jbrowse2-configs/assemblies/Nematostella_vectensis_GCA_033964005.1.json
   ```

2. **Loads track definitions** from:
   ```
   /metadata/jbrowse2-configs/tracks/Nematostella_vectensis/GCA_033964005.1/*/*.json
   ```

3. **Filters tracks** based on user access level:
   ```
   User: PUBLIC
   Shows: PUBLIC tracks only
   
   User: IP_IN_RANGE
   Shows: PUBLIC + IP_IN_RANGE tracks
   
   User: COLLABORATOR
   Shows: PUBLIC + tracks for assemblies they have access to
   
   User: ADMIN
   Shows: ALL tracks
   ```

4. **Adds JWT tokens** to track URLs (for remote access)

5. **Returns complete config** with plugins, tracks, etc.

---

## Data Sources

### Pre-Generated Config Files (Permission-Filtered)
These are generated by `tools/jbrowse/generate_tracks_from_sheet.php`:

```
jbrowse2/configs/{AssemblyName}/
├── PUBLIC.json          # Config for anonymous users
├── IP_IN_RANGE.json     # Config for whitelisted IPs
├── COLLABORATOR.json    # Config for collaborators
└── ADMIN.json           # Config for admins (all tracks)
```

**Current Status:** ❌ **NOT USED ANYMORE**
- These were used by the old system
- Now `config.php` generates configs dynamically from metadata

**Action:** Consider removing or updating the generator script

### Metadata Files (ACTIVE SOURCE)
Generated by `php tools/jbrowse/generate_tracks_from_sheet.php`:

```
metadata/jbrowse2-configs/
├── assemblies/
│   ├── Nematostella_vectensis_GCA_033964005.1.json
│   └── Anoura_caudifer_GCA_004027475.1.json
│
└── tracks/
    ├── Nematostella_vectensis/
    │   └── GCA_033964005.1/
    │       ├── gene_models/
    │       │   ├── ncbi_annotation.json
    │       │   └── apollo_annotation.json
    │       ├── alignments/
    │       │   └── long_reads.json
    │       └── maf/
    │           └── test_maf.json
    │
    └── Anoura_caudifer/
        └── GCA_004027475.1/
            └── ...
```

**Each track JSON contains:**
```json
{
  "trackId": "unique-id",
  "type": "QuantitativeTrack",
  "name": "Display Name",
  "category": ["Category", "Subcategory"],
  "assemblyNames": ["Assembly_Name"],
  "adapter": {
    "type": "BigWigAdapter",
    "bigWigLocation": {
      "uri": "/path/to/file.bw"
    }
  },
  "metadata": {
    "access_level": "PUBLIC",
    "description": "..."
  }
}
```

---

## Track URL Security

### JWT Token System
For **remote track access**, URLs get JWT tokens:

```json
{
  "adapter": {
    "bigWigLocation": {
      "uri": "/path/to/file.bw",
      "locationType": "UriLocation",
      "baseUri": "http://example.com",
      "internetAccountPreAuthorization": {
        "internetAccountType": "ExternalToken",
        "authInfo": {
          "token": "jwt-token-here"
        }
      }
    }
  }
}
```

**Whitelisted IPs:** No JWT token needed
**Remote users:** JWT token required

---

## Access Level Hierarchy

```
ADMIN (4)           → Can see ALL tracks
    ↓
IP_IN_RANGE (3)     → Can see PUBLIC + IP_IN_RANGE tracks
    ↓
COLLABORATOR (2)    → Can see PUBLIC + tracks for assemblies they have access to
    ↓
PUBLIC (1)          → Can see PUBLIC tracks only
```

**Determined by:** `lib/functions_access.php::get_access_level()`

---

## Key Functions

### In `config.php`:

- `generateAssemblyList($user_access_level)`
  - Returns filtered list of assemblies user can access
  
- `generateAssemblyConfig($organism, $assembly, $user_access_level)`
  - Returns full config with tracks for specific assembly
  
- `loadFilteredTracks($organism, $assembly, $user_access_level)`
  - Loads and filters tracks based on permissions
  
- `addTokensToTrack($track, $organism, $assembly, $access_level, $is_whitelisted)`
  - Adds JWT tokens to track URLs (if needed)

### Helper Functions:

- `lib/functions_access.php::get_access_level()` 
  - Returns: 'PUBLIC', 'IP_IN_RANGE', 'COLLABORATOR', 'ADMIN'
  
- `lib/functions_access.php::canUserAccessAssembly($user_level, $assembly_level, $organism, $assembly)`
  - Checks if user can access specific assembly
  
- `lib/jbrowse/track_token.php::generate_track_jwt($organism, $assembly, $user_level)`
  - Generates JWT token for track access

---

## Archived Files

### `archive/assembly.php`
- **Old endpoint** that was merged into `config.php`
- **Status:** Obsolete (moved 2026-02-14)
- **Reason:** Functionality merged into unified `config.php` endpoint

---

## Testing

### Test as PUBLIC user:
```bash
curl "http://localhost/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1"
```

### Test as ADMIN:
```bash
# Login as admin first, then:
curl "http://localhost/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1" \
  --cookie "PHPSESSID=your-session-id"
```

### Check what tracks PUBLIC sees:
```bash
curl "http://localhost/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1" | \
  jq '.tracks[].name'
```

---

## Adding New Tracks

1. **Add track to Google Sheet:**
   ```
   https://docs.google.com/spreadsheets/d/1Md23wIYo08cjtsOZMBy5UIsNaaxTxT8ijG-QLC3CjIo/edit
   ```

2. **Run generator script:**
   ```bash
   php tools/jbrowse/generate_tracks_from_sheet.php
   ```

3. **Tracks auto-appear** based on user permissions (no restart needed!)

---

## Performance Notes

- ✅ **Gzip compression** enabled for large configs
- ✅ **JWT tokens** cached per session
- ✅ **Configs** cached for 5 minutes
- ✅ Handles **500+ tracks** efficiently

---

## Future Improvements

1. **Remove unused pre-generated configs:**
   - Delete `jbrowse2/configs/` directory (or update generator)
   
2. **Implement Redis caching:**
   - Cache generated configs per (assembly + access_level)
   
3. **Add config versioning:**
   - Track when metadata changes, invalidate caches

---

## Summary

✅ **ACTIVE:** `config.php` (single endpoint for everything)
✅ **ACTIVE:** Metadata files in `metadata/jbrowse2-configs/`
✅ **ACTIVE:** Track generator script reads Google Sheet
❌ **OBSOLETE:** `assembly.php` (archived)
❌ **OBSOLETE:** Pre-generated configs in `jbrowse2/configs/` (not used)

**The system is clean, permission-based, and dynamically generates everything!**
