# JBrowse2 System Architecture & Data Flow

## Overview
This document describes how the JBrowse2 genome browser works in MOOP, from user request to data display.

---

## 1. User Opens JBrowse2

### Entry Point
```
URL: http://localhost:8000/moop/jbrowse2.php
```

### What Happens
```
jbrowse2.php
├── Loads session & access control
├── Gets user info (logged_in, username, access_level)
├── Renders page using MOOP layout
└── Includes: js/jbrowse2-loader.js
```

**File**: `/moop/jbrowse2.php`
**Does**: Authentication, page rendering, layout integration

---

## 2. Assembly List Loading

### JavaScript Initialization
```javascript
// In browser: js/jbrowse2-loader.js runs
fetch('/moop/api/jbrowse2/config.php')
  → Returns list of assemblies user can access
```

### API Processing
```
api/jbrowse2/config.php (no params)
├── Gets user access level (PUBLIC, COLLABORATOR, IP_IN_RANGE, ADMIN)
├── Reads: metadata/jbrowse2-configs/assemblies/*.json
├── Filters assemblies by accessLevel
└── Returns: { assemblies: [...], userAccessLevel: "..." }
```

**File**: `/moop/api/jbrowse2/config.php`
**Does**: Permission-filtered assembly list
**Note**: This is the **primary API endpoint** (config-optimized.php available for >1000 tracks)

---

## 3. User Clicks "View Genome"

### Config Request with Assembly
```javascript
// User clicks button for Nematostella_vectensis_GCA_033964005.1
window.location.href = '/moop/jbrowse2-dynamic.html?config=/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1'
```

### Full Config Generation
```
api/jbrowse2/config.php?organism=X&assembly=Y
├── Gets user access level
├── Reads: metadata/jbrowse2-configs/assemblies/ORGANISM_ASSEMBLY.json
├── Reads: metadata/jbrowse2-configs/tracks/ORGANISM_ASSEMBLY_*.json
├── Filters tracks by access level
├── Applies JWT tokens to track URLs (if needed)
└── Returns: Full JBrowse2 config with:
    ├── assembly definition
    ├── sequence adapter
    ├── all accessible tracks
    ├── plugins
    └── configuration
```

**File**: `/moop/api/jbrowse2/config.php`
**Does**: Generate complete permission-filtered JBrowse2 config

---

## 4. JBrowse2 Loads in Iframe

### JBrowse2 Initialization
```
jbrowse2/index.html (embedded React app)
├── Receives config URL via ?config= parameter
├── Fetches full config from API endpoint
├── Initializes @jbrowse/react-linear-genome-view
├── Loads plugins (MAF viewer, Synteny, etc.)
└── Displays genome browser
```

**File**: `/moop/jbrowse2/index.html` (React Linear Genome View)
**Does**: Embed JBrowse2, load config dynamically
**Note**: Uses prebuilt JBrowse2 React app bundle

---

## 5. Track Data Loading

### Secure File Serving via tracks.php
```
When JBrowse2 needs track data:

Track config has URL:
  /moop/api/jbrowse2/tracks.php?file=ORGANISM/ASSEMBLY/TRACK_TYPE/file.bw&token=JWT

User's browser requests track file:
  ├── tracks.php validates JWT token
  ├── Checks token grants access to organism/assembly
  ├── Prevents directory traversal attacks
  ├── Reads file from /moop/data/tracks/
  ├── Supports HTTP range requests (efficient streaming)
  └── Returns file data to browser

tracks.php acts as SECURE PROXY for track data
```

**File**: `/moop/api/jbrowse2/tracks.php` (file server with JWT validation)
**Data Location**: `/moop/data/tracks/` (BigWig, BAM, GFF, BED, etc.)
**Security**: JWT validation per request, organism/assembly access control

---

## 6. Permission System

### Access Levels
```
PUBLIC       → Only tracks with "accessLevel": "PUBLIC"
COLLABORATOR → PUBLIC + tracks for their specific assemblies
IP_IN_RANGE  → PUBLIC + IP_IN_RANGE tracks (whitelisted IPs)
ADMIN        → Everything including ADMIN-only tracks

Hierarchy: PUBLIC < COLLABORATOR < IP_IN_RANGE < ADMIN
```

### JWT Tokens
```
Generated by: lib/jbrowse/track_token.php
Contains: user_id, access_level, expiration
Applied to: Track URLs (except whitelisted IPs)
Validated by: Apache (mod_rewrite + PHP validation)
```

---

## 7. Metadata Generation & Dynamic Config System

### Track Configuration Files

**Primary Generator**: `tools/jbrowse/generate_tracks_from_sheet.php`

```bash
# Generate tracks from Google Sheet
php tools/jbrowse/generate_tracks_from_sheet.php SHEET_ID \
  --gid SHEET_GID \
  --organism Nematostella_vectensis \
  --assembly GCA_033964005.1
```

**What it does:**
- Reads track metadata from Google Sheet
- Auto-detects track types (BigWig, BAM, GFF, MAF, etc.)
- Generates JSON track configs with proper adapters
- Supports multi-BigWig combo tracks with color schemes
- Sets access levels per track (PUBLIC, COLLABORATOR, IP_IN_RANGE, ADMIN)
- Creates hierarchical track categories

**Output Structure:**
```
metadata/jbrowse2-configs/
├── assemblies/
│   └── Nematostella_vectensis_GCA_033964005.1.json
└── tracks/
    └── Nematostella_vectensis/
        └── GCA_033964005.1/
            ├── bigwig/
            │   ├── sample1.bw.json
            │   └── sample2.bw.json
            ├── bam/
            │   └── alignments.bam.json
            ├── gff/
            │   └── genes.gff.json
            └── maf/
                └── synteny.maf.json
```

### Dynamic Config Generation (Runtime)

**Standard Endpoint**: `api/jbrowse2/config.php`
- For assemblies with **< 1000 tracks**
- Generates full config with all tracks embedded
- Uses gzip compression for large configs
- Response time: ~500ms for 500 tracks

**Optimized Endpoint**: `api/jbrowse2/config-optimized.php` (AVAILABLE)
- For assemblies with **> 1000 tracks** (if needed)
- Uses track URIs instead of embedding full configs
- JBrowse2 lazy-loads individual tracks on demand
- Decision threshold: 50 tracks (embedded) vs URI-based (lazy load)

**Current Status:**
- Standard endpoint handles all current assemblies efficiently
- Optimized endpoint is available but not currently used
- Ready to switch to if any assembly exceeds 1000 tracks

### Performance Characteristics

| Track Count | Method | Load Time | Config Size |
|------------|--------|-----------|-------------|
| < 50 | Embedded | ~200ms | < 100KB |
| 50-500 | Embedded + gzip | ~500ms | 500KB → 50KB |
| 500-1000 | Embedded + gzip | ~1s | 2MB → 200KB |
| > 1000 | URI-based (optimized) | ~200ms | < 50KB |

---

## Active Files Summary

### PHP Entry Points
- `jbrowse2.php` - Main entry page (authentication, layout)
- `tools/pages/jbrowse2.php` - Page template with assembly list

### HTML/React
- `jbrowse2/index.html` - JBrowse2 React Linear Genome View (prebuilt)
- `jbrowse2-dynamic.html` - **OBSOLETE** (references archived get-config.php)

### API Endpoints

**Config Generation (Dynamic):**
- `api/jbrowse2/config.php` - **PRIMARY ENDPOINT** (currently used)
  - Assembly list (no params)
  - Full config (with organism + assembly params)
- `api/jbrowse2/config-optimized.php` - **AVAILABLE FOR FUTURE USE**
  - For assemblies with > 1000 tracks
  - Lazy-loading via track URIs

**File Serving (Secure Proxy):**
- `api/jbrowse2/tracks.php` - **FILE SERVER** (critical infrastructure)
  - Serves actual track data files (BigWig, BAM, GFF, BED, etc.)
  - JWT token validation per request
  - Organism/assembly access control
  - HTTP range request support for efficient streaming

### JavaScript
- `js/jbrowse2-loader.js` - Assembly list display

### Libraries
- `lib/jbrowse/track_token.php` - JWT generation
- `lib/JBrowse/PluginLoader.php` - Plugin configuration

### Metadata
- `metadata/jbrowse2-configs/assemblies/*.json`
- `metadata/jbrowse2-configs/tracks/*.json`

---

## Archived Files

Moved to: `api/jbrowse2/archive/` (as of 2026-02-14)

**Obsolete Endpoints:**
- `get-config.php` - Merged into `config.php`
- `assembly.php` - Merged into `config.php`
- `tracks.php` - Track loading now embedded in config
- `get-assembly-definition.php` - Assembly loading now in config
- `test-assembly.php` - Testing endpoints (obsolete)
- `fake-tracks-server.php` - Development testing tool

**Obsolete Caching:**
- `assembly-cached.php` - Redis caching (not implemented yet)
- `config.json.php` - Static config files (replaced by dynamic generation)

See: `api/jbrowse2/archive/README.md` for details

**Files with Outdated References (Need Updating):**
- `jbrowse2-dynamic.html` - Still references `get-config.php` (should use `config.php`)
- `js/jbrowse2-view-loader.js` - Still references `get-config.php` (should use `config.php`)
- `jbrowse2/jbrowse2-view-loader.js` - Still references `get-config.php` (should use `config.php`)

---

## Testing the System

### 1. Test Assembly List
```bash
curl -b cookies.txt 'http://localhost:8000/moop/api/jbrowse2/config.php'
```

### 2. Test Full Config
```bash
curl -b cookies.txt 'http://localhost:8000/moop/api/jbrowse2/config.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1'
```

### 3. Regenerate Track Metadata
This is the **ACTIVE** method for generating track configs:
```bash
# Generate from Google Sheet (primary method)
php tools/jbrowse/generate_tracks_from_sheet.php \
  1Md23wIYo08cjtsOZMBy5UIsNaaxTxT8ijG-QLC3CjIo \
  --gid 1977809640 \
  --organism Nematostella_vectensis \
  --assembly GCA_033964005.1

# List what tracks would be created (dry run)
php tools/jbrowse/generate_tracks_from_sheet.php SHEET_ID --dry-run

# Force regenerate specific tracks
php tools/jbrowse/generate_tracks_from_sheet.php SHEET_ID --force track1 track2

# List available color schemes
php tools/jbrowse/generate_tracks_from_sheet.php --list-colors
```

**After generating metadata, configs are generated dynamically at request time by `config.php`**

---

## Key Design Principles

1. **Dynamic Config Generation**: `config.php` generates configs from metadata (no pre-generated files)
2. **Permission Filtering**: All filtering happens at config generation time
3. **Secure File Serving**: Track data served through `tracks.php` with JWT validation
4. **JWT Security**: Tokens validate access per request, tied to organism/assembly
5. **Metadata-Driven**: All configs generated from JSON metadata files
6. **Two-Part Architecture**:
   - Config APIs: Generate JBrowse2 configuration JSON
   - File Server: Serve actual track data files securely

---

## Troubleshooting

### No Assemblies Showing
- Check user access level
- Verify assembly files in metadata/jbrowse2-configs/assemblies/
- Check accessLevel in assembly JSON files

### Tracks Not Loading
- Verify track files exist in data/tracks/
- Check JWT token generation
- Verify track metadata in metadata/jbrowse2-configs/tracks/

### Config Errors
- Clear browser cache
- Check PHP error logs
- Verify JSON syntax in metadata files

---

## Configuration Generation Strategy

### Current Approach: Dynamic Generation
All JBrowse2 configs are generated **on-demand** from metadata files:

1. **Metadata files are pre-generated** from Google Sheet
   - Tool: `tools/jbrowse/generate_tracks_from_sheet.php`
   - Output: JSON files in `metadata/jbrowse2-configs/`
   - Run when: Tracks are added/modified in Google Sheet

2. **Configs are generated at request time**
   - API: `api/jbrowse2/config.php`
   - Filters tracks by user access level
   - Adds JWT tokens to track URLs
   - Uses gzip compression for large configs

3. **No pre-generated config files**
   - Old system stored configs in `jbrowse2/configs/`
   - New system generates dynamically (cleaner, always current)

### Why Dynamic Generation?

**Advantages:**
- ✅ Always reflects current user permissions
- ✅ No stale configs (no need to regenerate on permission changes)
- ✅ Smaller storage footprint (metadata only)
- ✅ Easier to maintain (single source of truth)
- ✅ Supports 500+ tracks efficiently with gzip

**Performance:**
- Gzip compression: 2MB → 200KB
- Response time: ~500ms for 500 tracks
- Adequate for current scale (< 1000 tracks per assembly)

### Future Scaling Options

**If assemblies exceed 1000 tracks:**
- Switch to `config-optimized.php` (already available)
- Uses track URIs instead of embedding full configs
- JBrowse2 lazy-loads individual tracks on demand
- Reduces initial config size to < 50KB regardless of track count

**If performance becomes an issue:**
- Implement Redis caching (config cached per access level)
- Cache invalidation on metadata changes
- TTL: 5-10 minutes

---

## Maintenance Checklist

### Adding New Tracks
1. Add track info to Google Sheet
2. Run: `php tools/jbrowse/generate_tracks_from_sheet.php ...`
3. Tracks appear immediately (no server restart needed)

### Updating Track Permissions
1. Update access_level in Google Sheet
2. Regenerate metadata with generator script
3. Changes take effect immediately on next page load

### Adding New Assembly
1. Add assembly to Google Sheet
2. Run generator script for that assembly
3. Assembly appears in browser immediately

### Troubleshooting
- Check PHP error logs: `/var/log/apache2/error.log`
- Verify metadata exists: `ls metadata/jbrowse2-configs/assemblies/`
- Test API directly: `curl http://localhost/moop/api/jbrowse2/config.php`
- Check JWT tokens: Look for `?token=` in track URLs (if not whitelisted IP)

---

Last Updated: 2026-02-14
