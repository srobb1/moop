<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Registry - MOOP</title>
    <style>
        * { margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: #2c3e50; color: white; padding: 30px 0; margin: -20px -20px 30px -20px; }
        header h1 { margin-bottom: 10px; }
        header p { opacity: 0.9; }
        .search-box { margin: 20px 0; }
        input[type="text"] { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; }
        .unused-content { padding: 20px; }
        .unused-content.hidden { display: none; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-box { background: white; padding: 20px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
        .stat-box strong { display: block; font-size: 24px; color: #3498db; }
        .stat-box span { font-size: 12px; color: #666; }
        .file-section { background: white; margin: 20px 0; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .file-header { background: #34495e; color: white; padding: 15px 20px; font-weight: bold; cursor: pointer; }
        .file-header:hover { background: #2c3e50; }
        .functions-list { padding: 0; display: none; }
        .functions-list.open { display: block; }
        .function-item { padding: 15px 20px; border-bottom: 1px solid #ecf0f1; }
        .function-item:last-child { border-bottom: none; }
        .function-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding-bottom: 10px; }
        .function-header:hover { color: #3498db; }
        .function-name { font-family: 'Courier New', monospace; color: #2980b9; font-weight: 500; }
        .function-counter { display: inline-block; background: #3498db; color: white; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 24px; font-size: 12px; font-weight: bold; margin-left: 8px; }
        .function-line { font-size: 12px; color: #7f8c8d; }
        .function-code { display: none; background: #f8f8f8; padding: 15px; margin-top: 10px; border-radius: 4px; border-left: 3px solid #3498db; overflow-x: auto; }
        .function-code.open { display: block; }
        code { font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.5; color: #2c3e50; white-space: pre; display: block; }
        .function-comment { background: #fffacd; padding: 12px 15px; margin: 10px 0; border-left: 3px solid #f39c12; border-radius: 3px; }
        .function-comment pre { margin: 0; font-family: 'Courier New', monospace; font-size: 12px; color: #555; white-space: pre-wrap; word-break: break-word; }
        .function-usages { background: #e8f4f8; padding: 12px 15px; margin: 10px 0; border-left: 3px solid #3498db; border-radius: 3px; }
        .function-usages strong { display: block; margin-bottom: 8px; color: #2c3e50; }
        .function-usages ul { margin: 0; padding-left: 20px; }
        .function-usages li { margin: 6px 0; font-size: 12px; color: #555; }
        .function-usages code { display: inline; background: white; padding: 2px 6px; border-radius: 3px; border: 1px solid #bbb; }
        .function-usages small { display: block; margin-top: 2px; color: #666; font-style: italic; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üîç MOOP Function Registry</h1>
            <p>Auto-generated function documentation ‚Ä¢ Generated: 2025-11-26 16:45:03</p>
        </div>
    </header>
    <div class="container">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Search functions, files, or usage..." onkeyup="filterFunctions()">
        </div>
        <div class="stats">
            <div class="stat-box"><strong>120</strong><span>Total Functions</span></div>
            <div class="stat-box"><strong>19</strong><span>Files</span></div>
        </div>
        <div style="background: #ffe6e6; border: 2px solid #cc0000; border-radius: 4px; overflow: hidden; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="background: #cc0000; color: white; padding: 15px 20px; font-weight: bold; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center;" onclick="toggleUnused(this)">
                <span>‚ö†Ô∏è 17 Unused Function(s) Found</span>
                <span class="unusedArrow">‚ñ∂</span>
            </div>
            <div class="unused-content hidden">
                <p style="margin: 10px 0; color: #555;">These functions are defined but never called:</p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li><strong style="color: #cc0000;">filterDatabasesByProgram()</strong> in <code>lib/blast_functions.php</code> (line 72)</li>
                    <li><strong style="color: #cc0000;">generateBlastGraphicalView()</strong> in <code>lib/blast_results_visualizer.php</code> (line 352)</li>
                    <li><strong style="color: #cc0000;">generateBlastStatisticsSummary()</strong> in <code>lib/blast_results_visualizer.php</code> (line 650)</li>
                    <li><strong style="color: #cc0000;">getColorStyle()</strong> in <code>lib/blast_results_visualizer.php</code> (line 1263)</li>
                    <li><strong style="color: #cc0000;">generateQueryScale()</strong> in <code>lib/blast_results_visualizer.php</code> (line 1099)</li>
                    <li><strong style="color: #cc0000;">getFeaturesByType()</strong> in <code>lib/database_queries.php</code> (line 157)</li>
                    <li><strong style="color: #cc0000;">searchFeaturesByUniquename()</strong> in <code>lib/database_queries.php</code> (line 187)</li>
                    <li><strong style="color: #cc0000;">getAnnotationsByFeature()</strong> in <code>lib/database_queries.php</code> (line 219)</li>
                    <li><strong style="color: #cc0000;">getOrganismInfo()</strong> in <code>lib/database_queries.php</code> (line 240)</li>
                    <li><strong style="color: #cc0000;">searchFeaturesAndAnnotationsLike()</strong> in <code>lib/database_queries.php</code> (line 446)</li>
                    <li><strong style="color: #cc0000;">buildFilteredSourcesList()</strong> in <code>lib/extract_search_helpers.php</code> (line 257)</li>
                    <li><strong style="color: #cc0000;">buildLikeConditions()</strong> in <code>lib/functions_database.php</code> (line 241)</li>
                    <li><strong style="color: #cc0000;">getWebServerUserInfo()</strong> in <code>lib/functions_display.php</code> (line 456)</li>
                    <li><strong style="color: #cc0000;">test_input()</strong> in <code>lib/functions_validation.php</code> (line 23)</li>
                    <li><strong style="color: #cc0000;">validate_search_term()</strong> in <code>lib/functions_validation.php</code> (line 68)</li>
                    <li><strong style="color: #cc0000;">is_quoted_search()</strong> in <code>lib/functions_validation.php</code> (line 97)</li>
                    <li><strong style="color: #cc0000;">getAllTools()</strong> in <code>lib/tool_config.php</code> (line 62)</li>
                </ul>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin: 20px 0;">
            <button id="toggleBtn" onclick="toggleAll()" style="flex: 1; padding: 10px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">üìÇ Expand All</button>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ admin/manage_registry.php (1)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="getRegistryLastUpdate">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getRegistryLastUpdate()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 53</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">admin/manage_registry.php: getRegistryLastUpdate()</div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_registry.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 76</code>: <small>$php_last_update = getRegistryLastUpdate($php_registry_html, $php_registry_md);</small></li>
                                    <li><code>line 77</code>: <small>$js_last_update = getRegistryLastUpdate($js_registry_html, $js_registry_md);</small></li>
                                    <li><code>line 76</code>: <small>$php_last_update = getRegistryLastUpdate($php_registry_html, $php_registry_md);</small></li>
                                    <li><code>line 77</code>: <small>$js_last_update = getRegistryLastUpdate($js_registry_html, $js_registry_md);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getRegistryLastUpdate($htmlFile, $mdFile) {
    $lastUpdate = &#039;Never&#039;;
    
    // Try to get from HTML file first (has &quot;Generated:&quot; timestamp)
    if (file_exists($htmlFile) &amp;&amp; is_readable($htmlFile)) {
        $content = file_get_contents($htmlFile);
        // Look for &quot;Generated: YYYY-MM-DD HH:MM:SS&quot; in the HTML
        if (preg_match(&#039;/Generated:\s*(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})/&#039;, $content, $matches)) {
            $lastUpdate = $matches[1];
            return $lastUpdate;
        }
    }
    
    // Fallback to file modification time
    if (file_exists($htmlFile)) {
        $lastUpdate = date(&#039;Y-m-d H:i:s&#039;, filemtime($htmlFile));
    } elseif (file_exists($mdFile)) {
        $lastUpdate = date(&#039;Y-m-d H:i:s&#039;, filemtime($mdFile));
    }
    
    return $lastUpdate;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/blast_functions.php (5)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="getBlastDatabases">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getBlastDatabases()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 23</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_functions.php: getBlastDatabases()</div>
                    <div class="function-comment">
                        <pre>/**
* Get list of available BLAST databases for an assembly
* Looks for FASTA files matching configured sequence type patterns
* (protein.aa.fa, cds.nt.fa, transcript.nt.fa)
*
* @param string $assembly_path Path to assembly directory
* @return array Array of BLAST databases with type and path
*   Format: [
*     [&#039;name&#039; =&gt; &#039;protein&#039;, &#039;path&#039; =&gt; &#039;/path/to/protein.aa.fa&#039;, &#039;type&#039; =&gt; &#039;protein&#039;],
*     [&#039;name&#039; =&gt; &#039;cds&#039;, &#039;path&#039; =&gt; &#039;/path/to/cds.nt.fa&#039;, &#039;type&#039; =&gt; &#039;nucleotide&#039;]
*   ]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/blast.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 128</code>: <small>$all_dbs = getBlastDatabases($selected_source_obj[&#039;path&#039;]);</small></li>
                                    <li><code>line 602</code>: <small>$dbs = getBlastDatabases($source[&#039;path&#039;]);</small></li>
                                    <li><code>line 128</code>: <small>$all_dbs = getBlastDatabases($selected_source_obj[&#039;path&#039;]);</small></li>
                                    <li><code>line 602</code>: <small>$dbs = getBlastDatabases($source[&#039;path&#039;]);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getBlastDatabases($assembly_path) {
    global $sequence_types;
    $databases = [];
    
    if (!is_dir($assembly_path)) {
        return $databases;
    }
    
    // Map sequence types to database info
    $type_mapping = [
        &#039;protein&#039; =&gt; [&#039;name&#039; =&gt; &#039;Protein&#039;, &#039;blast_type&#039; =&gt; &#039;protein&#039;],
        &#039;cds&#039; =&gt; [&#039;name&#039; =&gt; &#039;CDS&#039;, &#039;blast_type&#039; =&gt; &#039;nucleotide&#039;],
        &#039;transcript&#039; =&gt; [&#039;name&#039; =&gt; &#039;Transcript&#039;, &#039;blast_type&#039; =&gt; &#039;nucleotide&#039;],
    ];
    
    // Check for each configured sequence type
    if (!empty($sequence_types)) {
        foreach ($sequence_types as $seq_type =&gt; $config) {
            $pattern = $config[&#039;pattern&#039;] ?? &#039;&#039;;
            if (empty($pattern)) {
                continue;
            }
            
            $file_path = &quot;$assembly_path/$pattern&quot;;
            
            // Check if file exists
            if (file_exists($file_path)) {
                $type_info = $type_mapping[$seq_type] ?? [&#039;name&#039; =&gt; ucfirst($seq_type), &#039;blast_type&#039; =&gt; &#039;nucleotide&#039;];
                
                $databases[] = [
                    &#039;name&#039; =&gt; $type_info[&#039;name&#039;],
                    &#039;path&#039; =&gt; $file_path,
                    &#039;type&#039; =&gt; $type_info[&#039;blast_type&#039;]
                ];
            }
        }
    }
    
    return $databases;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="filterDatabasesByProgram">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">filterDatabasesByProgram()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 72</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_functions.php: filterDatabasesByProgram()</div>
                    <div class="function-comment">
                        <pre>/**
* Filter BLAST databases by program type
* Returns only databases compatible with the selected BLAST program
*
* @param array $databases Array of databases from getBlastDatabases()
* @param string $blast_program BLAST program: blastn, blastp, blastx, tblastn, tblastx
* @return array Filtered array of compatible databases
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function filterDatabasesByProgram($databases, $blast_program) {
    $filtered = [];
    
    // Determine which database types are compatible with the program
    $compatible_types = [];
    switch ($blast_program) {
        case &#039;blastn&#039;:
        case &#039;tblastn&#039;:
        case &#039;tblastx&#039;:
            $compatible_types = [&#039;nucleotide&#039;];
            break;
        case &#039;blastp&#039;:
        case &#039;blastx&#039;:
            $compatible_types = [&#039;protein&#039;];
            break;
        default:
            return $databases; // Unknown program, return all
    }
    
    foreach ($databases as $db) {
        if (in_array($db[&#039;type&#039;], $compatible_types)) {
            $filtered[] = $db;
        }
    }
    
    return $filtered;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="executeBlastSearch">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">executeBlastSearch()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 110</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_functions.php: executeBlastSearch()</div>
                    <div class="function-comment">
                        <pre>/**
* Execute BLAST search
* Runs BLAST command with outfmt 11 (ASN.1), then converts using blast_formatter
*
* @param string $query_seq FASTA sequence to search
* @param string $blast_db Path to BLAST database (without extension)
* @param string $program BLAST program (blastn, blastp, blastx, etc.)
* @param array $options Additional BLAST options (evalue, max_hits, matrix, etc.)
* @return array Result array with &#039;success&#039;, &#039;output&#039;, &#039;error&#039;, and &#039;stderr&#039; keys
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/blast.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 172</code>: <small>$blast_result = executeBlastSearch($query_with_header, $blast_db, $blast_program</small></li>
                                    <li><code>line 172</code>: <small>$blast_result = executeBlastSearch($query_with_header, $blast_db, $blast_program</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function executeBlastSearch($query_seq, $blast_db, $program, $options = []) {
    $result = [
        &#039;success&#039; =&gt; false,
        &#039;output&#039; =&gt; &#039;&#039;,
        &#039;error&#039; =&gt; &#039;&#039;,
        &#039;stderr&#039; =&gt; &#039;&#039;
    ];
    
    // Validate inputs
    if (empty($query_seq) || empty($blast_db) || empty($program)) {
        $result[&#039;error&#039;] = &#039;Missing required parameters for BLAST search&#039;;
        return $result;
    }
    
    // Verify database exists - check for any of the BLAST index files
    $has_index = false;
    if (file_exists(&quot;$blast_db.nhr&quot;) || file_exists(&quot;$blast_db.phr&quot;) || 
        file_exists(&quot;$blast_db.ndb&quot;) || file_exists(&quot;$blast_db.pdb&quot;)) {
        $has_index = true;
    }
    
    if (!$has_index) {
        $result[&#039;error&#039;] = &#039;BLAST database not found: &#039; . basename($blast_db);
        return $result;
    }
    
    // Set default options
    $evalue = $options[&#039;evalue&#039;] ?? &#039;1e-3&#039;;
    $max_hits = (int)($options[&#039;max_hits&#039;] ?? 10);
    $matrix = $options[&#039;matrix&#039;] ?? &#039;BLOSUM62&#039;;
    $filter = $options[&#039;filter&#039;] ? &#039;yes&#039; : &#039;no&#039;;
    $task = $options[&#039;task&#039;] ?? &#039;&#039;;
    
    // Create temporary directory for ASN.1 archive output
    $temp_dir = sys_get_temp_dir();
    $archive_file = tempnam($temp_dir, &#039;blast_&#039;);
    
    if ($archive_file === false) {
        $result[&#039;error&#039;] = &#039;Failed to create temporary file for BLAST output&#039;;
        return $result;
    }
    
    // Build BLAST command with outfmt 11 (ASN.1)
    $cmd = [];
    $cmd[] = $program;
    // Use absolute path for database
    // For BLAST databases, we pass the base name and BLAST appends the extensions
    $db_dir = dirname($blast_db);
    $db_base = basename($blast_db);
    $db_path = realpath($db_dir);
    if (!$db_path) {
        unlink($archive_file);
        $result[&#039;error&#039;] = &#039;Cannot resolve database path: &#039; . $blast_db;
        return $result;
    }
    $full_db_path = $db_path . &#039;/&#039; . $db_base;
    $cmd[] = &#039;-db &#039; . escapeshellarg($full_db_path);
    $cmd[] = &#039;-evalue &#039; . escapeshellarg($evalue);
    $cmd[] = &#039;-num_descriptions &#039; . escapeshellarg($max_hits);
    $cmd[] = &#039;-num_alignments &#039; . escapeshellarg($max_hits);
    $cmd[] = &#039;-outfmt 11&#039;;
    $cmd[] = &#039;-out &#039; . escapeshellarg($archive_file);
    
    // Add program-specific options
    if ($program === &#039;blastn&#039;) {
        $cmd[] = &#039;-dust &#039; . escapeshellarg($filter);
    } elseif ($program === &#039;tblastn&#039;) {
        $cmd[] = &#039;-seg &#039; . escapeshellarg($filter);
    } elseif (in_array($program, [&#039;blastp&#039;, &#039;blastx&#039;, &#039;tblastx&#039;])) {
        $cmd[] = &#039;-seg &#039; . escapeshellarg($filter);
        $cmd[] = &#039;-matrix &#039; . escapeshellarg($matrix);
    }
    
    // Add task if specified
    if (!empty($task)) {
        $cmd[] = &#039;-task &#039; . escapeshellarg($task);
    }
    
    $command = &#039;printf &#039; . escapeshellarg($query_seq) . &#039; | &#039; . implode(&#039; &#039;, $cmd);
    
    // Execute BLAST with proc_open for better control
    $descriptors = [
        0 =&gt; [&quot;pipe&quot;, &quot;r&quot;],
        1 =&gt; [&quot;pipe&quot;, &quot;w&quot;],
        2 =&gt; [&quot;pipe&quot;, &quot;w&quot;],
    ];
    
    $process = proc_open($command, $descriptors, $pipes);
    if (!is_resource($process)) {
        unlink($archive_file);
        $result[&#039;error&#039;] = &#039;Failed to execute BLAST command&#039;;
        return $result;
    }
    
    fclose($pipes[0]);
    $blast_stdout = stream_get_contents($pipes[1]);
    fclose($pipes[1]);
    $blast_stderr = stream_get_contents($pipes[2]);
    fclose($pipes[2]);
    $return_code = proc_close($process);
    
    if ($return_code !== 0) {
        unlink($archive_file);
        $result[&#039;error&#039;] = &#039;BLAST execution failed with code &#039; . $return_code;
        $result[&#039;stderr&#039;] = $blast_stderr;
        return $result;
    }
    
    // Convert ASN.1 archive to outfmt 5 (XML) using blast_formatter
    $xml_file = tempnam($temp_dir, &#039;blast_xml_&#039;);
    $formatter_cmd = &#039;blast_formatter -archive &#039; . escapeshellarg($archive_file) . 
                     &#039; -outfmt 5 -out &#039; . escapeshellarg($xml_file);
    
    $process = proc_open($formatter_cmd, $descriptors, $pipes);
    if (!is_resource($process)) {
        unlink($archive_file);
        $result[&#039;error&#039;] = &#039;Failed to execute blast_formatter for XML&#039;;
        return $result;
    }
    
    fclose($pipes[0]);
    fclose($pipes[1]);
    fclose($pipes[2]);
    $return_code = proc_close($process);
    
    if ($return_code !== 0) {
        unlink($archive_file);
        unlink($xml_file);
        $result[&#039;error&#039;] = &#039;blast_formatter XML conversion failed with code &#039; . $return_code;
        return $result;
    }
    
    // Read the XML output
    $output = file_get_contents($xml_file);
    
    // Now convert ASN.1 archive to outfmt 0 (Pairwise text) for download
    $pairwise_file = tempnam($temp_dir, &#039;blast_pairwise_&#039;);
    $formatter_cmd = &#039;blast_formatter -archive &#039; . escapeshellarg($archive_file) . 
                     &#039; -outfmt 0 -out &#039; . escapeshellarg($pairwise_file);
    
    $process = proc_open($formatter_cmd, $descriptors, $pipes);
    if (!is_resource($process)) {
        unlink($archive_file);
        unlink($xml_file);
        unlink($pairwise_file);
        $result[&#039;error&#039;] = &#039;Failed to execute blast_formatter for pairwise&#039;;
        return $result;
    }
    
    fclose($pipes[0]);
    fclose($pipes[1]);
    fclose($pipes[2]);
    $return_code = proc_close($process);
    
    if ($return_code !== 0) {
        unlink($archive_file);
        unlink($xml_file);
        unlink($pairwise_file);
        $result[&#039;error&#039;] = &#039;blast_formatter pairwise conversion failed with code &#039; . $return_code;
        return $result;
    }
    
    // Read the pairwise output
    $pairwise_output = file_get_contents($pairwise_file);
    
    // Clean up temporary files
    unlink($archive_file);
    unlink($xml_file);
    unlink($pairwise_file);
    
    $result[&#039;success&#039;] = true;
    $result[&#039;output&#039;] = $output;
    $result[&#039;pairwise&#039;] = $pairwise_output;
    $result[&#039;stderr&#039;] = $blast_stderr;
    
    return $result;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="extractSequencesFromBlastDb">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">extractSequencesFromBlastDb()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 299</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_functions.php: extractSequencesFromBlastDb()</div>
                    <div class="function-comment">
                        <pre>/**
* Extract sequences from BLAST database using blastdbcmd
* Used by fasta extract and download tools
* Supports parent-&gt;child lookup from database
*
* @param string $blast_db Path to BLAST database (without extension)
* @param array $sequence_ids Array of sequence IDs to extract
* @param string $organism Optional organism name for parent/child lookup
* @param string $assembly Optional assembly name for parent/child lookup
* @return array Result array with &#039;success&#039;, &#039;content&#039;, and &#039;error&#039; keys
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/extract_search_helpers.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 168</code>: <small>$extract_result = extractSequencesFromBlastDb($fasta_file, $uniquenames, $organi</small></li>
                                    <li><code>line 189</code>: <small>$extract_result = extractSequencesFromBlastDb($fasta_file, $uniquenames, $organi</small></li>
                                    <li><code>line 168</code>: <small>$extract_result = extractSequencesFromBlastDb($fasta_file, $uniquenames, $organi</small></li>
                                    <li><code>line 189</code>: <small>$extract_result = extractSequencesFromBlastDb($fasta_file, $uniquenames, $organi</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function extractSequencesFromBlastDb($blast_db, $sequence_ids, $organism = &#039;&#039;, $assembly = &#039;&#039;) {
    $result = [
        &#039;success&#039; =&gt; false,
        &#039;content&#039; =&gt; &#039;&#039;,
        &#039;error&#039; =&gt; &#039;&#039;
    ];
    
    if (empty($sequence_ids) || !is_array($sequence_ids)) {
        $result[&#039;error&#039;] = &#039;No sequence IDs provided&#039;;
        return $result;
    }
    
    if (!file_exists($blast_db . &#039;.nhr&#039;) &amp;&amp; !file_exists($blast_db . &#039;.phr&#039;)) {
        $result[&#039;error&#039;] = &#039;BLAST database not found&#039;;
        return $result;
    }
    
    // Use blastdbcmd to extract sequences
    // IDs have already been expanded via database lookup to include children
    $ids_string = implode(&#039;,&#039;, $sequence_ids);
    $cmd = &quot;blastdbcmd -db &quot; . escapeshellarg($blast_db) . &quot; -entry &quot; . escapeshellarg($ids_string) . &quot; 2&gt;/dev/null&quot;;
    $output = [];
    $return_var = 0;
    @exec($cmd, $output, $return_var);
    
    // Check if blastdbcmd executed
    if ($return_var &gt; 1) {
        // Return code 1 is expected when some IDs don&#039;t exist, but &gt;1 is an error
        $result[&#039;error&#039;] = &quot;Error extracting sequences (exit code: $return_var). Ensure blastdbcmd is installed and FASTA files are formatted correctly.&quot;;
        return $result;
    }
    
    // Check if we got any output
    if (empty($output)) {
        $result[&#039;error&#039;] = &#039;No sequences found for the requested IDs&#039;;
        return $result;
    }
    
    $result[&#039;success&#039;] = true;
    $result[&#039;content&#039;] = implode(&quot;\n&quot;, $output);
    
    return $result;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="validateBlastSequence">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateBlastSequence()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 350</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_functions.php: validateBlastSequence()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate BLAST sequence input
* Checks if input is valid FASTA format
*
* @param string $sequence Raw sequence input (may or may not have FASTA header)
* @return array Array with &#039;valid&#039; bool and &#039;error&#039; string
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/blast.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 143</code>: <small>$validation = validateBlastSequence($search_query);</small></li>
                                    <li><code>line 143</code>: <small>$validation = validateBlastSequence($search_query);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateBlastSequence($sequence) {
    $sequence = trim($sequence);
    
    if (empty($sequence)) {
        return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; &#039;Sequence is empty&#039;];
    }
    
    // If sequence doesn&#039;t start with &gt;, add a header
    if ($sequence[0] !== &#039;&gt;&#039;) {
        $sequence = &quot;&gt;query_sequence\n&quot; . $sequence;
    }
    
    // Basic FASTA format validation
    $lines = explode(&quot;\n&quot;, $sequence);
    $in_header = true;
    $seq_count = 0;
    
    foreach ($lines as $line) {
        $line = trim($line);
        if (empty($line)) {
            continue;
        }
        
        if ($line[0] === &#039;&gt;&#039;) {
            if (!$in_header &amp;&amp; $seq_count === 0) {
                return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; &#039;Invalid FASTA format: sequence expected before header&#039;];
            }
            $in_header = true;
            $seq_count = 0;
        } else {
            if ($in_header) {
                $in_header = false;
            }
            $seq_count += strlen($line);
        }
    }
    
    if ($seq_count === 0) {
        return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; &#039;No sequence data found&#039;];
    }
    
    return [&#039;valid&#039; =&gt; true, &#039;error&#039; =&gt; &#039;&#039;];
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/blast_results_visualizer.php (15)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="parseBlastResults">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">parseBlastResults()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 19</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: parseBlastResults()</div>
                    <div class="function-comment">
                        <pre>/**
* Parse BLAST results from XML output
* Supports multiple queries, each with Hit/HSP hierarchy
*
* @param string $blast_xml Raw BLAST XML output
* @return array Array of parsed query results, each with hits array
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/blast_results_visualizer.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 735</code>: <small>$parse_result = parseBlastResults($blast_result[&#039;output&#039;]);</small></li>
                                    <li><code>line 735</code>: <small>$parse_result = parseBlastResults($blast_result[&#039;output&#039;]);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function parseBlastResults($blast_xml) {
    $all_queries = [];
    
    // Parse XML
    try {
        $xml = simplexml_load_string($blast_xml);
        
        if ($xml === false) {
            return [&#039;error&#039; =&gt; &#039;Failed to parse BLAST XML output&#039;, &#039;queries&#039; =&gt; []];
        }
        
        // Parse each iteration (each query gets one iteration)
        $iterations = $xml-&gt;xpath(&#039;//Iteration&#039;);
        
        foreach ($iterations as $iteration) {
            $query_result = [
                &#039;hits&#039; =&gt; [],
                &#039;query_length&#039; =&gt; 0,
                &#039;query_name&#039; =&gt; &#039;&#039;,
                &#039;query_desc&#039; =&gt; &#039;&#039;,
                &#039;total_hits&#039; =&gt; 0,
                &#039;error&#039; =&gt; &#039;&#039;
            ];
            
            // Get query info using XPath to handle hyphens in element names
            $query_len = $iteration-&gt;xpath(&#039;./Iteration_query-len&#039;);
            if (!empty($query_len)) {
                $query_result[&#039;query_length&#039;] = (int)$query_len[0];
            }
            
            $query_id = $iteration-&gt;xpath(&#039;./Iteration_query-ID&#039;);
            if (!empty($query_id)) {
                $query_result[&#039;query_name&#039;] = (string)$query_id[0];
            }
            
            $query_def = $iteration-&gt;xpath(&#039;./Iteration_query-def&#039;);
            if (!empty($query_def)) {
                $query_result[&#039;query_desc&#039;] = (string)$query_def[0];
            }
            
            // Parse each hit using XPath - maintain Hit/HSP hierarchy
            $hits = $iteration-&gt;xpath(&#039;.//Hit&#039;);
            foreach ($hits as $hit_node) {
                // Get hit info
                $hit_id = $hit_node-&gt;xpath(&#039;./Hit_id&#039;);
                $hit_def = $hit_node-&gt;xpath(&#039;./Hit_def&#039;);
                $hit_len = $hit_node-&gt;xpath(&#039;./Hit_len&#039;);
                
                $hit_id_str = !empty($hit_id) ? (string)$hit_id[0] : &#039;&#039;;
                $hit_def_str = !empty($hit_def) ? (string)$hit_def[0] : &#039;&#039;;
                $hit_len_int = !empty($hit_len) ? (int)$hit_len[0] : 0;
                
                // Get all HSPs (High-scoring Segment Pairs) for this hit
                $hsps = $hit_node-&gt;xpath(&#039;.//Hsp&#039;);
                if (!empty($hsps)) {
                    $hsps_array = [];
                    $best_evalue = PHP_FLOAT_MAX;
                    $cumulative_coverage = [];
                    
                    // Process each HSP for this hit
                    foreach ($hsps as $hsp) {
                        // Use XPath for HSP elements with hyphens
                        $identities = $hsp-&gt;xpath(&#039;./Hsp_identity&#039;);
                        $align_len = $hsp-&gt;xpath(&#039;./Hsp_align-len&#039;);
                        $evalue = $hsp-&gt;xpath(&#039;./Hsp_evalue&#039;);
                        $bit_score = $hsp-&gt;xpath(&#039;./Hsp_bit-score&#039;);
                        $score = $hsp-&gt;xpath(&#039;./Hsp_score&#039;);
                        $query_from = $hsp-&gt;xpath(&#039;./Hsp_query-from&#039;);
                        $query_to = $hsp-&gt;xpath(&#039;./Hsp_query-to&#039;);
                        $hit_from = $hsp-&gt;xpath(&#039;./Hsp_hit-from&#039;);
                        $hit_to = $hsp-&gt;xpath(&#039;./Hsp_hit-to&#039;);
                        $qseq = $hsp-&gt;xpath(&#039;./Hsp_qseq&#039;);
                        $hseq = $hsp-&gt;xpath(&#039;./Hsp_hseq&#039;);
                        $midline = $hsp-&gt;xpath(&#039;./Hsp_midline&#039;);
                        
                        $identities_int = !empty($identities) ? (int)$identities[0] : 0;
                        $align_len_int = !empty($align_len) ? (int)$align_len[0] : 0;
                        $evalue_float = !empty($evalue) ? (float)$evalue[0] : 0;
                        $hit_from_int = !empty($hit_from) ? (int)$hit_from[0] : 0;
                        $hit_to_int = !empty($hit_to) ? (int)$hit_to[0] : 0;
                        
                        // Track best (smallest) evalue
                        if ($evalue_float &lt; $best_evalue) {
                            $best_evalue = $evalue_float;
                        }
                        
                        // Track coverage regions for cumulative calculation
                        $cumulative_coverage[] = [
                            &#039;from&#039; =&gt; min($hit_from_int, $hit_to_int),
                            &#039;to&#039; =&gt; max($hit_from_int, $hit_to_int)
                        ];
                        
                        // Count gaps and similarities with gap lengths
                        $query_seq = !empty($qseq) ? (string)$qseq[0] : &#039;&#039;;
                        $hit_seq = !empty($hseq) ? (string)$hseq[0] : &#039;&#039;;
                        $midline_str = !empty($midline) ? (string)$midline[0] : &#039;&#039;;
                        
                        // Count gaps and track individual gap lengths
                        $gap_count = 0;
                        $gap_lengths = [];
                        
                        // Find gaps in query sequence
                        $in_gap = false;
                        $gap_len = 0;
                        for ($i = 0; $i &lt; strlen($query_seq); $i++) {
                            if ($query_seq[$i] === &#039;-&#039;) {
                                if (!$in_gap) {
                                    $in_gap = true;
                                    $gap_len = 1;
                                } else {
                                    $gap_len++;
                                }
                            } else {
                                if ($in_gap) {
                                    $gap_lengths[] = $gap_len;
                                    $gap_count += $gap_len;
                                    $in_gap = false;
                                }
                            }
                        }
                        if ($in_gap) {
                            $gap_lengths[] = $gap_len;
                            $gap_count += $gap_len;
                        }
                        
                        // Find gaps in hit sequence
                        $in_gap = false;
                        $gap_len = 0;
                        for ($i = 0; $i &lt; strlen($hit_seq); $i++) {
                            if ($hit_seq[$i] === &#039;-&#039;) {
                                if (!$in_gap) {
                                    $in_gap = true;
                                    $gap_len = 1;
                                } else {
                                    $gap_len++;
                                }
                            } else {
                                if ($in_gap) {
                                    $gap_lengths[] = $gap_len;
                                    $gap_count += $gap_len;
                                    $in_gap = false;
                                }
                            }
                        }
                        if ($in_gap) {
                            $gap_lengths[] = $gap_len;
                            $gap_count += $gap_len;
                        }
                        
                        $total_gap_length = $gap_count;
                        $gaps = count($gap_lengths);
                        $gap_lengths_str = implode(&#039;, &#039;, $gap_lengths);
                        
                        $similarities = strlen($midline_str) - $identities_int - substr_count($midline_str, &#039; &#039;);
                        
                        // Calculate HSP subject coverage percentage
                        $subject_coverage_percent = $hit_len_int &gt; 0 ? round((abs($hit_to_int - $hit_from_int) + 1) / $hit_len_int * 100, 2) : 0;
                        
                        $hsp_data = [
                            &#039;identities&#039; =&gt; $identities_int,
                            &#039;alignment_length&#039; =&gt; $align_len_int,
                            &#039;evalue&#039; =&gt; $evalue_float,
                            &#039;bit_score&#039; =&gt; !empty($bit_score) ? (float)$bit_score[0] : 0,
                            &#039;score&#039; =&gt; !empty($score) ? (int)$score[0] : 0,
                            &#039;percent_identity&#039; =&gt; $align_len_int &gt; 0 ? round(($identities_int / $align_len_int) * 100, 2) : 0,
                            &#039;query_from&#039; =&gt; !empty($query_from) ? (int)$query_from[0] : 0,
                            &#039;query_to&#039; =&gt; !empty($query_to) ? (int)$query_to[0] : 0,
                            &#039;hit_from&#039; =&gt; $hit_from_int,
                            &#039;hit_to&#039; =&gt; $hit_to_int,
                            &#039;query_seq&#039; =&gt; $query_seq,
                            &#039;hit_seq&#039; =&gt; $hit_seq,
                            &#039;midline&#039; =&gt; $midline_str,
                            &#039;gaps&#039; =&gt; $gaps,
                            &#039;gap_lengths&#039; =&gt; $gap_lengths,
                            &#039;gap_lengths_str&#039; =&gt; $gap_lengths_str,
                            &#039;total_gap_length&#039; =&gt; $total_gap_length,
                            &#039;similarities&#039; =&gt; $similarities,
                            &#039;subject_coverage_percent&#039; =&gt; $subject_coverage_percent
                        ];
                        
                        $hsps_array[] = $hsp_data;
                    }
                    
                    // Calculate cumulative coverage for this hit across all HSPs
                    // Track query coverage (not subject coverage)
                    $query_coverage = [];
                    foreach ($hsps_array as $hsp_data) {
                        $query_coverage[] = [
                            &#039;from&#039; =&gt; $hsp_data[&#039;query_from&#039;],
                            &#039;to&#039; =&gt; $hsp_data[&#039;query_to&#039;]
                        ];
                    }
                    
                    usort($query_coverage, function($a, $b) { return $a[&#039;from&#039;] - $b[&#039;from&#039;]; });
                    $merged = [];
                    foreach ($query_coverage as $region) {
                        if (empty($merged) || $merged[count($merged)-1][&#039;to&#039;] &lt; $region[&#039;from&#039;]) {
                            $merged[] = $region;
                        } else {
                            $merged[count($merged)-1][&#039;to&#039;] = max($merged[count($merged)-1][&#039;to&#039;], $region[&#039;to&#039;]);
                        }
                    }
                    $total_covered = 0;
                    foreach ($merged as $region) {
                        $total_covered += $region[&#039;to&#039;] - $region[&#039;from&#039;] + 1;
                    }
                    $query_coverage_percent = $query_result[&#039;query_length&#039;] &gt; 0 ? round(($total_covered / $query_result[&#039;query_length&#039;]) * 100, 2) : 0;
                    
                    // Also calculate subject cumulative coverage for display
                    $subject_cumulative_coverage = [];
                    foreach ($query_result[&#039;hits&#039;] as $hit_test) {
                        if ($hit_test[&#039;subject&#039;] === $hit_def_str) {
                            foreach ($hit_test[&#039;hsps&#039;] as $hsp_test) {
                                $subject_cumulative_coverage[] = [
                                    &#039;from&#039; =&gt; min($hsp_test[&#039;hit_from&#039;], $hsp_test[&#039;hit_to&#039;]),
                                    &#039;to&#039; =&gt; max($hsp_test[&#039;hit_from&#039;], $hsp_test[&#039;hit_to&#039;])
                                ];
                            }
                        }
                    }
                    usort($subject_cumulative_coverage, function($a, $b) { return $a[&#039;from&#039;] - $b[&#039;from&#039;]; });
                    $merged_subject = [];
                    foreach ($subject_cumulative_coverage as $region) {
                        if (empty($merged_subject) || $merged_subject[count($merged_subject)-1][&#039;to&#039;] &lt; $region[&#039;from&#039;]) {
                            $merged_subject[] = $region;
                        } else {
                            $merged_subject[count($merged_subject)-1][&#039;to&#039;] = max($merged_subject[count($merged_subject)-1][&#039;to&#039;], $region[&#039;to&#039;]);
                        }
                    }
                    $total_subject_covered = 0;
                    foreach ($merged_subject as $region) {
                        $total_subject_covered += $region[&#039;to&#039;] - $region[&#039;from&#039;] + 1;
                    }
                    $subject_cumulative_coverage_percent = $hit_len_int &gt; 0 ? round(($total_subject_covered / $hit_len_int) * 100, 2) : 0;
                    
                    // Create hit entry with all its HSPs
                    $hit = [
                        &#039;id&#039; =&gt; $hit_id_str,
                        &#039;subject&#039; =&gt; $hit_def_str,
                        &#039;length&#039; =&gt; $hit_len_int,
                        &#039;hsps&#039; =&gt; $hsps_array,
                        &#039;best_evalue&#039; =&gt; $best_evalue,
                        &#039;num_hsps&#039; =&gt; count($hsps_array),
                        &#039;query_coverage_percent&#039; =&gt; $query_coverage_percent,
                        &#039;subject_cumulative_coverage_percent&#039; =&gt; $subject_cumulative_coverage_percent
                    ];
                    
                    $query_result[&#039;hits&#039;][] = $hit;
                }
            }
            
            $query_result[&#039;total_hits&#039;] = count($query_result[&#039;hits&#039;]);
            $all_queries[] = $query_result;
        }
        
    } catch (Exception $e) {
        return [&#039;error&#039; =&gt; &#039;XML parsing error: &#039; . $e-&gt;getMessage(), &#039;queries&#039; =&gt; []];
    }
    
    return [&#039;queries&#039; =&gt; $all_queries, &#039;error&#039; =&gt; &#039;&#039;];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateHitsSummaryTable">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateHitsSummaryTable()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 288</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: generateHitsSummaryTable()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate HTML for hits summary table
*
* @param array $results Parsed BLAST results
* @param int $query_num Query number for linking to hit sections
* @return string HTML table
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/blast_results_visualizer.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 988</code>: <small>$html .= generateHitsSummaryTable($query, $query_num);</small></li>
                                    <li><code>line 988</code>: <small>$html .= generateHitsSummaryTable($query, $query_num);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function generateHitsSummaryTable($results, $query_num = 1) {
    $html = &#039;&lt;div class=&quot;blast-hits-summary mb-4&quot;&gt;&#039;;
    $html .= &#039;&lt;h6&gt;&lt;i class=&quot;fa fa-table&quot;&gt;&lt;/i&gt; Hits Summary (&#039; . $results[&#039;total_hits&#039;] . &#039; hits found)&lt;/h6&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;overflow-x: auto;&quot;&gt;&#039;;
    $html .= &#039;&lt;table class=&quot;table table-sm table-striped blast-hits-table&quot;&gt;&#039;;
    $html .= &#039;&lt;thead class=&quot;table-light&quot;&gt;&#039;;
    $html .= &#039;&lt;tr&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 5%&quot;&gt;#&lt;/th&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 45%&quot;&gt;Subject&lt;/th&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 20%&quot;&gt;Query Coverage %&lt;/th&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 12%&quot;&gt;E-value&lt;/th&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 18%&quot;&gt;HSPs&lt;/th&gt;&#039;;
    $html .= &#039;&lt;/tr&gt;&#039;;
    $html .= &#039;&lt;/thead&gt;&#039;;
    $html .= &#039;&lt;tbody&gt;&#039;;
    
    foreach ($results[&#039;hits&#039;] as $idx =&gt; $hit) {
        $hit_num = $idx + 1;
        $evalue_display = sprintf(&#039;%.2e&#039;, $hit[&#039;best_evalue&#039;]);
        $query_coverage = $hit[&#039;query_coverage_percent&#039;];
        $coverage_bar_width = min(100, $query_coverage);
        
        // Color based on coverage percentage
        if ($query_coverage &gt;= 80) {
            $coverage_color = &#039;#28a745&#039;; // Green - excellent coverage
        } elseif ($query_coverage &gt;= 50) {
            $coverage_color = &#039;#ffc107&#039;; // Yellow - good coverage
        } elseif ($query_coverage &gt;= 30) {
            $coverage_color = &#039;#fd7e14&#039;; // Orange - moderate coverage
        } else {
            $coverage_color = &#039;#dc3545&#039;; // Red - low coverage
        }
        
        $html .= &#039;&lt;tr style=&quot;cursor: pointer;&quot; onclick=&quot;const elem = document.getElementById(\&#039;query-&#039; . $query_num . &#039;-hit-&#039; . $hit_num . &#039;\&#039;); elem.scrollIntoView({behavior: \&#039;smooth\&#039;, block: \&#039;start\&#039;}); highlightHitElement(elem);&quot;&gt;&#039;;
        $html .= &#039;&lt;td&gt;&lt;strong&gt;&#039; . $hit_num . &#039;&lt;/strong&gt;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;td&gt;&lt;small&gt;&#039; . htmlspecialchars(substr($hit[&#039;subject&#039;], 0, 60)) . &#039;&lt;/small&gt;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;td&gt;&#039;;
        $html .= &#039;&lt;div class=&quot;blast-coverage-bar&quot; style=&quot;width: 100%; background: #e9ecef; border-radius: 4px; overflow: hidden;&quot;&gt;&#039;;
        $html .= &#039;&lt;div style=&quot;width: &#039; . $coverage_bar_width . &#039;%; background: &#039; . $coverage_color . &#039;; height: 20px; display: flex; align-items: center; justify-content: center;&quot;&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;font-weight: bold; color: white;&quot;&gt;&#039; . $query_coverage . &#039;%&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
        $html .= &#039;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;td&gt;&lt;small&gt;&#039; . $evalue_display . &#039;&lt;/small&gt;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;td&gt;&#039; . $hit[&#039;num_hsps&#039;] . &#039;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;/tr&gt;&#039;;
    }
    
    $html .= &#039;&lt;/tbody&gt;&#039;;
    $html .= &#039;&lt;/table&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    return $html;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateBlastGraphicalView">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateBlastGraphicalView()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 352</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: generateBlastGraphicalView()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate BLAST graphical results using SVG
* Displays hits/HSPs as colored rectangles with score-based coloring
* Similar to canvas graph but with better styling and E-value display
*
* @param array $results Parsed BLAST results
* @return string SVG HTML
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function generateBlastGraphicalView($results) {
    if ($results[&#039;query_length&#039;] &lt;= 0 || empty($results[&#039;hits&#039;])) {
        return &#039;&#039;;
    }
    
    $query_len = $results[&#039;query_length&#039;];
    $canvas_width = 1000;
    $canvas_height_per_row = 25;
    $total_rows = 0;
    
    // Count total rows (one row per HSP) - limit to top 2 HSPs per hit
    foreach ($results[&#039;hits&#039;] as $hit) {
        $total_rows += min(2, count($hit[&#039;hsps&#039;]));
    }
    
    $canvas_height = 120 + ($total_rows * $canvas_height_per_row) + 40;
    $img_width = 850;
    $xscale = $img_width / $query_len;
    $top_margin = 100;
    $left_margin = 200;
    $right_margin = 100;
    
    // Determine tick distance based on query length
    $tick_dist = 100;
    if ($query_len &gt; 2450) $tick_dist = 150;
    if ($query_len &gt; 3900) $tick_dist = 200;
    if ($query_len &gt; 5000) $tick_dist = 300;
    if ($query_len &gt; 7500) $tick_dist = round($query_len / 5);
    
    $html = &#039;&lt;div style=&quot;margin: 20px 0; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; background: white;&quot;&gt;&#039;;
    $html .= &#039;&lt;svg width=&quot;&#039; . ($canvas_width + $left_margin + $right_margin) . &#039;&quot; height=&quot;&#039; . $canvas_height . &#039;&quot; style=&quot;font-family: Arial, sans-serif;&quot;&gt;&#039;;
    
    // Background
    $html .= &#039;&lt;rect width=&quot;&#039; . ($canvas_width + $left_margin + $right_margin) . &#039;&quot; height=&quot;&#039; . $canvas_height . &#039;&quot; fill=&quot;#f9f9f9&quot;/&gt;&#039;;
    
    // Title
    $html .= &#039;&lt;text x=&quot;&#039; . ($left_margin + ($img_width / 2)) . &#039;&quot; y=&quot;30&quot; font-size=&quot;18&quot; font-weight=&quot;bold&quot; text-anchor=&quot;middle&quot; fill=&quot;#333&quot;&gt;Query Length (&#039; . $query_len . &#039; bp)&lt;/text&gt;&#039;;
    
    // Score legend
    $legend_y = 50;
    $legend_items = [
        [&#039;label&#039; =&gt; &#039;&lt;40&#039;, &#039;color&#039; =&gt; &#039;#000000&#039;, &#039;range&#039; =&gt; &#039;&lt;40&#039;],
        [&#039;label&#039; =&gt; &#039;40-50&#039;, &#039;color&#039; =&gt; &#039;#0047c8&#039;, &#039;range&#039; =&gt; &#039;40-50&#039;],
        [&#039;label&#039; =&gt; &#039;50-80&#039;, &#039;color&#039; =&gt; &#039;#77de75&#039;, &#039;range&#039; =&gt; &#039;50-80&#039;],
        [&#039;label&#039; =&gt; &#039;80-200&#039;, &#039;color&#039; =&gt; &#039;#e967f5&#039;, &#039;range&#039; =&gt; &#039;80-200&#039;],
        [&#039;label&#039; =&gt; &#039;‚â•200&#039;, &#039;color&#039; =&gt; &#039;#e83a2d&#039;, &#039;range&#039; =&gt; &#039;200+&#039;]
    ];
    
    $legend_x = $left_margin;
    $legend_width = $img_width / count($legend_items);
    foreach ($legend_items as $item) {
        $html .= &#039;&lt;rect x=&quot;&#039; . $legend_x . &#039;&quot; y=&quot;&#039; . $legend_y . &#039;&quot; width=&quot;&#039; . $legend_width . &#039;&quot; height=&quot;20&quot; fill=&quot;&#039; . $item[&#039;color&#039;] . &#039;&quot;/&gt;&#039;;
        $html .= &#039;&lt;text x=&quot;&#039; . ($legend_x + ($legend_width / 2)) . &#039;&quot; y=&quot;&#039; . ($legend_y + 15) . &#039;&quot; font-size=&quot;11&quot; font-weight=&quot;bold&quot; text-anchor=&quot;middle&quot; fill=&quot;white&quot;&gt;&#039; . $item[&#039;label&#039;] . &#039;&lt;/text&gt;&#039;;
        $legend_x += $legend_width;
    }
    
    // Horizontal line under legend
    $html .= &#039;&lt;line x1=&quot;&#039; . $left_margin . &#039;&quot; y1=&quot;&#039; . ($legend_y + 25) . &#039;&quot; x2=&quot;&#039; . ($left_margin + $img_width) . &#039;&quot; y2=&quot;&#039; . ($legend_y + 25) . &#039;&quot; stroke=&quot;#333&quot; stroke-width=&quot;2&quot;/&gt;&#039;;
    
    // Tick marks and labels
    $vline_tag = $tick_dist;
    for ($l = $tick_dist; $l + ($tick_dist / 2) &lt; $query_len; $l += $tick_dist) {
        $x = $left_margin + ($l * $xscale);
        // Vertical line
        $html .= &#039;&lt;line x1=&quot;&#039; . $x . &#039;&quot; y1=&quot;&#039; . ($legend_y + 25) . &#039;&quot; x2=&quot;&#039; . $x . &#039;&quot; y2=&quot;&#039; . $canvas_height . &#039;&quot; stroke=&quot;#ccc&quot; stroke-width=&quot;1&quot;/&gt;&#039;;
        // Tick label
        $html .= &#039;&lt;text x=&quot;&#039; . $x . &#039;&quot; y=&quot;&#039; . ($legend_y + 45) . &#039;&quot; font-size=&quot;12&quot; text-anchor=&quot;middle&quot; fill=&quot;#333&quot;&gt;&#039; . $vline_tag . &#039;&lt;/text&gt;&#039;;
        $vline_tag += $tick_dist;
    }
    
    // E-value column header
    $html .= &#039;&lt;text x=&quot;&#039; . ($left_margin + $img_width + 15) . &#039;&quot; y=&quot;&#039; . ($legend_y + 45) . &#039;&quot; font-size=&quot;12&quot; font-weight=&quot;bold&quot; fill=&quot;#333&quot;&gt;E-value&lt;/text&gt;&#039;;
    
    // Draw hits/HSPs
    $current_y = $top_margin;
    $prev_subject = &#039;&#039;;
    
    foreach ($results[&#039;hits&#039;] as $hit_idx =&gt; $hit) {
        $subject_name = substr($hit[&#039;subject&#039;], 0, 40);
        $is_new_subject = ($prev_subject !== $hit[&#039;subject&#039;]);
        
        if ($is_new_subject &amp;&amp; $prev_subject !== &#039;&#039;) {
            $current_y += 5; // Add spacing between different subjects
        }
        
        // Subject name (only once per hit)
        if ($is_new_subject) {
            $html .= &#039;&lt;text x=&quot;5&quot; y=&quot;&#039; . ($current_y + 15) . &#039;&quot; font-size=&quot;11&quot; font-weight=&quot;bold&quot; fill=&quot;#333&quot;&gt;&#039; . htmlspecialchars($subject_name) . &#039;&lt;/text&gt;&#039;;
        }
        
        // HSPs for this hit - limit to top 2
        foreach ($hit[&#039;hsps&#039;] as $hsp_idx =&gt; $hsp) {
            if ($hsp_idx &gt;= 2) break; // Only show top 2 HSPs
            
            $start_pos = $hsp[&#039;query_from&#039;];
            $end_pos = $hsp[&#039;query_to&#039;];
            $score = $hsp[&#039;bit_score&#039;];
            
            // Determine color based on bit score
            if ($score &gt;= 200) {
                $fill_color = &#039;rgba(255, 50, 40, 0.8)&#039;;
            } elseif ($score &gt;= 80) {
                $fill_color = &#039;rgba(235,96,247, 0.8)&#039;;
            } elseif ($score &gt;= 50) {
                $fill_color = &#039;rgba(119,222,117, 0.8)&#039;;
            } elseif ($score &gt;= 40) {
                $fill_color = &#039;rgba(0,62,203, 0.8)&#039;;
            } else {
                $fill_color = &#039;rgba(10,10,10, 0.8)&#039;;
            }
            
            $rect_x = $left_margin + ($start_pos * $xscale);
            $rect_width = (($end_pos - $start_pos + 1) * $xscale);
            
            // Convert rgba to hex for SVG
            if ($score &gt;= 200) {
                $fill_hex = &#039;#ff3228&#039;;
            } elseif ($score &gt;= 80) {
                $fill_hex = &#039;#eb60f7&#039;;
            } elseif ($score &gt;= 50) {
                $fill_hex = &#039;#77de75&#039;;
            } elseif ($score &gt;= 40) {
                $fill_hex = &#039;#003ecb&#039;;
            } else {
                $fill_hex = &#039;#0a0a0a&#039;;
            }
            
            // HSP rectangle - clickable
            $html .= &#039;&lt;g onclick=&quot;document.getElementById(\&#039;hit-&#039; . ($hit_idx + 1) . &#039;\&#039;).scrollIntoView({behavior: \&#039;smooth\&#039;, block: \&#039;start\&#039;})&quot; style=&quot;cursor: pointer;&quot;&gt;&#039;;
            $html .= &#039;&lt;title&gt;Hit &#039; . ($hit_idx + 1) . &#039; HSP &#039; . ($hsp_idx + 1) . &#039;: &#039; . round($hsp[&#039;percent_identity&#039;], 1) . &#039;% identity | E-value: &#039; . sprintf(&#039;%.2e&#039;, $hsp[&#039;evalue&#039;]) . &#039;&lt;/title&gt;&#039;;
            $html .= &#039;&lt;rect x=&quot;&#039; . $rect_x . &#039;&quot; y=&quot;&#039; . ($current_y) . &#039;&quot; width=&quot;&#039; . $rect_width . &#039;&quot; height=&quot;16&quot; fill=&quot;&#039; . $fill_hex . &#039;&quot; stroke=&quot;#333&quot; stroke-width=&quot;0.5&quot; rx=&quot;2&quot;/&gt;&#039;;
            $html .= &#039;&lt;/g&gt;&#039;;
            
            // E-value on the right
            $evalue_display = sprintf(&#039;%.2e&#039;, $hsp[&#039;evalue&#039;]);
            $html .= &#039;&lt;text x=&quot;&#039; . ($left_margin + $img_width + 15) . &#039;&quot; y=&quot;&#039; . ($current_y + 12) . &#039;&quot; font-size=&quot;10&quot; fill=&quot;#333&quot;&gt;&#039; . $evalue_display . &#039;&lt;/text&gt;&#039;;
            
            $current_y += $canvas_height_per_row;
        }
        
        $prev_subject = $hit[&#039;subject&#039;];
    }
    
    $html .= &#039;&lt;/svg&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Add legend explaining the colors
    $html .= &#039;&lt;div style=&quot;margin: 15px 0; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px;&quot;&gt;&#039;;
    $html .= &#039;&lt;strong style=&quot;display: block; margin-bottom: 10px;&quot;&gt;&lt;i class=&quot;fa fa-info-circle&quot;&gt;&lt;/i&gt; Legend - Bit Score Color Coding:&lt;/strong&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;&quot;&gt;&#039;;
    
    $legend_items = [
        [&#039;color&#039; =&gt; &#039;#0a0a0a&#039;, &#039;label&#039; =&gt; &#039;&lt; 40&#039;, &#039;desc&#039; =&gt; &#039;Weak alignment&#039;],
        [&#039;color&#039; =&gt; &#039;#003ecb&#039;, &#039;label&#039; =&gt; &#039;40 - 50&#039;, &#039;desc&#039; =&gt; &#039;Moderate alignment&#039;],
        [&#039;color&#039; =&gt; &#039;#77de75&#039;, &#039;label&#039; =&gt; &#039;50 - 80&#039;, &#039;desc&#039; =&gt; &#039;Good alignment&#039;],
        [&#039;color&#039; =&gt; &#039;#eb60f7&#039;, &#039;label&#039; =&gt; &#039;80 - 200&#039;, &#039;desc&#039; =&gt; &#039;Very good alignment&#039;],
        [&#039;color&#039; =&gt; &#039;#ff3228&#039;, &#039;label&#039; =&gt; &#039;‚â• 200&#039;, &#039;desc&#039; =&gt; &#039;Excellent alignment&#039;]
    ];
    
    foreach ($legend_items as $item) {
        $html .= &#039;&lt;div style=&quot;display: flex; align-items: center;&quot;&gt;&#039;;
        $html .= &#039;&lt;div style=&quot;width: 24px; height: 24px; background: &#039; . $item[&#039;color&#039;] . &#039;; border-radius: 3px; margin-right: 10px;&quot;&gt;&lt;/div&gt;&#039;;
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;strong&gt;&#039; . $item[&#039;label&#039;] . &#039;&lt;/strong&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666;&quot;&gt;&#039; . $item[&#039;desc&#039;] . &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    $html .= &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    return $html;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateAlignmentViewer">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateAlignmentViewer()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 533</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: generateAlignmentViewer()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate alignment viewer section
* Displays alignments organized by Hit, with multiple HSPs per Hit
*
* @param array $results Parsed BLAST results from parseBlastResults()
* @return string HTML with alignment viewer
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/blast_results_visualizer.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 991</code>: <small>$html .= generateAlignmentViewer($query, $blast_program, $query_num);</small></li>
                                    <li><code>line 991</code>: <small>$html .= generateAlignmentViewer($query, $blast_program, $query_num);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function generateAlignmentViewer($results, $blast_program = &#039;blastn&#039;, $query_num = 1) {
    $html = &#039;&lt;div class=&quot;blast-alignment-viewer mt-4&quot;&gt;&#039;;
    $html .= &#039;&lt;h6&gt;&lt;i class=&quot;fa fa-align-justify&quot;&gt;&lt;/i&gt; Detailed Alignments (HSPs)&lt;/h6&gt;&#039;;
    $html .= &#039;&lt;small class=&quot;text-muted d-block mb-3&quot;&gt;Each Hit section contains one or more High-Scoring Segment Pairs (HSPs)&lt;/small&gt;&#039;;
    
    if (empty($results[&#039;hits&#039;])) {
        $html .= &#039;&lt;div class=&quot;alert alert-info&quot;&gt;&lt;small&gt;No alignments to display&lt;/small&gt;&lt;/div&gt;&#039;;
        return $html . &#039;&lt;/div&gt;&#039;;
    }
    
    // Determine correct unit based on program
    $unit = &#039;bp&#039;;
    if (strpos($blast_program, &#039;blastp&#039;) !== false || strpos($blast_program, &#039;tblastn&#039;) !== false) {
        $unit = &#039;aa&#039;;
    }
    
    $html .= &#039;&lt;div style=&quot;background: #f8f9fa; border-radius: 4px; overflow-x: auto;&quot;&gt;&#039;;
    
    foreach ($results[&#039;hits&#039;] as $hit_idx =&gt; $hit) {
        $hit_num = $hit_idx + 1;
        $evalue_display = sprintf(&#039;%.2e&#039;, $hit[&#039;best_evalue&#039;]);
        
        // Hit header card
        $html .= &#039;&lt;div id=&quot;query-&#039; . $query_num . &#039;-hit-&#039; . $hit_num . &#039;&quot; style=&quot;padding: 15px;  scroll-margin-top: 20px; background: #f0f7ff; margin-bottom: 15px;&quot;&gt;&#039;;
        $html .= &#039;&lt;h5 style=&quot;margin-bottom: 10px; color: #007bff;&quot;&gt;&#039;;
        $html .= &#039;&lt;strong&gt;Hit &#039; . $hit_num . &#039;: &#039; . htmlspecialchars($hit[&#039;subject&#039;]) . &#039;&lt;/strong&gt;&#039;;
        $html .= &#039;&lt;/h5&gt;&#039;;
        $html .= &#039;&lt;small class=&quot;d-block&quot; style=&quot;margin-bottom: 10px;&quot;&gt;&#039;;
        $html .= &#039;&lt;strong&gt;Hit ID:&lt;/strong&gt; &#039; . htmlspecialchars($hit[&#039;id&#039;]) . &#039; | &#039;;
        $html .= &#039;&lt;strong&gt;Length:&lt;/strong&gt; &#039; . $hit[&#039;length&#039;] . &#039; &#039; . $unit . &#039; | &#039;;
        $html .= &#039;&lt;strong&gt;Best E-value:&lt;/strong&gt; &#039; . $evalue_display . &#039; | &#039;;
        $html .= &#039;&lt;strong&gt;Number of HSPs:&lt;/strong&gt; &#039; . $hit[&#039;num_hsps&#039;] . &#039; | &#039;;
        $html .= &#039;&lt;strong&gt;Query Coverage:&lt;/strong&gt; &#039; . $hit[&#039;query_coverage_percent&#039;] . &#039;% | &#039;;
        $html .= &#039;&lt;strong&gt;Subject Coverage:&lt;/strong&gt; &#039; . $hit[&#039;subject_cumulative_coverage_percent&#039;] . &#039;%&#039;;
        $html .= &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
        
        // HSPs for this hit
        foreach ($hit[&#039;hsps&#039;] as $hsp_idx =&gt; $hsp) {
            $hsp_num = $hsp_idx + 1;
            
            $html .= &#039;&lt;div style=&quot;padding: 15px; border-bottom: 1px solid #dee2e6; margin-left: 15px; background: #ffffff; margin-bottom: 10px; border-left: 4px solid #28a745;&quot;&gt;&#039;;
            $html .= &#039;&lt;h6 style=&quot;margin-bottom: 10px;&quot;&gt;&lt;strong&gt;HSP &#039; . $hsp_num . &#039;&lt;/strong&gt;&lt;/h6&gt;&#039;;
            $html .= &#039;&lt;small class=&quot;text-muted d-block&quot; style=&quot;margin-bottom: 10px;&quot;&gt;&#039;;
            $html .= &#039;E-value: &#039; . sprintf(&#039;%.2e&#039;, $hsp[&#039;evalue&#039;]) . &#039; | &#039;;
            $html .= &#039;Alignment length: &#039; . $hsp[&#039;alignment_length&#039;] . &#039; | &#039;;
            $html .= &#039;Identity: &#039; . $hsp[&#039;identities&#039;] . &#039;/&#039; . $hsp[&#039;alignment_length&#039;] . &#039; (&#039; . $hsp[&#039;percent_identity&#039;] . &#039;%) | &#039;;
            $html .= &#039;Similarities: &#039; . $hsp[&#039;similarities&#039;] . &#039; | &#039;;
            $html .= &#039;Gaps: &#039; . $hsp[&#039;gaps&#039;];
            if ($hsp[&#039;gaps&#039;] &gt; 0) {
                $html .= &#039; (lengths: &#039; . $hsp[&#039;gap_lengths_str&#039;] . &#039;, total: &#039; . $hsp[&#039;total_gap_length&#039;] . &#039;)&#039;;
            }
            $html .= &#039;&lt;/small&gt;&#039;;
            
            // Query coverage information for this HSP
            $query_hsp_coverage = $results[&#039;query_length&#039;] &gt; 0 ? round((($hsp[&#039;query_to&#039;] - $hsp[&#039;query_from&#039;] + 1) / $results[&#039;query_length&#039;]) * 100, 2) : 0;
            $html .= &#039;&lt;small class=&quot;d-block&quot; style=&quot;margin-bottom: 10px; background: #e7f3ff; padding: 8px; border-radius: 3px; border-left: 3px solid #007bff;&quot;&gt;&#039;;
            $html .= &#039;&lt;strong&gt;Query Coverage (This HSP):&lt;/strong&gt; &#039;;
            $html .= $query_hsp_coverage . &#039;% (&#039; . ($hsp[&#039;query_to&#039;] - $hsp[&#039;query_from&#039;] + 1) . &#039;/&#039; . $results[&#039;query_length&#039;] . &#039;) | &#039;;
            $html .= &#039;&lt;strong&gt;Subject Coverage (This HSP):&lt;/strong&gt; &#039;;
            $html .= $hsp[&#039;subject_coverage_percent&#039;] . &#039;% (&#039; . abs($hsp[&#039;hit_to&#039;] - $hsp[&#039;hit_from&#039;]) + 1 . &#039;/&#039; . $results[&#039;hits&#039;][$hit_idx][&#039;length&#039;] . &#039;)&#039;;
            $html .= &#039;&lt;/small&gt;&#039;;
            
            // Display alignment in monospace with frame-aware formatting
            $html .= &#039;&lt;pre style=&quot;background: white; border: 1px solid #dee2e6; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 11px; margin: 0; font-family: \&#039;Courier New\&#039;, monospace;&quot;&gt;&#039;;
            
            // Use frame-aware alignment formatter if frames are available
            if (isset($hsp[&#039;query_frame&#039;]) || isset($hsp[&#039;hit_frame&#039;])) {
                $query_frame = isset($hsp[&#039;query_frame&#039;]) ? (int)$hsp[&#039;query_frame&#039;] : 0;
                $hit_frame = isset($hsp[&#039;hit_frame&#039;]) ? (int)$hsp[&#039;hit_frame&#039;] : 0;
                $alignment_text = formatBlastAlignment(
                    $hsp[&#039;alignment_length&#039;],
                    $hsp[&#039;query_seq&#039;],
                    $hsp[&#039;query_from&#039;],
                    $hsp[&#039;query_to&#039;],
                    $hsp[&#039;midline&#039;],
                    $hsp[&#039;hit_seq&#039;],
                    $hsp[&#039;hit_from&#039;],
                    $hsp[&#039;hit_to&#039;],
                    &#039;Plus&#039;,
                    $query_frame,
                    $hit_frame
                );
                $html .= htmlspecialchars($alignment_text);
            } else {
                // Fallback to simple formatting
                $label_width = 15;
                $query_label = str_pad(&#039;Query  &#039; . $hsp[&#039;query_from&#039;], $label_width);
                $midline_label = str_pad(&#039;&#039;, $label_width);
                $sbjct_label = str_pad(&#039;Sbjct  &#039; . $hsp[&#039;hit_from&#039;], $label_width);
                
                $html .= $query_label . htmlspecialchars($hsp[&#039;query_seq&#039;]) . &#039; &#039; . $hsp[&#039;query_to&#039;] . &quot;\n&quot;;
                $html .= $midline_label . htmlspecialchars($hsp[&#039;midline&#039;]) . &quot;\n&quot;;
                $html .= $sbjct_label . htmlspecialchars($hsp[&#039;hit_seq&#039;]) . &#039; &#039; . $hsp[&#039;hit_to&#039;] . &quot;\n&quot;;
            }
            
            $html .= &#039;&lt;/pre&gt;&#039;;
            
            $html .= &#039;&lt;/div&gt;&#039;;
        }
    }
    
    $html .= &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    return $html;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateBlastStatisticsSummary">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateBlastStatisticsSummary()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 650</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: generateBlastStatisticsSummary()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate BLAST results statistics summary
* Pretty card showing overall results statistics
*
* @param array $results Parsed BLAST results
* @param string $query_seq Query sequence
* @param string $blast_program BLAST program name
* @return string HTML statistics card
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function generateBlastStatisticsSummary($results, $query_seq, $blast_program) {
    if ($results[&#039;total_hits&#039;] === 0) {
        return &#039;&#039;;
    }
    
    $html = &#039;&lt;div style=&quot;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);&quot;&gt;&#039;;
    
    // Title
    $html .= &#039;&lt;h4 style=&quot;margin: 0 0 20px 0; font-weight: bold;&quot;&gt;&lt;i class=&quot;fa fa-chart-bar&quot;&gt;&lt;/i&gt; BLAST Search Statistics&lt;/h4&gt;&#039;;
    
    // Statistics grid
    $html .= &#039;&lt;div style=&quot;display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;&quot;&gt;&#039;;
    
    // Query info
    $html .= &#039;&lt;div style=&quot;background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; border-left: 4px solid #4fc3f7;&quot;&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 12px; opacity: 0.9; margin-bottom: 5px;&quot;&gt;Query&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 24px; font-weight: bold;&quot;&gt;&#039; . strlen($query_seq) . &#039; bp&lt;/div&gt;&#039;;
    if (!empty($results[&#039;query_name&#039;])) {
        $html .= &#039;&lt;div style=&quot;font-size: 11px; opacity: 0.8; margin-top: 5px;&quot;&gt;&#039; . htmlspecialchars(substr($results[&#039;query_name&#039;], 0, 30)) . &#039;&lt;/div&gt;&#039;;
    }
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Hits found
    $html .= &#039;&lt;div style=&quot;background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; border-left: 4px solid #81c784;&quot;&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 12px; opacity: 0.9; margin-bottom: 5px;&quot;&gt;Hits Found&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 24px; font-weight: bold;&quot;&gt;&#039; . $results[&#039;total_hits&#039;] . &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 11px; opacity: 0.8; margin-top: 5px;&quot;&gt;Subject sequences&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Best hit info
    $best_hit = $results[&#039;hits&#039;][0];
    $best_hsp = $best_hit[&#039;hsps&#039;][0];
    $html .= &#039;&lt;div style=&quot;background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; border-left: 4px solid #ffa726;&quot;&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 12px; opacity: 0.9; margin-bottom: 5px;&quot;&gt;Best E-value&lt;/div&gt;&#039;;
    $evalue_display = sprintf(&#039;%.2e&#039;, $best_hit[&#039;best_evalue&#039;]);
    $html .= &#039;&lt;div style=&quot;font-size: 24px; font-weight: bold;&quot;&gt;&#039; . $evalue_display . &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 11px; opacity: 0.8; margin-top: 5px;&quot;&gt;Top hit&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Best identity
    $html .= &#039;&lt;div style=&quot;background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; border-left: 4px solid #ef5350;&quot;&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 12px; opacity: 0.9; margin-bottom: 5px;&quot;&gt;Best Identity&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 24px; font-weight: bold;&quot;&gt;&#039; . $best_hsp[&#039;percent_identity&#039;] . &#039;%&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 11px; opacity: 0.8; margin-top: 5px;&quot;&gt;&#039; . $best_hsp[&#039;identities&#039;] . &#039;/&#039; . $best_hsp[&#039;alignment_length&#039;] . &#039; bp/aa&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Total HSPs
    $total_hsps = 0;
    foreach ($results[&#039;hits&#039;] as $hit) {
        $total_hsps += $hit[&#039;num_hsps&#039;];
    }
    $html .= &#039;&lt;div style=&quot;background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; border-left: 4px solid #ab47bc;&quot;&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 12px; opacity: 0.9; margin-bottom: 5px;&quot;&gt;Total HSPs&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 24px; font-weight: bold;&quot;&gt;&#039; . $total_hsps . &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 11px; opacity: 0.8; margin-top: 5px;&quot;&gt;Alignments&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Program
    $html .= &#039;&lt;div style=&quot;background: rgba(255,255,255,0.15); padding: 15px; border-radius: 6px; border-left: 4px solid #29b6f6;&quot;&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 12px; opacity: 0.9; margin-bottom: 5px;&quot;&gt;Program&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 18px; font-weight: bold;&quot;&gt;&#039; . strtoupper(htmlspecialchars($blast_program)) . &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;font-size: 11px; opacity: 0.8; margin-top: 5px;&quot;&gt;Sequence search&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;/div&gt;&#039;; // End grid
    
    $html .= &#039;&lt;/div&gt;&#039;; // End container
    
    return $html;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateCompleteBlastVisualization">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateCompleteBlastVisualization()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 730</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: generateCompleteBlastVisualization()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate complete BLAST results visualization
* Combines all visualization components
*
* @param array $blast_result Result from executeBlastSearch()
* @param string $query_seq The query sequence
* @param string $blast_program The BLAST program used
* @return string Complete HTML visualization
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/blast.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 572</code>: <small>&lt;?= generateCompleteBlastVisualization($blast_result, $search_query, $blast_prog</small></li>
                                    <li><code>line 572</code>: <small>&lt;?= generateCompleteBlastVisualization($blast_result, $search_query, $blast_prog</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function generateCompleteBlastVisualization($blast_result, $query_seq, $blast_program, $blast_options = []) {
    if (!$blast_result[&#039;success&#039;]) {
        return &#039;&lt;div class=&quot;alert alert-danger&quot;&gt;&lt;i class=&quot;fa fa-exclamation-circle&quot;&gt;&lt;/i&gt; No results to visualize&lt;/div&gt;&#039;;
    }
    
    $parse_result = parseBlastResults($blast_result[&#039;output&#039;]);
    
    // Check for parsing errors
    if (!empty($parse_result[&#039;error&#039;])) {
        return &#039;&lt;div class=&quot;alert alert-danger&quot;&gt;&lt;i class=&quot;fa fa-exclamation-circle&quot;&gt;&lt;/i&gt; Error parsing results: &#039; . htmlspecialchars($parse_result[&#039;error&#039;]) . &#039;&lt;/div&gt;&#039;;
    }
    
    $queries = $parse_result[&#039;queries&#039;] ?? [];
    if (empty($queries)) {
        return &#039;&lt;div class=&quot;alert alert-info&quot;&gt;&lt;i class=&quot;fa fa-info-circle&quot;&gt;&lt;/i&gt; No queries found in results&lt;/div&gt;&#039;;
    }
    
    $html = &#039;&lt;div class=&quot;blast-visualization&quot;&gt;&#039;;
    
    // Determine correct unit based on program
    $unit = &#039;bp&#039;;
    if (strpos($blast_program, &#039;blastp&#039;) !== false || strpos($blast_program, &#039;tblastn&#039;) !== false) {
        $unit = &#039;aa&#039;;
    }
    
    // Search Parameters Section (moved up, collapsible)
    $html .= &#039;&lt;div style=&quot;background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 20px;&quot;&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;padding: 15px; cursor: pointer; background: #f8f9fa; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;&quot; onclick=&quot;document.getElementById(\&#039;search-params\&#039;).style.display = document.getElementById(\&#039;search-params\&#039;).style.display === \&#039;none\&#039; ? \&#039;block\&#039; : \&#039;none\&#039;; this.querySelector(\&#039;i\&#039;).style.transform = document.getElementById(\&#039;search-params\&#039;).style.display === \&#039;none\&#039; ? \&#039;rotate(0deg)\&#039; : \&#039;rotate(180deg)\&#039;;&quot;&gt;&#039;;
    $html .= &#039;&lt;h6 style=&quot;margin: 0; color: #333;&quot;&gt;&lt;i class=&quot;fa fa-cog&quot;&gt;&lt;/i&gt; Search Parameters&lt;/h6&gt;&#039;;
    $html .= &#039;&lt;i class=&quot;fa fa-chevron-down&quot; style=&quot;transition: transform 0.2s; transform: rotate(0deg);&quot;&gt;&lt;/i&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;div id=&quot;search-params&quot; style=&quot;display: none; padding: 15px;&quot;&gt;&#039;;
    
    // Original search parameters - first grid
    $html .= &#039;&lt;div style=&quot;display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 15px;&quot;&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Database&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;protein.aa.fa&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Posted Date&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;Nov 12, 2025 10:40 PM&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Database Size&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;21,106,416 letters | 54,384 sequences&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Program&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;&#039; . strtoupper(htmlspecialchars($blast_program)) . &#039;&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Original search parameters - second grid
    $html .= &#039;&lt;div style=&quot;display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;&quot;&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Matrix&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;BLOSUM62&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Gap Penalties&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;Existence: 11, Extension: 1&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Window for Multiple Hits&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;40&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Threshold&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;11&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // New search parameters from form - third grid
    $html .= &#039;&lt;hr style=&quot;margin: 15px 0;&quot;&gt;&#039;;
    $html .= &#039;&lt;h6 style=&quot;color: #333; margin-bottom: 15px;&quot;&gt;&lt;i class=&quot;fa fa-sliders-h&quot;&gt;&lt;/i&gt; Form Parameters&lt;/h6&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;&quot;&gt;&#039;;
    
    // Basic parameters
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;E-value Threshold&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;evalue&#039;] ?? &#039;1e-3&#039;) . &#039;&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Maximum Hits&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;&#039; . ($blast_options[&#039;max_hits&#039;] ?? 10) . &#039;&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    $html .= &#039;&lt;div&gt;&#039;;
    $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Scoring Matrix&lt;/small&gt;&lt;br&gt;&#039;;
    $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;matrix&#039;] ?? &#039;BLOSUM62&#039;) . &#039;&lt;/small&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Advanced parameters
    if (!empty($blast_options[&#039;word_size&#039;])) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Word Size&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;word_size&#039;]) . &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if (!empty($blast_options[&#039;gapopen&#039;])) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Gap Open Penalty&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;gapopen&#039;]) . &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if (!empty($blast_options[&#039;gapextend&#039;])) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Gap Extend Penalty&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;gapextend&#039;]) . &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if (!empty($blast_options[&#039;max_hsps&#039;])) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Max HSPs&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;max_hsps&#039;]) . &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if (!empty($blast_options[&#039;perc_identity&#039;])) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Percent Identity&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;perc_identity&#039;]) . &#039;%&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if (!empty($blast_options[&#039;culling_limit&#039;])) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Culling Limit&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;culling_limit&#039;]) . &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if (!empty($blast_options[&#039;threshold&#039;])) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Threshold&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;threshold&#039;]) . &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if (!empty($blast_options[&#039;strand&#039;])) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Strand&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&#039; . htmlspecialchars($blast_options[&#039;strand&#039;]) . &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if ($blast_options[&#039;soft_masking&#039;] ?? false) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Soft Masking&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&lt;i class=&quot;fa fa-check&quot; style=&quot;color: green;&quot;&gt;&lt;/i&gt; Enabled&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if ($blast_options[&#039;filter&#039;] ?? false) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Filter Low Complexity&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&lt;i class=&quot;fa fa-check&quot; style=&quot;color: green;&quot;&gt;&lt;/i&gt; Enabled&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    if ($blast_options[&#039;ungapped&#039;] ?? false) {
        $html .= &#039;&lt;div&gt;&#039;;
        $html .= &#039;&lt;small style=&quot;color: #666; font-weight: bold;&quot;&gt;Ungapped&lt;/small&gt;&lt;br&gt;&#039;;
        $html .= &#039;&lt;small&gt;&lt;i class=&quot;fa fa-check&quot; style=&quot;color: green;&quot;&gt;&lt;/i&gt; Enabled&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    $html .= &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Query Summary Table - all queries with links to their sections
    $html .= &#039;&lt;div style=&quot;background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 20px;&quot;&gt;&#039;;
    $html .= &#039;&lt;h6 style=&quot;margin-bottom: 15px;&quot;&gt;&lt;i class=&quot;fa fa-list&quot;&gt;&lt;/i&gt; Query Summary&lt;/h6&gt;&#039;;
    $html .= &#039;&lt;div style=&quot;overflow-x: auto;&quot;&gt;&#039;;
    $html .= &#039;&lt;table class=&quot;table table-sm table-striped&quot;&gt;&#039;;
    $html .= &#039;&lt;thead class=&quot;table-light&quot;&gt;&#039;;
    $html .= &#039;&lt;tr&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 5%&quot;&gt;#&lt;/th&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 35%&quot;&gt;Query Name&lt;/th&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 15%&quot;&gt;Length&lt;/th&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 15%&quot;&gt;Hits&lt;/th&gt;&#039;;
    $html .= &#039;&lt;th style=&quot;width: 30%&quot;&gt;Best E-value&lt;/th&gt;&#039;;
    $html .= &#039;&lt;/tr&gt;&#039;;
    $html .= &#039;&lt;/thead&gt;&#039;;
    $html .= &#039;&lt;tbody&gt;&#039;;
    
    foreach ($queries as $query_idx =&gt; $query) {
        $query_num = $query_idx + 1;
        $query_name = !empty($query[&#039;query_desc&#039;]) ? htmlspecialchars($query[&#039;query_desc&#039;]) : &#039;Query &#039; . $query_num;
        $best_evalue = $query[&#039;total_hits&#039;] &gt; 0 ? $query[&#039;hits&#039;][0][&#039;best_evalue&#039;] : PHP_FLOAT_MAX;
        $best_evalue_display = $best_evalue &lt; PHP_FLOAT_MAX ? sprintf(&#039;%.2e&#039;, $best_evalue) : &#039;N/A&#039;;
        
        $html .= &#039;&lt;tr style=&quot;cursor: pointer;&quot; onclick=&quot;document.getElementById(\&#039;query-&#039; . $query_num . &#039;\&#039;).scrollIntoView({behavior: \&#039;smooth\&#039;, block: \&#039;start\&#039;});&quot;&gt;&#039;;
        $html .= &#039;&lt;td&gt;&lt;strong&gt;&#039; . $query_num . &#039;&lt;/strong&gt;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;td&gt;&lt;small&gt;&#039; . $query_name . &#039;&lt;/small&gt;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;td&gt;&#039; . $query[&#039;query_length&#039;] . &#039; &#039; . $unit . &#039;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;td&gt;&#039; . $query[&#039;total_hits&#039;] . &#039;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;td&gt;&lt;small&gt;&#039; . $best_evalue_display . &#039;&lt;/small&gt;&lt;/td&gt;&#039;;
        $html .= &#039;&lt;/tr&gt;&#039;;
    }
    
    $html .= &#039;&lt;/tbody&gt;&#039;;
    $html .= &#039;&lt;/table&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Individual Query Sections - each query with all its results
    foreach ($queries as $query_idx =&gt; $query) {
        $query_num = $query_idx + 1;
        $query_name = !empty($query[&#039;query_desc&#039;]) ? htmlspecialchars($query[&#039;query_desc&#039;]) : &#039;Query &#039; . $query_num;
        
        // Collapsible query section
        $html .= &#039;&lt;div id=&quot;query-&#039; . $query_num . &#039;&quot; style=&quot;background: white; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 20px; scroll-margin-top: 20px;&quot;&gt;&#039;;
        
        // Query header (collapsible)
        $html .= &#039;&lt;div id=&quot;query-&#039; . $query_num . &#039;-header&quot; style=&quot;padding: 15px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;&quot; onclick=&quot;toggleQuerySection(\&#039;query-&#039; . $query_num . &#039;-content\&#039;, this);&quot;&gt;&#039;;
        $html .= &#039;&lt;h5 style=&quot;margin: 0;&quot;&gt;&lt;i class=&quot;fa fa-dna&quot;&gt;&lt;/i&gt; Query &#039; . $query_num . &#039;: &#039; . $query_name . &#039;&lt;/h5&gt;&#039;;
        $html .= &#039;&lt;i class=&quot;fa fa-chevron-down&quot; style=&quot;transition: transform 0.2s; transform: rotate(0deg);&quot;&gt;&lt;/i&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
        
        // Query content (collapsible)
        $html .= &#039;&lt;div id=&quot;query-&#039; . $query_num . &#039;-content&quot; style=&quot;padding: 15px;&quot;&gt;&#039;;
        
        // Query info
        $html .= &#039;&lt;div style=&quot;background: #f8f9fa; border-left: 4px solid #667eea; padding: 12px; margin-bottom: 15px; border-radius: 4px;&quot;&gt;&#039;;
        $html .= &#039;&lt;small&gt;&#039;;
        if (!empty($query[&#039;query_desc&#039;])) {
            $html .= &#039;&lt;strong&gt;Description:&lt;/strong&gt; &#039; . htmlspecialchars($query[&#039;query_desc&#039;]) . &#039;&lt;br&gt;&#039;;
        }
        $html .= &#039;&lt;strong&gt;Length:&lt;/strong&gt; &#039; . $query[&#039;query_length&#039;] . &#039; &#039; . $unit . &#039; | &#039;;
        $html .= &#039;&lt;strong&gt;Total Hits:&lt;/strong&gt; &#039; . $query[&#039;total_hits&#039;];
        $html .= &#039;&lt;/small&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
        
        if ($query[&#039;total_hits&#039;] === 0) {
            $html .= &#039;&lt;div class=&quot;alert alert-info&quot;&gt;&lt;small&gt;No significant matches found for this query&lt;/small&gt;&lt;/div&gt;&#039;;
        } else {
            // HSP visualization for this query
            $html .= generateHspVisualizationWithLines($query, $blast_program, $query_num);
            
            // Hits summary table for this query
            $html .= generateHitsSummaryTable($query, $query_num);
            
            // Alignment viewer for this query
            $html .= generateAlignmentViewer($query, $blast_program, $query_num);
        }
        
        $html .= &#039;&lt;/div&gt;&#039;; // End query content
        $html .= &#039;&lt;/div&gt;&#039;; // End query section
    }
    
    $html .= &#039;&lt;/div&gt;&#039;;
    
    return $html;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateHspVisualizationWithLines">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateHspVisualizationWithLines()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 985</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: generateHspVisualizationWithLines()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate HSP visualization with connecting lines (ported from locBLAST)
* Displays HSPs as colored segments with lines connecting adjacent HSPs
* Adapted from: https://github.com/cobilab/locBLAST (GPL-3.0)
*
* @param array $results Parsed BLAST results
* @param string $blast_program BLAST program name (blastn, blastp, etc.)
* @return string HTML with HSP visualization
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/blast_results_visualizer.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 985</code>: <small>$html .= generateHspVisualizationWithLines($query, $blast_program, $query_num);</small></li>
                                    <li><code>line 985</code>: <small>$html .= generateHspVisualizationWithLines($query, $blast_program, $query_num);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function generateHspVisualizationWithLines($results, $blast_program = &#039;blastn&#039;, $query_num = 1) {
    if (empty($results[&#039;hits&#039;]) || $results[&#039;query_length&#039;] &lt;= 0) {
        return &#039;&#039;;
    }
    
    // Determine unit based on program
    $unit = &#039;bp&#039;;
    if (strpos($blast_program, &#039;blastp&#039;) !== false || strpos($blast_program, &#039;tblastn&#039;) !== false) {
        $unit = &#039;aa&#039;;
    }
    
    $html = &#039;&lt;div class=&quot;blast-hsp-visualization&quot; style=&quot;margin: 20px 0; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px;&quot;&gt;&#039;;
    $html .= &#039;&lt;h6 style=&quot;text-align: center;&quot;&gt;&lt;i class=&quot;fa fa-ruler-horizontal&quot;&gt;&lt;/i&gt; Query Length (&#039; . $results[&#039;query_length&#039;] . &#039; &#039; . $unit . &#039;)&lt;/h6&gt;&#039;;
    
    // Add CSS for HSP visualization
    $html .= &#039;&lt;style&gt;&#039;;
    $html .= &#039;.hsp-row { display: flex; align-items: center; margin-bottom: 12px; }&#039;;
    $html .= &#039;.hsp-label { min-width: 100px; padding-right: 15px; font-size: 11px; font-weight: bold; word-break: break-all; }&#039;;
    $html .= &#039;.hsp-segments { display: flex; align-items: center; width: 800px; position: relative; z-index: 5; }&#039;;
    $html .= &#039;.hsp-segment { height: 16px; display: inline-block; margin-right: 0; cursor: pointer; border: 1px solid #333; transition: opacity 0.2s; }&#039;;
    $html .= &#039;.hsp-segment:hover { opacity: 0.8; }&#039;;
    $html .= &#039;.hsp-gap { height: 4px; background: #e0e0e0; display: inline-block; margin-top: 6px; }&#039;;
    $html .= &#039;.hsp-connector { width: 1px; height: 6px; background: #000; display: inline-block; margin: 5px 0; }&#039;;
    $html .= &#039;.color-black { background-color: #000000; }&#039;;
    $html .= &#039;.color-blue { background-color: #0047c8; }&#039;;
    $html .= &#039;.color-green { background-color: #77de75; }&#039;;
    $html .= &#039;.color-purple { background-color: #e967f5; }&#039;;
    $html .= &#039;.color-red { background-color: #e83a2d; }&#039;;
    $html .= &#039;.hit-highlighted { background-color: #ffffcc !important; transition: background-color 0.3s ease-out; }&#039;;
    $html .= &#039;.hsp-row:hover { background-color: rgba(100, 150, 255, 0.1); }&#039;;
    $html .= &#039;&lt;/style&gt;&#039;;
    
     // Add JavaScript for hit navigation and highlighting
     $html .= &#039;&lt;script&gt;&#039;;
     $html .= &#039;function jumpToHit(hitIndex, queryNum) {&#039;;
     $html .= &#039;  if (queryNum === undefined) queryNum = 1;&#039;;
     $html .= &#039;  const hitId = &quot;query-&quot; + queryNum + &quot;-hit-&quot; + (hitIndex + 1);&#039;;
     $html .= &#039;  const element = document.getElementById(hitId);&#039;;
     $html .= &#039;  if (element) {&#039;;
     $html .= &#039;    element.scrollIntoView({ behavior: &quot;smooth&quot;, block: &quot;start&quot; });&#039;;
     $html .= &#039;    highlightHitElement(element);&#039;;
     $html .= &#039;  }&#039;;
     $html .= &#039;}&#039;;
     $html .= &#039;function highlightHitElement(element) {&#039;;
     $html .= &#039;  if (!element) return;&#039;;
     $html .= &#039;  element.classList.remove(&quot;hit-highlighted&quot;);&#039;;
     $html .= &#039;  void element.offsetWidth;&#039;;
     $html .= &#039;  element.classList.add(&quot;hit-highlighted&quot;);&#039;;
     $html .= &#039;  setTimeout(() =&gt; {&#039;;
     $html .= &#039;    element.classList.remove(&quot;hit-highlighted&quot;);&#039;;
     $html .= &#039;  }, 3500);&#039;;
     $html .= &#039;}&#039;;
     $html .= &#039;function highlightHit(hitIndex, queryNum) {&#039;;
     $html .= &#039;  if (queryNum === undefined) queryNum = 1;&#039;;
     $html .= &#039;  jumpToHit(hitIndex, queryNum);&#039;;
     $html .= &#039;}&#039;;
     $html .= &#039;&lt;/script&gt;&#039;;
    
    $html .= &#039;&lt;div style=&quot;margin-top: 15px; margin: 0 auto; width: 1000px; text-align: center;&quot;&gt;&#039;;

    // Generate just the score legend (outside overflow:hidden)
    $html .= generateQueryScoreLegend($results[&#039;query_length&#039;], $results[&#039;query_name&#039;]);

    // Pixel unit calculation based on query length (800px width)
    $px_unit = 800 / $results[&#039;query_length&#039;];

    // Calculate total HSP rows
    $total_hsp_rows = 0;
    foreach ($results[&#039;hits&#039;] as $hit) {
        $total_hsp_rows += count($hit[&#039;hsps&#039;]) + 1; // +1 for spacing between hits
    }
    
    // Calculate height needed for HSP rows (each row ~25px + spacing)
    $hsp_content_height = ($total_hsp_rows * 25) + 50;
    // Set max height before scrolling (e.g., 400px)
    $max_hsp_height = 400;
    $use_scroll = $hsp_content_height &gt; $max_hsp_height;
    
    // Total container height: ticks (80px) + HSP area (either content height or max height)
    $hsp_display_height = min($hsp_content_height, $max_hsp_height);
    $total_container_height = 80 + $hsp_display_height;

    // Create a container for scale ticks and HSPs with relative positioning
    // This must be tall enough for all tick lines to extend down
    $html .= &#039;&lt;div style=&quot;position: relative; overflow: hidden; height: &#039; . $total_container_height . &#039;px;&quot;&gt;&#039;;
    
    // Generate the query scale ruler with ticks (inside overflow:hidden to be clipped properly)
    $html .= generateQueryScaleTicks($results[&#039;query_length&#039;]);
    
    // Create a scrollable wrapper for HSP rows positioned below the ticks
    $scroll_style = $use_scroll ? &#039;overflow-y: scroll;&#039; : &#039;overflow: hidden;&#039;;
    $html .= &#039;&lt;div style=&quot;position: absolute; top: 80px; left: 0; right: 0; height: &#039; . $hsp_display_height . &#039;px; &#039; . $scroll_style . &#039;&quot;&gt;&#039;;
    
    // Wrapper for HSP rows
    $html .= &#039;&lt;div style=&quot;padding-top: 0;&quot;&gt;&#039;;
    
    foreach ($results[&#039;hits&#039;] as $hit_idx =&gt; $hit) {
        $hit_num = $hit_idx + 1;
        
        // Organize HSPs by their query coordinates
        $hsp_positions = [];
        $hsp_scores = [];
        $hsp_details = [];
        
        foreach ($hit[&#039;hsps&#039;] as $hsp_idx =&gt; $hsp) {
            $q_start = min($hsp[&#039;query_from&#039;], $hsp[&#039;query_to&#039;]);
            $q_end = max($hsp[&#039;query_from&#039;], $hsp[&#039;query_to&#039;]);
            
            $hsp_positions[] = [
                &#039;start&#039; =&gt; $q_start,
                &#039;end&#039; =&gt; $q_end,
                &#039;index&#039; =&gt; $hsp_idx
            ];
            
            $hsp_scores[$hsp_idx] = $hsp[&#039;bit_score&#039;];
            $hsp_details[$hsp_idx] = $hsp;
        }
        
        // Sort by start position
        usort($hsp_positions, function($a, $b) {
            return $a[&#039;start&#039;] - $b[&#039;start&#039;];
        });
        
        // Build HTML row
        $html .= &#039;&lt;div class=&quot;hsp-row&quot; style=&quot;cursor: pointer;&quot; onclick=&quot;jumpToHit(&#039; . $hit_idx . &#039;, &#039; . $query_num . &#039;); highlightHit(&#039; . $hit_idx . &#039;, &#039; . $query_num . &#039;);&quot;&gt;&#039;;
        $html .= &#039;&lt;div class=&quot;hsp-label&quot;&gt;&lt;/div&gt;&#039;;
        $html .= &#039;&lt;div class=&quot;hsp-segments&quot;&gt;&#039;;
        
        // First HSP
        if (!empty($hsp_positions)) {
            $first_hsp = $hsp_positions[0];
            $first_idx = $first_hsp[&#039;index&#039;];
            $color = getHspColorClass($hsp_scores[$first_idx]);
            $segment_width = ($first_hsp[&#039;end&#039;] - $first_hsp[&#039;start&#039;]) * $px_unit;
            
            // Add leading gap if needed
            if ($first_hsp[&#039;start&#039;] &gt; 1) {
                $gap_width = ($first_hsp[&#039;start&#039;] - 1) * $px_unit;
                $html .= &#039;&lt;div class=&quot;hsp-gap&quot; style=&quot;width: &#039; . $gap_width . &#039;px;&quot;&gt;&lt;/div&gt;&#039;;
            }
            
            $hsp = $hsp_details[$first_idx];
            // Extract just the subject name (first word/identifier before space or bracket)
            $hit_name = &#039;Hit &#039; . $hit_num;
            if (!empty($hit[&#039;subject&#039;])) {
                $desc = htmlspecialchars($hit[&#039;subject&#039;]);
                // Extract first word or identifier (up to first space, bracket, or pipe)
                preg_match(&#039;/^([^\s\[\|\-]+)/&#039;, $desc, $matches);
                if (!empty($matches[1])) {
                    $hit_name = $matches[1];
                }
            }
            $title = $hit_name . &#039; - HSP &#039; . ($first_idx + 1) . &#039;: &#039; . $hsp[&#039;percent_identity&#039;] . &#039;% identity | E-value: &#039; . sprintf(&#039;%.2e&#039;, $hsp[&#039;evalue&#039;]);
            $html .= &#039;&lt;div class=&quot;hsp-segment &#039; . $color . &#039;&quot; style=&quot;width: &#039; . $segment_width . &#039;px;&quot; title=&quot;&#039; . htmlspecialchars($title) . &#039;&quot;&gt;&lt;/div&gt;&#039;;
            
            // Additional HSPs with connecting logic
            for ($k = 1; $k &lt; count($hsp_positions); $k++) {
                $current = $hsp_positions[$k];
                $previous = $hsp_positions[$k - 1];
                $current_idx = $current[&#039;index&#039;];
                
                $gap = $current[&#039;start&#039;] - $previous[&#039;end&#039;];
                
                if ($gap &gt; 0) {
                    // Add connector lines for gaps
                    $html .= &#039;&lt;div class=&quot;hsp-connector&quot;&gt;&lt;/div&gt;&#039;;
                    
                    // Add gap
                    $gap_width = $gap * $px_unit;
                    $html .= &#039;&lt;div class=&quot;hsp-gap&quot; style=&quot;width: &#039; . $gap_width . &#039;px;&quot;&gt;&lt;/div&gt;&#039;;
                    
                    // Add connector on other side
                    $html .= &#039;&lt;div class=&quot;hsp-connector&quot;&gt;&lt;/div&gt;&#039;;
                } else {
                    // Overlapping or adjacent HSPs - just connector line
                    $html .= &#039;&lt;div class=&quot;hsp-connector&quot;&gt;&lt;/div&gt;&#039;;
                }
                
                // Add current segment
                $color = getHspColorClass($hsp_scores[$current_idx]);
                $segment_width = ($current[&#039;end&#039;] - $current[&#039;start&#039;]) * $px_unit;
                $hsp = $hsp_details[$current_idx];
                // Extract just the subject name (first word/identifier before space or bracket)
                $hit_name = &#039;Hit &#039; . $hit_num;
                if (!empty($hit[&#039;subject&#039;])) {
                    $desc = htmlspecialchars($hit[&#039;subject&#039;]);
                    // Extract first word or identifier (up to first space, bracket, or pipe)
                    preg_match(&#039;/^([^\s\[\|\-]+)/&#039;, $desc, $matches);
                    if (!empty($matches[1])) {
                        $hit_name = $matches[1];
                    }
                }
                $title = $hit_name . &#039; - HSP &#039; . ($current_idx + 1) . &#039;: &#039; . $hsp[&#039;percent_identity&#039;] . &#039;% identity | E-value: &#039; . sprintf(&#039;%.2e&#039;, $hsp[&#039;evalue&#039;]);
                $html .= &#039;&lt;div class=&quot;hsp-segment &#039; . $color . &#039;&quot; style=&quot;width: &#039; . $segment_width . &#039;px;&quot; title=&quot;&#039; . htmlspecialchars($title) . &#039;&quot;&gt;&lt;/div&gt;&#039;;
            }
            
            // Trailing gap
            $last_end = $hsp_positions[count($hsp_positions) - 1][&#039;end&#039;];
            if ($last_end &lt; $results[&#039;query_length&#039;]) {
                $trailing_gap = ($results[&#039;query_length&#039;] - $last_end) * $px_unit;
                $html .= &#039;&lt;div class=&quot;hsp-gap&quot; style=&quot;width: &#039; . $trailing_gap . &#039;px;&quot;&gt;&lt;/div&gt;&#039;;
            }
        }
        
        $html .= &#039;&lt;/div&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    // Close the HSP rows wrapper
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Close the scrollable HSP container
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Close the main overflow:hidden container and outer div
    $html .= &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    // Add description below the HSP visualization (outside the relative container so ticks don&#039;t overlap)
    $html .= &#039;&lt;small class=&quot;text-muted&quot; style=&quot;display: block; margin-top: 15px; margin-bottom: 30px; text-align: center;&quot;&gt;Each color represents a different bit score range. Lines connect adjacent HSPs on the query sequence.&lt;/small&gt;&#039;;
    
    return $html;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getHspColorClass">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getHspColorClass()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 1144</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: getHspColorClass()</div>
                    <div class="function-comment">
                        <pre>/**
* Get HSP color class based on bit score
* Mirrors locBLAST color_key function
*
* @param float $score Bit score
* @return string CSS class name for color
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/blast_results_visualizer.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 1144</code>: <small>$color = getHspColorClass($hsp_scores[$first_idx]);</small></li>
                                    <li><code>line 1191</code>: <small>$color = getHspColorClass($hsp_scores[$current_idx]);</small></li>
                                    <li><code>line 1144</code>: <small>$color = getHspColorClass($hsp_scores[$first_idx]);</small></li>
                                    <li><code>line 1191</code>: <small>$color = getHspColorClass($hsp_scores[$current_idx]);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getHspColorClass($score) {
    if ($score &lt;= 40) {
        return &#039;color-black&#039;;
    } elseif ($score &lt;= 50) {
        return &#039;color-blue&#039;;
    } elseif ($score &lt;= 80) {
        return &#039;color-green&#039;;
    } elseif ($score &lt;= 200) {
        return &#039;color-purple&#039;;
    } else {
        return &#039;color-red&#039;;
    }
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getColorStyle">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getColorStyle()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 1263</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: getColorStyle()</div>
                    <div class="function-comment">
                        <pre>/**
* Get inline CSS style for color class
*
* @param string $colorClass CSS class name
* @return string Inline style
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function getColorStyle($colorClass) {
    $styles = [
        &#039;color-black&#039; =&gt; &#039;background-color: #000000;&#039;,
        &#039;color-blue&#039; =&gt; &#039;background-color: #0047c8;&#039;,
        &#039;color-green&#039; =&gt; &#039;background-color: #77de75;&#039;,
        &#039;color-purple&#039; =&gt; &#039;background-color: #e967f5;&#039;,
        &#039;color-red&#039; =&gt; &#039;background-color: #e83a2d;&#039;
    ];
    
    return isset($styles[$colorClass]) ? $styles[$colorClass] : &#039;&#039;;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="formatBlastAlignment">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">formatBlastAlignment()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 603</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: formatBlastAlignment()</div>
                    <div class="function-comment">
                        <pre>/**
* Format BLAST alignment output with frame-aware coordinate tracking
* Ported from locBLAST fmtprint() - handles frame shifts for BLASTx/tBLASTx
*
* @param int $length Alignment length
* @param string $query_seq Query sequence with gaps
* @param int $query_seq_from Query start coordinate
* @param int $query_seq_to Query end coordinate
* @param string $align_seq Midline (match indicators)
* @param string $sbjct_seq Subject sequence with gaps
* @param int $sbjct_seq_from Subject start coordinate
* @param int $sbjct_seq_to Subject end coordinate
* @param string $p_m Plus/Minus strand
* @param int $query_frame Query reading frame (0=none, ¬±1,2,3 for proteins)
* @param int $hit_frame Subject reading frame
* @return string Formatted alignment text
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/blast_results_visualizer.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 603</code>: <small>$alignment_text = formatBlastAlignment(</small></li>
                                    <li><code>line 603</code>: <small>$alignment_text = formatBlastAlignment(</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function formatBlastAlignment($length, $query_seq, $query_seq_from, $query_seq_to, $align_seq, $sbjct_seq, $sbjct_seq_from, $sbjct_seq_to, $p_m = &#039;Plus&#039;, $query_frame = 0, $hit_frame = 0) {
    $output = &#039;&#039;;
    $large = max(array((int)$query_seq_from, (int)$query_seq_to, (int)$sbjct_seq_from, (int)$sbjct_seq_to));
    $large_len = strlen($large);
    $n = (int)($length / 60);
    $r = $length % 60;
    if ($r &gt; 0) $t = $n + 1;
    else $t = $n;
    
    if ($query_frame != 0 &amp;&amp; $hit_frame != 0) {
        // Both query and subject are in frames (protein vs protein or translated)
        for ($i = 0; $i &lt; $t; $i++) {
            if ($query_frame &gt; 0) {
                $xn4 = $query_seq_from;
                $xs4 = substr($query_seq, 60*$i, 60);
                $xs4 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $xs4);
                $yn4 = $xn4 + (strlen($xs4) * 3) - 1;
                $output .= &quot;\nQuery  &quot; . str_pad($xn4, $large_len) . &quot;  &quot; . substr($query_seq, 60*$i, 60) . &quot;  &quot; . $yn4;
                $xn4 = $yn4 + 1;
                $output .= &quot;\n       &quot;. str_pad(&quot; &quot;, $large_len) . &quot;  &quot; . substr($align_seq, 60*$i, 60);
            } else {
                $xn = $query_seq_to;
                $xs = substr($query_seq, 60*$i, 60);
                $xs = preg_replace(&quot;/-/&quot;, &quot;&quot;, $xs);
                $yn = $xn - (strlen($xs) * 3) + 1;
                $output .= &quot;\nQuery  &quot; . str_pad($xn, $large_len) . &quot;  &quot; . substr($query_seq, 60*$i, 60) . &quot;  &quot; . $yn;
                $xn = $yn - 1;
                $output .= &quot;\n       &quot;. str_pad(&quot; &quot;, $large_len) . &quot;  &quot; . substr($align_seq, 60*$i, 60);
            }
            if ($hit_frame &gt; 0) {
                $an4 = $sbjct_seq_from;
                $ys4 = substr($sbjct_seq, 60*$i, 60);
                $ys4 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $ys4);
                $bn4 = $an4 + (strlen($ys4) *3) - 1;
                $output .= &quot;\nSbjct  &quot; . str_pad($an4, $large_len) . &quot;  &quot; . substr($sbjct_seq, 60*$i, 60) . &quot;  &quot; . $bn4 . &quot;\n&quot;;
                $an4 = $bn4 + 1;
            } else {
                $an = $sbjct_seq_to;
                $ys = substr($sbjct_seq, 60*$i, 60);
                $ys = preg_replace(&quot;/-/&quot;, &quot;&quot;, $ys);
                $bn = $an - (strlen($ys) *3) + 1;
                $output .= &quot;\nSbjct  &quot; . str_pad($an, $large_len) . &quot;  &quot; . substr($sbjct_seq, 60*$i, 60) . &quot;  &quot; . $bn . &quot;\n&quot;;
                $an = $bn - 1;
            }
        }
    } elseif ($query_frame != 0 &amp;&amp; $hit_frame == 0) {
        // Query is framed (tBLASTx, BLASTx), subject is not
        if ($query_frame &gt; 0) { $xn1 = $query_seq_from; } else { $xn1 = $query_seq_to; }
        $an1 = $sbjct_seq_from;
        for ($i = 0; $i &lt; $t; $i++) {
            if ($query_frame &gt; 0) {
                $xs1 = substr($query_seq, 60*$i, 60);
                $xs1 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $xs1);
                $yn1 = $xn1 + (strlen($xs1) * 3) - 1;
                $output .= &quot;\nQuery  &quot; . str_pad($xn1, $large_len) . &quot;  &quot; . substr($query_seq, 60*$i, 60) . &quot;  &quot; . $yn1;
                $xn1 = $yn1 + 1;
                $output .= &quot;\n       &quot;. str_pad(&quot; &quot;, $large_len) . &quot;  &quot; . substr($align_seq, 60*$i, 60);
                $ys1 = substr($sbjct_seq, 60*$i, 60);
                $ys1 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $ys1);
                $bn1 = $an1 + strlen($ys1) - 1;
                $output .= &quot;\nSbjct  &quot; . str_pad($an1, $large_len) . &quot;  &quot; . substr($sbjct_seq, 60*$i, 60) . &quot;  &quot; . $bn1 . &quot;\n&quot;;
                $an1 = $bn1 + 1;
            } else {
                $xs1 = substr($query_seq, 60*$i, 60);
                $xs1 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $xs1);
                $yn1 = $xn1 - (strlen($xs1) * 3) + 1;
                $output .= &quot;\nQuery  &quot; . str_pad($xn1, $large_len) . &quot;  &quot; . substr($query_seq, 60*$i, 60) . &quot;  &quot; . $yn1;
                $xn1 = $yn1 - 1;
                $output .= &quot;\n       &quot;. str_pad(&quot; &quot;, $large_len) . &quot;  &quot; . substr($align_seq, 60*$i, 60);
                $ys1 = substr($sbjct_seq, 60*$i, 60);
                $ys1 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $ys1);
                $bn1 = $an1 + strlen($ys1) - 1;
                $output .= &quot;\nSbjct  &quot; . str_pad($an1, $large_len) . &quot;  &quot; . substr($sbjct_seq, 60*$i, 60) . &quot;  &quot; . $bn1 . &quot;\n&quot;;
                $an1 = $bn1 + 1;
            }
        }
    } elseif ($query_frame == 0 &amp;&amp; $hit_frame != 0) {
        // Subject is framed, query is not
        if ($hit_frame &gt; 0) { $an3 = $sbjct_seq_from; } else { $an3 = $sbjct_seq_to; }
        $xn3 = $query_seq_from;
        for ($i = 0; $i &lt; $t; $i++) {
            if ($hit_frame &gt; 0) {
                $xs3 = substr($query_seq, 60*$i, 60);
                $xs3 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $xs3);
                $yn3 = $xn3 + strlen($xs3) - 1;
                $output .= &quot;\nQuery  &quot; . str_pad($xn3, $large_len) . &quot;  &quot; . substr($query_seq, 60*$i, 60) . &quot;  &quot; . $yn3;
                $xn3 = $yn3 + 1;
                $output .= &quot;\n       &quot;. str_pad(&quot; &quot;, $large_len) . &quot;  &quot; . substr($align_seq, 60*$i, 60);
                $ys3 = substr($sbjct_seq, 60*$i, 60);
                $ys3 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $ys3);
                $bn3 = $an3 + (strlen($ys3) * 3) - 1;
                $output .= &quot;\nSbjct  &quot; . str_pad($an3, $large_len) . &quot;  &quot; . substr($sbjct_seq, 60*$i, 60) . &quot;  &quot; . $bn3 . &quot;\n&quot;;
                $an3 = $bn3 + 1;
            } else {
                $xs3 = substr($query_seq, 60*$i, 60);
                $xs3 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $xs3);
                $yn3 = $xn3 + strlen($xs3) - 1;
                $output .= &quot;\nQuery  &quot; . str_pad($xn3, $large_len) . &quot;  &quot; . substr($query_seq, 60*$i, 60) . &quot;  &quot; . $yn3;
                $xn3 = $yn3 + 1;
                $output .= &quot;\n       &quot;. str_pad(&quot; &quot;, $large_len) . &quot;  &quot; . substr($align_seq, 60*$i, 60);
                $ys3 = substr($sbjct_seq, 60*$i, 60);
                $ys3 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $ys3);
                $bn3 = $an3 - (strlen($ys3) * 3) + 1;
                $output .= &quot;\nSbjct  &quot; . str_pad($an3, $large_len) . &quot;  &quot; . substr($sbjct_seq, 60*$i, 60) . &quot;  &quot; . $bn3 . &quot;\n&quot;;
                $an3 = $bn3 - 1;
            }
        }
    } else {
        // No frames - standard nucleotide vs nucleotide
        $xn2 = $query_seq_from;
        $an2 = $sbjct_seq_from;
        for ($i = 0; $i &lt; $t; $i++) {
            $xs2 = substr($query_seq, 60*$i, 60);
            $xs2 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $xs2);
            $yn2 = $xn2 + strlen($xs2) - 1;
            $output .= &quot;\nQuery  &quot; . str_pad($xn2, $large_len) . &quot;  &quot; . substr($query_seq, 60*$i, 60) . &quot;  &quot; . $yn2;
            $xn2 = $yn2 + 1;
            $output .= &quot;\n       &quot;. str_pad(&quot; &quot;, $large_len) . &quot;  &quot; . substr($align_seq, 60*$i, 60);
            $ys2 = substr($sbjct_seq, 60*$i, 60);
            $ys2 = preg_replace(&quot;/-/&quot;, &quot;&quot;, $ys2);
            if ($p_m == &quot;Plus&quot;) {
                $bn2 = $an2 + strlen($ys2) - 1;
                $output .= &quot;\nSbjct  &quot; . str_pad($an2, $large_len) . &quot;  &quot; . substr($sbjct_seq, 60*$i, 60) . &quot;  &quot; . $bn2 . &quot;\n&quot;;
                $an2 = $bn2 + 1;
            } else {
                $bn2 = $an2 - strlen($ys2) + 1;
                $output .= &quot;\nSbjct  &quot; . str_pad($an2, $large_len) . &quot;  &quot; . substr($sbjct_seq, 60*$i, 60) . &quot;  &quot; . $bn2 . &quot;\n&quot;;
                $an2 = $bn2 - 1;
            }
        }
    }
    
    return $output;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateQueryScoreLegend">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateQueryScoreLegend()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 1073</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: generateQueryScoreLegend()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate query score legend (outside overflow container)
* Shows score color ranges and query bar info
*
* @param int $query_length Total query length
* @param string $query_name Optional query name/ID
* @return string HTML for legend and query bar
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/blast_results_visualizer.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 1073</code>: <small>$html .= generateQueryScoreLegend($results[&#039;query_length&#039;], $results[&#039;query_name</small></li>
                                    <li><code>line 1073</code>: <small>$html .= generateQueryScoreLegend($results[&#039;query_length&#039;], $results[&#039;query_name</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function generateQueryScoreLegend($query_length, $query_name = &#039;&#039;) {
    $output = &#039;&lt;div style=&quot;margin: 0 auto 0px auto; width: 1000px;&quot;&gt;&#039;;
    
    // Score legend bar - discrete colored boxes (800px total width to match query)
    $output .= &#039;&lt;div style=&quot;display: flex; align-items: center; margin-bottom: 0;&quot;&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;min-width: 100px; padding-right: 15px; font-size: 11px; font-weight: bold; text-align: right;&quot;&gt;Score:&lt;/div&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;display: flex; gap: 0; width: 800px;&quot;&gt;&#039;;
    
    $score_ranges = [
        [&#039;color&#039; =&gt; &#039;#000000&#039;, &#039;label&#039; =&gt; &#039;‚â§40&lt;br&gt;&lt;small&gt;(Weak)&lt;/small&gt;&#039;],
        [&#039;color&#039; =&gt; &#039;#0047c8&#039;, &#039;label&#039; =&gt; &#039;40-50&#039;],
        [&#039;color&#039; =&gt; &#039;#77de75&#039;, &#039;label&#039; =&gt; &#039;50-80&#039;],
        [&#039;color&#039; =&gt; &#039;#e967f5&#039;, &#039;label&#039; =&gt; &#039;80-200&#039;],
        [&#039;color&#039; =&gt; &#039;#e83a2d&#039;, &#039;label&#039; =&gt; &#039;‚â•200&lt;br&gt;&lt;small&gt;(Excellent)&lt;/small&gt;&#039;]
    ];
    
    $box_width = (800 / 5); // Divide 800px by 5 color ranges evenly
    foreach ($score_ranges as $range) {
        $output .= &#039;&lt;div style=&quot;width: &#039; . $box_width . &#039;px; height: 25px; background-color: &#039; . $range[&#039;color&#039;] . &#039;; border-right: 1px solid #333; display: flex; align-items: center; justify-content: center;&quot;&gt;&#039;;
        $output .= &#039;&lt;span style=&quot;color: white; font-size: 10px; font-weight: bold; text-align: center; line-height: 1.2;&quot;&gt;&#039; . $range[&#039;label&#039;] . &#039;&lt;/span&gt;&#039;;
        $output .= &#039;&lt;/div&gt;&#039;;
    }
    
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    
    // Query bar - 800px width (no margins or padding, directly touches everything)
    $output .= &#039;&lt;div style=&quot;display: flex; align-items: center; margin: 0; padding: 0;&quot;&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;min-width: 100px; padding-right: 15px; font-size: 11px; font-weight: bold; text-align: right;&quot;&gt;&#039;;
    $output .= &#039;Query:&#039;;
    if (!empty($query_name)) {
        $output .= &#039;&lt;br&gt;&lt;small style=&quot;font-weight: normal; color: #666;&quot;&gt;&#039; . htmlspecialchars(substr($query_name, 0, 20)) . &#039;&lt;/small&gt;&#039;;
    }
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;width: 800px; height: 20px; position: relative; background: #f0f0f0; border-left: 1px solid #999; border-right: 1px solid #999; margin: 0; padding: 0;&quot;&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: linear-gradient(to right, #4CAF50 0%, #45a049 100%); margin: 0; padding: 0;&quot;&gt;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;position: absolute; left: 5px; top: 2px; color: white; font-size: 11px; font-weight: bold;&quot;&gt;1 - &#039; . $query_length . &#039; bp&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    
    $output .= &#039;&lt;/div&gt;&#039;;
    
    return $output;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateQueryScaleTicks">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateQueryScaleTicks()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 1099</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: generateQueryScaleTicks()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate query scale ticks (inside overflow container to be clipped)
* Shows tick marks and vertical reference lines
* Must be positioned at top of the HSP rows
*
* @param int $query_length Total query length
* @return string HTML for scale ticks and vertical lines
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/blast_results_visualizer.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 1099</code>: <small>$html .= generateQueryScaleTicks($results[&#039;query_length&#039;]);</small></li>
                                    <li><code>line 1099</code>: <small>$html .= generateQueryScaleTicks($results[&#039;query_length&#039;]);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function generateQueryScaleTicks($query_length) {
    $pxls = 800 / $query_length;
    $output = &#039;&#039;;
    
    // Generate exactly 10 evenly-spaced ticks across the query length
    $tick_numbers = [];
    
    // Calculate the spacing to get 10 ticks
    $tick_interval = $query_length / 10;
    
    // Generate 10 ticks
    for ($i = 1; $i &lt;= 10; $i++) {
        $tick_numbers[] = (int)($tick_interval * $i);
    }
    
    // Ensure the last tick is exactly the query length
    if (!empty($tick_numbers)) {
        $tick_numbers[count($tick_numbers) - 1] = $query_length;
    }
    
    // Scale ruler container with absolute positioning at the top
    // Use lower z-index so HSP bars appear on top of the reference lines
    $output .= &#039;&lt;div style=&quot;position: absolute; top: 0; left: 0; width: 100%; height: 80px; z-index: 1; margin: 0; padding: 0;&quot;&gt;&#039;;
    
    // Flex container for alignment
    $output .= &#039;&lt;div style=&quot;display: flex; align-items: flex-start; width: 100%; margin: 0; padding: 0;&quot;&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;min-width: 100px; padding-right: 15px; margin: 0;&quot;&gt;&lt;/div&gt;&#039;;
    
    // Container for ruler - 800px width
    $output .= &#039;&lt;div style=&quot;position: relative; width: 800px; height: 80px; margin: 0; padding: 0;&quot;&gt;&#039;;
    
    // Draw &quot;1&quot; marker at the start (aligned with other tick numbers at top: 10px)
    $output .= &#039;&lt;div style=&quot;position: absolute; left: -15px; top: 10px; width: 30px; text-align: center; font-size: 11px; font-weight: bold;&quot;&gt;1&lt;/div&gt;&#039;;
    
    // Draw tick marks with labels and vertical reference lines
    foreach ($tick_numbers as $tick_num) {
        // Calculate pixel position for this tick number (accounting for 1-based indexing)
        $pixel_pos = (int)($pxls * ($tick_num - 1));
        
        // Vertical reference line - extends from top through ticks to HSP boxes below
        $output .= &#039;&lt;div style=&quot;position: absolute; left: &#039; . $pixel_pos . &#039;px; top: 0px; width: 1px; height: 2000px; background: #cccccc; pointer-events: none;&quot;&gt;&lt;/div&gt;&#039;;
        
        // Tick mark at the top (dark gray)
        $output .= &#039;&lt;div style=&quot;position: absolute; left: &#039; . $pixel_pos . &#039;px; top: 0px; width: 1px; height: 8px; background: #999;&quot;&gt;&lt;/div&gt;&#039;;
        
        // Tick label number (aligned with &quot;1&quot; marker)
        $output .= &#039;&lt;div style=&quot;position: absolute; left: &#039; . ($pixel_pos - 15) . &#039;px; top: 10px; width: 30px; text-align: center; font-size: 11px; font-weight: bold;&quot;&gt;&#039; . $tick_num . &#039;&lt;/div&gt;&#039;;
    }
    
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    
    return $output;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateQueryScale">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateQueryScale()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 1099</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: generateQueryScale()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate query scale ruler with intelligent tick spacing
* Ported from locBLAST unit() function - displays as positioned overlay
* Includes horizontal query bar representation aligned with HSP boxes
* Tick lines are positioned absolutely and will be clipped by parent container
*
* @param int $query_length Total query length
* @param string $query_name Optional query name/ID
* @return string HTML for scale labels, ticks, and query bar
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function generateQueryScale($query_length, $query_name = &#039;&#039;) {
    $pxls = 800 / $query_length;  // Wider 800px instead of 500px
    $output = &#039;&lt;div style=&quot;margin: 0 auto 20px auto; width: 1000px;&quot;&gt;&#039;;
    
    // Score legend bar - discrete colored boxes (800px total width to match query)
    $output .= &#039;&lt;div style=&quot;display: flex; align-items: center; margin-bottom: 10px;&quot;&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;min-width: 100px; padding-right: 15px; font-size: 11px; font-weight: bold; text-align: right;&quot;&gt;Score:&lt;/div&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;display: flex; gap: 0; width: 800px;&quot;&gt;&#039;;
    
    $score_ranges = [
        [&#039;color&#039; =&gt; &#039;#000000&#039;, &#039;label&#039; =&gt; &#039;‚â§40&lt;br&gt;&lt;small&gt;(Weak)&lt;/small&gt;&#039;],
        [&#039;color&#039; =&gt; &#039;#0047c8&#039;, &#039;label&#039; =&gt; &#039;40-50&#039;],
        [&#039;color&#039; =&gt; &#039;#77de75&#039;, &#039;label&#039; =&gt; &#039;50-80&#039;],
        [&#039;color&#039; =&gt; &#039;#e967f5&#039;, &#039;label&#039; =&gt; &#039;80-200&#039;],
        [&#039;color&#039; =&gt; &#039;#e83a2d&#039;, &#039;label&#039; =&gt; &#039;‚â•200&lt;br&gt;&lt;small&gt;(Excellent)&lt;/small&gt;&#039;]
    ];
    
    $box_width = (800 / 5); // Divide 800px by 5 color ranges evenly
    foreach ($score_ranges as $range) {
        $output .= &#039;&lt;div style=&quot;width: &#039; . $box_width . &#039;px; height: 25px; background-color: &#039; . $range[&#039;color&#039;] . &#039;; border-right: 1px solid #333; display: flex; align-items: center; justify-content: center;&quot;&gt;&#039;;
        $output .= &#039;&lt;span style=&quot;color: white; font-size: 10px; font-weight: bold; text-align: center; line-height: 1.2;&quot;&gt;&#039; . $range[&#039;label&#039;] . &#039;&lt;/span&gt;&#039;;
        $output .= &#039;&lt;/div&gt;&#039;;
    }
    
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    
    // Query bar - 800px width
    $output .= &#039;&lt;div style=&quot;display: flex; align-items: center; margin-bottom: 0;&quot;&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;min-width: 100px; padding-right: 15px; font-size: 11px; font-weight: bold; text-align: right;&quot;&gt;&#039;;
    $output .= &#039;Query:&#039;;
    if (!empty($query_name)) {
        $output .= &#039;&lt;br&gt;&lt;small style=&quot;font-weight: normal; color: #666;&quot;&gt;&#039; . htmlspecialchars(substr($query_name, 0, 20)) . &#039;&lt;/small&gt;&#039;;
    }
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;width: 800px; height: 20px; position: relative; background: #f0f0f0; border-left: 1px solid #999; border-right: 1px solid #999; border-bottom: 1px solid #999; border-radius: 0 0 3px 3px; margin-right: 10px;&quot;&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: linear-gradient(to right, #4CAF50 0%, #45a049 100%); border-radius: 0 0 2px 2px;&quot;&gt;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;position: absolute; left: 5px; top: 2px; color: white; font-size: 11px; font-weight: bold;&quot;&gt;1 - &#039; . $query_length . &#039; bp&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    
    // Generate scale tick numbers: Calculate evenly spaced rounded intervals
    $tick_numbers = [];
    $tick_interval = $query_length / 10;  // Base interval for 10 ticks
    
    // Determine rounding interval based on query length for clean numbers
    if ($query_length &lt;= 100) {
        $round_to = 10;
    } elseif ($query_length &lt;= 500) {
        $round_to = 50;
    } elseif ($query_length &lt;= 1000) {
        $round_to = 100;
    } elseif ($query_length &lt;= 5000) {
        $round_to = 500;
    } else {
        $round_to = 1000;
    }
    
    // Round the base interval to get consistent tick spacing
    $rounded_interval = round($tick_interval / $round_to) * $round_to;
    
    // Generate 10 tick numbers using the rounded interval
    for ($i = 1; $i &lt;= 10; $i++) {
        $tick_num = $i * $rounded_interval;
        if ($tick_num &lt;= $query_length) {
            $tick_numbers[] = $tick_num;
        }
    }
    
    // Scale ruler with ticks and vertical lines down to HSPs
    $output .= &#039;&lt;div style=&quot;display: flex; align-items: flex-start;&quot;&gt;&#039;;
    $output .= &#039;&lt;div style=&quot;min-width: 100px; padding-right: 15px;&quot;&gt;&lt;/div&gt;&#039;;
    
    // Container for ruler - 800px width, extended height for vertical lines
    $output .= &#039;&lt;div style=&quot;position: relative; height: 40px; width: 800px; margin-right: 10px;&quot;&gt;&#039;;
    
    // Draw &quot;1&quot; marker at the start
    $output .= &#039;&lt;div style=&quot;position: absolute; left: -15px; top: 10px; width: 30px; text-align: center; font-size: 11px; font-weight: bold;&quot;&gt;1&lt;/div&gt;&#039;;
    
    // Draw tick marks with labels and vertical reference lines
    foreach ($tick_numbers as $tick_num) {
        // Calculate pixel position for this tick number (accounting for 1-based indexing)
        $pixel_pos = (int)($pxls * ($tick_num - 1));
        
        // Vertical reference line (light gray) extending down - will be clipped by parent container&#039;s overflow:hidden
        $output .= &#039;&lt;div style=&quot;position: absolute; left: &#039; . $pixel_pos . &#039;px; top: 0; width: 1px; height: 2000px; background: #cccccc; pointer-events: none;&quot;&gt;&lt;/div&gt;&#039;;
        
        // Tick mark at the top (dark gray)
        $output .= &#039;&lt;div style=&quot;position: absolute; left: &#039; . $pixel_pos . &#039;px; top: 0; width: 1px; height: 8px; background: #999;&quot;&gt;&lt;/div&gt;&#039;;
        
        // Tick label number (centered below tick mark)
        $output .= &#039;&lt;div style=&quot;position: absolute; left: &#039; . ($pixel_pos - 15) . &#039;px; top: 10px; width: 30px; text-align: center; font-size: 11px; font-weight: bold;&quot;&gt;&#039; . $tick_num . &#039;&lt;/div&gt;&#039;;
    }
    
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    $output .= &#039;&lt;/div&gt;&#039;;
    
    return $output;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getToggleQuerySectionScript">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getToggleQuerySectionScript()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 1659</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: getToggleQuerySectionScript()</div>
                    <div class="function-comment">
                        <pre>/**
* JavaScript function for toggling query sections (embedded in PHP output)
* Called onclick from query section headers
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/blast.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 569</code>: <small>&lt;?= getToggleQuerySectionScript() ?&gt;</small></li>
                                    <li><code>line 569</code>: <small>&lt;?= getToggleQuerySectionScript() ?&gt;</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getToggleQuerySectionScript() {
    return &lt;&lt;&lt;&#039;JS&#039;
&lt;script&gt;
function toggleQuerySection(contentId, headerElement) {
    const content = document.getElementById(contentId);
    const chevron = headerElement.querySelector(&#039;i&#039;);
    
    if (content.style.display === &#039;none&#039;) {
        content.style.display = &#039;block&#039;;
        chevron.style.transform = &#039;rotate(180deg)&#039;;
    } else {
        content.style.display = &#039;none&#039;;
        chevron.style.transform = &#039;rotate(0deg)&#039;;
    }
}
&lt;/script&gt;
JS;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="toggleQuerySection">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">toggleQuerySection()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 962</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/blast_results_visualizer.php: toggleQuerySection()</div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/blast_results_visualizer.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 962</code>: <small>$html .= &#039;&lt;div id=&quot;query-&#039; . $query_num . &#039;-header&quot; style=&quot;padding: 15px; cursor</small></li>
                                    <li><code>line 962</code>: <small>$html .= &#039;&lt;div id=&quot;query-&#039; . $query_num . &#039;-header&quot; style=&quot;padding: 15px; cursor</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function toggleQuerySection(contentId, headerElement) {
    const content = document.getElementById(contentId);
    const chevron = headerElement.querySelector(&#039;i&#039;);
    
    if (content.style.display === &#039;none&#039;) {
        content.style.display = &#039;block&#039;;
        chevron.style.transform = &#039;rotate(180deg)&#039;;
    } else {
        content.style.display = &#039;none&#039;;
        chevron.style.transform = &#039;rotate(0deg)&#039;;
    }
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/database_queries.php (14)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="getFeatureById">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getFeatureById()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 28</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getFeatureById()</div>
                    <div class="function-comment">
                        <pre>/**
* Get feature data by feature_id
* Returns complete feature information including organism and genome data
*
* @param int $feature_id - Feature ID to retrieve
* @param string $dbFile - Path to SQLite database
* @param array $genome_ids - Optional: Array of genome IDs to filter results
* @return array - Feature row with organism and genome info, or empty array
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 98</code>: <small>$row = getFeatureById($ancestor_feature_id, $db, $accessible_genome_ids);</small></li>
                                    <li><code>line 98</code>: <small>$row = getFeatureById($ancestor_feature_id, $db, $accessible_genome_ids);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getFeatureById($feature_id, $dbFile, $genome_ids = []) {
    if (!empty($genome_ids)) {
        $placeholders = implode(&#039;,&#039;, array_fill(0, count($genome_ids), &#039;?&#039;));
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.parent_feature_id, f.genome_id, f.organism_id,
                         o.genus, o.species, o.subtype, o.common_name, o.taxon_id,
                         g.genome_accession, g.genome_name
                  FROM feature f
                  JOIN organism o ON f.organism_id = o.organism_id
                  JOIN genome g ON f.genome_id = g.genome_id
                  WHERE f.feature_id = ? AND f.genome_id IN ($placeholders)&quot;;
        $params = array_merge([$feature_id], $genome_ids);
    } else {
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.parent_feature_id, f.genome_id, f.organism_id,
                         o.genus, o.species, o.subtype, o.common_name, o.taxon_id,
                         g.genome_accession, g.genome_name
                  FROM feature f
                  JOIN organism o ON f.organism_id = o.organism_id
                  JOIN genome g ON f.genome_id = g.genome_id
                  WHERE f.feature_id = ?&quot;;
        $params = [$feature_id];
    }
    
    $results = fetchData($query, $dbFile, $params);
    return !empty($results) ? $results[0] : [];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getFeatureByUniquename">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getFeatureByUniquename()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 65</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getFeatureByUniquename()</div>
                    <div class="function-comment">
                        <pre>/**
* Get feature data by feature_uniquename
* Returns complete feature information including organism and genome data
*
* @param string $feature_uniquename - Feature uniquename to retrieve
* @param string $dbFile - Path to SQLite database
* @param array $genome_ids - Optional: Array of genome IDs to filter results
* @return array - Feature row with organism and genome info, or empty array
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/parent_functions.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 19</code>: <small>$feature = getFeatureByUniquename($feature_uniquename, $dbFile, $genome_ids);</small></li>
                                    <li><code>line 19</code>: <small>$feature = getFeatureByUniquename($feature_uniquename, $dbFile, $genome_ids);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 97</code>: <small>$feature_result = getFeatureByUniquename($uniquename, $db);</small></li>
                                    <li><code>line 97</code>: <small>$feature_result = getFeatureByUniquename($uniquename, $db);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getFeatureByUniquename($feature_uniquename, $dbFile, $genome_ids = []) {
    if (!empty($genome_ids)) {
        $placeholders = implode(&#039;,&#039;, array_fill(0, count($genome_ids), &#039;?&#039;));
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.parent_feature_id, f.genome_id, f.organism_id,
                         o.genus, o.species, o.subtype, o.common_name, o.taxon_id,
                         g.genome_accession, g.genome_name
                  FROM feature f
                  JOIN organism o ON f.organism_id = o.organism_id
                  JOIN genome g ON f.genome_id = g.genome_id
                  WHERE f.feature_uniquename = ? AND f.genome_id IN ($placeholders)&quot;;
        $params = array_merge([$feature_uniquename], $genome_ids);
    } else {
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.parent_feature_id, f.genome_id, f.organism_id,
                         o.genus, o.species, o.subtype, o.common_name, o.taxon_id,
                         g.genome_accession, g.genome_name
                  FROM feature f
                  JOIN organism o ON f.organism_id = o.organism_id
                  JOIN genome g ON f.genome_id = g.genome_id
                  WHERE f.feature_uniquename = ?&quot;;
        $params = [$feature_uniquename];
    }
    
    $results = fetchData($query, $dbFile, $params);
    return !empty($results) ? $results[0] : [];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getChildrenByFeatureId">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getChildrenByFeatureId()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 102</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getChildrenByFeatureId()</div>
                    <div class="function-comment">
                        <pre>/**
* Get immediate children of a feature (not recursive)
* Returns direct children only
*
* @param int $parent_feature_id - Parent feature ID
* @param string $dbFile - Path to SQLite database
* @param array $genome_ids - Optional: Array of genome IDs to filter results
* @return array - Array of child feature rows
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/parent_functions.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 75</code>: <small>$results = getChildrenByFeatureId($feature_id, $dbFile, $genome_ids);</small></li>
                                    <li><code>line 257</code>: <small>$results = getChildrenByFeatureId($feature_id, $dbFile, $genome_ids);</small></li>
                                    <li><code>line 75</code>: <small>$results = getChildrenByFeatureId($feature_id, $dbFile, $genome_ids);</small></li>
                                    <li><code>line 257</code>: <small>$results = getChildrenByFeatureId($feature_id, $dbFile, $genome_ids);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getChildrenByFeatureId($parent_feature_id, $dbFile, $genome_ids = []) {
    if (!empty($genome_ids)) {
        $placeholders = implode(&#039;,&#039;, array_fill(0, count($genome_ids), &#039;?&#039;));
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.parent_feature_id
                  FROM feature f
                  WHERE f.parent_feature_id = ? AND f.genome_id IN ($placeholders)&quot;;
        $params = array_merge([$parent_feature_id], $genome_ids);
    } else {
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.parent_feature_id
                  FROM feature f
                  WHERE f.parent_feature_id = ?&quot;;
        $params = [$parent_feature_id];
    }
    
    return fetchData($query, $dbFile, $params);
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getParentFeature">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getParentFeature()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 130</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getParentFeature()</div>
                    <div class="function-comment">
                        <pre>/**
* Get immediate parent of a feature by ID
* Returns minimal parent info for hierarchy traversal
*
* @param int $feature_id - Feature ID to get parent of
* @param string $dbFile - Path to SQLite database
* @param array $genome_ids - Optional: Array of genome IDs to filter results
* @return array - Parent feature row (minimal fields), or empty array
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/parent_functions.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 46</code>: <small>$feature = getParentFeature($feature_id, $dbFile, $genome_ids);</small></li>
                                    <li><code>line 46</code>: <small>$feature = getParentFeature($feature_id, $dbFile, $genome_ids);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getParentFeature($feature_id, $dbFile, $genome_ids = []) {
    if (!empty($genome_ids)) {
        $placeholders = implode(&#039;,&#039;, array_fill(0, count($genome_ids), &#039;?&#039;));
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_type, f.parent_feature_id
                  FROM feature f
                  WHERE f.feature_id = ? AND f.genome_id IN ($placeholders)&quot;;
        $params = array_merge([$feature_id], $genome_ids);
    } else {
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_type, f.parent_feature_id
                  FROM feature f
                  WHERE f.feature_id = ?&quot;;
        $params = [$feature_id];
    }
    
    $results = fetchData($query, $dbFile, $params);
    return !empty($results) ? $results[0] : [];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getFeaturesByType">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getFeaturesByType()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 157</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getFeaturesByType()</div>
                    <div class="function-comment">
                        <pre>/**
* Get all features of specific types in a genome
* Useful for getting genes, mRNAs, or other feature types
*
* @param string $feature_type - Feature type to retrieve (e.g., &#039;gene&#039;, &#039;mRNA&#039;)
* @param string $dbFile - Path to SQLite database
* @param array $genome_ids - Optional: Array of genome IDs to filter results
* @return array - Array of features with specified type
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function getFeaturesByType($feature_type, $dbFile, $genome_ids = []) {
    if (!empty($genome_ids)) {
        $placeholders = implode(&#039;,&#039;, array_fill(0, count($genome_ids), &#039;?&#039;));
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.genome_id
                  FROM feature f
                  WHERE f.feature_type = ? AND f.genome_id IN ($placeholders)
                  ORDER BY f.feature_uniquename&quot;;
        $params = array_merge([$feature_type], $genome_ids);
    } else {
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.genome_id
                  FROM feature f
                  WHERE f.feature_type = ?
                  ORDER BY f.feature_uniquename&quot;;
        $params = [$feature_type];
    }
    
    return fetchData($query, $dbFile, $params);
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="searchFeaturesByUniquename">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">searchFeaturesByUniquename()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 187</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: searchFeaturesByUniquename()</div>
                    <div class="function-comment">
                        <pre>/**
* Search features by uniquename with optional organism filter
* Used for quick feature lookup and search suggestions
*
* @param string $search_term - Search term for feature uniquename (supports wildcards)
* @param string $dbFile - Path to SQLite database
* @param string $organism_name - Optional: Filter by organism name
* @return array - Array of matching features
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function searchFeaturesByUniquename($search_term, $dbFile, $organism_name = &#039;&#039;) {
    if ($organism_name) {
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.organism_id, o.genus, o.species
                  FROM feature f
                  JOIN organism o ON f.organism_id = o.organism_id
                  WHERE f.feature_uniquename LIKE ? AND o.genus || &#039; &#039; || o.species LIKE ?
                  ORDER BY f.feature_uniquename
                  LIMIT 50&quot;;
        $params = [&quot;%$search_term%&quot;, &quot;%$organism_name%&quot;];
    } else {
        $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_name, f.feature_description, 
                         f.feature_type, f.organism_id, o.genus, o.species
                  FROM feature f
                  JOIN organism o ON f.organism_id = o.organism_id
                  WHERE f.feature_uniquename LIKE ?
                  ORDER BY f.feature_uniquename
                  LIMIT 50&quot;;
        $params = [&quot;%$search_term%&quot;];
    }
    
    return fetchData($query, $dbFile, $params);
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAnnotationsByFeature">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAnnotationsByFeature()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 219</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getAnnotationsByFeature()</div>
                    <div class="function-comment">
                        <pre>/**
* Get all annotations for a feature
* Returns annotations with their sources and metadata
*
* @param int $feature_id - Feature ID to get annotations for
* @param string $dbFile - Path to SQLite database
* @return array - Array of annotation records
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function getAnnotationsByFeature($feature_id, $dbFile) {
    $query = &quot;SELECT a.annotation_id, a.annotation_accession, a.annotation_description, 
                     ans.annotation_source_name, ans.annotation_source_id,
                     fa.score, fa.date, fa.additional_info
              FROM annotation a
              JOIN feature_annotation fa ON a.annotation_id = fa.annotation_id
              JOIN annotation_source ans ON a.annotation_source_id = ans.annotation_source_id
              WHERE fa.feature_id = ?
              ORDER BY fa.date DESC&quot;;
    
    return fetchData($query, $dbFile, [$feature_id]);
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getOrganismInfo">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getOrganismInfo()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 240</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getOrganismInfo()</div>
                    <div class="function-comment">
                        <pre>/**
* Get organism information
* Returns complete organism record with taxonomic data
*
* @param string $organism_name - Organism name (genus + species)
* @param string $dbFile - Path to SQLite database
* @return array - Organism record, or empty array if not found
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function getOrganismInfo($organism_name, $dbFile) {
    $query = &quot;SELECT organism_id, genus, species, common_name, subtype, taxon_id
              FROM organism
              WHERE (genus || &#039; &#039; || species = ? OR common_name = ?)
              LIMIT 1&quot;;
    
    $results = fetchData($query, [$organism_name, $organism_name], $dbFile);
    return !empty($results) ? $results[0] : [];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAssemblyStats">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAssemblyStats()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 258</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getAssemblyStats()</div>
                    <div class="function-comment">
                        <pre>/**
* Get assembly/genome statistics
* Returns feature counts and metadata for an assembly
*
* @param string $genome_accession - Genome/assembly accession
* @param string $dbFile - Path to SQLite database
* @return array - Genome record with feature counts, or empty array
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/assembly_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 19</code>: <small>$assembly_info = getAssemblyStats($assembly_accession, $db_path);</small></li>
                                    <li><code>line 19</code>: <small>$assembly_info = getAssemblyStats($assembly_accession, $db_path);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAssemblyStats($genome_accession, $dbFile) {
    $query = &quot;SELECT g.genome_id, g.genome_accession, g.genome_name,
                     COUNT(DISTINCT CASE WHEN f.feature_type = &#039;gene&#039; THEN f.feature_id END) as gene_count,
                     COUNT(DISTINCT CASE WHEN f.feature_type = &#039;mRNA&#039; THEN f.feature_id END) as mrna_count,
                     COUNT(DISTINCT f.feature_id) as total_features
              FROM genome g
              LEFT JOIN feature f ON g.genome_id = f.genome_id
              WHERE g.genome_accession = ?
              GROUP BY g.genome_id&quot;;
    
    $results = fetchData($query, $dbFile, [$genome_accession]);
    return !empty($results) ? $results[0] : [];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="searchFeaturesAndAnnotations">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">searchFeaturesAndAnnotations()</div>
                            <span class="function-counter">3</span>
                            <div class="function-line">Line 282</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: searchFeaturesAndAnnotations()</div>
                    <div class="function-comment">
                        <pre>/**
* Search features and annotations by keyword
* Supports both keyword and quoted phrase searches
* Used by annotation_search_ajax.php
*
* @param string $search_term - Search term or phrase
* @param bool $is_quoted_search - Whether this is a quoted phrase search
* @param string $dbFile - Path to SQLite database
* @return array - Array of matching features with annotations
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (3 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/annotation_search_ajax.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 96</code>: <small>$search_result = searchFeaturesAndAnnotations($search_input, $quoted_search, $db</small></li>
                                    <li><code>line 96</code>: <small>$search_result = searchFeaturesAndAnnotations($search_input, $quoted_search, $db</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tests/benchmark_search.php</strong> (1x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 49</code>: <small>$results = searchFeaturesAndAnnotations($searchTerm, false, $dbFile);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function searchFeaturesAndAnnotations($search_term, $is_quoted_search, $dbFile, $source_names = []) {
    // Use provided source names filter, or empty array if not provided
    $source_filter = !empty($source_names) ? $source_names : [];
    $search_term_clean = $search_term;
    
    // Build the WHERE clause for annotations with REGEXP ranking
    if ($is_quoted_search) {
        // Exact phrase match
        $like_pattern = &quot;%$search_term_clean%&quot;;
        $regex_exact = &#039;\b&#039; . preg_quote($search_term_clean, &#039;/&#039;) . &#039;\b&#039;;
        $regex_start = &#039;\b&#039; . preg_quote($search_term_clean, &#039;/&#039;);
        
        $query = &quot;SELECT f.feature_uniquename, f.feature_name, f.feature_description, 
                         a.annotation_accession, a.annotation_description, 
                         fa.score, fa.date, ans.annotation_source_name, 
                         o.genus, o.species, o.common_name, o.subtype, f.feature_type, f.organism_id,
                         g.genome_accession
                  FROM annotation a, feature f, feature_annotation fa, annotation_source ans, organism o, genome g
                  WHERE ans.annotation_source_id = a.annotation_source_id 
                    AND f.feature_id = fa.feature_id 
                    AND fa.annotation_id = a.annotation_id 
                    AND f.organism_id = o.organism_id
                    AND f.genome_id = g.genome_id
                    AND (a.annotation_description LIKE ? 
                       OR f.feature_name LIKE ? 
                       OR f.feature_description LIKE ?
                       OR a.annotation_accession LIKE ?)&quot;;
        
        $params = [$like_pattern, $like_pattern, $like_pattern, $like_pattern];
        
        // Add source filter if specified (exact match with IN)
        if (!empty($source_filter)) {
            $placeholders = implode(&#039;,&#039;, array_fill(0, count($source_filter), &#039;?&#039;));
            $query .= &quot; AND ans.annotation_source_name IN ($placeholders)&quot;;
            $params = array_merge($params, $source_filter);
        }
        
        $query .= &quot; ORDER BY 
                     CASE 
                       WHEN f.feature_name REGEXP ? THEN 1
                       WHEN f.feature_name REGEXP ? THEN 2
                       WHEN f.feature_description REGEXP ? THEN 3
                       WHEN a.annotation_description REGEXP ? THEN 4
                       ELSE 5
                     END,
                     f.feature_uniquename&quot;;
        
        $params[] = $regex_exact;
        $params[] = $regex_start;
        $params[] = $regex_start;
        $params[] = $regex_exact;
        
    } else {
        // Multi-term keyword search (all terms must appear somewhere)
        $terms = array_filter(array_map(&#039;trim&#039;, preg_split(&#039;/\s+/&#039;, $search_term_clean)));
        if (empty($terms)) {
            return [&#039;results&#039; =&gt; [], &#039;capped&#039; =&gt; false, &#039;warning&#039; =&gt; null];
        }
        
        // Extract primary term for relevance scoring (first word of search)
        $primary_term = $terms[0];
        $primary_pattern = &quot;%$primary_term%&quot;;
        $regex_exact = &#039;\b&#039; . preg_quote($primary_term, &#039;/&#039;) . &#039;\b&#039;;
        $regex_start = &#039;\b&#039; . preg_quote($primary_term, &#039;/&#039;);
        
        // Build conditions: (col1 LIKE term1 OR col2 LIKE term1 OR ...) AND (col1 LIKE term2 OR ...)
        $conditions = [];
        $params = [];
        $columns = [&#039;a.annotation_description&#039;, &#039;f.feature_name&#039;, &#039;f.feature_description&#039;, &#039;a.annotation_accession&#039;];
        
        foreach ($terms as $term) {
            $term_conditions = implode(&#039; OR &#039;, array_map(function($col) { return &quot;$col LIKE ?&quot;; }, $columns));
            $conditions[] = &quot;($term_conditions)&quot;;
            for ($i = 0; $i &lt; count($columns); $i++) {
                $params[] = &quot;%$term%&quot;;
            }
        }
        
        $where_clause = implode(&#039; AND &#039;, $conditions);
        
        $query = &quot;SELECT f.feature_uniquename, f.feature_name, f.feature_description, 
                         a.annotation_accession, a.annotation_description, 
                         fa.score, fa.date, ans.annotation_source_name, 
                         o.genus, o.species, o.common_name, o.subtype, f.feature_type, f.organism_id,
                         g.genome_accession
                  FROM annotation a, feature f, feature_annotation fa, annotation_source ans, organism o, genome g
                  WHERE ans.annotation_source_id = a.annotation_source_id 
                    AND f.feature_id = fa.feature_id 
                    AND fa.annotation_id = a.annotation_id 
                    AND f.organism_id = o.organism_id
                    AND f.genome_id = g.genome_id
                    AND $where_clause&quot;;
        
        // Add source filter if specified (exact match with IN)
        if (!empty($source_filter)) {
            $placeholders = implode(&#039;,&#039;, array_fill(0, count($source_filter), &#039;?&#039;));
            $query .= &quot; AND ans.annotation_source_name IN ($placeholders)&quot;;
            $params = array_merge($params, $source_filter);
        }
        
        $query .= &quot; ORDER BY 
                    CASE 
                      WHEN f.feature_name REGEXP ? THEN 1
                      WHEN f.feature_name REGEXP ? THEN 2
                      WHEN f.feature_description REGEXP ? THEN 3
                      WHEN a.annotation_description REGEXP ? THEN 4
                      ELSE 5
                    END,
                    f.feature_uniquename&quot;;
        
        // Add primary term patterns for CASE statement to params
        $params[] = $regex_exact;
        $params[] = $regex_start;
        $params[] = $regex_start;
        $params[] = $regex_exact;
    }
    
    // Use LIMIT+check approach: query for 2501 results to detect if there are more
    $max_display = 2500;
    $query .= &quot; LIMIT &quot; . ($max_display + 1);
    
    try {
        $dbh = new PDO(&quot;sqlite:&quot; . $dbFile);
        $dbh-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        // Register REGEXP function
        $dbh-&gt;sqliteCreateFunction(&#039;REGEXP&#039;, function($pattern, $text) {
            return preg_match(&#039;/&#039; . $pattern . &#039;/i&#039;, $text) ? 1 : 0;
        }, 2);
        
        $stmt = $dbh-&gt;prepare($query);
        $stmt-&gt;execute($params);
        $all_results = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);
        
        $dbh = null;
        
        // Check if results were capped
        $capped = count($all_results) &gt; $max_display;
        $warning = null;
        
        if ($capped) {
            // We got 2501+ results, so we know it&#039;s &quot;2500+&quot;
            $results = array_slice($all_results, 0, $max_display);
            $warning = &quot;2,500+ results found. Use Advanced Filter or add more search terms to refine.&quot;;
        } else {
            // We got fewer than 2501, so all results are displayed
            $results = $all_results;
        }
        
        return [
            &#039;results&#039; =&gt; $results,
            &#039;capped&#039; =&gt; $capped,
            &#039;warning&#039; =&gt; $warning
        ];
        
    } catch (PDOException $e) {
        return [
            &#039;results&#039; =&gt; [],
            &#039;capped&#039; =&gt; false,
            &#039;warning&#039; =&gt; &#039;Search error: &#039; . $e-&gt;getMessage()
        ];
    }
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="searchFeaturesAndAnnotationsLike">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">searchFeaturesAndAnnotationsLike()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 446</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: searchFeaturesAndAnnotationsLike()</div>
                    <div class="function-code">
                        <code>function searchFeaturesAndAnnotationsLike($search_term, $is_quoted_search, $dbFile) {
    if ($is_quoted_search) {
        $like_pattern = &quot;%$search_term%&quot;;
        $params = [$like_pattern, $like_pattern, $like_pattern, $like_pattern];
    } else {
        $terms = array_filter(array_map(&#039;trim&#039;, preg_split(&#039;/\s+/&#039;, $search_term)));
        if (empty($terms)) {
            return [];
        }
        
        $conditions = [];
        $params = [];
        $columns = [&#039;a.annotation_description&#039;, &#039;f.feature_name&#039;, &#039;f.feature_description&#039;, &#039;a.annotation_accession&#039;];
        
        foreach ($terms as $term) {
            $term_conditions = implode(&#039; OR &#039;, array_map(function($col) { return &quot;$col LIKE ?&quot;; }, $columns));
            $conditions[] = &quot;($term_conditions)&quot;;
            for ($i = 0; $i &lt; count($columns); $i++) {
                $params[] = &quot;%$term%&quot;;
            }
        }
        $where_clause = implode(&#039; AND &#039;, $conditions);
    }
    
    if ($is_quoted_search) {
        $query = &quot;SELECT f.feature_uniquename, f.feature_name, f.feature_description, 
                         a.annotation_accession, a.annotation_description, 
                         fa.score, fa.date, ans.annotation_source_name, 
                         o.genus, o.species, o.common_name, o.subtype, f.feature_type, f.organism_id,
                         g.genome_accession
                  FROM annotation a, feature f, feature_annotation fa, annotation_source ans, organism o, genome g
                  WHERE ans.annotation_source_id = a.annotation_source_id 
                    AND f.feature_id = fa.feature_id 
                    AND fa.annotation_id = a.annotation_id 
                    AND f.organism_id = o.organism_id
                    AND f.genome_id = g.genome_id
                    AND (a.annotation_description LIKE ? 
                       OR f.feature_name LIKE ? 
                       OR f.feature_description LIKE ?
                       OR a.annotation_accession LIKE ?)
                  ORDER BY f.feature_uniquename&quot;;
    } else {
        $query = &quot;SELECT f.feature_uniquename, f.feature_name, f.feature_description, 
                         a.annotation_accession, a.annotation_description, 
                         fa.score, fa.date, ans.annotation_source_name, 
                         o.genus, o.species, o.common_name, o.subtype, f.feature_type, f.organism_id,
                         g.genome_accession
                  FROM annotation a, feature f, feature_annotation fa, annotation_source ans, organism o, genome g
                  WHERE ans.annotation_source_id = a.annotation_source_id 
                    AND f.feature_id = fa.feature_id 
                    AND fa.annotation_id = a.annotation_id 
                    AND f.organism_id = o.organism_id
                    AND f.genome_id = g.genome_id
                    AND $where_clause
                  ORDER BY f.feature_uniquename&quot;;
    }
    
    return fetchData($query, $dbFile, $params);
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="searchFeaturesByUniquenameForSearch">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">searchFeaturesByUniquenameForSearch()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 516</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: searchFeaturesByUniquenameForSearch()</div>
                    <div class="function-comment">
                        <pre>/**
* Search features by uniquename (primary search)
* Returns only features, not annotations
* Used as fast path before annotation search
*
* @param string $search_term - Search term for uniquename
* @param string $dbFile - Path to SQLite database
* @param string $organism_name - Optional: Filter by organism
* @return array - Array of matching features
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/annotation_search_ajax.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 90</code>: <small>$results = searchFeaturesByUniquenameForSearch($search_input, $db);</small></li>
                                    <li><code>line 90</code>: <small>$results = searchFeaturesByUniquenameForSearch($search_input, $db);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function searchFeaturesByUniquenameForSearch($search_term, $dbFile, $organism_name = &#039;&#039;) {
    if ($organism_name) {
        $query = &quot;SELECT f.feature_uniquename, f.feature_name, f.feature_description, 
                         o.genus, o.species, o.common_name, o.subtype, f.feature_type, f.organism_id,
                         g.genome_accession
                  FROM feature f, organism o, genome g
                  WHERE f.organism_id = o.organism_id
                    AND f.genome_id = g.genome_id
                    AND f.feature_uniquename LIKE ? 
                    AND (o.genus || &#039; &#039; || o.species = ?)
                  ORDER BY f.feature_uniquename
                  &quot;;
        $params = [&quot;%$search_term%&quot;, $organism_name];
    } else {
        $query = &quot;SELECT f.feature_uniquename, f.feature_name, f.feature_description, 
                         o.genus, o.species, o.common_name, o.subtype, f.feature_type, f.organism_id,
                         g.genome_accession
                  FROM feature f, organism o, genome g
                  WHERE f.organism_id = o.organism_id
                    AND f.genome_id = g.genome_id
                    AND f.feature_uniquename LIKE ?
                  ORDER BY f.feature_uniquename
                  &quot;;
        $params = [&quot;%$search_term%&quot;];
    }
    
    return fetchData($query, $dbFile, $params);
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAnnotationSources">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAnnotationSources()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 553</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getAnnotationSources()</div>
                    <div class="function-comment">
                        <pre>/**
* Get all annotation sources for an organism with counts
* Used to populate search help/tutorial
*
* @param string $dbFile - Path to SQLite database
* @return array - Array of sources with name and count
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/get_annotation_sources.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 39</code>: <small>$sources = getAnnotationSources($db);</small></li>
                                    <li><code>line 39</code>: <small>$sources = getAnnotationSources($db);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAnnotationSources($dbFile) {
    try {
        $query = &quot;SELECT DISTINCT 
                         ans.annotation_source_name as name,
                         COUNT(a.annotation_id) as count
                  FROM annotation_source ans
                  LEFT JOIN annotation a ON ans.annotation_source_id = a.annotation_source_id
                  GROUP BY ans.annotation_source_id
                  ORDER BY count DESC&quot;;
        
        return fetchData($query, $dbFile, []);
    } catch (Exception $e) {
        return [];
    }
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAnnotationSourcesByType">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAnnotationSourcesByType()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 576</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/database_queries.php: getAnnotationSourcesByType()</div>
                    <div class="function-comment">
                        <pre>/**
* Get annotation sources grouped by type
* Used to populate advanced search filter modal
*
* @param string $dbFile - Path to SQLite database
* @return array - Grouped sources: {type: [{name, count}, ...], ...}
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/get_annotation_sources_grouped.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 35</code>: <small>$source_types = getAnnotationSourcesByType($db);</small></li>
                                    <li><code>line 35</code>: <small>$source_types = getAnnotationSourcesByType($db);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAnnotationSourcesByType($dbFile) {
    try {
        // Get all sources with their annotation types from the database
        $query = &quot;SELECT 
                    ans.annotation_source_name as name,
                    ans.annotation_type as type,
                    COUNT(a.annotation_id) as count
                  FROM annotation_source ans
                  LEFT JOIN annotation a ON ans.annotation_source_id = a.annotation_source_id
                  GROUP BY ans.annotation_source_id, ans.annotation_type
                  ORDER BY ans.annotation_type, COUNT(a.annotation_id) DESC&quot;;
        
        $sources_with_types = fetchData($query, $dbFile, []);
        
        // Group by annotation_type
        $grouped = [];
        foreach ($sources_with_types as $source) {
            $type = $source[&#039;type&#039;];
            
            if (!isset($grouped[$type])) {
                $grouped[$type] = [];
            }
            
            $grouped[$type][] = [
                &#039;name&#039; =&gt; $source[&#039;name&#039;],
                &#039;count&#039; =&gt; $source[&#039;count&#039;]
            ];
        }
        
        // Sort types in display order
        $order = [&#039;Gene Ontology&#039;, &#039;Gene Families&#039;, &#039;Domains&#039;, &#039;Orthologs&#039;, &#039;Homologs&#039;, &#039;AI Annotations&#039;];
        $sorted = [];
        foreach ($order as $type) {
            if (isset($grouped[$type])) {
                $sorted[$type] = $grouped[$type];
            }
        }
        
        return $sorted;
        
    } catch (Exception $e) {
        return [];
    }
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/extract_search_helpers.php (11)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="parseOrganismParameter">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">parseOrganismParameter()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 29</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: parseOrganismParameter()</div>
                    <div class="function-comment">
                        <pre>/**
* Parse organism parameter from various sources and formats
*
* Handles multiple input formats:
* - Array from multi-search context (organisms[])
* - Single organism from context parameters
* - Comma-separated string
*
* @param string|array $organisms_param - Raw parameter value
* @param string $context_organism - Optional fallback organism
* @return array - [&#039;organisms&#039; =&gt; [], &#039;string&#039; =&gt; &#039;comma,separated,list&#039;]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 44</code>: <small>$organism_result = parseOrganismParameter($organisms_param, $context[&#039;organism&#039;]</small></li>
                                    <li><code>line 44</code>: <small>$organism_result = parseOrganismParameter($organisms_param, $context[&#039;organism&#039;]</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function parseOrganismParameter($organisms_param, $context_organism = &#039;&#039;) {
    $filter_organisms = [];
    $filter_organisms_string = &#039;&#039;;
    
    // First check for array (highest priority - from multi-search)
    if (is_array($organisms_param)) {
        $filter_organisms = array_filter($organisms_param);
        $filter_organisms_string = implode(&#039;,&#039;, $filter_organisms);
    } 
    // Then check for single organism context
    elseif (!empty($context_organism)) {
        $filter_organisms = [$context_organism];
        $filter_organisms_string = $context_organism;
    }
    // Finally try comma-separated string format
    else {
        $filter_organisms_string = trim($organisms_param);
        if (!empty($filter_organisms_string)) {
            $filter_organisms = array_map(&#039;trim&#039;, explode(&#039;,&#039;, $filter_organisms_string));
            $filter_organisms = array_filter($filter_organisms);
        }
    }
    
    return [
        &#039;organisms&#039; =&gt; $filter_organisms,
        &#039;string&#039; =&gt; $filter_organisms_string
    ];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="parseContextParameters">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">parseContextParameters()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 65</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: parseContextParameters()</div>
                    <div class="function-comment">
                        <pre>/**
* Extract context parameters from request
*
* Checks explicit context_* fields first (highest priority), then regular fields as fallback
*
* @return array - [&#039;organism&#039; =&gt; &#039;&#039;, &#039;assembly&#039; =&gt; &#039;&#039;, &#039;group&#039; =&gt; &#039;&#039;, &#039;display_name&#039; =&gt; &#039;&#039;, &#039;context_page&#039; =&gt; &#039;&#039;]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 3 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 41</code>: <small>$context = parseContextParameters();</small></li>
                                    <li><code>line 41</code>: <small>$context = parseContextParameters();</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/retrieve_selected_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 58</code>: <small>$context = parseContextParameters();</small></li>
                                    <li><code>line 58</code>: <small>$context = parseContextParameters();</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/blast.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 31</code>: <small>$context = parseContextParameters();</small></li>
                                    <li><code>line 31</code>: <small>$context = parseContextParameters();</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function parseContextParameters() {
    return [
        &#039;organism&#039; =&gt; trim($_GET[&#039;context_organism&#039;] ?? $_POST[&#039;context_organism&#039;] ?? $_GET[&#039;organism&#039;] ?? $_POST[&#039;organism&#039;] ?? &#039;&#039;),
        &#039;assembly&#039; =&gt; trim($_GET[&#039;context_assembly&#039;] ?? $_POST[&#039;context_assembly&#039;] ?? $_GET[&#039;assembly&#039;] ?? $_POST[&#039;assembly&#039;] ?? &#039;&#039;),
        &#039;group&#039; =&gt; trim($_GET[&#039;context_group&#039;] ?? $_POST[&#039;context_group&#039;] ?? $_GET[&#039;group&#039;] ?? $_POST[&#039;group&#039;] ?? &#039;&#039;),
        &#039;display_name&#039; =&gt; trim($_GET[&#039;display_name&#039;] ?? $_POST[&#039;display_name&#039;] ?? &#039;&#039;),
        &#039;context_page&#039; =&gt; trim($_GET[&#039;context_page&#039;] ?? $_POST[&#039;context_page&#039;] ?? &#039;&#039;)
    ];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="validateExtractInputs">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateExtractInputs()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 86</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: validateExtractInputs()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate extract/search inputs (organism, assembly, feature IDs)
*
* Comprehensive validation for extract operations
*
* @param string $organism - Organism name
* @param string $assembly - Assembly name
* @param string $uniquenames_string - Comma-separated feature IDs
* @param array $accessible_sources - Available assemblies from getAccessibleAssemblies()
* @return array - [&#039;valid&#039; =&gt; bool, &#039;errors&#039; =&gt; [], &#039;fasta_source&#039; =&gt; null]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 74</code>: <small>$validation = validateExtractInputs($selected_organism, $selected_assembly, $uni</small></li>
                                    <li><code>line 74</code>: <small>$validation = validateExtractInputs($selected_organism, $selected_assembly, $uni</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateExtractInputs($organism, $assembly, $uniquenames_string, $accessible_sources) {
    $errors = [];
    $fasta_source = null;
    
    // Check required fields
    if (empty($uniquenames_string)) {
        $errors[] = &quot;No feature IDs provided.&quot;;
    }
    
    if (empty($organism) || empty($assembly)) {
        $errors[] = &quot;No assembly selected.&quot;;
    }
    
    // Find the assembly in accessible sources
    if (empty($errors)) {
        foreach ($accessible_sources as $source) {
            if ($source[&#039;assembly&#039;] === $assembly &amp;&amp; $source[&#039;organism&#039;] === $organism) {
                $fasta_source = $source;
                break;
            }
        }
        
        if (!$fasta_source) {
            $errors[] = &quot;You do not have access to the selected assembly.&quot;;
        }
    }
    
    return [
        &#039;valid&#039; =&gt; empty($errors),
        &#039;errors&#039; =&gt; $errors,
        &#039;fasta_source&#039; =&gt; $fasta_source
    ];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="parseFeatureIds">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">parseFeatureIds()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 128</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: parseFeatureIds()</div>
                    <div class="function-comment">
                        <pre>/**
* Parse and validate feature IDs from user input
*
* Handles both comma and newline separated formats
*
* @param string $uniquenames_string - Comma or newline separated IDs
* @return array - [&#039;valid&#039; =&gt; bool, &#039;uniquenames&#039; =&gt; [], &#039;error&#039; =&gt; &#039;&#039;]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 80</code>: <small>$id_parse = parseFeatureIds($uniquenames_string);</small></li>
                                    <li><code>line 80</code>: <small>$id_parse = parseFeatureIds($uniquenames_string);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/retrieve_selected_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 77</code>: <small>$id_parse = parseFeatureIds($uniquenames_string);</small></li>
                                    <li><code>line 77</code>: <small>$id_parse = parseFeatureIds($uniquenames_string);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function parseFeatureIds($uniquenames_string) {
    $uniquenames = [];
    
    if (empty($uniquenames_string)) {
        return [&#039;valid&#039; =&gt; false, &#039;uniquenames&#039; =&gt; [], &#039;error&#039; =&gt; &#039;No feature IDs provided&#039;];
    }
    
    // Handle both comma and newline separated formats
    $uniquenames = array_filter(array_map(&#039;trim&#039;, 
        preg_split(&#039;/[\n,]+/&#039;, $uniquenames_string)
    ));
    
    if (empty($uniquenames)) {
        return [&#039;valid&#039; =&gt; false, &#039;uniquenames&#039; =&gt; [], &#039;error&#039; =&gt; &#039;No valid feature IDs found&#039;];
    }
    
    return [&#039;valid&#039; =&gt; true, &#039;uniquenames&#039; =&gt; $uniquenames, &#039;error&#039; =&gt; &#039;&#039;];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="extractSequencesForAllTypes">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">extractSequencesForAllTypes()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 159</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: extractSequencesForAllTypes()</div>
                    <div class="function-comment">
                        <pre>/**
* Extract sequences for all available types from BLAST database
*
* Iterates through all sequence types and extracts for the given feature IDs
*
* @param string $assembly_dir - Path to assembly directory
* @param array $uniquenames - Feature IDs to extract
* @param array $sequence_types - Available sequence type configurations (from site_config)
* @param string $organism - Organism name (for parent/child database lookup)
* @param string $assembly - Assembly name (for parent/child database lookup)
* @return array - [&#039;success&#039; =&gt; bool, &#039;content&#039; =&gt; [...], &#039;errors&#039; =&gt; []]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 116</code>: <small>$extract_result = extractSequencesForAllTypes($fasta_source[&#039;path&#039;], $uniquename</small></li>
                                    <li><code>line 116</code>: <small>$extract_result = extractSequencesForAllTypes($fasta_source[&#039;path&#039;], $uniquename</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/retrieve_selected_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 102</code>: <small>$extract_result = extractSequencesForAllTypes($assembly_dir, $uniquenames, $sequ</small></li>
                                    <li><code>line 102</code>: <small>$extract_result = extractSequencesForAllTypes($assembly_dir, $uniquenames, $sequ</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function extractSequencesForAllTypes($assembly_dir, $uniquenames, $sequence_types, $organism = &#039;&#039;, $assembly = &#039;&#039;) {
    $displayed_content = [];
    $errors = [];
    
    foreach ($sequence_types as $seq_type =&gt; $config) {
        $files = glob(&quot;$assembly_dir/*{$config[&#039;pattern&#039;]}&quot;);
        
        if (!empty($files)) {
            $fasta_file = $files[0];
            $extract_result = extractSequencesFromBlastDb($fasta_file, $uniquenames, $organism, $assembly);
            
            if ($extract_result[&#039;success&#039;]) {
                // Remove blank lines
                $lines = explode(&quot;\n&quot;, $extract_result[&#039;content&#039;]);
                $lines = array_filter($lines, function($line) {
                    return trim($line) !== &#039;&#039;;
                });
                $displayed_content[$seq_type] = implode(&quot;\n&quot;, $lines);
            } else {
                $errors[] = &quot;Failed to extract $seq_type sequences&quot;;
            }
        }
    }
    
    // Only report &quot;no sequences found&quot; errors if we got no content at all
    if (empty($displayed_content)) {
        foreach ($sequence_types as $seq_type =&gt; $config) {
            $files = glob(&quot;$assembly_dir/*{$config[&#039;pattern&#039;]}&quot;);
            if (!empty($files)) {
                $fasta_file = $files[0];
                $extract_result = extractSequencesFromBlastDb($fasta_file, $uniquenames, $organism, $assembly);
                if (!empty($extract_result[&#039;error&#039;])) {
                    $errors[] = $extract_result[&#039;error&#039;];
                    break;
                }
            }
        }
    }
    
    return [
        &#039;success&#039; =&gt; !empty($displayed_content),
        &#039;content&#039; =&gt; $displayed_content,
        &#039;errors&#039; =&gt; $errors
    ];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="formatSequenceResults">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">formatSequenceResults()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 214</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: formatSequenceResults()</div>
                    <div class="function-comment">
                        <pre>/**
* Format extracted sequences for display component
*
* Converts extracted content into format expected by sequences_display.php
*
* @param array $displayed_content - Extracted sequences by type
* @param array $sequence_types - Type configurations (from site_config)
* @return array - Formatted for sequences_display.php inclusion
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 388</code>: <small>$available_sequences = formatSequenceResults($displayed_content, $sequence_types</small></li>
                                    <li><code>line 388</code>: <small>$available_sequences = formatSequenceResults($displayed_content, $sequence_types</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/retrieve_selected_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 198</code>: <small>$available_sequences = formatSequenceResults($displayed_content, $sequence_types</small></li>
                                    <li><code>line 198</code>: <small>$available_sequences = formatSequenceResults($displayed_content, $sequence_types</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function formatSequenceResults($displayed_content, $sequence_types) {
    $available_sequences = [];
    
    foreach ($displayed_content as $seq_type =&gt; $content) {
        $available_sequences[$seq_type] = [
            &#039;label&#039; =&gt; $sequence_types[$seq_type][&#039;label&#039;] ?? ucfirst($seq_type),
            &#039;sequences&#039; =&gt; [$content]  // Wrap in array as sequences_display expects
        ];
    }
    
    return $available_sequences;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="sendFileDownload">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">sendFileDownload()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 237</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: sendFileDownload()</div>
                    <div class="function-comment">
                        <pre>/**
* Send file download response and exit
*
* Sets appropriate headers and outputs file content
* Should be called before any HTML output
*
* @param string $content - File content to download
* @param string $sequence_type - Type of sequence (for filename)
* @param string $file_format - Format (fasta or txt)
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 155</code>: <small>sendFileDownload($displayed_content[$sequence_type], $sequence_type, $file_forma</small></li>
                                    <li><code>line 155</code>: <small>sendFileDownload($displayed_content[$sequence_type], $sequence_type, $file_forma</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/retrieve_selected_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 113</code>: <small>sendFileDownload($displayed_content[$sequence_type], $sequence_type, $file_forma</small></li>
                                    <li><code>line 113</code>: <small>sendFileDownload($displayed_content[$sequence_type], $sequence_type, $file_forma</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function sendFileDownload($content, $sequence_type, $file_format = &#039;fasta&#039;) {
    $ext = ($file_format === &#039;txt&#039;) ? &#039;txt&#039; : &#039;fasta&#039;;
    $filename = &quot;sequences_{$sequence_type}_&quot; . date(&quot;Y-m-d_His&quot;) . &quot;.{$ext}&quot;;
    
    header(&#039;Content-Type: application/octet-stream&#039;);
    header(&quot;Content-Disposition: attachment; filename={$filename}&quot;);
    header(&#039;Content-Length: &#039; . strlen($content));
    echo $content;
    exit;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="buildFilteredSourcesList">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">buildFilteredSourcesList()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 257</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: buildFilteredSourcesList()</div>
                    <div class="function-comment">
                        <pre>/**
* Build organism-filtered list of accessible assembly sources
*
* Filters nested sources array by organism list
*
* @param array $sources_by_group - Nested array from getAccessibleAssemblies()
* @param array $filter_organisms - Optional organism filter list
* @return array - Nested array [group][organism][...assemblies]
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function buildFilteredSourcesList($sources_by_group, $filter_organisms = []) {
    $filtered = [];
    
    foreach ($sources_by_group as $group_name =&gt; $organisms) {
        foreach ($organisms as $organism =&gt; $assemblies) {
            // Skip if organism filter is set and this organism is not in it
            if (!empty($filter_organisms) &amp;&amp; !in_array($organism, $filter_organisms)) {
                continue;
            }
            
            if (!isset($filtered[$group_name])) {
                $filtered[$group_name] = [];
            }
            $filtered[$group_name][$organism] = $assemblies;
        }
    }
    
    return $filtered;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="flattenSourcesList">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">flattenSourcesList()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 286</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: flattenSourcesList()</div>
                    <div class="function-comment">
                        <pre>/**
* Flatten nested sources array for sequential processing
*
* Converts nested [group][organism][...sources] structure to flat list
* Useful for iterating all sources without nested loops
*
* @param array $sources_by_group - Nested array from getAccessibleAssemblies()
* @return array - Flat list of all sources
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 52</code>: <small>$accessible_sources = flattenSourcesList($sources_by_group);</small></li>
                                    <li><code>line 52</code>: <small>$accessible_sources = flattenSourcesList($sources_by_group);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function flattenSourcesList($sources_by_group) {
    $accessible_sources = [];
    
    foreach ($sources_by_group as $group =&gt; $organisms) {
        foreach ($organisms as $org =&gt; $assemblies) {
            $accessible_sources = array_merge($accessible_sources, $assemblies);
        }
    }
    
    return $accessible_sources;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="assignGroupColors">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">assignGroupColors()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 307</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: assignGroupColors()</div>
                    <div class="function-comment">
                        <pre>/**
* Assign Bootstrap colors to groups for consistent UI display
*
* Uses Bootstrap color palette cyclically across groups
* Same group always gets same color (idempotent)
*
* @param array $sources_by_group - Groups to assign colors to
* @return array - [group_name =&gt; bootstrap_color]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 253</code>: <small>$group_color_map = assignGroupColors($sources_by_group);</small></li>
                                    <li><code>line 253</code>: <small>$group_color_map = assignGroupColors($sources_by_group);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function assignGroupColors($sources_by_group) {
    $group_colors = [&#039;primary&#039;, &#039;success&#039;, &#039;info&#039;, &#039;warning&#039;, &#039;danger&#039;, &#039;secondary&#039;, &#039;dark&#039;];
    $group_color_map = [];
    
    foreach ($sources_by_group as $group_name =&gt; $organisms) {
        if (!isset($group_color_map[$group_name])) {
            $group_color_map[$group_name] = $group_colors[count($group_color_map) % count($group_colors)];
        }
    }
    
    return $group_color_map;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAvailableSequenceTypesForDisplay">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAvailableSequenceTypesForDisplay()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 330</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/extract_search_helpers.php: getAvailableSequenceTypesForDisplay()</div>
                    <div class="function-comment">
                        <pre>/**
* Get available sequence types from all accessible sources
*
* Scans assembly directories to determine which sequence types are available
* Useful for populating UI dropdowns/display options
*
* @param array $accessible_sources - Flattened list of sources
* @param array $sequence_types - Type configurations (from site_config)
* @return array - [type =&gt; label] for types that have available files
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 160</code>: <small>$available_types = getAvailableSequenceTypesForDisplay($accessible_sources, $seq</small></li>
                                    <li><code>line 160</code>: <small>$available_types = getAvailableSequenceTypesForDisplay($accessible_sources, $seq</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAvailableSequenceTypesForDisplay($accessible_sources, $sequence_types) {
    $available_types = [];
    
    foreach ($accessible_sources as $source) {
        foreach ($sequence_types as $seq_type =&gt; $config) {
            $files = glob($source[&#039;path&#039;] . &quot;/*{$config[&#039;pattern&#039;]}&quot;);
            if (!empty($files)) {
                $available_types[$seq_type] = $config[&#039;label&#039;];
            }
        }
    }
    
    return $available_types;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_access.php (3)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="getAccessibleAssemblies">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAccessibleAssemblies()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 15</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_access.php: getAccessibleAssemblies()</div>
                    <div class="function-comment">
                        <pre>/**
* Get assemblies accessible to current user
* Filters assemblies based on user access level and group membership
*
* @param string $specific_organism Optional organism to filter by
* @param string $specific_assembly Optional assembly to filter by
* @return array Organized by group -&gt; organism, or assemblies for specific organism/assembly
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 51</code>: <small>$sources_by_group = getAccessibleAssemblies();</small></li>
                                    <li><code>line 51</code>: <small>$sources_by_group = getAccessibleAssemblies();</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/blast.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 93</code>: <small>$sources_by_group = getAccessibleAssemblies();</small></li>
                                    <li><code>line 93</code>: <small>$sources_by_group = getAccessibleAssemblies();</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAccessibleAssemblies($specific_organism = null, $specific_assembly = null) {
    $config = ConfigManager::getInstance();
    $organism_data = $config-&gt;getPath(&#039;organism_data&#039;);
    $metadata_path = $config-&gt;getPath(&#039;metadata_path&#039;);
    
    // Load groups data
    $groups_data = [];
    $groups_file = &quot;$metadata_path/organism_assembly_groups.json&quot;;
    if (file_exists($groups_file)) {
        $groups_data = json_decode(file_get_contents($groups_file), true) ?: [];
    }
    
    $accessible_sources = [];
    
    // Filter entries based on referrer (specific org/assembly or all)
    $entries_to_process = $groups_data;
    
    if (!empty($specific_organism)) {
        $entries_to_process = array_filter($groups_data, function($entry) use ($specific_organism) {
            return $entry[&#039;organism&#039;] === $specific_organism;
        });
    }
    
    if (!empty($specific_assembly)) {
        $entries_to_process = array_filter($entries_to_process, function($entry) use ($specific_assembly) {
            return $entry[&#039;assembly&#039;] === $specific_assembly;
        });
    }
    
    // Build list of accessible sources using assembly-based permissions
    foreach ($entries_to_process as $entry) {
        $org = $entry[&#039;organism&#039;];
        $assembly = $entry[&#039;assembly&#039;];
        $entry_groups = $entry[&#039;groups&#039;] ?? [];
        
        // Check if user has access to this specific assembly
        // 1. ALL/Admin users have access to everything
        // 2. Public assemblies are accessible to everyone
        // 3. Collaborators can access assemblies in their $_SESSION[&#039;access&#039;] list
        $access_granted = false;
        
        if (has_access(&#039;ALL&#039;)) {
            $access_granted = true;
        } elseif (is_public_assembly($org, $assembly)) {
            $access_granted = true;
        } elseif (has_access(&#039;Collaborator&#039;)) {
            // Check if user has access to this specific assembly
            $user_access = get_user_access();
            if (isset($user_access[$org]) &amp;&amp; is_array($user_access[$org]) &amp;&amp; in_array($assembly, $user_access[$org])) {
                $access_granted = true;
            }
        }
        
        if ($access_granted) {
            $assembly_path = &quot;$organism_data/$org/$assembly&quot;;
            
            // Only include assembly if directory exists AND has FASTA files
            if (is_dir($assembly_path)) {
                // Check if assembly has any FASTA files (protein, transcript, cds, or genome)
                $has_fasta = false;
                foreach ([&#039;.fa&#039;, &#039;.fasta&#039;, &#039;.faa&#039;, &#039;.nt.fa&#039;, &#039;.aa.fa&#039;] as $ext) {
                    if (glob(&quot;$assembly_path/*$ext&quot;)) {
                        $has_fasta = true;
                        break;
                    }
                }
                
                if ($has_fasta) {
                    $accessible_sources[] = [
                        &#039;organism&#039; =&gt; $org,
                        &#039;assembly&#039; =&gt; $assembly,
                        &#039;path&#039; =&gt; $assembly_path,
                        &#039;groups&#039; =&gt; $entry_groups
                    ];
                }
            }
        }
    }
    
    // Organize by group -&gt; organism
    $organized = [];
    foreach ($accessible_sources as $source) {
        foreach ($source[&#039;groups&#039;] as $group) {
            if (!isset($organized[$group])) {
                $organized[$group] = [];
            }
            $org = $source[&#039;organism&#039;];
            if (!isset($organized[$group][$org])) {
                $organized[$group][$org] = [];
            }
            $organized[$group][$org][] = $source;
        }
    }
    
    // Sort groups (Public first, then alphabetically)
    uksort($organized, function($a, $b) {
        if ($a === &#039;Public&#039;) return -1;
        if ($b === &#039;Public&#039;) return 1;
        return strcasecmp($a, $b);
    });
    
    // Sort organisms within each group alphabetically
    foreach ($organized as &amp;$group_data) {
        ksort($group_data);
    }
    
    return $organized;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getPhyloTreeUserAccess">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getPhyloTreeUserAccess()</div>
                            <span class="function-counter">1</span>
                            <div class="function-line">Line 131</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_access.php: getPhyloTreeUserAccess()</div>
                    <div class="function-comment">
                        <pre>/**
* Get phylogenetic tree user access for display
* Returns organisms accessible to current user for phylo tree display
*
* @param array $group_data Array of organism/assembly/groups data
* @return array Array of accessible organisms with true value
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (1 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/index.php</strong> (1x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 25</code>: <small>$phylo_user_access = getPhyloTreeUserAccess($group_data);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getPhyloTreeUserAccess($group_data) {
    $phylo_user_access = [];
    
    if (get_access_level() === &#039;ALL&#039; || get_access_level() === &#039;Admin&#039;) {
        // Admin gets access to all organisms
        foreach ($group_data as $data) {
            $organism = $data[&#039;organism&#039;];
            if (!isset($phylo_user_access[$organism])) {
                $phylo_user_access[$organism] = true;
            }
        }
    } elseif (is_logged_in()) {
        // Logged-in users get their specific access
        $phylo_user_access = get_user_access();
    } else {
        // Public users: get organisms in Public group
        foreach ($group_data as $data) {
            if (in_array(&#039;Public&#039;, $data[&#039;groups&#039;])) {
                $organism = $data[&#039;organism&#039;];
                if (!isset($phylo_user_access[$organism])) {
                    $phylo_user_access[$organism] = true;
                }
            }
        }
    }
    
    return $phylo_user_access;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="requireAccess">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">requireAccess()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 170</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_access.php: requireAccess()</div>
                    <div class="function-comment">
                        <pre>/**
* Require user to have specific access level or redirect to access denied
*
* @param string $level Required access level (e.g., &#039;Collaborator&#039;, &#039;Admin&#039;)
* @param string $resource Resource name (e.g., group name or organism name)
* @param array $options Options array with keys:
*   - redirect_on_deny (bool, default: true) - Redirect to deny page if no access
*   - deny_page (string, default: /$site/access_denied.php) - URL to redirect to
* @return bool True if user has access, false otherwise
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/groups_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 39</code>: <small>requireAccess(&#039;Collaborator&#039;, $group_name);</small></li>
                                    <li><code>line 39</code>: <small>requireAccess(&#039;Collaborator&#039;, $group_name);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function requireAccess($level, $resource, $options = []) {
    global $site;
    
    $redirect_on_deny = $options[&#039;redirect_on_deny&#039;] ?? true;
    $deny_page = $options[&#039;deny_page&#039;] ?? &quot;/$site/access_denied.php&quot;;
    
    $has_access = has_access($level, $resource);
    
    if (!$has_access &amp;&amp; $redirect_on_deny) {
        header(&quot;Location: $deny_page&quot;);
        exit;
    }
    
    return $has_access;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_data.php (14)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="getGroupData">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getGroupData()</div>
                            <span class="function-counter">7</span>
                            <div class="function-line">Line 12</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: getGroupData()</div>
                    <div class="function-comment">
                        <pre>/**
* Get group metadata from organism_assembly_groups.json
*
* @return array Array of organism/assembly/groups data
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 4 unique file(s) (7 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/groups_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 23</code>: <small>$group_data = getGroupData();</small></li>
                                    <li><code>line 23</code>: <small>$group_data = getGroupData();</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/organism_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 198</code>: <small>$group_data = getGroupData();</small></li>
                                    <li><code>line 198</code>: <small>$group_data = getGroupData();</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 25</code>: <small>$group_data = getGroupData();</small></li>
                                    <li><code>line 25</code>: <small>$group_data = getGroupData();</small></li>
                                </ul></li>
                            <li><strong>/data/moop/index.php</strong> (1x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 15</code>: <small>$group_data = getGroupData();</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getGroupData() {
    $config = ConfigManager::getInstance();
    $metadata_path = $config-&gt;getPath(&#039;metadata_path&#039;);
    $groups_file = &quot;$metadata_path/organism_assembly_groups.json&quot;;
    $groups_data = [];
    if (file_exists($groups_file)) {
        $groups_data = json_decode(file_get_contents($groups_file), true);
    }
    return $groups_data;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAllGroupCards">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAllGroupCards()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 30</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: getAllGroupCards()</div>
                    <div class="function-comment">
                        <pre>/**
* Get all group cards from metadata
* Returns card objects for every group in the system
*
* @param array $group_data Array of organism/assembly/groups data
* @return array Associative array of group_name =&gt; card_info
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 166</code>: <small>$all_cards = getAllGroupCards($group_data);</small></li>
                                    <li><code>line 166</code>: <small>$all_cards = getAllGroupCards($group_data);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAllGroupCards($group_data) {
    $cards = [];
    foreach ($group_data as $data) {
        foreach ($data[&#039;groups&#039;] as $group) {
            if (!isset($cards[$group])) {
                $cards[$group] = [
                    &#039;title&#039; =&gt; $group,
                    &#039;text&#039; =&gt; &quot;Explore $group Data&quot;,
                    &#039;link&#039; =&gt; &#039;tools/groups_display.php?group=&#039; . urlencode($group)
                ];
            }
        }
    }
    return $cards;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getPublicGroupCards">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getPublicGroupCards()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 53</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: getPublicGroupCards()</div>
                    <div class="function-comment">
                        <pre>/**
* Get group cards that have at least one public assembly
* Returns card objects only for groups containing assemblies in the &quot;Public&quot; group
*
* @param array $group_data Array of organism/assembly/groups data
* @return array Associative array of group_name =&gt; card_info for public groups only
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 172</code>: <small>$cards_to_display = getPublicGroupCards($group_data);</small></li>
                                    <li><code>line 186</code>: <small>$cards_to_display = getPublicGroupCards($group_data);</small></li>
                                    <li><code>line 172</code>: <small>$cards_to_display = getPublicGroupCards($group_data);</small></li>
                                    <li><code>line 186</code>: <small>$cards_to_display = getPublicGroupCards($group_data);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getPublicGroupCards($group_data) {
    $public_groups = [];
    
    // Find all groups that contain at least one public assembly
    foreach ($group_data as $data) {
        if (in_array(&#039;Public&#039;, $data[&#039;groups&#039;])) {
            foreach ($data[&#039;groups&#039;] as $group) {
                if (!isset($public_groups[$group])) {
                    $public_groups[$group] = [
                        &#039;title&#039; =&gt; $group,
                        &#039;text&#039; =&gt; &quot;Explore $group Data&quot;,
                        &#039;link&#039; =&gt; &#039;tools/groups_display.php?group=&#039; . urlencode($group)
                    ];
                }
            }
        }
    }
    return $public_groups;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAccessibleOrganismsInGroup">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAccessibleOrganismsInGroup()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 81</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: getAccessibleOrganismsInGroup()</div>
                    <div class="function-comment">
                        <pre>/**
* Filter organisms in a group to only those with at least one accessible assembly
* Respects user permissions for assembly access
*
* @param string $group_name The group name to filter
* @param array $group_data Array of organism/assembly/groups data
* @return array Filtered array of organism =&gt; [accessible_assemblies]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/groups_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 35</code>: <small>$group_organisms = getAccessibleOrganismsInGroup($group_name, $group_data);</small></li>
                                    <li><code>line 35</code>: <small>$group_organisms = getAccessibleOrganismsInGroup($group_name, $group_data);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAccessibleOrganismsInGroup($group_name, $group_data) {
    $group_organisms = [];
    
    // Find all organisms/assemblies in this group
    foreach ($group_data as $data) {
        if (in_array($group_name, $data[&#039;groups&#039;])) {
            $organism = $data[&#039;organism&#039;];
            $assembly = $data[&#039;assembly&#039;];
            
            if (!isset($group_organisms[$organism])) {
                $group_organisms[$organism] = [];
            }
            $group_organisms[$organism][] = $assembly;
        }
    }
    
    // Filter: only keep organisms with at least one accessible assembly
    $accessible_organisms = [];
    foreach ($group_organisms as $organism =&gt; $assemblies) {
        $has_accessible_assembly = false;
        
        foreach ($assemblies as $assembly) {
            // Check if user has access to this specific assembly
            if (has_assembly_access($organism, $assembly)) {
                $has_accessible_assembly = true;
                break;
            }
        }
        
        if ($has_accessible_assembly) {
            $accessible_organisms[$organism] = $assemblies;
        }
    }
    
    // Sort organisms alphabetically
    ksort($accessible_organisms);
    
    return $accessible_organisms;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAssemblyFastaFiles">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAssemblyFastaFiles()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 131</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: getAssemblyFastaFiles()</div>
                    <div class="function-comment">
                        <pre>/**
* Get FASTA files for an assembly
*
* Scans the assembly directory for FASTA files matching configured sequence types.
* Uses patterns from $sequence_types global to identify file types (genome, protein, transcript, cds).
*
* @param string $organism_name The organism name
* @param string $assembly_name The assembly name (accession)
* @return array Associative array of type =&gt; [&#039;path&#039; =&gt; relative_path, &#039;label&#039; =&gt; label]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/assembly_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 108</code>: <small>$fasta_files = getAssemblyFastaFiles($organism_name, $assembly_accession);</small></li>
                                    <li><code>line 108</code>: <small>$fasta_files = getAssemblyFastaFiles($organism_name, $assembly_accession);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/organism_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 218</code>: <small>&lt;?php $fasta_files = getAssemblyFastaFiles($organism_name, $assembly); ?&gt;</small></li>
                                    <li><code>line 218</code>: <small>&lt;?php $fasta_files = getAssemblyFastaFiles($organism_name, $assembly); ?&gt;</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAssemblyFastaFiles($organism_name, $assembly_name) {
    $config = ConfigManager::getInstance();
    $organism_data = $config-&gt;getPath(&#039;organism_data&#039;);
    $sequence_types = $config-&gt;getSequenceTypes();
    $fasta_files = [];
    $assembly_dir = &quot;$organism_data/$organism_name/$assembly_name&quot;;
    
    if (is_dir($assembly_dir)) {
        $fasta_files_found = glob($assembly_dir . &#039;/*.fa&#039;);
        foreach ($fasta_files_found as $fasta_file) {
            $filename = basename($fasta_file);
            $relative_path = &quot;$organism_name/$assembly_name/$filename&quot;;
            
            foreach ($sequence_types as $type =&gt; $config) {
                if (strpos($filename, $config[&#039;pattern&#039;]) !== false) {
                    $fasta_files[$type] = [
                        &#039;path&#039; =&gt; $relative_path,
                        &#039;label&#039; =&gt; $config[&#039;label&#039;]
                    ];
                    break;
                }
            }
        }
    }
    return $fasta_files;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getIndexDisplayCards">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getIndexDisplayCards()</div>
                            <span class="function-counter">1</span>
                            <div class="function-line">Line 164</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: getIndexDisplayCards()</div>
                    <div class="function-comment">
                        <pre>/**
* Get cards to display on index page based on user access level
*
* @param array $group_data Array of group data from getGroupData()
* @return array Cards to display with title, text, and link
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (1 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/index.php</strong> (1x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 18</code>: <small>$cards_to_display = getIndexDisplayCards($group_data);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getIndexDisplayCards($group_data) {
    $cards_to_display = [];
    $all_cards = getAllGroupCards($group_data);
    
    if (get_access_level() === &#039;ALL&#039; || get_access_level() === &#039;Admin&#039;) {
        $cards_to_display = $all_cards;
    } elseif (is_logged_in()) {
        // Logged-in users see: public groups + their permitted organisms
        $cards_to_display = getPublicGroupCards($group_data);
        
        foreach (get_user_access() as $organism =&gt; $assemblies) {
            if (!isset($cards_to_display[$organism])) {
                $formatted_name = formatIndexOrganismName($organism);
                $cards_to_display[$organism] = [
                    &#039;title&#039; =&gt; $formatted_name,
                    &#039;text&#039;  =&gt; &quot;Explore &quot; . strip_tags($formatted_name) . &quot; Data&quot;,
                    &#039;link&#039;  =&gt; &#039;tools/organism_display.php?organism=&#039; . urlencode($organism)
                ];
            }
        }
    } else {
        // Visitors see only groups with public assemblies
        $cards_to_display = getPublicGroupCards($group_data);
    }
    
    return $cards_to_display;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="formatIndexOrganismName">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">formatIndexOrganismName()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 176</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: formatIndexOrganismName()</div>
                    <div class="function-comment">
                        <pre>/**
* Format organism name for index page display with italics
*
* @param string $organism Organism name with underscores
* @return string Formatted name with proper capitalization and italics
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 176</code>: <small>$formatted_name = formatIndexOrganismName($organism);</small></li>
                                    <li><code>line 176</code>: <small>$formatted_name = formatIndexOrganismName($organism);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function formatIndexOrganismName($organism) {
    $parts = explode(&#039;_&#039;, $organism);
    $formatted_name = ucfirst(strtolower($parts[0]));
    for ($i = 1; $i &lt; count($parts); $i++) {
        $formatted_name .= &#039; &#039; . strtolower($parts[$i]);
    }
    return &#039;&lt;i&gt;&#039; . $formatted_name . &#039;&lt;/i&gt;&#039;;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="loadAllOrganismsMetadata">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">loadAllOrganismsMetadata()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 214</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: loadAllOrganismsMetadata()</div>
                    <div class="function-comment">
                        <pre>/**
* Load all organisms&#039; JSON metadata from organism_data directory
* Central function used by manage_organisms.php and manage_phylo_tree.php
*
* @param string $organism_data_dir Path to organism data directory
* @return array Associative array of organism_name =&gt; metadata
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 540</code>: <small>$organisms_metadata = loadAllOrganismsMetadata($organism_data_path);</small></li>
                                    <li><code>line 540</code>: <small>$organisms_metadata = loadAllOrganismsMetadata($organism_data_path);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_phylo_tree.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 24</code>: <small>$organisms = loadAllOrganismsMetadata($organism_data_dir);</small></li>
                                    <li><code>line 24</code>: <small>$organisms = loadAllOrganismsMetadata($organism_data_dir);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function loadAllOrganismsMetadata($organism_data_dir) {
    $organisms = [];
    
    if (!is_dir($organism_data_dir)) {
        return $organisms;
    }
    
    $entries = scandir($organism_data_dir);
    foreach ($entries as $organism) {
        // Skip hidden directories and non-directories
        if ($organism[0] === &#039;.&#039; || !is_dir(&quot;$organism_data_dir/$organism&quot;)) {
            continue;
        }
        
        // Load organism.json using loadJsonFile (from functions_json.php)
        $organism_json_path = &quot;$organism_data_dir/$organism/organism.json&quot;;
        $organism_info = loadJsonFile($organism_json_path);
        
        if (!$organism_info) {
            continue;
        }
        
        // Handle improperly wrapped JSON (extra outer braces)
        if (!isset($organism_info[&#039;genus&#039;]) &amp;&amp; !isset($organism_info[&#039;common_name&#039;])) {
            $keys = array_keys($organism_info);
            if (count($keys) &gt; 0 &amp;&amp; is_array($organism_info[$keys[0]]) &amp;&amp; isset($organism_info[$keys[0]][&#039;genus&#039;])) {
                $organism_info = $organism_info[$keys[0]];
            }
        }
        
        // Store organism metadata keyed by organism name
        $organisms[$organism] = [
            &#039;genus&#039; =&gt; $organism_info[&#039;genus&#039;] ?? &#039;&#039;,
            &#039;species&#039; =&gt; $organism_info[&#039;species&#039;] ?? &#039;&#039;,
            &#039;common_name&#039; =&gt; $organism_info[&#039;common_name&#039;] ?? &#039;&#039;,
            &#039;taxon_id&#039; =&gt; $organism_info[&#039;taxon_id&#039;] ?? &#039;&#039;
        ];
    }
    
    return $organisms;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getOrganismsWithAssemblies">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getOrganismsWithAssemblies()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 266</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: getOrganismsWithAssemblies()</div>
                    <div class="function-comment">
                        <pre>/**
* Get all organisms with their assemblies from filesystem
*
* Scans the organism data directory and returns a map of organisms to their assemblies.
* Used for user permission management and group configuration.
* Note: Database may have different/cached info - use this for filesystem truth.
*
* @param string $organism_data_path Path to organism data directory
* @return array Associative array of organism_name =&gt; array of assembly names
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/createUser.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 146</code>: <small>$organisms = getOrganismsWithAssemblies($config-&gt;getPath(&#039;organism_data&#039;));</small></li>
                                    <li><code>line 146</code>: <small>$organisms = getOrganismsWithAssemblies($config-&gt;getPath(&#039;organism_data&#039;));</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_groups.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 45</code>: <small>$all_organisms = getOrganismsWithAssemblies($organism_data_path);</small></li>
                                    <li><code>line 45</code>: <small>$all_organisms = getOrganismsWithAssemblies($organism_data_path);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getOrganismsWithAssemblies($organism_data_path) {
    $orgs = [];
    
    if (!is_dir($organism_data_path)) {
        return $orgs;
    }
    
    $organisms = scandir($organism_data_path);
    foreach ($organisms as $organism) {
        if ($organism[0] === &#039;.&#039; || !is_dir(&quot;$organism_data_path/$organism&quot;)) {
            continue;
        }
        
        $assemblies = [];
        $assemblyPath = &quot;$organism_data_path/$organism&quot;;
        $files = scandir($assemblyPath);
        foreach ($files as $file) {
            if ($file[0] === &#039;.&#039; || !is_dir(&quot;$assemblyPath/$file&quot;)) {
                continue;
            }
            $assemblies[] = $file;
        }
        $orgs[$organism] = $assemblies;
    }
    return $orgs;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAllExistingGroups">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAllExistingGroups()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 302</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: getAllExistingGroups()</div>
                    <div class="function-comment">
                        <pre>/**
* Get all existing groups from group data
*
* Extracts unique group names from organism_assembly_groups.json data
* and returns a sorted list
*
* @param array $groups_data Array of organism/assembly/groups data
* @return array Sorted list of unique group names
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_groups.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 47</code>: <small>$all_existing_groups = getAllExistingGroups($groups_data);</small></li>
                                    <li><code>line 242</code>: <small>$existing_groups = getAllExistingGroups($groups_data);</small></li>
                                    <li><code>line 47</code>: <small>$all_existing_groups = getAllExistingGroups($groups_data);</small></li>
                                    <li><code>line 242</code>: <small>$existing_groups = getAllExistingGroups($groups_data);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAllExistingGroups($groups_data) {
    $all_groups = [];
    foreach ($groups_data as $data) {
        if (!empty($data[&#039;groups&#039;])) {
            foreach ($data[&#039;groups&#039;] as $group) {
                $all_groups[$group] = true;
            }
        }
    }
    $group_list = array_keys($all_groups);
    sort($group_list);
    return $group_list;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="syncGroupDescriptions">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">syncGroupDescriptions()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 326</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: syncGroupDescriptions()</div>
                    <div class="function-comment">
                        <pre>/**
* Sync group descriptions with existing groups
*
* Marks groups as in_use=true, marks unused groups as in_use=false,
* and creates default structure for new groups
*
* @param array $existing_groups List of group names that exist
* @param array $descriptions_data Current group descriptions
* @return array Updated descriptions with synced in_use status
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_groups.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 49</code>: <small>$updated_descriptions = syncGroupDescriptions($all_existing_groups, $description</small></li>
                                    <li><code>line 49</code>: <small>$updated_descriptions = syncGroupDescriptions($all_existing_groups, $description</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function syncGroupDescriptions($existing_groups, $descriptions_data) {
    $desc_map = [];
    foreach ($descriptions_data as $desc) {
        $desc_map[$desc[&#039;group_name&#039;]] = $desc;
    }
    
    $updated_descriptions = [];
    
    // Update existing groups to in_use = true
    foreach ($existing_groups as $group) {
        if (isset($desc_map[$group])) {
            $desc_map[$group][&#039;in_use&#039;] = true;
            $updated_descriptions[] = $desc_map[$group];
        } else {
            // New group - add with default structure
            $updated_descriptions[] = [
                &#039;group_name&#039; =&gt; $group,
                &#039;images&#039; =&gt; [
                    [
                        &#039;file&#039; =&gt; &#039;&#039;,
                        &#039;caption&#039; =&gt; &#039;&#039;
                    ]
                ],
                &#039;html_p&#039; =&gt; [
                    [
                        &#039;text&#039; =&gt; &#039;&#039;,
                        &#039;style&#039; =&gt; &#039;&#039;,
                        &#039;class&#039; =&gt; &#039;&#039;
                    ]
                ],
                &#039;in_use&#039; =&gt; true
            ];
        }
        unset($desc_map[$group]);
    }
    
    // Mark any remaining groups (not in existing groups) as in_use = false
    foreach ($desc_map as $group_name =&gt; $desc) {
        $desc[&#039;in_use&#039;] = false;
        $updated_descriptions[] = $desc;
    }
    
    return $updated_descriptions;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="fetch_taxonomy_lineage">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">fetch_taxonomy_lineage()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 380</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: fetch_taxonomy_lineage()</div>
                    <div class="function-comment">
                        <pre>/**
* Fetch taxonomic lineage from NCBI using XML parsing
*
* Retrieves the full taxonomic classification for an organism using NCBI&#039;s API
* and returns it as an array of rank =&gt; name pairs
*
* @param int $taxon_id NCBI Taxonomy ID
* @return array|null Array of [&#039;rank&#039; =&gt; x, &#039;name&#039; =&gt; y] entries, or null if failed
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 465</code>: <small>$lineage = fetch_taxonomy_lineage($data[&#039;taxon_id&#039;]);</small></li>
                                    <li><code>line 465</code>: <small>$lineage = fetch_taxonomy_lineage($data[&#039;taxon_id&#039;]);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function fetch_taxonomy_lineage($taxon_id) {
    $url = &quot;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=taxonomy&amp;id={$taxon_id}&amp;retmode=xml&quot;;
    
    $context = stream_context_create([
        &#039;http&#039; =&gt; [
            &#039;timeout&#039; =&gt; 10,
            &#039;user_agent&#039; =&gt; &#039;MOOP Phylo Tree Generator&#039;
        ]
    ]);
    $response = @file_get_contents($url, false, $context);
    
    if ($response === false) {
        return null;
    }
    
    // Parse XML using regex since SimpleXML isn&#039;t always available
    $lineage = [];
    
    // Extract Lineage text (semicolon-separated)
    if (preg_match(&#039;/&lt;Lineage&gt;(.+?)&lt;\/Lineage&gt;/s&#039;, $response, $matches)) {
        $lineage_text = trim($matches[1]);
        $lineage_parts = array_filter(array_map(&#039;trim&#039;, explode(&#039;;&#039;, $lineage_text)));
        
        // Extract ranks from LineageEx
        $rank_map = [];
        if (preg_match_all(&#039;/&lt;Taxon&gt;.*?&lt;ScientificName&gt;(.+?)&lt;\/ScientificName&gt;.*?&lt;Rank&gt;(.+?)&lt;\/Rank&gt;.*?&lt;\/Taxon&gt;/s&#039;, $response, $matches, PREG_SET_ORDER)) {
            foreach ($matches as $match) {
                $sci_name = trim($match[1]);
                $rank = trim($match[2]);
                $rank_map[$sci_name] = $rank;
            }
        }
        
        // Build lineage array with matched ranks
        $valid_ranks = [&#039;superkingdom&#039;, &#039;kingdom&#039;, &#039;phylum&#039;, &#039;class&#039;, &#039;order&#039;, &#039;family&#039;, &#039;genus&#039;];
        foreach ($lineage_parts as $name) {
            $rank = $rank_map[$name] ?? null;
            
            // Map domain to superkingdom
            if ($rank === &#039;domain&#039;) {
                $rank = &#039;superkingdom&#039;;
            }
            
            // Only include standard taxonomic ranks (skip intermediate ranks like &#039;clade&#039;)
            if ($rank &amp;&amp; in_array($rank, $valid_ranks)) {
                $lineage[] = [
                    &#039;rank&#039; =&gt; $rank,
                    &#039;name&#039; =&gt; $name
                ];
            }
        }
    }
    
    // Add the species itself
    if (preg_match(&#039;/&lt;ScientificName&gt;(.+?)&lt;\/ScientificName&gt;/&#039;, $response, $matches)) {
        $sci_name = trim($matches[1]);
        // Only add if it&#039;s not already in lineage
        if (empty($lineage) || $lineage[count($lineage)-1][&#039;name&#039;] !== $sci_name) {
            $lineage[] = [
                &#039;rank&#039; =&gt; &#039;species&#039;,
                &#039;name&#039; =&gt; $sci_name
            ];
        }
    }
    
    return !empty($lineage) ? $lineage : null;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="build_tree_from_organisms">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">build_tree_from_organisms()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 457</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: build_tree_from_organisms()</div>
                    <div class="function-comment">
                        <pre>/**
* Build phylogenetic tree from organisms
*
* Creates a hierarchical tree structure from a list of organisms by fetching
* their taxonomic lineage from NCBI and organizing by taxonomic ranks
*
* @param array $organisms Array of organism_name =&gt; [&#039;taxon_id&#039; =&gt; x, &#039;common_name&#039; =&gt; y, ...]
* @return array Tree structure: [&#039;tree&#039; =&gt; [...]]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_phylo_tree.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 38</code>: <small>$tree_data = build_tree_from_organisms($organisms);</small></li>
                                    <li><code>line 38</code>: <small>$tree_data = build_tree_from_organisms($organisms);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function build_tree_from_organisms($organisms) {
    $all_lineages = [];
    
    foreach ($organisms as $organism_name =&gt; $data) {
        if (empty($data[&#039;taxon_id&#039;])) {
            continue;
        }
        
        $lineage = fetch_taxonomy_lineage($data[&#039;taxon_id&#039;]);
        $image = fetch_organism_image($data[&#039;taxon_id&#039;], $organism_name);
        if ($lineage) {
            $all_lineages[$organism_name] = [
                &#039;lineage&#039; =&gt; $lineage,
                &#039;common_name&#039; =&gt; $data[&#039;common_name&#039;],
                &#039;image&#039; =&gt; $image
            ];
        }
        
        // Be nice to NCBI - rate limit
        usleep(350000); // 350ms = ~3 requests per second
    }
    
    // Build tree structure
    $tree = [&#039;name&#039; =&gt; &#039;Life&#039;, &#039;children&#039; =&gt; []];
    
    foreach ($all_lineages as $organism_name =&gt; $info) {
        $current = &amp;$tree;
        
        foreach ($info[&#039;lineage&#039;] as $level) {
            $name = $level[&#039;name&#039;];
            $rank = $level[&#039;rank&#039;];
            
            // Find or create child node
            $found = false;
            foreach ($current[&#039;children&#039;] as &amp;$child) {
                if ($child[&#039;name&#039;] === $name) {
                    $current = &amp;$child;
                    $found = true;
                    break;
                }
            }
            
            if (!$found) {
                $new_node = [&#039;name&#039; =&gt; $name];
                
                // If this is the species level, add organism info
                if ($rank === &#039;species&#039;) {
                    $new_node[&#039;organism&#039;] = $organism_name;
                    $new_node[&#039;common_name&#039;] = $info[&#039;common_name&#039;];
                    if ($info[&#039;image&#039;]) {
                        $new_node[&#039;image&#039;] = $info[&#039;image&#039;];
                    }
                } else {
                    $new_node[&#039;children&#039;] = [];
                }
                
                $current[&#039;children&#039;][] = $new_node;
                $current = &amp;$current[&#039;children&#039;][count($current[&#039;children&#039;]) - 1];
            }
        }
    }
    
    return [&#039;tree&#039; =&gt; $tree];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getDetailedOrganismsInfo">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getDetailedOrganismsInfo()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 532</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_data.php: getDetailedOrganismsInfo()</div>
                    <div class="function-comment">
                        <pre>/**
* Get detailed information about all organisms
*
* Aggregates organism metadata, assemblies, database info, and validation results
* for all organisms in the system. Used for admin management and reporting.
*
* @param string $organism_data_path Path to organism data directory
* @param array $sequence_types List of valid sequence types (e.g., [&#039;cds&#039;, &#039;protein&#039;, &#039;genome&#039;])
* @return array Associative array of organism_name =&gt; array with metadata, assemblies, validations
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_organisms.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 158</code>: <small>$organisms = getDetailedOrganismsInfo($organism_data, $sequence_types);</small></li>
                                    <li><code>line 158</code>: <small>$organisms = getDetailedOrganismsInfo($organism_data, $sequence_types);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getDetailedOrganismsInfo($organism_data_path, $sequence_types = []) {
    $organisms_info = [];
    
    if (!is_dir($organism_data_path)) {
        return $organisms_info;
    }
    
    // Load all organisms&#039; JSON metadata using consolidated function
    $organisms_metadata = loadAllOrganismsMetadata($organism_data_path);
    
    $organisms = scandir($organism_data_path);
    foreach ($organisms as $organism) {
        if ($organism[0] === &#039;.&#039; || !is_dir(&quot;$organism_data_path/$organism&quot;)) {
            continue;
        }
        
        // Get organism.json info (already loaded from consolidated function)
        $organism_json = &quot;$organism_data_path/$organism/organism.json&quot;;
        $json_validation = validateOrganismJson($organism_json);
        $info = $organisms_metadata[$organism] ?? [];
        
        // Get assemblies
        $assemblies = [];
        $assembly_path = &quot;$organism_data_path/$organism&quot;;
        $files = scandir($assembly_path);
        foreach ($files as $file) {
            if ($file[0] === &#039;.&#039; || !is_dir(&quot;$assembly_path/$file&quot;)) {
                continue;
            }
            $assemblies[] = $file;
        }
        
        // Check for database file
        $db_file = null;
        if (file_exists(&quot;$organism_data_path/$organism/organism.sqlite&quot;)) {
            $db_file = &quot;$organism_data_path/$organism/organism.sqlite&quot;;
        }
        
        $has_db = !is_null($db_file);
        
        // Validate database integrity if database exists
        $db_validation = null;
        $assembly_validation = null;
        $fasta_validation = null;
        if ($has_db) {
            $db_validation = validateDatabaseIntegrity($db_file);
            // Also validate assembly directories
            $assembly_validation = validateAssemblyDirectories($db_file, &quot;$organism_data_path/$organism&quot;);
        }
        // Validate FASTA files in assembly directories
        $fasta_validation = validateAssemblyFastaFiles(&quot;$organism_data_path/$organism&quot;, $sequence_types);
        
        $organisms_info[$organism] = [
            &#039;info&#039; =&gt; $info,
            &#039;assemblies&#039; =&gt; $assemblies,
            &#039;has_db&#039; =&gt; $has_db,
            &#039;db_file&#039; =&gt; $db_file,
            &#039;db_validation&#039; =&gt; $db_validation,
            &#039;assembly_validation&#039; =&gt; $assembly_validation,
            &#039;fasta_validation&#039; =&gt; $fasta_validation,
            &#039;json_validation&#039; =&gt; $json_validation,
            &#039;path&#039; =&gt; &quot;$organism_data_path/$organism&quot;
        ];
    }
    
    return $organisms_info;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_database.php (8)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="validateDatabaseFile">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateDatabaseFile()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 13</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_database.php: validateDatabaseFile()</div>
                    <div class="function-comment">
                        <pre>/**
* Validates database file is readable and accessible
*
* @param string $dbFile - Path to SQLite database file
* @return array - Validation results with &#039;valid&#039; and &#039;error&#039; keys
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/annotation_search_ajax.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 74</code>: <small>$db_validation = validateDatabaseFile($db);</small></li>
                                    <li><code>line 74</code>: <small>$db_validation = validateDatabaseFile($db);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateDatabaseFile($dbFile) {
    if (!file_exists($dbFile)) {
        return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; &#039;Database file not found&#039;];
    }
    
    if (!is_readable($dbFile)) {
        return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; &#039;Database file not readable (permission denied)&#039;];
    }
    
    try {
        $db = new PDO(&#039;sqlite:&#039; . $dbFile);
        $db = null;
        return [&#039;valid&#039; =&gt; true, &#039;error&#039; =&gt; &#039;&#039;];
    } catch (Exception $e) {
        return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; $e-&gt;getMessage()];
    }
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="validateDatabaseIntegrity">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateDatabaseIntegrity()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 44</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_database.php: validateDatabaseIntegrity()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate database integrity and data quality
*
* Checks:
* - File is readable
* - Valid SQLite database
* - All required tables exist
* - Tables have data
* - Data completeness (no orphaned records)
*
* @param string $dbFile - Path to SQLite database file
* @return array - Validation results with status and details
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 577</code>: <small>$db_validation = validateDatabaseIntegrity($db_file);</small></li>
                                    <li><code>line 577</code>: <small>$db_validation = validateDatabaseIntegrity($db_file);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateDatabaseIntegrity($dbFile) {
    $result = [
        &#039;valid&#039; =&gt; false,
        &#039;readable&#039; =&gt; false,
        &#039;database_valid&#039; =&gt; false,
        &#039;tables_present&#039; =&gt; [],
        &#039;tables_missing&#039; =&gt; [],
        &#039;row_counts&#039; =&gt; [],
        &#039;data_issues&#039; =&gt; [],
        &#039;errors&#039; =&gt; []
    ];
    
    // Check if file exists and is readable
    if (!file_exists($dbFile)) {
        $result[&#039;errors&#039;][] = &#039;Database file not found&#039;;
        return $result;
    }
    
    if (!is_readable($dbFile)) {
        $result[&#039;errors&#039;][] = &#039;Database file not readable (permission denied)&#039;;
        return $result;
    }
    
    $result[&#039;readable&#039;] = true;
    
    // Try to connect to database
    try {
        $dbh = new PDO(&quot;sqlite:&quot; . $dbFile);
        $dbh-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    } catch (PDOException $e) {
        $result[&#039;errors&#039;][] = &#039;Invalid SQLite database: &#039; . $e-&gt;getMessage();
        return $result;
    }
    
    $result[&#039;database_valid&#039;] = true;
    
    // Required tables based on schema
    $required_tables = [
        &#039;organism&#039;,
        &#039;genome&#039;,
        &#039;feature&#039;,
        &#039;annotation_source&#039;,
        &#039;annotation&#039;,
        &#039;feature_annotation&#039;
    ];
    
    // Check which tables exist
    try {
        $stmt = $dbh-&gt;query(&quot;SELECT name FROM sqlite_master WHERE type=&#039;table&#039;&quot;);
        $existing_tables = $stmt-&gt;fetchAll(PDO::FETCH_COLUMN);
        
        foreach ($required_tables as $table) {
            if (in_array($table, $existing_tables)) {
                $result[&#039;tables_present&#039;][] = $table;
            } else {
                $result[&#039;tables_missing&#039;][] = $table;
            }
        }
    } catch (PDOException $e) {
        $result[&#039;errors&#039;][] = &#039;Cannot query tables: &#039; . $e-&gt;getMessage();
        $dbh = null;
        return $result;
    }
    
    // Check row counts and data quality
    try {
        foreach ($result[&#039;tables_present&#039;] as $table) {
            $stmt = $dbh-&gt;query(&quot;SELECT COUNT(*) FROM $table&quot;);
            $count = $stmt-&gt;fetchColumn();
            $result[&#039;row_counts&#039;][$table] = $count;
        }
        
        // Check for data quality issues
        
        // 1. Check for annotations without sources (orphaned)
        if (in_array(&#039;annotation&#039;, $result[&#039;tables_present&#039;]) &amp;&amp; in_array(&#039;annotation_source&#039;, $result[&#039;tables_present&#039;])) {
            $stmt = $dbh-&gt;query(&quot;
                SELECT COUNT(*) FROM annotation a 
                LEFT JOIN annotation_source ans ON a.annotation_source_id = ans.annotation_source_id 
                WHERE ans.annotation_source_id IS NULL
            &quot;);
            $orphaned_count = $stmt-&gt;fetchColumn();
            if ($orphaned_count &gt; 0) {
                $result[&#039;data_issues&#039;][] = &quot;Orphaned annotations (no source): $orphaned_count&quot;;
            }
        }
        
        // 2. Check for incomplete annotations (missing accession or description)
        if (in_array(&#039;annotation&#039;, $result[&#039;tables_present&#039;])) {
            $stmt = $dbh-&gt;query(&quot;
                SELECT COUNT(*) FROM annotation 
                WHERE annotation_accession IS NULL OR annotation_accession = &#039;&#039;
            &quot;);
            $missing_accession = $stmt-&gt;fetchColumn();
            if ($missing_accession &gt; 0) {
                $result[&#039;data_issues&#039;][] = &quot;Annotations with missing accession: $missing_accession&quot;;
            }
        }
        
        // 3. Check for features without organisms
        if (in_array(&#039;feature&#039;, $result[&#039;tables_present&#039;]) &amp;&amp; in_array(&#039;organism&#039;, $result[&#039;tables_present&#039;])) {
            $stmt = $dbh-&gt;query(&quot;
                SELECT COUNT(*) FROM feature f 
                LEFT JOIN organism o ON f.organism_id = o.organism_id 
                WHERE o.organism_id IS NULL
            &quot;);
            $orphaned_features = $stmt-&gt;fetchColumn();
            if ($orphaned_features &gt; 0) {
                $result[&#039;data_issues&#039;][] = &quot;Features without organism: $orphaned_features&quot;;
            }
        }
        
    } catch (PDOException $e) {
        $result[&#039;errors&#039;][] = &#039;Data quality check failed: &#039; . $e-&gt;getMessage();
    }
    
    $dbh = null;
    
    // Determine overall validity
    $result[&#039;valid&#039;] = (
        $result[&#039;readable&#039;] &amp;&amp; 
        $result[&#039;database_valid&#039;] &amp;&amp; 
        empty($result[&#039;tables_missing&#039;]) &amp;&amp; 
        empty($result[&#039;data_issues&#039;]) &amp;&amp;
        empty($result[&#039;errors&#039;])
    );
    
    return $result;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getDbConnection">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getDbConnection()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 181</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_database.php: getDbConnection()</div>
                    <div class="function-comment">
                        <pre>/**
* Get database connection
*
* @param string $dbFile - Path to SQLite database file
* @return PDO - Database connection
* @throws PDOException if connection fails
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_database.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 208</code>: <small>$dbh = getDbConnection($dbFile);</small></li>
                                    <li><code>line 208</code>: <small>$dbh = getDbConnection($dbFile);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getDbConnection($dbFile) {
    try {
        $dbh = new PDO(&quot;sqlite:&quot; . $dbFile);
        $dbh-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        // Register custom REGEXP function for word boundary matching
        $dbh-&gt;sqliteCreateFunction(&#039;REGEXP&#039;, function($pattern, $text) {
            return preg_match(&#039;/&#039; . $pattern . &#039;/i&#039;, $text) ? 1 : 0;
        }, 2);
        
        return $dbh;
    } catch (PDOException $e) {
        die(&quot;Database connection failed: &quot; . $e-&gt;getMessage());
    }
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="fetchData">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">fetchData()</div>
                            <span class="function-counter">30</span>
                            <div class="function-line">Line 206</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_database.php: fetchData()</div>
                    <div class="function-comment">
                        <pre>/**
* Execute SQL query with prepared statement
*
* @param string $sql - SQL query with ? placeholders
* @param string $dbFile - Path to SQLite database file
* @param array $params - Parameters to bind to query (optional)
* @return array - Array of associative arrays (results)
* @throws PDOException if query fails
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 3 unique file(s) (30 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/parent_functions.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 225</code>: <small>$results = fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 225</code>: <small>$results = fetchData($query, $dbFile, $params);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/lib/database_queries.php</strong> (26x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 52</code>: <small>$results = fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 89</code>: <small>$results = fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 118</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 144</code>: <small>$results = fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 175</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 208</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 229</code>: <small>return fetchData($query, $dbFile, [$feature_id]);</small></li>
                                    <li><code>line 246</code>: <small>$results = fetchData($query, [$organism_name, $organism_name], $dbFile);</small></li>
                                    <li><code>line 268</code>: <small>$results = fetchData($query, $dbFile, [$genome_accession]);</small></li>
                                    <li><code>line 503</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 542</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 563</code>: <small>return fetchData($query, $dbFile, []);</small></li>
                                    <li><code>line 588</code>: <small>$sources_with_types = fetchData($query, $dbFile, []);</small></li>
                                    <li><code>line 52</code>: <small>$results = fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 89</code>: <small>$results = fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 118</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 144</code>: <small>$results = fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 175</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 208</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 229</code>: <small>return fetchData($query, $dbFile, [$feature_id]);</small></li>
                                    <li><code>line 246</code>: <small>$results = fetchData($query, [$organism_name, $organism_name], $dbFile);</small></li>
                                    <li><code>line 268</code>: <small>$results = fetchData($query, $dbFile, [$genome_accession]);</small></li>
                                    <li><code>line 503</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 542</code>: <small>return fetchData($query, $dbFile, $params);</small></li>
                                    <li><code>line 563</code>: <small>return fetchData($query, $dbFile, []);</small></li>
                                    <li><code>line 588</code>: <small>$sources_with_types = fetchData($query, $dbFile, []);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/lib/functions_database.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 289</code>: <small>$results = fetchData($query, $db_path, $params);</small></li>
                                    <li><code>line 289</code>: <small>$results = fetchData($query, $db_path, $params);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function fetchData($sql, $dbFile, $params = []) {
    try {
        $dbh = getDbConnection($dbFile);
        $stmt = $dbh-&gt;prepare($sql);
        $stmt-&gt;execute($params);
        $result = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);
        $dbh = null;
        return $result;
    } catch (PDOException $e) {
        die(&quot;Query failed: &quot; . $e-&gt;getMessage());
    }
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="buildLikeConditions">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">buildLikeConditions()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 241</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_database.php: buildLikeConditions()</div>
                    <div class="function-comment">
                        <pre>/**
* Build SQL LIKE conditions for multi-column search
* Supports both quoted (phrase) and unquoted (word-by-word) searches
*
* Creates SQL WHERE clause fragments for searching multiple columns.
* Supports both keyword search (AND logic) and quoted phrase search.
*
* Keyword search: &quot;ABC transporter&quot;
*   - Splits into terms: [&quot;ABC&quot;, &quot;transporter&quot;]
*   - Logic: (col1 LIKE &#039;%ABC%&#039; OR col2 LIKE &#039;%ABC%&#039;) AND (col1 LIKE &#039;%transporter%&#039; OR col2 LIKE &#039;%transporter%&#039;)
*   - Result: Both terms must match somewhere
*
* Quoted search: &#039;&quot;ABC transporter&quot;&#039;
*   - Keeps as single phrase: &quot;ABC transporter&quot;
*   - Logic: (col1 LIKE &#039;%ABC transporter%&#039; OR col2 LIKE &#039;%ABC transporter%&#039;)
*   - Result: Exact phrase must match
*
* @param array $columns - Column names to search
* @param string $search - Search string (unquoted: words separated by space, quoted: single phrase)
* @param bool $quoted - If true, treat entire $search as single phrase; if false, split on whitespace
* @return array - [$sqlFragment, $params] for use with fetchData()
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function buildLikeConditions($columns, $search, $quoted = false) {
    $conditions = [];
    $params = [];

    if ($quoted) {
        $searchConditions = [];
        foreach ($columns as $col) {
            $searchConditions[] = &quot;$col LIKE ?&quot;;
            $params[] = &quot;%&quot; . $search . &quot;%&quot;;
        }
        $conditions[] = &quot;(&quot; . implode(&quot; OR &quot;, $searchConditions) . &quot;)&quot;;
    } else {
        $terms = preg_split(&#039;/\s+/&#039;, trim($search));
        foreach ($terms as $term) {
            if (empty($term)) continue;
            $termConditions = [];
            foreach ($columns as $col) {
                $termConditions[] = &quot;$col LIKE ?&quot;;
                $params[] = &quot;%&quot; . $term . &quot;%&quot;;
            }
            $conditions[] = &quot;(&quot; . implode(&quot; OR &quot;, $termConditions) . &quot;)&quot;;
        }
    }

    $sqlFragment = implode(&quot; AND &quot;, $conditions);
    return [$sqlFragment, $params];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAccessibleGenomeIds">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAccessibleGenomeIds()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 277</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_database.php: getAccessibleGenomeIds()</div>
                    <div class="function-comment">
                        <pre>/**
* Get accessible genome IDs from database for organism
*
* @param string $organism_name - Organism name
* @param array $accessible_assemblies - List of accessible assembly names
* @param string $db_path - Path to SQLite database file
* @return array - Array of genome IDs
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 32</code>: <small>$accessible_genome_ids = getAccessibleGenomeIds($organism_name, $accessible_asse</small></li>
                                    <li><code>line 32</code>: <small>$accessible_genome_ids = getAccessibleGenomeIds($organism_name, $accessible_asse</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAccessibleGenomeIds($organism_name, $accessible_assemblies, $db_path) {
    if (empty($accessible_assemblies)) {
        return [];
    }
    
    $placeholders = implode(&#039;,&#039;, array_fill(0, count($accessible_assemblies), &#039;?&#039;));
    $query = &quot;SELECT DISTINCT genome_id FROM genome 
              WHERE genome_name IN ($placeholders) 
              OR genome_accession IN ($placeholders)&quot;;
    
    // Pass accessible_assemblies twice - once for names, once for accessions
    $params = array_merge($accessible_assemblies, $accessible_assemblies);
    $results = fetchData($query, $db_path, $params);
    
    return array_column($results, &#039;genome_id&#039;);
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="loadOrganismInfo">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">loadOrganismInfo()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 301</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_database.php: loadOrganismInfo()</div>
                    <div class="function-comment">
                        <pre>/**
* Load organism info from organism.json file
*
* @param string $organism_name - Organism name
* @param string $organism_data_dir - Path to organism data directory
* @return array|null - Organism info array or null if not found
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_display.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 28</code>: <small>$organism_info = loadOrganismInfo($organism_name, $organism_data);</small></li>
                                    <li><code>line 276</code>: <small>$organism_info = loadOrganismInfo($organism_name, $organism_data_dir);</small></li>
                                    <li><code>line 28</code>: <small>$organism_info = loadOrganismInfo($organism_name, $organism_data);</small></li>
                                    <li><code>line 276</code>: <small>$organism_info = loadOrganismInfo($organism_name, $organism_data_dir);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function loadOrganismInfo($organism_name, $organism_data_dir) {
    $organism_json_path = &quot;$organism_data_dir/$organism_name/organism.json&quot;;
    $organism_info = loadJsonFile($organism_json_path);
    
    if (!$organism_info) {
        return null;
    }
    
    // Handle improperly wrapped JSON (extra outer braces)
    if (!isset($organism_info[&#039;genus&#039;]) &amp;&amp; !isset($organism_info[&#039;common_name&#039;])) {
        $keys = array_keys($organism_info);
        if (count($keys) &gt; 0 &amp;&amp; is_array($organism_info[$keys[0]]) &amp;&amp; isset($organism_info[$keys[0]][&#039;genus&#039;])) {
            $organism_info = $organism_info[$keys[0]];
        }
    }
    
    // Validate required fields
    if (!isset($organism_info[&#039;common_name&#039;]) &amp;&amp; !isset($organism_info[&#039;genus&#039;])) {
        return null;
    }
    
    return $organism_info;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="verifyOrganismDatabase">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">verifyOrganismDatabase()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 332</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_database.php: verifyOrganismDatabase()</div>
                    <div class="function-comment">
                        <pre>/**
* Verify organism database file exists
*
* @param string $organism_name - Organism name
* @param string $organism_data_dir - Path to organism data directory
* @return string - Database path if exists, exits with error if not
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 3 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 90</code>: <small>$db = verifyOrganismDatabase($selected_organism, $organism_data);</small></li>
                                    <li><code>line 90</code>: <small>$db = verifyOrganismDatabase($selected_organism, $organism_data);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/assembly_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 16</code>: <small>$db_path = verifyOrganismDatabase($organism_name, $organism_data);</small></li>
                                    <li><code>line 16</code>: <small>$db_path = verifyOrganismDatabase($organism_name, $organism_data);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 22</code>: <small>$db = verifyOrganismDatabase($organism_name, $organism_data);</small></li>
                                    <li><code>line 22</code>: <small>$db = verifyOrganismDatabase($organism_name, $organism_data);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function verifyOrganismDatabase($organism_name, $organism_data_dir) {
    $db_path = &quot;$organism_data_dir/$organism_name/organism.sqlite&quot;;
    
    if (!file_exists($db_path)) {
        header(&quot;HTTP/1.1 500 Internal Server Error&quot;);
        die(&quot;Error: Database not found for organism &#039;$organism_name&#039;. Please ensure the organism is properly configured.&quot;);
    }
    
    return $db_path;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_display.php (9)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="loadOrganismAndGetImagePath">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">loadOrganismAndGetImagePath()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 18</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_display.php: loadOrganismAndGetImagePath()</div>
                    <div class="function-comment">
                        <pre>/**
* Load organism info and get image path
*
* Combines organism.json loading with image path resolution.
* Uses loadOrganismInfo() for JSON loading and getOrganismImagePath() for image logic.
*
* @param string $organism_name The organism name
* @param string $images_path URL path to images directory (e.g., &#039;moop/images&#039;)
* @param string $absolute_images_path Absolute file system path to images directory
* @return array [&#039;organism_info&#039; =&gt; array, &#039;image_path&#039; =&gt; string]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/annotation_search_ajax.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 86</code>: <small>$organism_data_result = loadOrganismAndGetImagePath($organism, $images_path, $ab</small></li>
                                    <li><code>line 86</code>: <small>$organism_data_result = loadOrganismAndGetImagePath($organism, $images_path, $ab</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/multi_organism_search.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 115</code>: <small>$organism_data_result = loadOrganismAndGetImagePath($organism, $images_path, $ab</small></li>
                                    <li><code>line 115</code>: <small>$organism_data_result = loadOrganismAndGetImagePath($organism, $images_path, $ab</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function loadOrganismAndGetImagePath($organism_name, $images_path = &#039;moop/images&#039;, $absolute_images_path = &#039;&#039;) {
    $config = ConfigManager::getInstance();
    $organism_data = $config-&gt;getPath(&#039;organism_data&#039;);
    
    $result = [
        &#039;organism_info&#039; =&gt; [],
        &#039;image_path&#039; =&gt; &#039;&#039;
    ];
    
    // Use consolidated loadOrganismInfo() instead of manual JSON loading
    $organism_info = loadOrganismInfo($organism_name, $organism_data);
    if ($organism_info) {
        $result[&#039;organism_info&#039;] = $organism_info;
        $result[&#039;image_path&#039;] = getOrganismImagePath($organism_info, $images_path, $absolute_images_path);
    }
    
    return $result;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getOrganismImagePath">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getOrganismImagePath()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 11</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_display.php: getOrganismImagePath()</div>
                    <div class="function-comment">
                        <pre>/**
* Get organism image file path
*
* Returns the URL path to an organism&#039;s image with fallback logic:
* 1. Custom image from organism.json if defined
* 2. NCBI taxonomy image if taxon_id exists and image file found
* 3. Empty string if no image available
*
* @param array $organism_info Array from organism.json with keys: images, taxon_id
* @param string $images_path URL path to images directory (e.g., &#039;moop/images&#039;)
* @param string $absolute_images_path Absolute file system path to images directory
* @return string URL path to image file or empty string if no image
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_display.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 31</code>: <small>$result[&#039;image_path&#039;] = getOrganismImagePath($organism_info, $images_path, $abso</small></li>
                                    <li><code>line 151</code>: <small>$image_path = getOrganismImagePath($organism_info, $images_path, $absolute_image</small></li>
                                    <li><code>line 31</code>: <small>$result[&#039;image_path&#039;] = getOrganismImagePath($organism_info, $images_path, $abso</small></li>
                                    <li><code>line 151</code>: <small>$image_path = getOrganismImagePath($organism_info, $images_path, $absolute_image</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/groups_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 188</code>: <small>$image_src = getOrganismImagePath($organism_info, $images_path, $absolute_images</small></li>
                                    <li><code>line 188</code>: <small>$image_src = getOrganismImagePath($organism_info, $images_path, $absolute_images</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getOrganismImagePath($organism_info, $images_path = &#039;moop/images&#039;, $absolute_images_path = &#039;&#039;) {
    // Validate input
    if (empty($organism_info) || !is_array($organism_info)) {
        logError(&#039;getOrganismImagePath received invalid organism_info&#039;, &#039;organism_image&#039;, [
            &#039;organism_info_type&#039; =&gt; gettype($organism_info),
            &#039;organism_info_empty&#039; =&gt; empty($organism_info)
        ]);
        return &#039;&#039;;
    }
    
    // Check for custom image first
    if (!empty($organism_info[&#039;images&#039;]) &amp;&amp; is_array($organism_info[&#039;images&#039;])) {
        return &quot;/$images_path/&quot; . htmlspecialchars($organism_info[&#039;images&#039;][0][&#039;file&#039;]);
    }
    
    // Fall back to NCBI taxonomy image if taxon_id exists
    if (!empty($organism_info[&#039;taxon_id&#039;])) {
        // Construct path - use absolute_images_path if provided, otherwise fall back
        if (!empty($absolute_images_path)) {
            $ncbi_image_file = &quot;$absolute_images_path/ncbi_taxonomy/&quot; . $organism_info[&#039;taxon_id&#039;] . &#039;.jpg&#039;;
        } else {
            $ncbi_image_file = __DIR__ . &#039;/../../images/ncbi_taxonomy/&#039; . $organism_info[&#039;taxon_id&#039;] . &#039;.jpg&#039;;
        }
        
        if (file_exists($ncbi_image_file)) {
            return &quot;/moop/images/ncbi_taxonomy/&quot; . $organism_info[&#039;taxon_id&#039;] . &quot;.jpg&quot;;
        } else {
            logError(&#039;NCBI taxonomy image not found&#039;, &#039;organism_image&#039;, [
                &#039;taxon_id&#039; =&gt; $organism_info[&#039;taxon_id&#039;],
                &#039;expected_path&#039; =&gt; $ncbi_image_file
            ]);
        }
    }
    
    return &#039;&#039;;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getOrganismImageCaption">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getOrganismImageCaption()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 98</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_display.php: getOrganismImageCaption()</div>
                    <div class="function-comment">
                        <pre>/**
* Get organism image caption with optional link
*
* Returns display caption for organism image:
* - Custom images: caption from organism.json or empty string
* - NCBI taxonomy fallback: &quot;Image from NCBI Taxonomy&quot; with link to NCBI
*
* @param array $organism_info Array from organism.json with keys: images, taxon_id
* @param string $absolute_images_path Absolute file system path to images directory
* @return array [&#039;caption&#039; =&gt; caption text, &#039;link&#039; =&gt; URL or empty string]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 152</code>: <small>$image_info = getOrganismImageCaption($organism_info, $absolute_images_path);</small></li>
                                    <li><code>line 152</code>: <small>$image_info = getOrganismImageCaption($organism_info, $absolute_images_path);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getOrganismImageCaption($organism_info, $absolute_images_path = &#039;&#039;) {
    $result = [
        &#039;caption&#039; =&gt; &#039;&#039;,
        &#039;link&#039; =&gt; &#039;&#039;
    ];
    
    // Validate input
    if (empty($organism_info) || !is_array($organism_info)) {
        logError(&#039;getOrganismImageCaption received invalid organism_info&#039;, &#039;organism_image&#039;, [
            &#039;organism_info_type&#039; =&gt; gettype($organism_info),
            &#039;organism_info_empty&#039; =&gt; empty($organism_info)
        ]);
        return $result;
    }
    
    // Custom image caption
    if (!empty($organism_info[&#039;images&#039;]) &amp;&amp; is_array($organism_info[&#039;images&#039;])) {
        if (!empty($organism_info[&#039;images&#039;][0][&#039;caption&#039;])) {
            $result[&#039;caption&#039;] = $organism_info[&#039;images&#039;][0][&#039;caption&#039;];
        }
        return $result;
    }
    
    // NCBI taxonomy caption with link
    if (!empty($organism_info[&#039;taxon_id&#039;])) {
        // Construct path - use absolute_images_path if provided, otherwise fall back
        if (!empty($absolute_images_path)) {
            $ncbi_image_file = &quot;$absolute_images_path/ncbi_taxonomy/&quot; . $organism_info[&#039;taxon_id&#039;] . &#039;.jpg&#039;;
        } else {
            $ncbi_image_file = __DIR__ . &#039;/../../images/ncbi_taxonomy/&#039; . $organism_info[&#039;taxon_id&#039;] . &#039;.jpg&#039;;
        }
        
        if (file_exists($ncbi_image_file)) {
            $result[&#039;caption&#039;] = &#039;Image from NCBI Taxonomy&#039;;
            $result[&#039;link&#039;] = &#039;https://www.ncbi.nlm.nih.gov/datasets/taxonomy/&#039; . htmlspecialchars($organism_info[&#039;taxon_id&#039;]);
        }
    }
    
    return $result;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getOrganismImageWithCaption">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getOrganismImageWithCaption()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 150</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_display.php: getOrganismImageWithCaption()</div>
                    <div class="function-comment">
                        <pre>/**
* Get organism image with path and caption
*
* Convenience function combining getOrganismImagePath() and getOrganismImageCaption()
* Used when both image URL and caption are needed (common display pattern).
*
* @param array $organism_info Array from organism.json with keys: images, taxon_id
* @param string $images_path URL path to images directory (e.g., &#039;moop/images&#039;)
* @param string $absolute_images_path Absolute file system path to images directory
* @return array [&#039;image_path&#039; =&gt; string, &#039;caption&#039; =&gt; string, &#039;link&#039; =&gt; string or empty]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/organism_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 97</code>: <small>$image_data = getOrganismImageWithCaption($organism_info, $images_path, $absolut</small></li>
                                    <li><code>line 97</code>: <small>$image_data = getOrganismImageWithCaption($organism_info, $images_path, $absolut</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getOrganismImageWithCaption($organism_info, $images_path = &#039;moop/images&#039;, $absolute_images_path = &#039;&#039;) {
    $image_path = getOrganismImagePath($organism_info, $images_path, $absolute_images_path);
    $image_info = getOrganismImageCaption($organism_info, $absolute_images_path);
    
    return [
        &#039;image_path&#039; =&gt; $image_path,
        &#039;caption&#039; =&gt; $image_info[&#039;caption&#039;],
        &#039;link&#039; =&gt; $image_info[&#039;link&#039;]
    ];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="validateOrganismJson">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateOrganismJson()</div>
                            <span class="function-counter">8</span>
                            <div class="function-line">Line 173</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_display.php: validateOrganismJson()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate organism.json file
*
* Checks:
* - File exists
* - File is readable
* - Valid JSON format
* - Contains required fields (genus, species, common_name, taxon_id)
*
* @param string $json_path - Path to organism.json file
* @return array - Validation results with status and details
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (8 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 550</code>: <small>$json_validation = validateOrganismJson($organism_json);</small></li>
                                    <li><code>line 550</code>: <small>$json_validation = validateOrganismJson($organism_json);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tests/test_organism_json_validation.php</strong> (6x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 71</code>: <small>$result = validateOrganismJson($path);</small></li>
                                    <li><code>line 88</code>: <small>$result = validateOrganismJson($path);</small></li>
                                    <li><code>line 110</code>: <small>$result = validateOrganismJson($path);</small></li>
                                    <li><code>line 137</code>: <small>$result = validateOrganismJson($path);</small></li>
                                    <li><code>line 163</code>: <small>$result = validateOrganismJson($path);</small></li>
                                    <li><code>line 190</code>: <small>$result = validateOrganismJson($path);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateOrganismJson($json_path) {
    $validation = [
        &#039;exists&#039; =&gt; false,
        &#039;readable&#039; =&gt; false,
        &#039;writable&#039; =&gt; false,
        &#039;valid_json&#039; =&gt; false,
        &#039;has_required_fields&#039; =&gt; false,
        &#039;required_fields&#039; =&gt; [&#039;genus&#039;, &#039;species&#039;, &#039;common_name&#039;, &#039;taxon_id&#039;],
        &#039;missing_fields&#039; =&gt; [],
        &#039;errors&#039; =&gt; [],
        &#039;owner&#039; =&gt; null,
        &#039;perms&#039; =&gt; null,
        &#039;web_user&#039; =&gt; null,
        &#039;web_group&#039; =&gt; null
    ];
    
    if (!file_exists($json_path)) {
        $validation[&#039;errors&#039;][] = &#039;organism.json file does not exist&#039;;
        return $validation;
    }
    
    $validation[&#039;exists&#039;] = true;
    
    // Get file ownership and permissions
    if (@is_readable($json_path) || @file_exists($json_path)) {
        $perms = @fileperms($json_path);
        if ($perms !== false) {
            $validation[&#039;perms&#039;] = substr(sprintf(&#039;%o&#039;, $perms), -3);
        }
        $owner = @posix_getpwuid(@fileowner($json_path));
        if ($owner !== false) {
            $validation[&#039;owner&#039;] = $owner[&#039;name&#039;] ?? &#039;unknown&#039;;
        }
    }
    
    // Get web server user/group
    $current_user = get_current_user();
    if ($current_user) {
        $validation[&#039;web_user&#039;] = $current_user;
        $group_info = @posix_getgrgid(@posix_getegid());
        if ($group_info !== false) {
            $validation[&#039;web_group&#039;] = $group_info[&#039;name&#039;] ?? &#039;www-data&#039;;
        }
    }
    
    if (!is_readable($json_path)) {
        $validation[&#039;errors&#039;][] = &#039;organism.json file is not readable&#039;;
        return $validation;
    }
    
    $validation[&#039;readable&#039;] = true;
    $validation[&#039;writable&#039;] = is_writable($json_path);
    
    $content = file_get_contents($json_path);
    $json_data = json_decode($content, true);
    
    if ($json_data === null) {
        $validation[&#039;errors&#039;][] = &#039;organism.json contains invalid JSON: &#039; . json_last_error_msg();
        return $validation;
    }
    
    $validation[&#039;valid_json&#039;] = true;
    
    // Handle wrapped JSON (single-level wrapping)
    if (!isset($json_data[&#039;genus&#039;]) &amp;&amp; !isset($json_data[&#039;common_name&#039;])) {
        $keys = array_keys($json_data);
        if (count($keys) &gt; 0 &amp;&amp; is_array($json_data[$keys[0]])) {
            $json_data = $json_data[$keys[0]];
        }
    }
    
    // Check for required fields
    foreach ($validation[&#039;required_fields&#039;] as $field) {
        if (!isset($json_data[$field]) || empty($json_data[$field])) {
            $validation[&#039;missing_fields&#039;][] = $field;
        }
    }
    
    $validation[&#039;has_required_fields&#039;] = empty($validation[&#039;missing_fields&#039;]);
    
    if (!$validation[&#039;has_required_fields&#039;]) {
        $validation[&#039;errors&#039;][] = &#039;Missing required fields: &#039; . implode(&#039;, &#039;, $validation[&#039;missing_fields&#039;]);
    }
    
    return $validation;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="setupOrganismDisplayContext">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">setupOrganismDisplayContext()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 271</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_display.php: setupOrganismDisplayContext()</div>
                    <div class="function-comment">
                        <pre>/**
* Complete setup for organism display pages
* Validates parameter, loads organism info, checks access, returns context
* Use this to replace boilerplate in organism_display, assembly_display, parent_display
*
* @param string $organism_name Organism from GET/POST
* @param string $organism_data_dir Path to organism data directory
* @param bool $check_access Whether to check access control (default: true)
* @param string $redirect_home Home URL for redirects (default: /moop/index.php)
* @return array Array with &#039;name&#039; and &#039;info&#039; keys, or exits on error
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 3 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/assembly_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 12</code>: <small>$organism_context = setupOrganismDisplayContext($organism_name, $organism_data, </small></li>
                                    <li><code>line 12</code>: <small>$organism_context = setupOrganismDisplayContext($organism_name, $organism_data, </small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/organism_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 10</code>: <small>$organism_context = setupOrganismDisplayContext($_GET[&#039;organism&#039;] ?? &#039;&#039;, $organi</small></li>
                                    <li><code>line 10</code>: <small>$organism_context = setupOrganismDisplayContext($_GET[&#039;organism&#039;] ?? &#039;&#039;, $organi</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 18</code>: <small>$organism_context = setupOrganismDisplayContext($organism_name, $organism_data, </small></li>
                                    <li><code>line 18</code>: <small>$organism_context = setupOrganismDisplayContext($organism_name, $organism_data, </small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function setupOrganismDisplayContext($organism_name, $organism_data_dir, $check_access = true, $redirect_home = &#039;/moop/index.php&#039;) {
    // Validate organism parameter
    $organism_name = validateOrganismParam($organism_name, $redirect_home);
    
    // Load and validate organism info
    $organism_info = loadOrganismInfo($organism_name, $organism_data_dir);
    
    if (!$organism_info) {
        header(&quot;Location: $redirect_home&quot;);
        exit;
    }
    
    // Check access (unless it&#039;s public)
    if ($check_access) {
        $is_public = is_public_organism($organism_name);
        if (!$is_public) {
            require_access(&#039;Collaborator&#039;, $organism_name);
        }
    }
    
    return [
        &#039;name&#039; =&gt; $organism_name,
        &#039;info&#039; =&gt; $organism_info
    ];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="fetch_organism_image">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">fetch_organism_image()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 308</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_display.php: fetch_organism_image()</div>
                    <div class="function-comment">
                        <pre>/**
* Fetch and cache organism image from NCBI to ncbi_taxonomy directory
*
* Downloads organism images from NCBI taxonomy API and caches them locally.
* Returns the web-accessible image path or null if download fails.
*
* @param int $taxon_id NCBI Taxonomy ID
* @param string|null $organism_name Optional organism name (for reference)
* @param string $absolute_images_path Absolute filesystem path to images directory
* @return string|null Web path to image (e.g., &#039;images/ncbi_taxonomy/12345.jpg&#039;), or null if failed
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 466</code>: <small>$image = fetch_organism_image($data[&#039;taxon_id&#039;], $organism_name);</small></li>
                                    <li><code>line 466</code>: <small>$image = fetch_organism_image($data[&#039;taxon_id&#039;], $organism_name);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function fetch_organism_image($taxon_id, $organism_name = null, $absolute_images_path = null) {
    if ($absolute_images_path === null) {
        $config = ConfigManager::getInstance();
        $absolute_images_path = $config-&gt;getPath(&#039;absolute_images_path&#039;);
    }
    
    $ncbi_dir = $absolute_images_path . &#039;/ncbi_taxonomy&#039;;
    $image_path = $ncbi_dir . &#039;/&#039; . $taxon_id . &#039;.jpg&#039;;
    
    // Check if image already cached
    if (file_exists($image_path)) {
        return &#039;images/ncbi_taxonomy/&#039; . $taxon_id . &#039;.jpg&#039;;
    }
    
    // Ensure directory exists
    if (!is_dir($ncbi_dir)) {
        @mkdir($ncbi_dir, 0755, true);
    }
    
    // Download from NCBI
    $image_url = &quot;https://api.ncbi.nlm.nih.gov/datasets/v2/taxonomy/taxon/{$taxon_id}/image&quot;;
    
    $context = stream_context_create([&#039;http&#039; =&gt; [&#039;timeout&#039; =&gt; 10, &#039;user_agent&#039; =&gt; &#039;MOOP&#039;]]);
    $image_data = @file_get_contents($image_url, false, $context);
    
    if ($image_data === false || strlen($image_data) &lt; 100) {
        return null;
    }
    
    // Save image
    if (file_put_contents($image_path, $image_data) !== false) {
        return &#039;images/ncbi_taxonomy/&#039; . $taxon_id . &#039;.jpg&#039;;
    }
    
    return null;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generatePermissionAlert">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generatePermissionAlert()</div>
                            <span class="function-counter">10</span>
                            <div class="function-line">Line 359</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_display.php: generatePermissionAlert()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate a permission alert HTML for a file or directory
*
* Shows current status (readable, writable) and provides either:
* 1. A &quot;Fix Permissions&quot; button if web server can fix it automatically
* 2. Manual fix instructions with commands if web server lacks permissions
*
* @param string $file_path Path to file or directory
* @param string $title Alert title (e.g., &quot;Metadata File Permission Issue&quot;)
* @param string $problem Description of the problem
* @param string $file_type Type for AJAX call: &#039;file&#039; or &#039;directory&#039;
* @param string $organism Optional organism name for targeting
* @return string HTML for the permission alert, empty if no issues
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (10 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_registry.php</strong> (8x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 98</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                    <li><code>line 105</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                    <li><code>line 112</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                    <li><code>line 119</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                    <li><code>line 98</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                    <li><code>line 105</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                    <li><code>line 112</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                    <li><code>line 119</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_organisms.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 789</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                    <li><code>line 789</code>: <small>&lt;?php echo generatePermissionAlert(</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function generatePermissionAlert($file_path, $title = &#039;&#039;, $problem = &#039;&#039;, $file_type = &#039;file&#039;, $organism = &#039;&#039;) {
    // Check current permissions
    $readable = is_readable($file_path);
    $writable = is_writable($file_path);
    
    // If everything is fine, return empty
    if ($readable &amp;&amp; $writable) {
        return &#039;&#039;;
    }
    
    // Get file/directory info
    $exists = file_exists($file_path);
    if (!$exists) {
        return &#039;&#039;;
    }
    
    $is_dir = is_dir($file_path);
    $file_size = $is_dir ? &#039;directory&#039; : filesize($file_path) . &#039; bytes&#039;;
    $owner = @posix_getpwuid(fileowner($file_path));
    $owner_name = $owner !== false ? $owner[&#039;name&#039;] : &#039;unknown&#039;;
    $perms = substr(sprintf(&#039;%o&#039;, fileperms($file_path)), -3);
    $web_user = get_current_user() ?: &#039;www-data&#039;;
    $web_group_info = @posix_getgrgid(@posix_getegid());
    $web_group = $web_group_info !== false ? $web_group_info[&#039;name&#039;] : &#039;www-data&#039;;
    
    // Determine if web server can fix permissions
    $can_fix = is_writable(dirname($file_path)) || is_writable($file_path);
    
    // Determine what&#039;s wrong
    $issue = &#039;&#039;;
    if (!$readable &amp;&amp; !$writable) {
        $issue = &#039;Cannot read or write&#039;;
    } elseif (!$readable) {
        $issue = &#039;Cannot read (permission denied)&#039;;
    } else {
        $issue = &#039;Cannot write (read-only)&#039;;
    }
    
    $safe_path = htmlspecialchars($file_path);
    $safe_title = htmlspecialchars($title ?: $issue);
    $safe_problem = htmlspecialchars($problem);
    $safe_organism = htmlspecialchars($organism);
    
    // Start building alert HTML
    $html = &#039;&lt;div class=&quot;alert alert-warning alert-dismissible fade show mb-3&quot;&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;  &lt;button type=&quot;button&quot; class=&quot;btn-close&quot; data-bs-dismiss=&quot;alert&quot;&gt;&lt;/button&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;  &lt;h6&gt;&lt;i class=&quot;fa fa-exclamation-circle&quot;&gt;&lt;/i&gt; &#039; . $safe_title . &#039;&lt;/h6&gt;&#039; . &quot;\n&quot;;
    
    if ($safe_problem) {
        $html .= &#039;  &lt;p class=&quot;mb-2&quot;&gt;&lt;strong&gt;Problem:&lt;/strong&gt; &#039; . $safe_problem . &#039;&lt;/p&gt;&#039; . &quot;\n&quot;;
    }
    
    $html .= &#039;  &lt;p class=&quot;mb-3&quot;&gt;&lt;strong&gt;Current Status:&lt;/strong&gt;&lt;/p&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;  &lt;ul class=&quot;mb-3 small&quot;&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;    &lt;li&gt;Path: &lt;code&gt;&#039; . $safe_path . &#039;&lt;/code&gt;&lt;/li&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;    &lt;li&gt;Type: &#039; . ($is_dir ? &#039;Directory&#039; : &#039;File&#039;) . &#039;&lt;/li&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;    &lt;li&gt;Owner: &lt;code&gt;&#039; . htmlspecialchars($owner_name) . &#039;&lt;/code&gt;&lt;/li&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;    &lt;li&gt;Permissions: &lt;code&gt;&#039; . $perms . &#039;&lt;/code&gt;&lt;/li&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;    &lt;li&gt;Readable: &lt;span class=&quot;badge &#039; . ($readable ? &#039;bg-success&#039; : &#039;bg-danger&#039;) . &#039;&quot;&gt;&#039; . ($readable ? &#039;‚úì Yes&#039; : &#039;‚úó No&#039;) . &#039;&lt;/span&gt;&lt;/li&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;    &lt;li&gt;Writable: &lt;span class=&quot;badge &#039; . ($writable ? &#039;bg-success&#039; : &#039;bg-danger&#039;) . &#039;&quot;&gt;&#039; . ($writable ? &#039;‚úì Yes&#039; : &#039;‚úó No&#039;) . &#039;&lt;/span&gt;&lt;/li&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;    &lt;li&gt;Web server user: &lt;code&gt;&#039; . htmlspecialchars($web_user) . &#039;&lt;/code&gt;&lt;/li&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;  &lt;/ul&gt;&#039; . &quot;\n&quot;;
    
    if ($can_fix) {
        // Web server can fix it - offer button
        $html .= &#039;  &lt;p class=&quot;mb-2&quot;&gt;&lt;strong&gt;Quick Fix:&lt;/strong&gt; Click the button below to attempt automatic fix:&lt;/p&gt;&#039; . &quot;\n&quot;;
        $html .= &#039;  &lt;button class=&quot;btn btn-warning btn-sm&quot; onclick=&quot;fixFilePermissions(event, &#039; . json_encode($file_path) . &#039;, &#039; . json_encode($file_type) . &#039;, &#039; . json_encode($organism) . &#039;)&quot;&gt;&#039; . &quot;\n&quot;;
        $html .= &#039;    &lt;i class=&quot;fa fa-wrench&quot;&gt;&lt;/i&gt; Fix Permissions&#039; . &quot;\n&quot;;
        $html .= &#039;  &lt;/button&gt;&#039; . &quot;\n&quot;;
        $html .= &#039;  &lt;div id=&quot;fixResult-&#039; . md5($file_path) . &#039;&quot; class=&quot;mt-3&quot;&gt;&lt;/div&gt;&#039; . &quot;\n&quot;;
    } else {
        // Web server cannot fix - show manual instructions
        $html .= &#039;  &lt;p class=&quot;mb-2&quot;&gt;&lt;strong&gt;To Fix:&lt;/strong&gt; Run this command on the server:&lt;/p&gt;&#039; . &quot;\n&quot;;
        $html .= &#039;  &lt;div style=&quot;margin: 10px 0; background: #f0f0f0; padding: 10px; border-radius: 4px; border: 1px solid #ddd;&quot;&gt;&#039; . &quot;\n&quot;;
        $html .= &#039;    &lt;code style=&quot;word-break: break-all; display: block; font-size: 0.9em;&quot;&gt;&#039; . &quot;\n&quot;;
        if ($is_dir) {
            $html .= &#039;      sudo chown -R &#039; . htmlspecialchars($web_user) . &#039;:&#039; . htmlspecialchars($web_group) . &#039; &#039; . $safe_path . &#039;&lt;br&gt;&#039; . &quot;\n&quot;;
            $html .= &#039;      sudo chmod -R 775 &#039; . $safe_path . &quot;\n&quot;;
        } else {
            $html .= &#039;      sudo chown &#039; . htmlspecialchars($web_user) . &#039;:&#039; . htmlspecialchars($web_group) . &#039; &#039; . $safe_path . &#039;&lt;br&gt;&#039; . &quot;\n&quot;;
            $html .= &#039;      sudo chmod 664 &#039; . $safe_path . &quot;\n&quot;;
        }
        $html .= &#039;    &lt;/code&gt;&#039; . &quot;\n&quot;;
        $html .= &#039;  &lt;/div&gt;&#039; . &quot;\n&quot;;
    }
    
    $html .= &#039;  &lt;p class=&quot;small text-muted mb-0&quot;&gt;After fixing permissions, refresh this page.&lt;/p&gt;&#039; . &quot;\n&quot;;
    $html .= &#039;&lt;/div&gt;&#039; . &quot;\n&quot;;
    
    return $html;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getWebServerUserInfo">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getWebServerUserInfo()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 456</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_display.php: getWebServerUserInfo()</div>
                    <div class="function-comment">
                        <pre>/**
* Get web server user information
*
* @return array Array with &#039;user&#039; and &#039;group&#039; keys
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function getWebServerUserInfo() {
    $user = get_current_user() ?: &#039;www-data&#039;;
    $group_info = @posix_getgrgid(@posix_getegid());
    $group = $group_info !== false ? $group_info[&#039;name&#039;] : &#039;www-data&#039;;
    
    return [&#039;user&#039; =&gt; $user, &#039;group&#039; =&gt; $group];
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_errorlog.php (3)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="logError">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">logError()</div>
                            <span class="function-counter">20</span>
                            <div class="function-line">Line 15</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_errorlog.php: logError()</div>
                    <div class="function-comment">
                        <pre>/**
* Log an error to the error log file
*
* @param string $error_message The error message to log
* @param string $context Optional context (e.g., organism name, page name)
* @param array $additional_info Additional details to log
* @return void
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 5 unique file(s) (20 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_display.php</strong> (6x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 53</code>: <small>logError(&#039;getOrganismImagePath received invalid organism_info&#039;, &#039;organism_image&#039;</small></li>
                                    <li><code>line 77</code>: <small>logError(&#039;NCBI taxonomy image not found&#039;, &#039;organism_image&#039;, [</small></li>
                                    <li><code>line 106</code>: <small>logError(&#039;getOrganismImageCaption received invalid organism_info&#039;, &#039;organism_ima</small></li>
                                    <li><code>line 53</code>: <small>logError(&#039;getOrganismImagePath received invalid organism_info&#039;, &#039;organism_image&#039;</small></li>
                                    <li><code>line 77</code>: <small>logError(&#039;NCBI taxonomy image not found&#039;, &#039;organism_image&#039;, [</small></li>
                                    <li><code>line 106</code>: <small>logError(&#039;getOrganismImageCaption received invalid organism_info&#039;, &#039;organism_ima</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 139</code>: <small>logError($err, &quot;download_fasta&quot;, [&#039;user&#039; =&gt; $_SESSION[&#039;username&#039;] ?? &#039;unknown&#039;])</small></li>
                                    <li><code>line 139</code>: <small>logError($err, &quot;download_fasta&quot;, [&#039;user&#039; =&gt; $_SESSION[&#039;username&#039;] ?? &#039;unknown&#039;])</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/sequences_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 126</code>: <small>logError(</small></li>
                                    <li><code>line 126</code>: <small>logError(</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/annotation_search_ajax.php</strong> (6x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 65</code>: <small>logError(&#039;Database not found for organism&#039;, $organism, [</small></li>
                                    <li><code>line 76</code>: <small>logError(&#039;Database file not accessible&#039;, $organism, [</small></li>
                                    <li><code>line 142</code>: <small>logError(&#039;Incomplete annotation records found&#039;, $organism, [</small></li>
                                    <li><code>line 65</code>: <small>logError(&#039;Database not found for organism&#039;, $organism, [</small></li>
                                    <li><code>line 76</code>: <small>logError(&#039;Database file not accessible&#039;, $organism, [</small></li>
                                    <li><code>line 142</code>: <small>logError(&#039;Incomplete annotation records found&#039;, $organism, [</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_groups.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 217</code>: <small>logError(&#039;manage_groups.php&#039;, &quot;Failed to write to change_log/manage_groups.log&quot;,</small></li>
                                    <li><code>line 226</code>: <small>logError(&#039;manage_groups.php&#039;, &quot;Failed to write to organism_assembly_groups.json&quot;</small></li>
                                    <li><code>line 217</code>: <small>logError(&#039;manage_groups.php&#039;, &quot;Failed to write to change_log/manage_groups.log&quot;,</small></li>
                                    <li><code>line 226</code>: <small>logError(&#039;manage_groups.php&#039;, &quot;Failed to write to organism_assembly_groups.json&quot;</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function logError($error_message, $context = &#039;&#039;, $additional_info = []) {
    $config = ConfigManager::getInstance();
    $log_file = $config-&gt;getPath(&#039;error_log_file&#039;);
    
    $error_entry = [
        &#039;timestamp&#039; =&gt; date(&#039;Y-m-d H:i:s&#039;),
        &#039;error&#039; =&gt; $error_message,
        &#039;context&#039; =&gt; $context,
        &#039;user&#039; =&gt; $_SESSION[&#039;username&#039;] ?? &#039;anonymous&#039;,
        &#039;page&#039; =&gt; $_SERVER[&#039;REQUEST_URI&#039;] ?? &#039;&#039;,
        &#039;ip&#039; =&gt; $_SERVER[&#039;REMOTE_ADDR&#039;] ?? &#039;&#039;,
        &#039;details&#039; =&gt; $additional_info
    ];
    
    $log_line = json_encode($error_entry) . &quot;\n&quot;;
    
    if ($log_file) {
        error_log($log_line, 3, $log_file);
    }
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getErrorLog">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getErrorLog()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 42</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_errorlog.php: getErrorLog()</div>
                    <div class="function-comment">
                        <pre>/**
* Get error log entries
*
* @param int $limit Maximum number of entries to retrieve (0 = all)
* @return array Array of error entries
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/error_log.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 17</code>: <small>$all_errors = getErrorLog(500); // Get more for filtering</small></li>
                                    <li><code>line 17</code>: <small>$all_errors = getErrorLog(500); // Get more for filtering</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getErrorLog($limit = 0) {
    $config = ConfigManager::getInstance();
    $log_file = $config-&gt;getPath(&#039;error_log_file&#039;);
    
    if (!$log_file || !file_exists($log_file)) {
        return [];
    }
    
    $lines = file($log_file, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    if (!$lines) {
        return [];
    }
    
    $errors = [];
    foreach (array_reverse($lines) as $line) {
        $error = json_decode($line, true);
        if ($error) {
            $errors[] = $error;
        }
    }
    
    if ($limit &gt; 0) {
        $errors = array_slice($errors, 0, $limit);
    }
    
    return $errors;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="clearErrorLog">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">clearErrorLog()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 75</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_errorlog.php: clearErrorLog()</div>
                    <div class="function-comment">
                        <pre>/**
* Clear the error log file
*
* @return bool True if successful
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/error_log.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 11</code>: <small>if (clearErrorLog()) {</small></li>
                                    <li><code>line 11</code>: <small>if (clearErrorLog()) {</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function clearErrorLog() {
    $config = ConfigManager::getInstance();
    $log_file = $config-&gt;getPath(&#039;error_log_file&#039;);
    
    if (!$log_file) {
        return false;
    }
    
    return file_put_contents($log_file, &#039;&#039;) !== false;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_filesystem.php (9)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="validateDirectoryName">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateDirectoryName()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 15</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_filesystem.php: validateDirectoryName()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate directory name for security
*
* Prevents path traversal attacks by checking for invalid characters
*
* @param string $name - Directory name to validate
* @return bool - True if valid, false if contains path separators or traversal attempts
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_filesystem.php</strong> (6x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 223</code>: <small>if (!validateDirectoryName($old_name) || !validateDirectoryName($new_name)) {</small></li>
                                    <li><code>line 223</code>: <small>if (!validateDirectoryName($old_name) || !validateDirectoryName($new_name)) {</small></li>
                                    <li><code>line 268</code>: <small>if (!validateDirectoryName($dir_name)) {</small></li>
                                    <li><code>line 223</code>: <small>if (!validateDirectoryName($old_name) || !validateDirectoryName($new_name)) {</small></li>
                                    <li><code>line 223</code>: <small>if (!validateDirectoryName($old_name) || !validateDirectoryName($new_name)) {</small></li>
                                    <li><code>line 268</code>: <small>if (!validateDirectoryName($dir_name)) {</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateDirectoryName($name) {
    return strpos($name, &#039;/&#039;) === false &amp;&amp; 
           strpos($name, &#039;..&#039;) === false &amp;&amp;
           $name !== &#039;.&#039; &amp;&amp; 
           $name !== &#039;..&#039; &amp;&amp;
           $name !== &#039;organism.json&#039;;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="buildDirectoryResult">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">buildDirectoryResult()</div>
                            <span class="function-counter">22</span>
                            <div class="function-line">Line 33</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_filesystem.php: buildDirectoryResult()</div>
                    <div class="function-comment">
                        <pre>/**
* Build standardized directory operation result
*
* Factory function for consistent result array structure across directory operations
*
* @param bool $success - Operation success status
* @param string $message - Result message
* @param string $command - Optional manual command if operation failed (for admin execution)
* @return array - Result array with success, message, and command
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (22 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_filesystem.php</strong> (22x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 219</code>: <small>return buildDirectoryResult(false, &#039;Organism directory not found&#039;);</small></li>
                                    <li><code>line 224</code>: <small>return buildDirectoryResult(false, &#039;Invalid directory name (contains path separa</small></li>
                                    <li><code>line 232</code>: <small>return buildDirectoryResult(false, &quot;Directory &#039;$old_name&#039; not found&quot;);</small></li>
                                    <li><code>line 237</code>: <small>return buildDirectoryResult(false, &quot;Directory &#039;$new_name&#039; already exists&quot;);</small></li>
                                    <li><code>line 245</code>: <small>return buildDirectoryResult(true, &quot;Successfully renamed &#039;$old_name&#039; to &#039;$new_nam</small></li>
                                    <li><code>line 247</code>: <small>return buildDirectoryResult(false, &#039;Web server lacks permission to rename direct</small></li>
                                    <li><code>line 264</code>: <small>return buildDirectoryResult(false, &#039;Organism directory not found&#039;);</small></li>
                                    <li><code>line 269</code>: <small>return buildDirectoryResult(false, &#039;Invalid directory name (security check faile</small></li>
                                    <li><code>line 276</code>: <small>return buildDirectoryResult(false, &quot;Directory &#039;$dir_name&#039; not found&quot;);</small></li>
                                    <li><code>line 284</code>: <small>return buildDirectoryResult(true, &quot;Successfully deleted directory &#039;$dir_name&#039;&quot;, </small></li>
                                    <li><code>line 286</code>: <small>return buildDirectoryResult(false, &#039;Web server lacks permission to delete direct</small></li>
                                    <li><code>line 219</code>: <small>return buildDirectoryResult(false, &#039;Organism directory not found&#039;);</small></li>
                                    <li><code>line 224</code>: <small>return buildDirectoryResult(false, &#039;Invalid directory name (contains path separa</small></li>
                                    <li><code>line 232</code>: <small>return buildDirectoryResult(false, &quot;Directory &#039;$old_name&#039; not found&quot;);</small></li>
                                    <li><code>line 237</code>: <small>return buildDirectoryResult(false, &quot;Directory &#039;$new_name&#039; already exists&quot;);</small></li>
                                    <li><code>line 245</code>: <small>return buildDirectoryResult(true, &quot;Successfully renamed &#039;$old_name&#039; to &#039;$new_nam</small></li>
                                    <li><code>line 247</code>: <small>return buildDirectoryResult(false, &#039;Web server lacks permission to rename direct</small></li>
                                    <li><code>line 264</code>: <small>return buildDirectoryResult(false, &#039;Organism directory not found&#039;);</small></li>
                                    <li><code>line 269</code>: <small>return buildDirectoryResult(false, &#039;Invalid directory name (security check faile</small></li>
                                    <li><code>line 276</code>: <small>return buildDirectoryResult(false, &quot;Directory &#039;$dir_name&#039; not found&quot;);</small></li>
                                    <li><code>line 284</code>: <small>return buildDirectoryResult(true, &quot;Successfully deleted directory &#039;$dir_name&#039;&quot;, </small></li>
                                    <li><code>line 286</code>: <small>return buildDirectoryResult(false, &#039;Web server lacks permission to delete direct</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function buildDirectoryResult($success, $message, $command = &#039;&#039;) {
    return [
        &#039;success&#039; =&gt; $success,
        &#039;message&#039; =&gt; $message,
        &#039;command&#039; =&gt; $command
    ];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="validateAssemblyDirectories">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateAssemblyDirectories()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 51</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_filesystem.php: validateAssemblyDirectories()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate assembly directories match database records
*
* Checks that for each genome in the database, there is a corresponding directory
* named either genome_name or genome_accession
*
* @param string $dbFile - Path to SQLite database file
* @param string $organism_data_dir - Path to organism data directory
* @return array - Validation results with genomes list and mismatches
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 579</code>: <small>$assembly_validation = validateAssemblyDirectories($db_file, &quot;$organism_data_pat</small></li>
                                    <li><code>line 579</code>: <small>$assembly_validation = validateAssemblyDirectories($db_file, &quot;$organism_data_pat</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateAssemblyDirectories($dbFile, $organism_data_dir) {
    $result = [
        &#039;valid&#039; =&gt; true,
        &#039;genomes&#039; =&gt; [],
        &#039;mismatches&#039; =&gt; [],
        &#039;errors&#039; =&gt; []
    ];
    
    if (!file_exists($dbFile) || !is_readable($dbFile)) {
        $result[&#039;valid&#039;] = false;
        $result[&#039;errors&#039;][] = &#039;Database not readable&#039;;
        return $result;
    }
    
    if (!is_dir($organism_data_dir)) {
        $result[&#039;valid&#039;] = false;
        $result[&#039;errors&#039;][] = &#039;Organism directory not found&#039;;
        return $result;
    }
    
    try {
        $dbh = new PDO(&quot;sqlite:&quot; . $dbFile);
        $dbh-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        // Get all genome records
        $stmt = $dbh-&gt;query(&quot;SELECT genome_id, genome_name, genome_accession FROM genome ORDER BY genome_name&quot;);
        $genomes = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);
        
        // Get list of directories in organism folder
        $dirs = array_diff(scandir($organism_data_dir), [&#039;.&#039;, &#039;..&#039;]);
        $dir_names = [];
        foreach ($dirs as $dir) {
            $full_path = &quot;$organism_data_dir/$dir&quot;;
            if (is_dir($full_path)) {
                $dir_names[] = $dir;
            }
        }
        
        // Check each genome record
        foreach ($genomes as $genome) {
            $name = $genome[&#039;genome_name&#039;];
            $accession = $genome[&#039;genome_accession&#039;];
            $genome_id = $genome[&#039;genome_id&#039;];
            
            // Check if either name or accession matches a directory
            $found_dir = null;
            if (in_array($name, $dir_names)) {
                $found_dir = $name;
            } elseif (in_array($accession, $dir_names)) {
                $found_dir = $accession;
            }
            
            $result[&#039;genomes&#039;][] = [
                &#039;genome_id&#039; =&gt; $genome_id,
                &#039;genome_name&#039; =&gt; $name,
                &#039;genome_accession&#039; =&gt; $accession,
                &#039;directory_found&#039; =&gt; $found_dir,
                &#039;exists&#039; =&gt; $found_dir !== null
            ];
            
            if ($found_dir === null) {
                $result[&#039;valid&#039;] = false;
                $result[&#039;mismatches&#039;][] = [
                    &#039;type&#039; =&gt; &#039;missing_directory&#039;,
                    &#039;genome_name&#039; =&gt; $name,
                    &#039;genome_accession&#039; =&gt; $accession,
                    &#039;message&#039; =&gt; &quot;No directory found matching genome_name &#039;$name&#039; or genome_accession &#039;$accession&#039;&quot;
                ];
            } elseif ($found_dir !== $name &amp;&amp; $found_dir !== $accession) {
                // Directory exists but doesn&#039;t match expected names
                $result[&#039;mismatches&#039;][] = [
                    &#039;type&#039; =&gt; &#039;name_mismatch&#039;,
                    &#039;genome_name&#039; =&gt; $name,
                    &#039;genome_accession&#039; =&gt; $accession,
                    &#039;found_directory&#039; =&gt; $found_dir,
                    &#039;message&#039; =&gt; &quot;Directory &#039;$found_dir&#039; found, but doesn&#039;t match genome_name &#039;$name&#039; or genome_accession &#039;$accession&#039;&quot;
                ];
            }
        }
        
        $dbh = null;
    } catch (PDOException $e) {
        $result[&#039;valid&#039;] = false;
        $result[&#039;errors&#039;][] = &#039;Database query failed: &#039; . $e-&gt;getMessage();
    }
    
    return $result;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="validateAssemblyFastaFiles">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateAssemblyFastaFiles()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 150</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_filesystem.php: validateAssemblyFastaFiles()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate assembly FASTA files exist
*
* Checks if each assembly directory contains the required FASTA files
* based on sequence_types patterns from site config
*
* @param string $organism_dir - Path to organism directory
* @param array $sequence_types - Sequence type patterns from site_config
* @return array - Validation results for each assembly
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 582</code>: <small>$fasta_validation = validateAssemblyFastaFiles(&quot;$organism_data_path/$organism&quot;, </small></li>
                                    <li><code>line 582</code>: <small>$fasta_validation = validateAssemblyFastaFiles(&quot;$organism_data_path/$organism&quot;, </small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateAssemblyFastaFiles($organism_dir, $sequence_types) {
    $result = [
        &#039;assemblies&#039; =&gt; [],
        &#039;missing_files&#039; =&gt; []
    ];
    
    if (!is_dir($organism_dir)) {
        return $result;
    }
    
    // Get all directories in organism folder
    $dirs = array_diff(scandir($organism_dir), [&#039;.&#039;, &#039;..&#039;]);
    
    foreach ($dirs as $dir) {
        $full_path = &quot;$organism_dir/$dir&quot;;
        if (!is_dir($full_path)) {
            continue;
        }
        
        $assembly_info = [
            &#039;name&#039; =&gt; $dir,
            &#039;fasta_files&#039; =&gt; [],
            &#039;missing_patterns&#039; =&gt; []
        ];
        
        // Check for each sequence type pattern
        foreach ($sequence_types as $type =&gt; $config) {
            $pattern = $config[&#039;pattern&#039;];
            $files = glob(&quot;$full_path/*$pattern&quot;);
            
            if (!empty($files)) {
                $assembly_info[&#039;fasta_files&#039;][$type] = [
                    &#039;found&#039; =&gt; true,
                    &#039;pattern&#039; =&gt; $pattern,
                    &#039;file&#039; =&gt; basename($files[0])
                ];
            } else {
                $assembly_info[&#039;fasta_files&#039;][$type] = [
                    &#039;found&#039; =&gt; false,
                    &#039;pattern&#039; =&gt; $pattern
                ];
                $assembly_info[&#039;missing_patterns&#039;][] = $pattern;
            }
        }
        
        $result[&#039;assemblies&#039;][$dir] = $assembly_info;
        
        if (!empty($assembly_info[&#039;missing_patterns&#039;])) {
            $result[&#039;missing_files&#039;][$dir] = $assembly_info[&#039;missing_patterns&#039;];
        }
    }
    
    return $result;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="renameAssemblyDirectory">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">renameAssemblyDirectory()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 217</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_filesystem.php: renameAssemblyDirectory()</div>
                    <div class="function-comment">
                        <pre>/**
* Rename an assembly directory
*
* Renames a directory within an organism folder from old_name to new_name
* Used to align directory names with genome_name or genome_accession
* Returns manual command if automatic rename fails
*
* @param string $organism_dir - Path to organism directory
* @param string $old_name - Current directory name
* @param string $new_name - New directory name
* @return array - [&#039;success&#039; =&gt; bool, &#039;message&#039; =&gt; string, &#039;command&#039; =&gt; string (if manual fix needed)]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_organisms.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 51</code>: <small>$result = renameAssemblyDirectory($organism_dir, $old_name, $new_name);</small></li>
                                    <li><code>line 1090</code>: <small>&lt;button class=&quot;btn btn-info btn-sm w-100&quot; onclick=&quot;renameAssemblyDirectory(event</small></li>
                                    <li><code>line 51</code>: <small>$result = renameAssemblyDirectory($organism_dir, $old_name, $new_name);</small></li>
                                    <li><code>line 1090</code>: <small>&lt;button class=&quot;btn btn-info btn-sm w-100&quot; onclick=&quot;renameAssemblyDirectory(event</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function renameAssemblyDirectory($organism_dir, $old_name, $new_name) {
    if (!is_dir($organism_dir)) {
        return buildDirectoryResult(false, &#039;Organism directory not found&#039;);
    }
    
    // Validate both names for security
    if (!validateDirectoryName($old_name) || !validateDirectoryName($new_name)) {
        return buildDirectoryResult(false, &#039;Invalid directory name (contains path separators)&#039;);
    }
    
    $old_path = &quot;$organism_dir/$old_name&quot;;
    $new_path = &quot;$organism_dir/$new_name&quot;;
    
    // Validate old directory exists
    if (!is_dir($old_path)) {
        return buildDirectoryResult(false, &quot;Directory &#039;$old_name&#039; not found&quot;);
    }
    
    // Check new name doesn&#039;t already exist
    if (is_dir($new_path) || file_exists($new_path)) {
        return buildDirectoryResult(false, &quot;Directory &#039;$new_name&#039; already exists&quot;);
    }
    
    // Build command for admin to run if automatic rename fails
    $command = &quot;cd &quot; . escapeshellarg($organism_dir) . &quot; &amp;&amp; mv &quot; . escapeshellarg($old_name) . &quot; &quot; . escapeshellarg($new_name);
    
    // Try to rename
    if (@rename($old_path, $new_path)) {
        return buildDirectoryResult(true, &quot;Successfully renamed &#039;$old_name&#039; to &#039;$new_name&#039;&quot;, $command);
    } else {
        return buildDirectoryResult(false, &#039;Web server lacks permission to rename directory.&#039;, $command);
    }
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="deleteAssemblyDirectory">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">deleteAssemblyDirectory()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 262</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_filesystem.php: deleteAssemblyDirectory()</div>
                    <div class="function-comment">
                        <pre>/**
* Delete an assembly directory
*
* Recursively deletes a directory within an organism folder
* Used to remove incorrectly named or unused assembly directories
* Returns manual command if automatic delete fails
*
* @param string $organism_dir - Path to organism directory
* @param string $dir_name - Directory name to delete
* @return array - [&#039;success&#039; =&gt; bool, &#039;message&#039; =&gt; string, &#039;command&#039; =&gt; string (if manual fix needed)]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_organisms.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 72</code>: <small>$result = deleteAssemblyDirectory($organism_dir, $dir_name);</small></li>
                                    <li><code>line 1123</code>: <small>&lt;button class=&quot;btn btn-danger btn-sm w-100&quot; onclick=&quot;deleteAssemblyDirectory(eve</small></li>
                                    <li><code>line 72</code>: <small>$result = deleteAssemblyDirectory($organism_dir, $dir_name);</small></li>
                                    <li><code>line 1123</code>: <small>&lt;button class=&quot;btn btn-danger btn-sm w-100&quot; onclick=&quot;deleteAssemblyDirectory(eve</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function deleteAssemblyDirectory($organism_dir, $dir_name) {
    if (!is_dir($organism_dir)) {
        return buildDirectoryResult(false, &#039;Organism directory not found&#039;);
    }
    
    // Validate directory name for security
    if (!validateDirectoryName($dir_name)) {
        return buildDirectoryResult(false, &#039;Invalid directory name (security check failed)&#039;);
    }
    
    $dir_path = &quot;$organism_dir/$dir_name&quot;;
    
    // Validate directory exists
    if (!is_dir($dir_path)) {
        return buildDirectoryResult(false, &quot;Directory &#039;$dir_name&#039; not found&quot;);
    }
    
    // Build command for admin to run if automatic delete fails
    $command = &quot;rm -rf &quot; . escapeshellarg($dir_path);
    
    // Try to delete recursively
    if (rrmdir($dir_path)) {
        return buildDirectoryResult(true, &quot;Successfully deleted directory &#039;$dir_name&#039;&quot;, $command);
    } else {
        return buildDirectoryResult(false, &#039;Web server lacks permission to delete directory.&#039;, $command);
    }
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="rrmdir">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">rrmdir()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 283</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_filesystem.php: rrmdir()</div>
                    <div class="function-comment">
                        <pre>/**
* Recursively remove directory
*
* Helper function to delete a directory and all its contents
*
* @param string $dir - Directory path
* @return bool - True if successful
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_filesystem.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 283</code>: <small>if (rrmdir($dir_path)) {</small></li>
                                    <li><code>line 310</code>: <small>if (!rrmdir($path)) {</small></li>
                                    <li><code>line 283</code>: <small>if (rrmdir($dir_path)) {</small></li>
                                    <li><code>line 310</code>: <small>if (!rrmdir($path)) {</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function rrmdir($dir) {
    if (!is_dir($dir)) {
        return false;
    }
    
    $items = scandir($dir);
    foreach ($items as $item) {
        if ($item === &#039;.&#039; || $item === &#039;..&#039;) {
            continue;
        }
        $path = $dir . &#039;/&#039; . $item;
        if (is_dir($path)) {
            if (!rrmdir($path)) {
                return false;
            }
        } else {
            if (!@unlink($path)) {
                return false;
            }
        }
    }
    
    return @rmdir($dir);
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getFileWriteError">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getFileWriteError()</div>
                            <span class="function-counter">12</span>
                            <div class="function-line">Line 330</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_filesystem.php: getFileWriteError()</div>
                    <div class="function-comment">
                        <pre>/**
* Check file writeability and return error info if file is not writable
* Uses web server group and keeps original owner
*
* @param string $filepath - Path to file to check
* @return array|null - Array with error details if not writable, null if ok
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 5 unique file(s) (12 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/createUser.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 25</code>: <small>$file_write_error = getFileWriteError($usersFile);</small></li>
                                    <li><code>line 25</code>: <small>$file_write_error = getFileWriteError($usersFile);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_groups.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 28</code>: <small>$file_write_error = getFileWriteError($groups_file);</small></li>
                                    <li><code>line 31</code>: <small>$desc_file_write_error = getFileWriteError($descriptions_file);</small></li>
                                    <li><code>line 28</code>: <small>$file_write_error = getFileWriteError($groups_file);</small></li>
                                    <li><code>line 31</code>: <small>$desc_file_write_error = getFileWriteError($descriptions_file);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_annotations.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 12</code>: <small>$file_write_error = getFileWriteError($config_file);</small></li>
                                    <li><code>line 12</code>: <small>$file_write_error = getFileWriteError($config_file);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_phylo_tree.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 20</code>: <small>$file_write_error = getFileWriteError($tree_config_file);</small></li>
                                    <li><code>line 20</code>: <small>$file_write_error = getFileWriteError($tree_config_file);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_organisms.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 140</code>: <small>$write_error = getFileWriteError($organism_json_path);</small></li>
                                    <li><code>line 140</code>: <small>$write_error = getFileWriteError($organism_json_path);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getFileWriteError($filepath) {
    if (!file_exists($filepath) || is_writable($filepath)) {
        return null;
    }
    
    $webserver = getWebServerUser();
    $web_user = $webserver[&#039;user&#039;];
    $web_group = $webserver[&#039;group&#039;];
    
    $current_owner = function_exists(&#039;posix_getpwuid&#039;) ? posix_getpwuid(fileowner($filepath))[&#039;name&#039;] ?? &#039;unknown&#039; : &#039;unknown&#039;;
    $current_perms = substr(sprintf(&#039;%o&#039;, fileperms($filepath)), -4);
    
    // Command keeps original owner but changes group to webserver and sets perms to 664
    $fix_command = &quot;sudo chgrp &quot; . escapeshellarg($web_group) . &quot; &quot; . escapeshellarg($filepath) . &quot; &amp;&amp; sudo chmod 664 &quot; . escapeshellarg($filepath);
    
    return [
        &#039;owner&#039; =&gt; $current_owner,
        &#039;perms&#039; =&gt; $current_perms,
        &#039;web_user&#039; =&gt; $web_user,
        &#039;web_group&#039; =&gt; $web_group,
        &#039;command&#039; =&gt; $fix_command,
        &#039;file&#039; =&gt; $filepath
    ];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getDirectoryError">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getDirectoryError()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 361</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_filesystem.php: getDirectoryError()</div>
                    <div class="function-comment">
                        <pre>/**
* Check directory existence and writeability, return error info if issues found
* Uses owner of /moop directory and web server group
* Automatically detects if sudo is needed for the commands
*
* Usage:
*   $dir_error = getDirectoryError(&#039;/path/to/directory&#039;);
*   if ($dir_error) {
*       // Display error alert with fix instructions
*   }
*
* Can be used in any admin page that needs to ensure a directory exists and is writable.
* Common use cases:
*   - Image cache directories (ncbi_taxonomy, organisms, etc)
*   - Log directories
*   - Upload/temp directories
*   - Any other required filesystem paths
*
* @param string $dirpath - Path to directory to check
* @return array|null - Array with error details if directory missing/not writable, null if ok
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_groups.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 39</code>: <small>$change_log_error = @getDirectoryError($change_log_dir);</small></li>
                                    <li><code>line 42</code>: <small>$change_log_error = @getDirectoryError($change_log_dir);</small></li>
                                    <li><code>line 39</code>: <small>$change_log_error = @getDirectoryError($change_log_dir);</small></li>
                                    <li><code>line 42</code>: <small>$change_log_error = @getDirectoryError($change_log_dir);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_phylo_tree.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 21</code>: <small>$dir_error = getDirectoryError($absolute_images_path . &#039;/ncbi_taxonomy&#039;);</small></li>
                                    <li><code>line 21</code>: <small>$dir_error = getDirectoryError($absolute_images_path . &#039;/ncbi_taxonomy&#039;);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getDirectoryError($dirpath) {
    if (is_dir($dirpath) &amp;&amp; is_writable($dirpath)) {
        return null;
    }
    
    $webserver = getWebServerUser();
    $web_group = $webserver[&#039;group&#039;];
    
    // Get owner from /moop directory
    $moop_owner = &#039;ubuntu&#039;;  // Default fallback
    if (function_exists(&#039;posix_getpwuid&#039;)) {
        $moop_info = @stat(__DIR__ . &#039;/..&#039;);  // Get stat of /moop parent directory
        if ($moop_info) {
            $moop_pwd = posix_getpwuid($moop_info[&#039;uid&#039;]);
            if ($moop_pwd) {
                $moop_owner = $moop_pwd[&#039;name&#039;];
            }
        }
    }
    
    // Detect if sudo is needed
    $current_uid = function_exists(&#039;posix_getuid&#039;) ? posix_getuid() : null;
    $need_sudo = false;
    
    if ($current_uid !== null &amp;&amp; $current_uid !== 0) {
        // Not running as root, check if we&#039;re the moop owner
        $current_user = function_exists(&#039;posix_getpwuid&#039;) ? posix_getpwuid($current_uid)[&#039;name&#039;] ?? null : null;
        if ($current_user !== $moop_owner) {
            $need_sudo = true;
        }
    }
    
    // Helper function to add sudo if needed
    $cmd_prefix = $need_sudo ? &#039;sudo &#039; : &#039;&#039;;
    
    if (!is_dir($dirpath)) {
        // Directory doesn&#039;t exist
        return [
            &#039;type&#039; =&gt; &#039;missing&#039;,
            &#039;dir&#039; =&gt; $dirpath,
            &#039;owner&#039; =&gt; $moop_owner,
            &#039;group&#039; =&gt; $web_group,
            &#039;need_sudo&#039; =&gt; $need_sudo,
            &#039;commands&#039; =&gt; [
                &quot;{$cmd_prefix}mkdir -p &quot; . escapeshellarg($dirpath),
                &quot;{$cmd_prefix}chown {$moop_owner}:{$web_group} &quot; . escapeshellarg($dirpath),
                &quot;{$cmd_prefix}chmod 775 &quot; . escapeshellarg($dirpath)
            ]
        ];
    }
    
    // Directory exists but not writable
    $current_owner = function_exists(&#039;posix_getpwuid&#039;) ? posix_getpwuid(fileowner($dirpath))[&#039;name&#039;] ?? &#039;unknown&#039; : &#039;unknown&#039;;
    $current_perms = substr(sprintf(&#039;%o&#039;, fileperms($dirpath)), -4);
    
    return [
        &#039;type&#039; =&gt; &#039;not_writable&#039;,
        &#039;dir&#039; =&gt; $dirpath,
        &#039;owner&#039; =&gt; $current_owner,
        &#039;perms&#039; =&gt; $current_perms,
        &#039;target_owner&#039; =&gt; $moop_owner,
        &#039;target_group&#039; =&gt; $web_group,
        &#039;need_sudo&#039; =&gt; $need_sudo,
        &#039;commands&#039; =&gt; [
            &quot;{$cmd_prefix}chown {$moop_owner}:{$web_group} &quot; . escapeshellarg($dirpath),
            &quot;{$cmd_prefix}chmod 775 &quot; . escapeshellarg($dirpath)
        ]
    ];
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_json.php (4)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="loadJsonFile">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">loadJsonFile()</div>
                            <span class="function-counter">20</span>
                            <div class="function-line">Line 14</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_json.php: loadJsonFile()</div>
                    <div class="function-comment">
                        <pre>/**
* Load JSON file safely with error handling
*
* @param string $path Path to JSON file
* @param mixed $default Default value if file doesn&#039;t exist (default: [])
* @return mixed Decoded JSON data or default value
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 8 unique file(s) (20 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_database.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 303</code>: <small>$organism_info = loadJsonFile($organism_json_path);</small></li>
                                    <li><code>line 303</code>: <small>$organism_info = loadJsonFile($organism_json_path);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/lib/functions_data.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 230</code>: <small>$organism_info = loadJsonFile($organism_json_path);</small></li>
                                    <li><code>line 230</code>: <small>$organism_info = loadJsonFile($organism_json_path);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/lib/functions_json.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 88</code>: <small>$existing = loadJsonFile($file_path);</small></li>
                                    <li><code>line 88</code>: <small>$existing = loadJsonFile($file_path);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/groups_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 20</code>: <small>$group_descriptions = loadJsonFile($group_descriptions_file, []);</small></li>
                                    <li><code>line 20</code>: <small>$group_descriptions = loadJsonFile($group_descriptions_file, []);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/admin_access_check.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 8</code>: <small>$users = loadJsonFile($usersFile, []);</small></li>
                                    <li><code>line 8</code>: <small>$users = loadJsonFile($usersFile, []);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_groups.php</strong> (6x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 21</code>: <small>$groups_data = loadJsonFile($groups_file, []);</small></li>
                                    <li><code>line 25</code>: <small>$descriptions_data = loadJsonFile($descriptions_file, []);</small></li>
                                    <li><code>line 48</code>: <small>$descriptions_data = loadJsonFile($descriptions_file, []);</small></li>
                                    <li><code>line 21</code>: <small>$groups_data = loadJsonFile($groups_file, []);</small></li>
                                    <li><code>line 25</code>: <small>$descriptions_data = loadJsonFile($descriptions_file, []);</small></li>
                                    <li><code>line 48</code>: <small>$descriptions_data = loadJsonFile($descriptions_file, []);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_annotations.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 9</code>: <small>$config = loadJsonFile($config_file, []);</small></li>
                                    <li><code>line 9</code>: <small>$config = loadJsonFile($config_file, []);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_phylo_tree.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 81</code>: <small>$current_tree = loadJsonFile($tree_config_file, null);</small></li>
                                    <li><code>line 81</code>: <small>$current_tree = loadJsonFile($tree_config_file, null);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function loadJsonFile($path, $default = []) {
    if (!file_exists($path)) {
        return $default;
    }
    
    $json_content = file_get_contents($path);
    if ($json_content === false) {
        return $default;
    }
    
    $data = json_decode($json_content, true);
    return $data !== null ? $data : $default;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="loadJsonFileRequired">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">loadJsonFileRequired()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 36</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_json.php: loadJsonFileRequired()</div>
                    <div class="function-comment">
                        <pre>/**
* Load JSON file and require it to exist
*
* @param string $path Path to JSON file
* @param string $errorMsg Error message to log if file missing
* @param bool $exitOnError Whether to exit if file not found (default: true)
* @return mixed Decoded JSON data or empty array if error
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 41</code>: <small>$annotation_config = loadJsonFileRequired($annotation_config_file, &quot;Missing anno</small></li>
                                    <li><code>line 41</code>: <small>$annotation_config = loadJsonFileRequired($annotation_config_file, &quot;Missing anno</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function loadJsonFileRequired($path, $errorMsg = &#039;&#039;, $exitOnError = false) {
    if (!file_exists($path)) {
        if ($errorMsg) {
            error_log($errorMsg);
        }
        if ($exitOnError) {
            header(&quot;HTTP/1.1 500 Internal Server Error&quot;);
            exit(&quot;Required data file not found&quot;);
        }
        return [];
    }
    
    $json_content = file_get_contents($path);
    if ($json_content === false) {
        $msg = $errorMsg ?: &quot;Failed to read file: $path&quot;;
        error_log($msg);
        if ($exitOnError) {
            header(&quot;HTTP/1.1 500 Internal Server Error&quot;);
            exit(&quot;Failed to read required data&quot;);
        }
        return [];
    }
    
    $data = json_decode($json_content, true);
    if ($data === null) {
        $msg = $errorMsg ?: &quot;Invalid JSON in file: $path&quot;;
        error_log($msg);
        if ($exitOnError) {
            header(&quot;HTTP/1.1 500 Internal Server Error&quot;);
            exit(&quot;Invalid data format&quot;);
        }
        return [];
    }
    
    return $data;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="loadAndMergeJson">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">loadAndMergeJson()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 81</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_json.php: loadAndMergeJson()</div>
                    <div class="function-comment">
                        <pre>/**
* Load existing JSON file and merge with new data
* Handles wrapped JSON automatically, preserves existing fields not in merge data
*
* @param string $file_path Path to JSON file to load
* @param array $new_data New data to merge in (overwrites matching keys)
* @return array Merged data (or just new_data if file doesn&#039;t exist)
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_organisms.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 129</code>: <small>$metadata = loadAndMergeJson($organism_json_path, $metadata);</small></li>
                                    <li><code>line 129</code>: <small>$metadata = loadAndMergeJson($organism_json_path, $metadata);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function loadAndMergeJson($file_path, $new_data = []) {
    // If file doesn&#039;t exist, just return new data
    if (!file_exists($file_path)) {
        return $new_data;
    }
    
    // Load existing data
    $existing = loadJsonFile($file_path);
    
    if (!is_array($existing)) {
        return $new_data;
    }
    
    // Handle wrapped JSON (extra outer braces)
    if (!isset($existing[&#039;genus&#039;]) &amp;&amp; !isset($existing[&#039;common_name&#039;])) {
        $keys = array_keys($existing);
        if (count($keys) &gt; 0 &amp;&amp; is_array($existing[$keys[0]])) {
            $existing = $existing[$keys[0]];
        }
    }
    
    // Merge: existing fields are preserved, new data overwrites matching keys
    return array_merge($existing, $new_data);
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="decodeJsonString">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">decodeJsonString()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 113</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_json.php: decodeJsonString()</div>
                    <div class="function-comment">
                        <pre>/**
* Decode JSON string safely with type checking
*
* @param string $json_string JSON string to decode
* @param bool $as_array Return as array (default: true)
* @return array|null Decoded data or null if invalid
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_organisms.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 107</code>: <small>$images = decodeJsonString($images_json);</small></li>
                                    <li><code>line 108</code>: <small>$html_p = decodeJsonString($html_p_json);</small></li>
                                    <li><code>line 107</code>: <small>$images = decodeJsonString($images_json);</small></li>
                                    <li><code>line 108</code>: <small>$html_p = decodeJsonString($html_p_json);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function decodeJsonString($json_string, $as_array = true) {
    if (empty($json_string)) {
        return $as_array ? [] : null;
    }
    
    $decoded = json_decode($json_string, $as_array);
    
    // Validate it decoded properly
    if ($decoded === null &amp;&amp; json_last_error() !== JSON_ERROR_NONE) {
        error_log(&quot;JSON decode error: &quot; . json_last_error_msg());
        return $as_array ? [] : null;
    }
    
    return $decoded;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_system.php (4)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="getWebServerUser">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getWebServerUser()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 14</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_system.php: getWebServerUser()</div>
                    <div class="function-comment">
                        <pre>/**
* Get the web server user and group
*
* Detects the user running the current PHP process (web server)
*
* @return array - [&#039;user&#039; =&gt; string, &#039;group&#039; =&gt; string]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_filesystem.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 335</code>: <small>$webserver = getWebServerUser();</small></li>
                                    <li><code>line 381</code>: <small>$webserver = getWebServerUser();</small></li>
                                    <li><code>line 335</code>: <small>$webserver = getWebServerUser();</small></li>
                                    <li><code>line 381</code>: <small>$webserver = getWebServerUser();</small></li>
                                </ul></li>
                            <li><strong>/data/moop/lib/functions_system.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 66</code>: <small>$webserver = getWebServerUser();</small></li>
                                    <li><code>line 66</code>: <small>$webserver = getWebServerUser();</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getWebServerUser() {
    $user = &#039;www-data&#039;;
    $group = &#039;www-data&#039;;
    
    // Try to get the actual user running this process
    if (function_exists(&#039;posix_getuid&#039;)) {
        $uid = posix_getuid();
        $pwinfo = posix_getpwuid($uid);
        if ($pwinfo !== false) {
            $user = $pwinfo[&#039;name&#039;];
        }
    }
    
    // Try to get the actual group
    if (function_exists(&#039;posix_getgid&#039;)) {
        $gid = posix_getgid();
        $grinfo = posix_getgrgid($gid);
        if ($grinfo !== false) {
            $group = $grinfo[&#039;name&#039;];
        }
    }
    
    return [&#039;user&#039; =&gt; $user, &#039;group&#039; =&gt; $group];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="fixDatabasePermissions">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">fixDatabasePermissions()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 48</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_system.php: fixDatabasePermissions()</div>
                    <div class="function-comment">
                        <pre>/**
* Attempt to fix database file permissions
*
* Tries to make database readable by web server user.
* Returns instructions if automatic fix fails.
*
* @param string $dbFile - Path to database file
* @return array - [&#039;success&#039; =&gt; bool, &#039;message&#039; =&gt; string, &#039;command&#039; =&gt; string (if manual fix needed)]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/manage_organisms.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 29</code>: <small>$result = fixDatabasePermissions($db_file);</small></li>
                                    <li><code>line 704</code>: <small>&lt;button class=&quot;btn btn-warning btn-sm&quot; onclick=&quot;fixDatabasePermissions(event, &#039;&lt;</small></li>
                                    <li><code>line 29</code>: <small>$result = fixDatabasePermissions($db_file);</small></li>
                                    <li><code>line 704</code>: <small>&lt;button class=&quot;btn btn-warning btn-sm&quot; onclick=&quot;fixDatabasePermissions(event, &#039;&lt;</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function fixDatabasePermissions($dbFile) {
    $result = [
        &#039;success&#039; =&gt; false,
        &#039;message&#039; =&gt; &#039;&#039;,
        &#039;command&#039; =&gt; &#039;&#039;
    ];
    
    if (!file_exists($dbFile)) {
        $result[&#039;message&#039;] = &#039;Database file not found&#039;;
        return $result;
    }
    
    if (!is_file($dbFile)) {
        $result[&#039;message&#039;] = &#039;Path is not a file&#039;;
        return $result;
    }
    
    // Get web server user
    $webserver = getWebServerUser();
    $web_user = $webserver[&#039;user&#039;];
    $web_group = $webserver[&#039;group&#039;];
    
    // Get file info for reporting
    $file_owner = function_exists(&#039;posix_getpwuid&#039;) ? posix_getpwuid(fileowner($dbFile))[&#039;name&#039;] : &#039;unknown&#039;;
    $file_group = function_exists(&#039;posix_getgrgid&#039;) ? posix_getgrgid(filegroup($dbFile))[&#039;name&#039;] : &#039;unknown&#039;;
    $current_perms = substr(sprintf(&#039;%o&#039;, fileperms($dbFile)), -4);
    
    // Build command for admin to run if automatic fix fails
    $result[&#039;command&#039;] = &quot;sudo chmod 644 &quot; . escapeshellarg($dbFile) . &quot; &amp;&amp; sudo chown &quot; . escapeshellarg(&quot;$web_user:$web_group&quot;) . &quot; &quot; . escapeshellarg($dbFile);
    
    // Try to fix permissions
    try {
        // Try chmod to make readable (644 = rw-r--r--)
        $chmod_result = @chmod($dbFile, 0644);
        
        if (!$chmod_result) {
            $result[&#039;message&#039;] = &#039;Web server lacks permission to change file permissions.&#039;;
            return $result;
        }
        
        // Try to change ownership to web server user (may fail if not root)
        @chown($dbFile, $web_user);
        @chgrp($dbFile, $web_group);
        
        // Verify it worked
        if (is_readable($dbFile)) {
            $result[&#039;success&#039;] = true;
            $result[&#039;message&#039;] = &#039;Permissions fixed successfully! Database is now readable.&#039;;
        } else {
            $result[&#039;message&#039;] = &#039;Permissions were modified but file still not readable.&#039;;
        }
        
    } catch (Exception $e) {
        $result[&#039;message&#039;] = &#039;Error: &#039; . $e-&gt;getMessage();
    }
    
    return $result;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="fixFilePermissions">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">fixFilePermissions()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 117</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_system.php: fixFilePermissions()</div>
                    <div class="function-comment">
                        <pre>/**
* Fix file or directory permissions (AJAX handler)
*
* Called via AJAX when user clicks &quot;Fix Permissions&quot; button.
* Only works if web server has sufficient permissions to chmod/chown.
*
* @param string $file_path Path to file or directory
* @param string $file_type &#039;file&#039; or &#039;directory&#039;
* @return array Result array with &#039;success&#039;, &#039;message&#039; keys
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_system.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 213</code>: <small>return fixFilePermissions($file_path, $file_type);</small></li>
                                    <li><code>line 213</code>: <small>return fixFilePermissions($file_path, $file_type);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/lib/functions_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 425</code>: <small>$html .= &#039;  &lt;button class=&quot;btn btn-warning btn-sm&quot; onclick=&quot;fixFilePermissions(e</small></li>
                                    <li><code>line 425</code>: <small>$html .= &#039;  &lt;button class=&quot;btn btn-warning btn-sm&quot; onclick=&quot;fixFilePermissions(e</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function fixFilePermissions($file_path, $file_type = &#039;file&#039;) {
    $result = [
        &#039;success&#039; =&gt; false,
        &#039;message&#039; =&gt; &#039;&#039;,
        &#039;command&#039; =&gt; &#039;&#039;
    ];
    
    // Validate input
    if (empty($file_path) || !file_exists($file_path)) {
        $result[&#039;message&#039;] = &#039;File or directory not found&#039;;
        return $result;
    }
    
    $is_dir = is_dir($file_path);
    
    // Get web server user info
    $web_user = get_current_user() ?: &#039;www-data&#039;;
    $web_group_info = @posix_getgrgid(@posix_getegid());
    $web_group = $web_group_info !== false ? $web_group_info[&#039;name&#039;] : &#039;www-data&#039;;
    
    try {
        if ($is_dir) {
            // For directories: chmod 755 (rwxr-xr-x)
            $chmod_result = @chmod($file_path, 0755);
            
            if (!$chmod_result) {
                $result[&#039;message&#039;] = &#039;Web server lacks permission to change directory permissions.&#039;;
                return $result;
            }
            
            // Try to change ownership (may fail if not root)
            @chown($file_path, $web_user);
            @chgrp($file_path, $web_group);
            
            // Verify it worked
            if (is_readable($file_path) &amp;&amp; is_writable($file_path)) {
                $result[&#039;success&#039;] = true;
                $result[&#039;message&#039;] = &#039;Directory permissions fixed successfully!&#039;;
            } else {
                $result[&#039;message&#039;] = &#039;Permissions were modified but directory still has issues.&#039;;
            }
        } else {
            // For files: chmod 644 (rw-r--r--)
            $chmod_result = @chmod($file_path, 0644);
            
            if (!$chmod_result) {
                $result[&#039;message&#039;] = &#039;Web server lacks permission to change file permissions.&#039;;
                return $result;
            }
            
            // Try to change ownership (may fail if not root)
            @chown($file_path, $web_user);
            @chgrp($file_path, $web_group);
            
            // Verify it worked
            if (is_readable($file_path)) {
                $result[&#039;success&#039;] = true;
                $result[&#039;message&#039;] = &#039;File permissions fixed successfully!&#039;;
            } else {
                $result[&#039;message&#039;] = &#039;Permissions were modified but file still not readable.&#039;;
            }
        }
    } catch (Exception $e) {
        $result[&#039;message&#039;] = &#039;Error: &#039; . $e-&gt;getMessage();
    }
    
    return $result;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="handleFixFilePermissionsAjax">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">handleFixFilePermissionsAjax()</div>
                            <span class="function-counter">10</span>
                            <div class="function-line">Line 192</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_system.php: handleFixFilePermissionsAjax()</div>
                    <div class="function-comment">
                        <pre>/**
* Handle file permission fix AJAX request
*
* Call this in your admin script&#039;s POST handler:
* if (isset($_POST[&#039;action&#039;]) &amp;&amp; $_POST[&#039;action&#039;] === &#039;fix_file_permissions&#039;) {
*     header(&#039;Content-Type: application/json&#039;);
*     echo json_encode(handleFixFilePermissionsAjax());
*     exit;
* }
*
* @return array JSON-serializable result array
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 5 unique file(s) (10 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/admin/createUser.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 10</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                    <li><code>line 10</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_groups.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 12</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                    <li><code>line 12</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_phylo_tree.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 12</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                    <li><code>line 12</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_registry.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 11</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                    <li><code>line 11</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                </ul></li>
                            <li><strong>/data/moop/admin/manage_organisms.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 12</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                    <li><code>line 12</code>: <small>echo json_encode(handleFixFilePermissionsAjax());</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function handleFixFilePermissionsAjax() {
    if (empty($_POST[&#039;file_path&#039;])) {
        return [&#039;success&#039; =&gt; false, &#039;message&#039; =&gt; &#039;File path not provided&#039;];
    }
    
    $file_path = $_POST[&#039;file_path&#039;];
    $file_type = $_POST[&#039;file_type&#039;] ?? &#039;file&#039;;
    
    // Basic security: prevent directory traversal
    $file_path = realpath($file_path);
    
    if (!$file_path || !file_exists($file_path)) {
        return [&#039;success&#039; =&gt; false, &#039;message&#039; =&gt; &#039;File or directory not found&#039;];
    }
    
    return fixFilePermissions($file_path, $file_type);
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_tools.php (2)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="getAvailableTools">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAvailableTools()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 14</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_tools.php: getAvailableTools()</div>
                    <div class="function-comment">
                        <pre>/**
* Get available tools filtered by context
* Returns only tools that have the required context parameters available
*
* @param array $context - Context array with optional keys: organism, assembly, group, display_name
* @return array - Array of available tools with built URLs
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/tool_section.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 62</code>: <small>$tools = getAvailableTools($context ?? []);</small></li>
                                    <li><code>line 62</code>: <small>$tools = getAvailableTools($context ?? []);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAvailableTools($context = []) {
    global $site, $available_tools;
    
    // Include tool configuration
    include_once __DIR__ . &#039;/tool_config.php&#039;;
    
    // If $available_tools not set by include, return empty array
    if (!isset($available_tools) || !is_array($available_tools)) {
        return [];
    }
    
    // Get current page from context (optional)
    $current_page = $context[&#039;page&#039;] ?? null;
    
    $tools = [];
    foreach ($available_tools as $tool_id =&gt; $tool) {
        // Check page visibility - skip if tool doesn&#039;t show on this page
        if ($current_page &amp;&amp; !isToolVisibleOnPage($tool, $current_page)) {
            continue;
        }
        
        $url = buildToolUrl($tool_id, $context, $site);
        if ($url) {
            $tools[$tool_id] = array_merge($tool, [&#039;url&#039; =&gt; $url]);
        }
    }
    
    return $tools;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="createToolContext">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">createToolContext()</div>
                            <span class="function-counter">11</span>
                            <div class="function-line">Line 55</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_tools.php: createToolContext()</div>
                    <div class="function-comment">
                        <pre>/**
* Create a tool context for tool_section.php
*
* Builds a context array with page type and available entity parameters.
* Filters out null/empty values to keep context clean.
*
* @param string $page Page identifier: &#039;index&#039;, &#039;organism&#039;, &#039;assembly&#039;, &#039;group&#039;, &#039;parent&#039;, &#039;multi_organism_search&#039;
* @param array $params Optional entity parameters: organism, assembly, group, organisms, display_name, use_onclick_handler
* @return array Context array for tool_section.php
*
* Examples:
*   createToolContext(&#039;index&#039;, [&#039;use_onclick_handler&#039; =&gt; true])
*   createToolContext(&#039;organism&#039;, [&#039;organism&#039; =&gt; $name, &#039;display_name&#039; =&gt; $common_name])
*   createToolContext(&#039;assembly&#039;, [&#039;organism&#039; =&gt; $org, &#039;assembly&#039; =&gt; $acc, &#039;display_name&#039; =&gt; $name])
*   createToolContext(&#039;group&#039;, [&#039;group&#039; =&gt; $name])
*   createToolContext(&#039;parent&#039;, [&#039;organism&#039; =&gt; $org, &#039;assembly&#039; =&gt; $acc, &#039;display_name&#039; =&gt; $feature])
*   createToolContext(&#039;multi_organism_search&#039;, [&#039;organisms&#039; =&gt; $orgs, &#039;display_name&#039; =&gt; $name])
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 6 unique file(s) (11 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/groups_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 100</code>: <small>$context = createToolContext(&#039;group&#039;, [&#039;group&#039; =&gt; $group_name]);</small></li>
                                    <li><code>line 100</code>: <small>$context = createToolContext(&#039;group&#039;, [&#039;group&#039; =&gt; $group_name]);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/assembly_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 72</code>: <small>$context = createToolContext(&#039;assembly&#039;, [</small></li>
                                    <li><code>line 72</code>: <small>$context = createToolContext(&#039;assembly&#039;, [</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/organism_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 70</code>: <small>$context = createToolContext(&#039;organism&#039;, [</small></li>
                                    <li><code>line 70</code>: <small>$context = createToolContext(&#039;organism&#039;, [</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 198</code>: <small>$context = createToolContext(&#039;parent&#039;, [</small></li>
                                    <li><code>line 198</code>: <small>$context = createToolContext(&#039;parent&#039;, [</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/multi_organism_search.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 85</code>: <small>$context = createToolContext(&#039;multi_organism_search&#039;, [&#039;organisms&#039; =&gt; $organisms</small></li>
                                    <li><code>line 85</code>: <small>$context = createToolContext(&#039;multi_organism_search&#039;, [&#039;organisms&#039; =&gt; $organisms</small></li>
                                </ul></li>
                            <li><strong>/data/moop/index.php</strong> (1x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 123</code>: <small>$context = createToolContext(&#039;index&#039;, [&#039;use_onclick_handler&#039; =&gt; true]);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function createToolContext($page, $params = []) {
    $context = [&#039;page&#039; =&gt; $page];
    
    // Add optional parameters if provided and not null/empty
    $optional_keys = [&#039;organism&#039;, &#039;assembly&#039;, &#039;group&#039;, &#039;organisms&#039;, &#039;display_name&#039;, &#039;use_onclick_handler&#039;];
    foreach ($optional_keys as $key) {
        if (!empty($params[$key])) {
            $context[$key] = $params[$key];
        }
    }
    
    // Set sensible defaults for display_name if not provided
    if (empty($context[&#039;display_name&#039;])) {
        if (!empty($context[&#039;organism&#039;])) {
            $context[&#039;display_name&#039;] = $context[&#039;organism&#039;];
        } elseif (!empty($context[&#039;group&#039;])) {
            $context[&#039;display_name&#039;] = $context[&#039;group&#039;];
        } elseif ($page === &#039;index&#039;) {
            $context[&#039;display_name&#039;] = &#039;Multi-Organism Search&#039;;
        } elseif ($page === &#039;multi_organism_search&#039;) {
            $context[&#039;display_name&#039;] = &#039;Multi-Organism Search&#039;;
        }
    }
    
    return $context;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/functions_validation.php (6)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="test_input">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">test_input()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 23</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_validation.php: test_input()</div>
                    <div class="function-comment">
                        <pre>/**
* Sanitize user input - remove dangerous characters
*
* DEPRECATED: Use context-specific sanitization instead:
* - For database queries: Use prepared statements with parameter binding
* - For HTML output: Use htmlspecialchars() at the point of output
* - For URL parameters: Use urlencode()/urldecode() as needed
*
* This function is kept for backwards compatibility but combines multiple
* concerns and is typically misused. It applies both raw character removal
* and HTML escaping, which should be handled separately based on context.
*
* @param string $data - Raw user input
* @return string - Sanitized string with &lt; &gt; removed and HTML entities escaped
* @deprecated Use prepared statements and context-specific escaping
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function test_input($data) {
    $data = stripslashes($data);
    $data = preg_replace(&#039;/[\&lt;\&gt;]+/&#039;, &#039;&#039;, $data);
    $data = htmlspecialchars($data);
    return $data;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="sanitize_search_input">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">sanitize_search_input()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 40</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_validation.php: sanitize_search_input()</div>
                    <div class="function-comment">
                        <pre>/**
* Sanitize search input specifically for use in database search queries
*
* This function handles search-specific sanitization that removes or escapes
* characters that could interfere with search functionality while preserving
* useful search characters like spaces, quotes, and basic punctuation.
*
* @param string $input - Raw search input from user
* @return string - Sanitized search string safe for database queries
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_validation.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 69</code>: <small>$term = sanitize_search_input($term);</small></li>
                                    <li><code>line 69</code>: <small>$term = sanitize_search_input($term);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/annotation_search_ajax.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 59</code>: <small>$search_input = sanitize_search_input($search_keywords, $quoted_search);</small></li>
                                    <li><code>line 59</code>: <small>$search_input = sanitize_search_input($search_keywords, $quoted_search);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function sanitize_search_input($input, $quoted_search = false) {
    // Remove null bytes and control characters
    $input = preg_replace(&#039;/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/&#039;, &#039;&#039;, $input);
    
    // Trim whitespace
    $input = trim($input);
    
    // Remove quotes if this is a quoted search - they will be removed before passing to database
    if ($quoted_search) {
        $input = trim($input, &#039;&quot;&#039;);
    }
    
    // Remove excessive whitespace (multiple spaces become single space)
    $input = preg_replace(&#039;/\s+/&#039;, &#039; &#039;, $input);
    
    return $input;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="validate_search_term">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validate_search_term()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 68</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_validation.php: validate_search_term()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate a search term for safety and usability
*
* Checks that a search term meets minimum requirements and doesn&#039;t contain
* problematic patterns that could cause issues with database queries or
* return meaningless results.
*
* @param string $term - Search term to validate
* @return array - Validation result with &#039;valid&#039; boolean and &#039;error&#039; message
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function validate_search_term($term) {
    $term = sanitize_search_input($term);
    
    if (empty($term)) {
        return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; &#039;Search term cannot be empty&#039;];
    }
    
    if (strlen($term) &lt; 2) {
        return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; &#039;Search term must be at least 2 characters long&#039;];
    }
    
    if (strlen($term) &gt; 100) {
        return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; &#039;Search term too long (maximum 100 characters)&#039;];
    }
    
    // Check for patterns that might cause performance issues
    if (preg_match(&#039;/^[%_*]+$/&#039;, $term)) {
        return [&#039;valid&#039; =&gt; false, &#039;error&#039; =&gt; &#039;Search term cannot consist only of wildcards&#039;];
    }
    
    return [&#039;valid&#039; =&gt; true, &#039;term&#039; =&gt; $term];
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="is_quoted_search">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">is_quoted_search()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 97</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_validation.php: is_quoted_search()</div>
                    <div class="function-comment">
                        <pre>/**
* Check if a search term is quoted (surrounded by quotes)
*
* @param string $term - Search term to check
* @return bool - True if term is quoted, false otherwise
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function is_quoted_search($term) {
    $term = trim($term);
    return (strlen($term) &gt;= 2 &amp;&amp; 
            (($term[0] === &#039;&quot;&#039; &amp;&amp; $term[-1] === &#039;&quot;&#039;) ||
             ($term[0] === &quot;&#039;&quot; &amp;&amp; $term[-1] === &quot;&#039;&quot;)));
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="validateOrganismParam">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateOrganismParam()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 112</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_validation.php: validateOrganismParam()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate and extract organism parameter from GET/POST
* Redirects to home if missing/empty
*
* @param string $organism_name Organism name to validate
* @param string $redirect_on_empty URL to redirect to if empty (default: /moop/index.php)
* @return string Validated organism name
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 3 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 273</code>: <small>$organism_name = validateOrganismParam($organism_name, $redirect_home);</small></li>
                                    <li><code>line 273</code>: <small>$organism_name = validateOrganismParam($organism_name, $redirect_home);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/assembly_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 8</code>: <small>$organism_name = validateOrganismParam($_GET[&#039;organism&#039;] ?? &#039;&#039;);</small></li>
                                    <li><code>line 8</code>: <small>$organism_name = validateOrganismParam($_GET[&#039;organism&#039;] ?? &#039;&#039;);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 11</code>: <small>$organism_name = validateOrganismParam($_GET[&#039;organism&#039;] ?? &#039;&#039;, null);</small></li>
                                    <li><code>line 11</code>: <small>$organism_name = validateOrganismParam($_GET[&#039;organism&#039;] ?? &#039;&#039;, null);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateOrganismParam($organism_name, $redirect_on_empty = &#039;/moop/index.php&#039;) {
    if (empty($organism_name)) {
        header(&quot;Location: $redirect_on_empty&quot;);
        exit;
    }
    return $organism_name;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="validateAssemblyParam">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">validateAssemblyParam()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 128</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/functions_validation.php: validateAssemblyParam()</div>
                    <div class="function-comment">
                        <pre>/**
* Validate and extract assembly parameter from GET/POST
* Redirects to home if missing/empty
*
* @param string $assembly Assembly accession to validate
* @param string $redirect_on_empty URL to redirect to if empty
* @return string Validated assembly name
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/assembly_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 9</code>: <small>$assembly_accession = validateAssemblyParam($_GET[&#039;assembly&#039;] ?? &#039;&#039;);</small></li>
                                    <li><code>line 9</code>: <small>$assembly_accession = validateAssemblyParam($_GET[&#039;assembly&#039;] ?? &#039;&#039;);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 12</code>: <small>$uniquename = validateAssemblyParam($_GET[&#039;uniquename&#039;] ?? &#039;&#039;, null);</small></li>
                                    <li><code>line 12</code>: <small>$uniquename = validateAssemblyParam($_GET[&#039;uniquename&#039;] ?? &#039;&#039;, null);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function validateAssemblyParam($assembly, $redirect_on_empty = &#039;/moop/index.php&#039;) {
    if (empty($assembly)) {
        header(&quot;Location: $redirect_on_empty&quot;);
        exit;
    }
    return $assembly;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/parent_functions.php (6)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="getAncestors">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAncestors()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 18</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/parent_functions.php: getAncestors()</div>
                    <div class="function-comment">
                        <pre>/**
* Get hierarchy of features (ancestors)
* Traverses up the feature hierarchy from a given feature to its parents/grandparents
* Optionally filters by genome_ids for permission-based access
*
* @param string $feature_uniquename - The feature uniquename to start from
* @param string $dbFile - Path to SQLite database
* @param array $genome_ids - Optional: Array of genome IDs to filter results (empty = no filtering)
* @return array - Array of features: [self, parent, grandparent, ...]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 71</code>: <small>$ancestors = getAncestors($uniquename, $db, $accessible_genome_ids);</small></li>
                                    <li><code>line 71</code>: <small>$ancestors = getAncestors($uniquename, $db, $accessible_genome_ids);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAncestors($feature_uniquename, $dbFile, $genome_ids = []) {
    $feature = getFeatureByUniquename($feature_uniquename, $dbFile, $genome_ids);
    
    if (empty($feature)) {
        return [];
    }
    
    $ancestors = [$feature];
    
    if ($feature[&#039;parent_feature_id&#039;]) {
        $parent_ancestors = getAncestorsByFeatureId($feature[&#039;parent_feature_id&#039;], $dbFile, $genome_ids);
        $ancestors = array_merge($ancestors, $parent_ancestors);
    }
    
    return $ancestors;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAncestorsByFeatureId">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAncestorsByFeatureId()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 28</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/parent_functions.php: getAncestorsByFeatureId()</div>
                    <div class="function-comment">
                        <pre>/**
* Helper function for recursive ancestor traversal
* Fetches ancestors by feature_id (used internally by getAncestors)
* Optionally filters by genome_ids for permission-based access
*
* @param int $feature_id - The feature ID to start from
* @param string $dbFile - Path to SQLite database
* @param array $genome_ids - Optional: Array of genome IDs to filter results
* @return array - Array of ancestor features
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/parent_functions.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 28</code>: <small>$parent_ancestors = getAncestorsByFeatureId($feature[&#039;parent_feature_id&#039;], $dbFi</small></li>
                                    <li><code>line 55</code>: <small>$parent_ancestors = getAncestorsByFeatureId($feature[&#039;parent_feature_id&#039;], $dbFi</small></li>
                                    <li><code>line 28</code>: <small>$parent_ancestors = getAncestorsByFeatureId($feature[&#039;parent_feature_id&#039;], $dbFi</small></li>
                                    <li><code>line 55</code>: <small>$parent_ancestors = getAncestorsByFeatureId($feature[&#039;parent_feature_id&#039;], $dbFi</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAncestorsByFeatureId($feature_id, $dbFile, $genome_ids = []) {
    $feature = getParentFeature($feature_id, $dbFile, $genome_ids);
    
    if (empty($feature)) {
        return [];
    }
    
    $ancestors = [$feature];
    
    if ($feature[&#039;parent_feature_id&#039;]) {
        $parent_ancestors = getAncestorsByFeatureId($feature[&#039;parent_feature_id&#039;], $dbFile, $genome_ids);
        $ancestors = array_merge($ancestors, $parent_ancestors);
    }
    
    return $ancestors;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getChildren">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getChildren()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 72</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/parent_functions.php: getChildren()</div>
                    <div class="function-comment">
                        <pre>/**
* Get all children and descendants of a feature
* Recursively fetches all child features at any depth
* Optionally filters by genome_ids for permission-based access
*
* @param int $feature_id - The parent feature ID
* @param string $dbFile - Path to SQLite database
* @param array $genome_ids - Optional: Array of genome IDs to filter results (empty = no filtering)
* @return array - Flat array of all children and descendants
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 3 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/parent_functions.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 79</code>: <small>$child_descendants = getChildren($row[&#039;feature_id&#039;], $dbFile, $genome_ids);</small></li>
                                    <li><code>line 79</code>: <small>$child_descendants = getChildren($row[&#039;feature_id&#039;], $dbFile, $genome_ids);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/retrieve_sequences.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 101</code>: <small>$children = getChildren($feature_id, $db);</small></li>
                                    <li><code>line 101</code>: <small>$children = getChildren($feature_id, $db);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 122</code>: <small>$children = getChildren($feature_id, $db, $accessible_genome_ids);</small></li>
                                    <li><code>line 122</code>: <small>$children = getChildren($feature_id, $db, $accessible_genome_ids);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getChildren($feature_id, $dbFile, $genome_ids = []) {
    $children = [];
    
    $results = getChildrenByFeatureId($feature_id, $dbFile, $genome_ids);
    
    foreach ($results as $row) {
        $children[] = $row;
        $child_descendants = getChildren($row[&#039;feature_id&#039;], $dbFile, $genome_ids);
        $children = array_merge($children, $child_descendants);
    }
    return $children;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateAnnotationTableHTML">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateAnnotationTableHTML()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 99</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/parent_functions.php: generateAnnotationTableHTML()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate annotation table with export buttons
* Creates a responsive HTML table displaying annotations with sorting/filtering
*
* @param array $results - Annotation results from database
* @param string $uniquename - Feature uniquename (for export)
* @param string $type - Feature type (for export)
* @param int $count - Table counter (ensures unique IDs)
* @param string $annotation_type - Type of annotation (e.g., &quot;InterPro&quot;)
* @param string $desc - Description/definition of annotation type
* @param string $color - Bootstrap color class for badge
* @param string $organism - Organism name (for export)
* @return string - HTML for the annotation table section
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (4x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 261</code>: <small>echo generateAnnotationTableHTML($annot_results, $feature_uniquename, $type, $co</small></li>
                                    <li><code>line 325</code>: <small>echo generateAnnotationTableHTML($annot_results, $child_uniquename, $child_type,</small></li>
                                    <li><code>line 261</code>: <small>echo generateAnnotationTableHTML($annot_results, $feature_uniquename, $type, $co</small></li>
                                    <li><code>line 325</code>: <small>echo generateAnnotationTableHTML($annot_results, $child_uniquename, $child_type,</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function generateAnnotationTableHTML($results, $uniquename, $type, $count, $annotation_type, $desc, $color = &#039;warning&#039;, $organism = &#039;&#039;) {
    if (empty($results)) {
        return &#039;&#039;;
    }
    
    $table_id = &quot;annotTable_$count&quot;;
    $result_count = count($results);
    $desc_id = &quot;annotDesc_$count&quot;;
    
    // Determine text color based on background color
    $text_color = in_array($color, [&#039;warning&#039;, &#039;info&#039;, &#039;secondary&#039;]) ? &#039;text-dark&#039; : &#039;text-white&#039;;
    
    // Border color matches badge color
    $border_class = &quot;border-$color&quot;;
    
    // Create unique ID for this annotation section
    $section_id = &quot;annot_section_&quot; . preg_replace(&#039;/[^a-zA-Z0-9_]/&#039;, &#039;_&#039;, $uniquename . &#039;_&#039; . $annotation_type);
    
    $html = &#039;&lt;div class=&quot;annotation-section mb-3 &#039; . htmlspecialchars($border_class) . &#039;&quot; id=&quot;&#039; . htmlspecialchars($section_id) . &#039;&quot;&gt;&#039;;
    $html .= &#039;&lt;div class=&quot;d-flex justify-content-between align-items-center mb-2&quot;&gt;&#039;;
    $html .= &quot;&lt;h5 class=\&quot;mb-0\&quot;&gt;&lt;span class=\&quot;badge bg-&quot; . htmlspecialchars($color) . &quot; $text_color badge-lg\&quot;&gt;&quot; . htmlspecialchars($annotation_type) . &quot;&lt;/span&gt;&quot;;
    $html .= &quot; &lt;span class=\&quot;badge bg-secondary badge-lg\&quot;&gt;&quot; . htmlspecialchars($result_count) . &quot; result&quot; . ($result_count &gt; 1 ? &#039;s&#039; : &#039;&#039;) . &quot;&lt;/span&gt;&quot;;
    
    if ($desc) {
        $html .= &quot;&amp;nbsp;&lt;button class=\&quot;btn btn-sm btn-link p-0 annotation-info-btn\&quot; type=\&quot;button\&quot; data-bs-toggle=\&quot;collapse\&quot; data-bs-target=\&quot;#&quot; . htmlspecialchars($desc_id) . &quot;\&quot; aria-expanded=\&quot;false\&quot;&gt;&quot;;
        $html .= &quot;&lt;i class=\&quot;fas fa-info-circle\&quot;&gt;&lt;/i&gt;&quot;;
        $html .= &quot;&lt;/button&gt;&quot;;
    }
    
    $html .= &quot;&lt;/h5&gt;&quot;;
    $html .= &#039;&lt;div class=&quot;d-flex gap-2 align-items-center&quot;&gt;&#039;;
    $html .= &#039;&lt;div id=&quot;&#039; . htmlspecialchars($table_id) . &#039;_filter&quot; class=&quot;dataTables_filter&quot;&gt;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;a href=&quot;#sequencesSection&quot; class=&quot;btn btn-sm btn-info&quot; title=&quot;Jump to sequences section&quot;&gt;&lt;i class=&quot;fas fa-dna&quot;&gt;&lt;/i&gt; Jump to Sequences&lt;/a&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    $html .= &#039;&lt;/div&gt;&#039;;
    
    if ($desc) {
        $html .= &#039;&lt;div class=&quot;collapse mb-3&quot; id=&quot;&#039; . htmlspecialchars($desc_id) . &#039;&quot;&gt;&#039;;
        $html .= &#039;&lt;div class=&quot;alert alert-info mb-0 font-size-xsmall&quot;&gt;&#039;;
        $html .= $desc;
        $html .= &#039;&lt;/div&gt;&#039;;
        $html .= &#039;&lt;/div&gt;&#039;;
    }
    
    // Table with DataTables
    $html .= &quot;&lt;div class=\&quot;table-responsive\&quot;&gt;&quot;;
    $html .= &quot;&lt;table id=\&quot;&quot; . htmlspecialchars($table_id) . &quot;\&quot; class=\&quot;table table-sm table-striped table-hover\&quot; style=\&quot;width:100%;\&quot;&gt;&quot;;
    $html .= &quot;&lt;thead&gt;&lt;tr&gt;&quot;;
    $html .= &quot;&lt;th class=\&quot;export-only\&quot;&gt;Organism&lt;/th&gt;&quot;;
    $html .= &quot;&lt;th class=\&quot;export-only\&quot;&gt;Feature ID&lt;/th&gt;&quot;;
    $html .= &quot;&lt;th class=\&quot;export-only\&quot;&gt;Feature Type&lt;/th&gt;&quot;;
    $html .= &quot;&lt;th class=\&quot;export-only\&quot;&gt;Annotation Type&lt;/th&gt;&quot;;
    $html .= &quot;&lt;th&gt;Annotation ID&lt;/th&gt;&quot;;
    $html .= &quot;&lt;th&gt;Description&lt;/th&gt;&quot;;
    $html .= &quot;&lt;th&gt;Score&lt;/th&gt;&quot;;
    $html .= &quot;&lt;th&gt;Source&lt;/th&gt;&quot;;
    $html .= &quot;&lt;/tr&gt;&lt;/thead&gt;&quot;;
    $html .= &quot;&lt;tbody&gt;&quot;;
    
    foreach ($results as $row) {
        $hit_id = htmlspecialchars($row[&#039;annotation_accession&#039;]);
        $hit_description = htmlspecialchars($row[&#039;annotation_description&#039;]);
        $hit_score = htmlspecialchars($row[&#039;score&#039;]);
        $annotation_source = htmlspecialchars($row[&#039;annotation_source_name&#039;]);
        $annotation_accession_url = htmlspecialchars($row[&#039;annotation_accession_url&#039;]);
        $hit_id_link = $annotation_accession_url . urlencode($row[&#039;annotation_accession&#039;]);
        
        $html .= &quot;&lt;tr&gt;&quot;;
        $html .= &quot;&lt;td class=\&quot;export-only\&quot;&gt;&quot; . htmlspecialchars($organism) . &quot;&lt;/td&gt;&quot;;
        $html .= &quot;&lt;td class=\&quot;export-only\&quot;&gt;&quot; . htmlspecialchars($uniquename) . &quot;&lt;/td&gt;&quot;;
        $html .= &quot;&lt;td class=\&quot;export-only\&quot;&gt;&quot; . htmlspecialchars($type) . &quot;&lt;/td&gt;&quot;;
        $html .= &quot;&lt;td class=\&quot;export-only\&quot;&gt;&quot; . htmlspecialchars($annotation_type) . &quot;&lt;/td&gt;&quot;;
        $html .= &quot;&lt;td&gt;&lt;a href=\&quot;&quot; . htmlspecialchars($hit_id_link) . &quot;\&quot; target=\&quot;_blank\&quot;&gt;&quot; . $hit_id . &quot;&lt;/a&gt;&lt;/td&gt;&quot;;
        $html .= &quot;&lt;td&gt;&quot; . $hit_description . &quot;&lt;/td&gt;&quot;;
        $html .= &quot;&lt;td&gt;&quot; . $hit_score . &quot;&lt;/td&gt;&quot;;
        $html .= &quot;&lt;td&gt;&quot; . $annotation_source . &quot;&lt;/td&gt;&quot;;
        $html .= &quot;&lt;/tr&gt;&quot;;
    }
    
    $html .= &quot;&lt;/tbody&gt;&lt;/table&gt;&quot;;
    $html .= &quot;&lt;/div&gt;&quot;;
    $html .= &quot;&lt;/div&gt;&quot;;
    
    return $html;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAllAnnotationsForFeatures">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAllAnnotationsForFeatures()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 195</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/parent_functions.php: getAllAnnotationsForFeatures()</div>
                    <div class="function-comment">
                        <pre>/**
* Get all annotations for multiple features at once (optimized)
* Fetches annotations for multiple features in a single query
* Optionally filters by genome_ids for permission-based access
*
* @param array $feature_ids - Array of feature IDs to fetch annotations for
* @param string $dbFile - Path to SQLite database
* @param array $genome_ids - Optional: Array of genome IDs to filter results (empty = no filtering)
* @return array - Organized as [$feature_id =&gt; [$annotation_type =&gt; [results]]]
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 129</code>: <small>$all_annotations = getAllAnnotationsForFeatures($all_feature_ids, $db);</small></li>
                                    <li><code>line 129</code>: <small>$all_annotations = getAllAnnotationsForFeatures($all_feature_ids, $db);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getAllAnnotationsForFeatures($feature_ids, $dbFile, $genome_ids = []) {
    if (empty($feature_ids)) {
        return [];
    }
    
    $placeholders = implode(&#039;,&#039;, array_fill(0, count($feature_ids), &#039;?&#039;));
    
    // Build WHERE clause with optional genome filtering
    $where_clause = &quot;f.feature_id IN ($placeholders)&quot;;
    $params = $feature_ids;
    
    if (!empty($genome_ids)) {
        $genome_placeholders = implode(&#039;,&#039;, array_fill(0, count($genome_ids), &#039;?&#039;));
        $where_clause .= &quot; AND f.genome_id IN ($genome_placeholders)&quot;;
        $params = array_merge($params, $genome_ids);
    }
    
    $query = &quot;SELECT f.feature_id, f.feature_uniquename, f.feature_type, 
              a.annotation_accession, a.annotation_description, 
              fa.score, fa.date, 
              ans.annotation_source_name, ans.annotation_accession_url, ans.annotation_type
        FROM annotation a, feature f, feature_annotation fa, annotation_source ans, genome g, organism o
        WHERE f.organism_id = o.organism_id
          AND f.genome_id = g.genome_id
          AND ans.annotation_source_id = a.annotation_source_id
          AND f.feature_id = fa.feature_id
          AND fa.annotation_id = a.annotation_id
          AND $where_clause
        ORDER BY f.feature_id, ans.annotation_type&quot;;
    
    $results = fetchData($query, $dbFile, $params);
    
    // Organize by feature_id and annotation_type
    $organized = [];
    foreach ($results as $row) {
        $feature_id = $row[&#039;feature_id&#039;];
        $annotation_type = $row[&#039;annotation_type&#039;];
        
        if (!isset($organized[$feature_id])) {
            $organized[$feature_id] = [];
        }
        if (!isset($organized[$feature_id][$annotation_type])) {
            $organized[$feature_id][$annotation_type] = [];
        }
        
        $organized[$feature_id][$annotation_type][] = $row;
    }
    
    return $organized;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="generateTreeHTML">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">generateTreeHTML()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 256</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/parent_functions.php: generateTreeHTML()</div>
                    <div class="function-comment">
                        <pre>/**
* Generate tree-style HTML for feature hierarchy
* Creates a hierarchical list with box-drawing characters (like Unix &#039;tree&#039; command)
*
* @param int $feature_id - The parent feature ID
* @param string $dbFile - Path to SQLite database
* @param string $prefix - Internal use for recursion
* @param bool $is_last - Internal use for recursion
* @return string - HTML string with nested ul/li tree structure
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/parent_functions.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 299</code>: <small>$html .= generateTreeHTML($row[&#039;feature_id&#039;], $dbFile, $prefix, $is_last_child, </small></li>
                                    <li><code>line 299</code>: <small>$html .= generateTreeHTML($row[&#039;feature_id&#039;], $dbFile, $prefix, $is_last_child, </small></li>
                                </ul></li>
                            <li><strong>/data/moop/tools/parent_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 225</code>: <small>&lt;?= generateTreeHTML($feature_id, $db) ?&gt;</small></li>
                                    <li><code>line 225</code>: <small>&lt;?= generateTreeHTML($feature_id, $db) ?&gt;</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function generateTreeHTML($feature_id, $dbFile, $prefix = &#039;&#039;, $is_last = true, $genome_ids = []) {
    $results = getChildrenByFeatureId($feature_id, $dbFile, $genome_ids);

    if (empty($results)) {
        return &#039;&#039;;
    }
    
    $html = &quot;&lt;ul&gt;&quot;;
    $total = count($results);
    
    foreach ($results as $index =&gt; $row) {
        $is_last_child = ($index === $total - 1);
        
        $feature_type = htmlspecialchars($row[&#039;feature_type&#039;]);
        $feature_name = htmlspecialchars($row[&#039;feature_uniquename&#039;]);
        
        // Color code badges by feature type
        $badge_class = &#039;bg-secondary&#039;;
        $text_color = &#039;text-white&#039;;
        
        if ($feature_type == &#039;mRNA&#039;) {
            $badge_class = &#039;bg-feature-mrna&#039;;
            $text_color = &#039;text-white&#039;;
        } elseif ($feature_type == &#039;CDS&#039;) {
            $badge_class = &#039;bg-info&#039;;
            $text_color = &#039;text-white&#039;;
        } elseif ($feature_type == &#039;exon&#039;) {
            $badge_class = &#039;bg-warning&#039;;
            $text_color = &#039;text-dark&#039;;
        } elseif ($feature_type == &#039;gene&#039;) {
            $badge_class = &#039;bg-feature-gene&#039;;
            $text_color = &#039;text-white&#039;;
        }
        
        // Tree character - ‚îî‚îÄ‚îÄ for last child, ‚îú‚îÄ‚îÄ for others
        $tree_char = $is_last_child ? &#039;‚îî‚îÄ‚îÄ &#039; : &#039;‚îú‚îÄ‚îÄ &#039;;
        
        $html .= &quot;&lt;li&gt;&quot;;
        $html .= &quot;&lt;span class=\&quot;tree-char\&quot;&gt;$tree_char&lt;/span&gt;&quot;;
        $html .= &quot;&lt;span class=\&quot;text-dark\&quot;&gt;$feature_name&lt;/span&gt; &quot;;
        $html .= &quot;&lt;span class=\&quot;badge $badge_class $text_color\&quot;&gt;$feature_type&lt;/span&gt;&quot;;
        
        // Recursive call for nested children
        $html .= generateTreeHTML($row[&#039;feature_id&#039;], $dbFile, $prefix, $is_last_child, $genome_ids);
        $html .= &quot;&lt;/li&gt;&quot;;
    }
    $html .= &quot;&lt;/ul&gt;&quot;;

    return $html;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ lib/tool_config.php (4)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="getTool">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getTool()</div>
                            <span class="function-counter">4</span>
                            <div class="function-line">Line 52</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/tool_config.php: getTool()</div>
                    <div class="function-comment">
                        <pre>/**
* Get a specific tool configuration
*
* @param string $tool_id - The tool identifier
* @return array|null - Tool configuration or null if not found
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 2 unique file(s) (4 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/tool_config.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 76</code>: <small>$tool = getTool($tool_id);</small></li>
                                    <li><code>line 76</code>: <small>$tool = getTool($tool_id);</small></li>
                                </ul></li>
                            <li><strong>/data/moop/includes/ConfigManager.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 270</code>: <small>$tool = $this-&gt;getTool($tool_id);</small></li>
                                    <li><code>line 304</code>: <small>$tool = $this-&gt;getTool($tool_id);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function getTool($tool_id) {
    global $available_tools;
    return $available_tools[$tool_id] ?? null;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="getAllTools">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">getAllTools()</div>
                            <span class="function-counter">0</span>
                            <div class="function-line">Line 62</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/tool_config.php: getAllTools()</div>
                    <div class="function-comment">
                        <pre>/**
* Get all available tools
*
* @return array - Array of all tool configurations
*/</pre>
                    </div>
                    <div class="function-code">
                        <code>function getAllTools() {
    global $available_tools;
    return $available_tools;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="buildToolUrl">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">buildToolUrl()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 75</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/tool_config.php: buildToolUrl()</div>
                    <div class="function-comment">
                        <pre>/**
* Build tool URL with context parameters
*
* @param string $tool_id - The tool identifier
* @param array $context - Context array with organism, assembly, group, display_name
* @param string $site - Site variable (from site_config.php)
* @return string|null - Built URL or null if tool not found
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_tools.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 35</code>: <small>$url = buildToolUrl($tool_id, $context, $site);</small></li>
                                    <li><code>line 35</code>: <small>$url = buildToolUrl($tool_id, $context, $site);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function buildToolUrl($tool_id, $context, $site) {
    $tool = getTool($tool_id);
    if (!$tool) {
        return null;
    }
    
    $url = &quot;/$site&quot; . $tool[&#039;url_path&#039;];
    $params = [];
    
    // Build query parameters from context
    foreach ($tool[&#039;context_params&#039;] as $param) {
        if (!empty($context[$param])) {
            $params[$param] = $context[$param];
        }
    }
    
    if (!empty($params)) {
        $url .= &#039;?&#039; . http_build_query($params);
    }
    
    return $url;
}</code>
                    </div>
                </div>
                <div class="function-item searchable" data-func="isToolVisibleOnPage">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">isToolVisibleOnPage()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 105</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">lib/tool_config.php: isToolVisibleOnPage()</div>
                    <div class="function-comment">
                        <pre>/**
* Check if a tool should be visible on a specific page
*
* @param array $tool - Tool configuration
* @param string $page - Page identifier (index, organism, group, assembly, parent, multi_organism_search)
* @return bool - True if tool should be visible on this page
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/lib/functions_tools.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 31</code>: <small>if ($current_page &amp;&amp; !isToolVisibleOnPage($tool, $current_page)) {</small></li>
                                    <li><code>line 31</code>: <small>if ($current_page &amp;&amp; !isToolVisibleOnPage($tool, $current_page)) {</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function isToolVisibleOnPage($tool, $page) {
    // If &#039;pages&#039; key not defined, default to &#039;all&#039;
    $pages = $tool[&#039;pages&#039;] ?? &#039;all&#039;;
    
    // &#039;all&#039; means show on all pages
    if ($pages === &#039;all&#039;) {
        return true;
    }
    
    // If pages is an array, check if current page is in it
    if (is_array($pages)) {
        return in_array($page, $pages);
    }
    
    // If pages is a string (and not &#039;all&#039;), treat as single page name
    return $page === $pages;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ tools/generate_js_registry.php (1)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="findJsFunctionUsages">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">findJsFunctionUsages()</div>
                            <span class="function-counter">6</span>
                            <div class="function-line">Line 106</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">tools/generate_js_registry.php: findJsFunctionUsages()</div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (6 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/generate_js_registry.php</strong> (6x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 254</code>: <small>$usages = findJsFunctionUsages($func[&#039;name&#039;], $jsDir, $jsFile, $func[&#039;line&#039;]);</small></li>
                                    <li><code>line 311</code>: <small>$usages = findJsFunctionUsages($func[&#039;name&#039;], $jsDir, $jsFile, $func[&#039;line&#039;]);</small></li>
                                    <li><code>line 469</code>: <small>$usages = findJsFunctionUsages($func[&#039;name&#039;], $jsDir, $jsFile, $func[&#039;line&#039;]);</small></li>
                                    <li><code>line 254</code>: <small>$usages = findJsFunctionUsages($func[&#039;name&#039;], $jsDir, $jsFile, $func[&#039;line&#039;]);</small></li>
                                    <li><code>line 311</code>: <small>$usages = findJsFunctionUsages($func[&#039;name&#039;], $jsDir, $jsFile, $func[&#039;line&#039;]);</small></li>
                                    <li><code>line 469</code>: <small>$usages = findJsFunctionUsages($func[&#039;name&#039;], $jsDir, $jsFile, $func[&#039;line&#039;]);</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function findJsFunctionUsages($funcName, $jsDir, $definitionFile = null, $definitionLine = null) {
    $usages = [];
    $searchPattern = &#039;/\b&#039; . preg_quote($funcName, &#039;/&#039;) . &#039;\s*\(/&#039;;
    
    // Search in JS files
    $files = array_merge(glob($jsDir . &#039;/*.js&#039;) ?: [], glob($jsDir . &#039;/modules/*.js&#039;) ?: []);
    foreach ($files as $file) {
        if (strpos($file, &#039;.min.js&#039;) !== false || strpos($file, &#039;unused&#039;) !== false) continue;
        
        $content = file_get_contents($file);
        if (preg_match_all($searchPattern, $content, $matches, PREG_OFFSET_CAPTURE)) {
            foreach ($matches[0] as $match) {
                $lineNum = substr_count($content, &quot;\n&quot;, 0, $match[1]) + 1;
                $lines = explode(&quot;\n&quot;, $content);
                $contextLine = isset($lines[$lineNum - 1]) ? trim($lines[$lineNum - 1]) : &#039;&#039;;
                
                // Skip comments
                if (preg_match(&#039;/^\s*(\/\/|\/\*)/&#039;, $contextLine)) continue;
                
                // Skip the function definition line itself
                if (preg_match(&#039;/(?:^|\s)(?:function|const|let|var)\s+&#039; . preg_quote($funcName) . &#039;\s*[=:\(]/&#039;, $contextLine)) continue;
                
                $relativeFile = str_replace(__DIR__ . &#039;/../&#039;, &#039;&#039;, $file);
                
                // Skip if this is the definition file and line
                if ($definitionFile &amp;&amp; $definitionLine &amp;&amp; $relativeFile === $definitionFile &amp;&amp; $lineNum === $definitionLine) {
                    continue;
                }
                
                $usages[] = [
                    &#039;file&#039; =&gt; $relativeFile,
                    &#039;line&#039; =&gt; $lineNum,
                    &#039;context&#039; =&gt; $contextLine
                ];
            }
        }
    }
    
    // Also search in PHP files for inline JS calls (onclick, etc.)
    $phpFiles = array_merge(
        glob(__DIR__ . &#039;/../*.php&#039;) ?: [],
        glob(__DIR__ . &#039;/../admin/*.php&#039;) ?: [],
        glob(__DIR__ . &#039;/../admin/**/*.php&#039;) ?: [],
        glob(__DIR__ . &#039;/../tools/*.php&#039;) ?: [],
        glob(__DIR__ . &#039;/../tools/**/*.php&#039;) ?: []
    );
    
    foreach (array_unique($phpFiles) as $phpFile) {
        if (!file_exists($phpFile)) continue;
        
        $content = file_get_contents($phpFile);
        if (preg_match_all($searchPattern, $content, $matches, PREG_OFFSET_CAPTURE)) {
            foreach ($matches[0] as $match) {
                $lineNum = substr_count($content, &quot;\n&quot;, 0, $match[1]) + 1;
                $lines = explode(&quot;\n&quot;, $content);
                $contextLine = isset($lines[$lineNum - 1]) ? trim($lines[$lineNum - 1]) : &#039;&#039;;
                
                // Skip PHP comments and function definitions
                if (preg_match(&#039;/^\s*(\/\/|\/\*|#)/&#039;, $contextLine)) continue;
                if (preg_match(&#039;/function\s+&#039; . preg_quote($funcName) . &#039;\s*\(/&#039;, $contextLine)) continue;
                
                // Must be in an HTML onclick, inline script, or similar
                if (strpos($contextLine, $funcName) === false) continue;
                
                $usages[] = [
                    &#039;file&#039; =&gt; str_replace(__DIR__ . &#039;/../&#039;, &#039;&#039;, $phpFile),
                    &#039;line&#039; =&gt; $lineNum,
                    &#039;context&#039; =&gt; $contextLine
                ];
            }
        }
    }
    
    return $usages;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <div class="file-section">
            <div class="file-header" onclick="toggleFile(this)">üìÑ tools/sequences_display.php (1)</div>
            <div class="functions-list">
                <div class="function-item searchable" data-func="extractSequencesFromFasta">
                    <div class="function-header" onclick="toggleCode(this)">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="function-name">extractSequencesFromFasta()</div>
                            <span class="function-counter">2</span>
                            <div class="function-line">Line 113</div>
                        </div>
                        <span style="font-size: 20px; margin-left: 10px;">‚ñ∂</span>
                    </div>
                    <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #666; padding: 8px 0; border-bottom: 1px solid #ecf0f1; user-select: all; cursor: copy;" title="Click to select">tools/sequences_display.php: extractSequencesFromFasta()</div>
                    <div class="function-comment">
                        <pre>/**
* Extract sequences from a FASTA file for specific feature IDs
*
* @param string $fasta_file Path to FASTA file
* @param array $feature_ids Array of feature IDs to extract
* @return array Associative array with feature_id =&gt; sequence content
*/</pre>
                    </div>
                    <div class="function-usages">
                        <strong>üìç Used in 1 unique file(s) (2 total times):</strong>
                        <ul>
                            <li><strong>/data/moop/tools/sequences_display.php</strong> (2x)
                                <ul style="margin-top: 5px;">
                                    <li><code>line 113</code>: <small>$sequences = extractSequencesFromFasta($fasta_file, $feature_ids, $seq_type, $ex</small></li>
                                    <li><code>line 113</code>: <small>$sequences = extractSequencesFromFasta($fasta_file, $feature_ids, $seq_type, $ex</small></li>
                                </ul></li>
                        </ul>
                    </div>
                    <div class="function-code">
                        <code>function extractSequencesFromFasta($fasta_file, $feature_ids, $seq_type, &amp;$errors) {
    $sequences = [];
    
    // Validate inputs
    if (empty($fasta_file)) {
        $errors[] = &quot;FASTA file path is empty for $seq_type sequences&quot;;
        return $sequences;
    }
    
    if (empty($feature_ids)) {
        $errors[] = &quot;No feature IDs provided to extract&quot;;
        return $sequences;
    }
    
    // Check if file exists
    if (!file_exists($fasta_file)) {
        $errors[] = &quot;FASTA file not found for $seq_type: &quot; . basename($fasta_file);
        return $sequences;
    }
    
    // Build list of IDs to search, including variants for parent/child relationships
    $search_ids = [];
    foreach ($feature_ids as $id) {
        $search_ids[] = $id;
        // Also try with .1 suffix if not already present (for parent-&gt;child relationships)
        if (substr($id, -2) !== &#039;.1&#039;) {
            $search_ids[] = $id . &#039;.1&#039;;
        }
    }
    
    // Use blastdbcmd to extract sequences - it accepts comma-separated IDs
    $ids_string = implode(&#039;,&#039;, $search_ids);
    $cmd = &quot;blastdbcmd -db &quot; . escapeshellarg($fasta_file) . &quot; -entry &quot; . escapeshellarg($ids_string) . &quot; 2&gt;/dev/null&quot;;
    $output = [];
    $return_var = 0;
    @exec($cmd, $output, $return_var);
    
    // Check if blastdbcmd executed
    if ($return_var &gt; 1) {
        // Return code 1 is expected when some IDs don&#039;t exist, but &gt;1 is an error
        $errors[] = &quot;Error extracting $seq_type sequences (exit code: $return_var). Ensure blastdbcmd is installed and FASTA files are formatted correctly.&quot;;
        return $sequences;
    }
    
    // Check if we got any output
    // If empty, it just means these IDs don&#039;t exist in this file type (e.g., gene IDs won&#039;t be in genome.fa)
    // Return empty sequences gracefully - not an error
    if (empty($output)) {
        return $sequences;
    }
    
    // Parse FASTA output into individual sequences by feature ID
    $current_id = null;
    $current_seq = [];
    
    foreach ($output as $line) {
        if (strpos($line, &#039;&gt;&#039;) === 0) {
            // Header line
            if (!is_null($current_id)) {
                // Store previous sequence with full FASTA format (including &gt;)
                $sequences[$current_id] = implode(&quot;\n&quot;, array_merge([&quot;&gt;&quot; . $current_id], $current_seq));
            }
            // Extract ID from header (remove leading &#039;&gt;&#039;)
            $current_id = substr($line, 1);
            $current_seq = [];
        } else {
            // Sequence line
            $current_seq[] = $line;
        }
    }
    
    // Store last sequence with full FASTA format
    if (!is_null($current_id)) {
        $sequences[$current_id] = implode(&quot;\n&quot;, array_merge([&quot;&gt;&quot; . $current_id], $current_seq));
    }
    
    return $sequences;
}</code>
                    </div>
                </div>
            </div>
        </div>
        <script>
            function toggleFile(header) {
                header.nextElementSibling.classList.toggle('open');
            }
            function toggleAll() {
                const lists = document.querySelectorAll('.functions-list');
                const hiddenCount = document.querySelectorAll('.functions-list:not(.open)').length;
                const btn = document.getElementById('toggleBtn');
                if (hiddenCount > 0) {
                    lists.forEach(list => list.classList.add('open'));
                    btn.textContent = 'üìÅ Collapse All';
                } else {
                    lists.forEach(list => list.classList.remove('open'));
                    btn.textContent = 'üìÇ Expand All';
                }
            }
            function toggleCode(header) {
                const codeBlock = header.parentElement.querySelector('.function-code');
                if (codeBlock) {
                    codeBlock.classList.toggle('open');
                    const arrow = header.querySelector('span');
                    arrow.textContent = codeBlock.classList.contains('open') ? '‚ñº' : '‚ñ∂';
                }
            }
            function toggleUnused(header) {
                const content = header.nextElementSibling;
                const arrow = header.querySelector('.unusedArrow');
                content.classList.toggle('hidden');
                arrow.textContent = content.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
            }
            function filterFunctions() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const fileSections = document.querySelectorAll('.file-section');
                
                fileSections.forEach(section => {
                    const fileName = section.querySelector('.file-header').textContent.toLowerCase();
                    const functionItems = section.querySelectorAll('.function-item');
                    let hasVisibleFunction = false;
                    
                    functionItems.forEach(item => {
                        const funcName = item.querySelector('.function-name').textContent.toLowerCase();
                        const funcDetails = item.querySelector('.function-code') ? item.querySelector('.function-code').textContent.toLowerCase() : '';
                        const match = funcName.includes(searchTerm) || funcDetails.includes(searchTerm) || fileName.includes(searchTerm);
                        
                        if (searchTerm === '' || match) {
                            item.classList.remove('hidden');
                            hasVisibleFunction = true;
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                    
                    if (searchTerm === '' || hasVisibleFunction || fileName.includes(searchTerm)) {
                        section.classList.remove('hidden');
                        if (searchTerm !== '') {
                            section.querySelector('.functions-list').classList.add('open');
                        } else {
                            section.querySelector('.functions-list').classList.remove('open');
                        }
                    } else {
                        section.classList.add('hidden');
                    }
                });
            }
        </script>
    </div>
</body>
</html>
