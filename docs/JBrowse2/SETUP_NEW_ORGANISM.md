# Setting Up a New Organism in JBrowse2

**Last Updated:** February 25, 2026  
**Purpose:** Complete guide for adding a new organism/assembly to the MOOP JBrowse2 system

---

## Overview

This document describes the **required source files**, **generated files**, **directory structure**, and **workflow** for integrating a new organism into JBrowse2.

---

## Required Source Files

### 1. Genome Files (Required)

**Location:** `/data/moop/organisms/{Organism_name}/{Assembly_ID}/`

```
organisms/
‚îî‚îÄ‚îÄ Nematostella_vectensis/
    ‚îî‚îÄ‚îÄ GCA_033964005.1/
        ‚îú‚îÄ‚îÄ genome.fa          ‚Üê Required: Reference genome (FASTA)
        ‚îî‚îÄ‚îÄ genomic.gff        ‚Üê Optional: Gene annotations (GFF3)
```

**Requirements:**
- `genome.fa` - Reference genome sequence in FASTA format
- `genomic.gff` - Gene annotations in GFF3 format (optional but recommended)

### 2. Track Data Files

**Location:** `/data/moop/data/tracks/{Organism_name}/{Assembly_ID}/`

```
data/tracks/
‚îî‚îÄ‚îÄ Nematostella_vectensis/
    ‚îî‚îÄ‚îÄ GCA_033964005.1/
        ‚îú‚îÄ‚îÄ bam/
        ‚îÇ   ‚îú‚îÄ‚îÄ sample1.bam
        ‚îÇ   ‚îî‚îÄ‚îÄ sample1.bam.bai     ‚Üê Required: BAM index
        ‚îî‚îÄ‚îÄ bigwig/
            ‚îú‚îÄ‚îÄ sample1.pos.bw
            ‚îî‚îÄ‚îÄ sample1.neg.bw
```

**Supported Track Types:**
- **BAM** - Alignment files (requires .bam.bai index)
- **BigWig** - Coverage/signal tracks
- **VCF** - Variant files (requires .vcf.gz.tbi index)

**‚ö†Ô∏è Important:** All BAM files MUST have corresponding `.bam.bai` index files

---

## Remote Track Server Support

### Using URLs for Track Files

**YES!** Track files can be hosted on a remote server. The system supports:

```json
{
  "adapter": {
    "type": "BamAdapter",
    "bamLocation": {
      "uri": "https://tracks.example.com/data/sample.bam",
      "locationType": "UriLocation"
    },
    "index": {
      "location": {
        "uri": "https://tracks.example.com/data/sample.bam.bai",
        "locationType": "UriLocation"
      }
    }
  }
}
```

### Local vs Remote Paths

**Local paths:**
```bash
/data/moop/data/tracks/bam/Organism_Assembly_trackname.bam
```

**Remote URLs:**
```bash
https://tracks.example.com/bam/Organism_Assembly_trackname.bam
```

**To use remote tracks:**
1. Edit the track metadata JSON file manually after creation
2. Replace local paths with URLs
3. Ensure remote server has CORS enabled
4. Regenerate configs: `php tools/jbrowse/generate-jbrowse-configs.php`

---

## Generated Files

### 1. Processed Genome Files

**Location:** `/data/moop/data/genomes/{Organism_name}/{Assembly_ID}/`

```
data/genomes/
‚îî‚îÄ‚îÄ Nematostella_vectensis/
    ‚îî‚îÄ‚îÄ GCA_033964005.1/
        ‚îú‚îÄ‚îÄ reference.fasta          ‚Üê Symlink to genome.fa
        ‚îú‚îÄ‚îÄ reference.fasta.fai      ‚Üê Generated: FASTA index
        ‚îú‚îÄ‚îÄ annotations.gff3         ‚Üê Symlink to genomic.gff
        ‚îú‚îÄ‚îÄ annotations.gff3.gz      ‚Üê Generated: Compressed GFF
        ‚îî‚îÄ‚îÄ annotations.gff3.gz.tbi  ‚Üê Generated: Tabix index
```

**Generated by:** `setup_jbrowse_assembly.sh`

### 2. Track Data (Centralized)

**Location:** `/data/moop/data/tracks/{type}/`

```
data/tracks/
‚îú‚îÄ‚îÄ bam/
‚îÇ   ‚îú‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1_sample1.bam
‚îÇ   ‚îî‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1_sample1.bam.bai
‚îî‚îÄ‚îÄ bigwig/
    ‚îú‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1_sample1.pos.bw
    ‚îî‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1_sample1.neg.bw
```

**Generated by:** `add_bam_track.sh`, `add_bigwig_track.sh`

### 3. Metadata Files

**Location:** `/data/moop/metadata/jbrowse2-configs/`

```
metadata/jbrowse2-configs/
‚îú‚îÄ‚îÄ assemblies/
‚îÇ   ‚îî‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1.json  ‚Üê Assembly definition
‚îî‚îÄ‚îÄ tracks/
    ‚îú‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1_sample1_bam.json
    ‚îú‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1_sample1_pos.json
    ‚îî‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1_sample1_neg.json
```

**Generated by:** `add_assembly_to_jbrowse.sh`, track scripts

### 4. Cached Config Files

**Location:** `/data/moop/jbrowse2/configs/{Organism}_{Assembly}/`

```
jbrowse2/configs/
‚îî‚îÄ‚îÄ Nematostella_vectensis_GCA_033964005.1/
    ‚îú‚îÄ‚îÄ PUBLIC.json         ‚Üê Public tracks only
    ‚îú‚îÄ‚îÄ COLLABORATOR.json   ‚Üê Public + collaborator tracks
    ‚îú‚îÄ‚îÄ IP_IN_RANGE.json    ‚Üê Public + collaborator tracks
    ‚îú‚îÄ‚îÄ ADMIN.json          ‚Üê All tracks (including admin-only)
    ‚îî‚îÄ‚îÄ config.json         ‚Üê Legacy (all tracks)
```

**Generated by:** `generate-jbrowse-configs.php`

---

## Complete Directory Structure

```
/data/moop/
‚îÇ
‚îú‚îÄ‚îÄ organisms/                           ‚Üê SOURCE DATA (version controlled)
‚îÇ   ‚îî‚îÄ‚îÄ {Organism_name}/
‚îÇ       ‚îî‚îÄ‚îÄ {Assembly_ID}/
‚îÇ           ‚îú‚îÄ‚îÄ genome.fa               ‚Üê Input: Reference genome
‚îÇ           ‚îî‚îÄ‚îÄ genomic.gff             ‚Üê Input: Annotations
‚îÇ
‚îú‚îÄ‚îÄ data/                                ‚Üê GENERATED/WORKING DATA (not in git)
‚îÇ   ‚îú‚îÄ‚îÄ genomes/                         ‚Üê Processed genome files
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ {Organism_name}/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ {Assembly_ID}/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ reference.fasta      ‚Üí Symlink
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ reference.fasta.fai  ‚Üê Generated
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ annotations.gff3     ‚Üí Symlink
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ annotations.gff3.gz  ‚Üê Generated
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ annotations.gff3.gz.tbi ‚Üê Generated
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ tracks/                          ‚Üê Track data files
‚îÇ       ‚îú‚îÄ‚îÄ {Organism_name}/             ‚Üê Per-organism storage
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ {Assembly_ID}/
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ bam/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ bigwig/
‚îÇ       ‚îú‚îÄ‚îÄ bam/                         ‚Üê Centralized storage
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ {Organism}_{Assembly}_{track}.bam
‚îÇ       ‚îî‚îÄ‚îÄ bigwig/
‚îÇ           ‚îî‚îÄ‚îÄ {Organism}_{Assembly}_{track}.bw
‚îÇ
‚îú‚îÄ‚îÄ metadata/jbrowse2-configs/           ‚Üê CONFIG METADATA (not in git)
‚îÇ   ‚îú‚îÄ‚îÄ assemblies/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ {Organism}_{Assembly}.json   ‚Üê Assembly definition
‚îÇ   ‚îî‚îÄ‚îÄ tracks/
‚îÇ       ‚îî‚îÄ‚îÄ {Organism}_{Assembly}_{track}.json ‚Üê Track definitions
‚îÇ
‚îî‚îÄ‚îÄ jbrowse2/configs/                    ‚Üê CACHED CONFIGS (not in git)
    ‚îî‚îÄ‚îÄ {Organism}_{Assembly}/
        ‚îú‚îÄ‚îÄ PUBLIC.json
        ‚îú‚îÄ‚îÄ COLLABORATOR.json
        ‚îú‚îÄ‚îÄ IP_IN_RANGE.json
        ‚îú‚îÄ‚îÄ ADMIN.json
        ‚îî‚îÄ‚îÄ config.json
```

---

## Step-by-Step Setup Workflow

### Prerequisites

```bash
# Ensure tools are installed
samtools --version
bgzip --version
tabix --version
jq --version
```

---

## üö® CRITICAL: Web Server Security Setup

**FIRST TIME SETUP ONLY** - Do this BEFORE adding any organisms!

Track files MUST be blocked from direct web access. Without this protection, anyone can bypass JWT authentication by accessing files directly.

### Quick Check: Is Your Server Secure?

```bash
# Test if direct access is blocked (should return 403)
curl -I http://localhost/moop/data/tracks/test.bw

# ‚úÖ Secure:   HTTP/1.1 403 Forbidden
# ‚ùå INSECURE: HTTP/1.1 404 Not Found (or 200 OK)
```

If you see **403 Forbidden**, you're secure! Skip to [Step 1](#step-1-prepare-source-files).

If you see anything else, **STOP** and configure your web server now:

### Option A: Apache with .htaccess (Recommended)

**Step 1:** Create `.htaccess` file in tracks directory:

```bash
cat > /var/www/html/moop/data/tracks/.htaccess << 'EOF'
# SECURITY: Block direct access to track files
# All track requests MUST go through /api/jbrowse2/tracks.php

# Apache 2.2 style
<IfVersion < 2.4>
    Order Deny,Allow
    Deny from all
</IfVersion>

# Apache 2.4+ style
<IfVersion >= 2.4>
    Require all denied
</IfVersion>

ErrorDocument 403 "Access denied. Track files must be accessed through the API endpoint with valid JWT token."
EOF
```

**Step 2:** Enable `.htaccess` in Apache config:

Edit your Apache site config (e.g., `/etc/apache2/sites-available/moop.conf`):

```apache
<VirtualHost *:80>
    ServerName moop.example.com
    DocumentRoot /var/www/html
    
    # Add this block:
    <Directory "/var/www/html/moop/data/tracks">
        AllowOverride All
        Require all denied
    </Directory>
</VirtualHost>
```

**Step 3:** Reload Apache:

```bash
sudo apache2ctl configtest
sudo systemctl reload apache2
```

### Option B: Nginx

Edit your nginx site config (e.g., `/etc/nginx/sites-available/moop`):

```nginx
server {
    listen 80;
    server_name moop.example.com;
    root /var/www/html;
    
    # Add this block:
    location ~ ^/moop/data/tracks/ {
        deny all;
        return 403 "Access denied. Track files must be accessed through the API endpoint with valid JWT token.";
    }
    
    # ... rest of config ...
}
```

**Reload nginx:**

```bash
sudo nginx -t
sudo systemctl reload nginx
```

### Verify Security

```bash
# Test 1: Direct access should be BLOCKED
curl -I http://localhost/moop/data/tracks/test.bw
# Expected: HTTP/1.1 403 Forbidden ‚úÖ

# Test 2: API access should work (after adding tracks)
# This will be tested later after you add your first track
```

**‚úÖ Once you see "403 Forbidden", proceed with organism setup below.**

For detailed security documentation, see: [docs/JBrowse2/technical/SECURITY.md](technical/SECURITY.md)

---

### Step 1: Prepare Source Files

Place your source data in the organisms directory:

```bash
/data/moop/organisms/Nematostella_vectensis/GCA_033964005.1/
‚îú‚îÄ‚îÄ genome.fa
‚îî‚îÄ‚îÄ genomic.gff
```

And raw track data:

```bash
/data/moop/data/tracks/Nematostella_vectensis/GCA_033964005.1/
‚îú‚îÄ‚îÄ bam/
‚îÇ   ‚îú‚îÄ‚îÄ sample1.bam
‚îÇ   ‚îî‚îÄ‚îÄ sample1.bam.bai
‚îî‚îÄ‚îÄ bigwig/
    ‚îú‚îÄ‚îÄ sample1.pos.bw
    ‚îî‚îÄ‚îÄ sample1.neg.bw
```

### Step 2: Setup Genome Files (~5 minutes)

**Script:** `tools/jbrowse/setup_jbrowse_assembly.sh`

```bash
cd /data/moop
./tools/jbrowse/setup_jbrowse_assembly.sh \
    /data/moop/organisms/Nematostella_vectensis/GCA_033964005.1
```

**What it does:**
1. Creates `/data/genomes/{Organism}/{Assembly}/`
2. Symlinks genome.fa ‚Üí reference.fasta
3. Indexes FASTA with `samtools faidx`
4. Symlinks genomic.gff ‚Üí annotations.gff3
5. Compresses GFF with `bgzip`
6. Indexes GFF with `tabix`

**Output:**
- `reference.fasta` + `.fai`
- `annotations.gff3.gz` + `.tbi`

### Step 3: Register Assembly (~30 seconds)

**Script:** `tools/jbrowse/add_assembly_to_jbrowse.sh`

```bash
cd /data/moop
./tools/jbrowse/add_assembly_to_jbrowse.sh \
    Nematostella_vectensis \
    GCA_033964005.1 \
    --display-name "Nematostella vectensis (GCA_033964005.1)" \
    --access-level PUBLIC
```

**What it does:**
1. Creates assembly metadata JSON in `metadata/jbrowse2-configs/assemblies/`
2. Defines assembly name, display name, aliases
3. Configures reference sequence adapter
4. Sets default access level

**Output:**
- `metadata/jbrowse2-configs/assemblies/Nematostella_vectensis_GCA_033964005.1.json`

**‚ö†Ô∏è Important:** The annotations GFF is automatically loaded if present. You do NOT need to create a separate track for it.

### Step 4: Add Track Files (~2 minutes per track)

#### Add BAM Track

**Script:** `tools/jbrowse/add_bam_track.sh`

```bash
./tools/jbrowse/add_bam_track.sh \
    /data/moop/data/tracks/Nematostella_vectensis/GCA_033964005.1/bam/sample1.bam \
    Nematostella_vectensis \
    GCA_033964005.1 \
    --name "Sample 1 RNA-seq" \
    --category "RNA-seq" \
    --access ADMIN \
    --description "RNA-seq alignments from sample 1"
```

**What it does:**
1. Copies BAM + BAI to centralized location
2. Validates BAM file
3. Extracts read statistics
4. Creates track metadata JSON

**Output:**
- `data/tracks/bam/Nematostella_vectensis_GCA_033964005.1_sample1.bam`
- `metadata/jbrowse2-configs/tracks/Nematostella_vectensis_GCA_033964005.1_sample1.json`

#### Add BigWig Track

**Script:** `tools/jbrowse/add_bigwig_track.sh`

```bash
./tools/jbrowse/add_bigwig_track.sh \
    /data/moop/data/tracks/Nematostella_vectensis/GCA_033964005.1/bigwig/sample1.pos.bw \
    Nematostella_vectensis \
    GCA_033964005.1 \
    --name "Sample 1 Coverage (+ strand)" \
    --category "RNA-seq Coverage" \
    --access PUBLIC \
    --color "#1f77b4"
```

**What it does:**
1. Copies BigWig to centralized location
2. Creates track metadata JSON

**Output:**
- `data/tracks/bigwig/Nematostella_vectensis_GCA_033964005.1_sample1_pos.bw`
- `metadata/jbrowse2-configs/tracks/Nematostella_vectensis_GCA_033964005.1_sample1_pos.json`

### Step 5: Generate Cached Configs (~5 seconds)

**Script:** `tools/jbrowse/generate-jbrowse-configs.php`

```bash
cd /data/moop
php tools/jbrowse/generate-jbrowse-configs.php
```

**What it does:**
1. Reads all assembly definitions
2. Reads all track definitions
3. Filters tracks by access level
4. Generates 4 configs per assembly (PUBLIC, COLLABORATOR, IP_IN_RANGE, ADMIN)

**Output:**
```
jbrowse2/configs/Nematostella_vectensis_GCA_033964005.1/
‚îú‚îÄ‚îÄ PUBLIC.json         (2 tracks)
‚îú‚îÄ‚îÄ COLLABORATOR.json   (2 tracks)
‚îú‚îÄ‚îÄ IP_IN_RANGE.json    (2 tracks)
‚îú‚îÄ‚îÄ ADMIN.json          (3 tracks)
‚îî‚îÄ‚îÄ config.json         (3 tracks)
```

**‚ö†Ô∏è Run this every time you add/modify/remove tracks!**

---

## Access Control

### Access Levels

| Level | Value | Sees |
|-------|-------|------|
| **ADMIN** | 4 | All tracks (including test/unreleased) |
| **IP_IN_RANGE** | 3 | Public + collaborator tracks |
| **COLLABORATOR** | 2 | Public + collaborator tracks (per-assembly) |
| **PUBLIC** | 1 | Public tracks only |

### Track Access

When adding tracks, specify `--access`:

```bash
--access PUBLIC        # Everyone can see
--access COLLABORATOR  # Logged-in users only
--access ADMIN         # Admins only (for testing/unreleased data)
```

### Assembly Access

In the assembly JSON, set `defaultAccessLevel`:

```json
{
  "defaultAccessLevel": "PUBLIC"  // or "COLLABORATOR" or "ADMIN"
}
```

---

## Production Setup with Remote Tracks

### Configuration for Remote Track Server

1. **Add tracks normally** using local paths
2. **Edit track metadata** to use URLs:

```bash
vim metadata/jbrowse2-configs/tracks/Nematostella_vectensis_GCA_033964005.1_sample1.json
```

Change:
```json
{
  "adapter": {
    "bamLocation": {
      "uri": "/data/moop/data/tracks/bam/file.bam"
    }
  }
}
```

To:
```json
{
  "adapter": {
    "bamLocation": {
      "uri": "https://tracks.example.com/bam/file.bam",
      "locationType": "UriLocation"
    },
    "index": {
      "location": {
        "uri": "https://tracks.example.com/bam/file.bam.bai",
        "locationType": "UriLocation"
      }
    }
  }
}
```

3. **Regenerate configs:**

```bash
php tools/jbrowse/generate-jbrowse-configs.php
```

### Remote Server Requirements

**CORS Headers Required:**

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, HEAD, OPTIONS
Access-Control-Allow-Headers: Range
Access-Control-Expose-Headers: Content-Length, Content-Range
```

**HTTP Range Requests:**
- Must support `Range` header for efficient data loading
- JBrowse uses byte-range requests to load only visible regions

---

## Maintenance

### Adding New Tracks

```bash
# 1. Add track with script
./tools/jbrowse/add_bam_track.sh ...

# 2. Regenerate configs
php tools/jbrowse/generate-jbrowse-configs.php

# 3. Refresh browser
```

### Updating Track Access Levels

```bash
# 1. Edit track metadata JSON
vim metadata/jbrowse2-configs/tracks/{track_name}.json

# 2. Change "access_level": "PUBLIC" to "ADMIN"

# 3. Regenerate configs
php tools/jbrowse/generate-jbrowse-configs.php
```

### Removing Tracks

```bash
# 1. Remove track metadata
rm metadata/jbrowse2-configs/tracks/{track_name}.json

# 2. Optionally remove data file
rm data/tracks/bam/{track_name}.bam*

# 3. Regenerate configs
php tools/jbrowse/generate-jbrowse-configs.php
```

### Removing an Assembly

```bash
# 1. Remove assembly metadata
rm metadata/jbrowse2-configs/assemblies/{organism}_{assembly}.json

# 2. Remove all track metadata for this assembly
rm metadata/jbrowse2-configs/tracks/{organism}_{assembly}_*.json

# 3. Optionally remove data files
rm -rf data/genomes/{organism}/{assembly}
rm -rf jbrowse2/configs/{organism}_{assembly}

# 4. Regenerate configs
php tools/jbrowse/generate-jbrowse-configs.php
```

---

## Troubleshooting

### Annotations Not Showing

**Problem:** GFF annotations track doesn't appear in browser

**Solution:**
```bash
# Check files exist
ls -lh /data/moop/data/genomes/{organism}/{assembly}/annotations.gff3.gz*

# Verify tabix index
tabix -l /data/moop/data/genomes/{organism}/{assembly}/annotations.gff3.gz

# Check assembly.php auto-adds it (line ~249)
grep "annotations" /data/moop/api/jbrowse2/assembly.php
```

The annotations track is **automatically added** if the GFF file exists. No manual track creation needed.

### Tracks Not Loading

**Problem:** Tracks appear in list but don't load data

**Solution:**
```bash
# Check file permissions
chmod 644 data/tracks/bam/*.bam*
chmod 644 data/tracks/bigwig/*.bw

# Verify BAM index exists
ls -lh data/tracks/bam/*.bam.bai

# Check JWT keys exist
ls -lh certs/jwt_*.pem

# Test track metadata
jq . metadata/jbrowse2-configs/tracks/{track_name}.json
```

### Remote Tracks Not Loading

**Problem:** Remote URLs don't load

**Solution:**
```bash
# Check CORS headers
curl -I https://tracks.example.com/bam/file.bam

# Test byte-range request
curl -H "Range: bytes=0-1023" https://tracks.example.com/bam/file.bam

# Verify URLs are correct in track metadata
jq .adapter metadata/jbrowse2-configs/tracks/{track_name}.json
```

---

## Quick Reference

### Complete Setup Commands

```bash
# 1. Setup genome
./tools/jbrowse/setup_jbrowse_assembly.sh \
    /data/moop/organisms/Nematostella_vectensis/GCA_033964005.1

# 2. Register assembly
./tools/jbrowse/add_assembly_to_jbrowse.sh \
    Nematostella_vectensis GCA_033964005.1 \
    --display-name "Nematostella vectensis (GCA_033964005.1)" \
    --access-level PUBLIC

# 3. Add tracks
./tools/jbrowse/add_bam_track.sh FILE.bam Nematostella_vectensis GCA_033964005.1 \
    --name "Track Name" --category "Category" --access ADMIN

./tools/jbrowse/add_bigwig_track.sh FILE.bw Nematostella_vectensis GCA_033964005.1 \
    --name "Track Name" --category "Category" --access PUBLIC --color "#1f77b4"

# 4. Generate configs
php tools/jbrowse/generate-jbrowse-configs.php

# 5. Test
curl -s "http://localhost:8888/api/jbrowse2/test-assembly.php?organism=Nematostella_vectensis&assembly=GCA_033964005.1" | jq .
```

---

## Related Documentation

- [WALKTHROUGH_Nematostella_vectensis.md](WALKTHROUGH_Nematostella_vectensis.md) - Complete example
- [ACCESS_CONTROL_UPDATE.md](ACCESS_CONTROL_UPDATE.md) - Access control details
- [AUTO_CONFIG_GENERATION.md](AUTO_CONFIG_GENERATION.md) - Config generation system

---

**Last Updated:** February 10, 2026  
**Tested With:** Nematostella vectensis GCA_033964005.1
