# Synteny Tracks in Google Sheets

This guide explains how to configure synteny tracks (whole genome comparisons) in the Google Sheets automation system.

## Overview

Synteny tracks visualize genomic relationships between **two assemblies**. They require:
- **Both assemblies already loaded** in JBrowse2
- Special row format with two assembly names
- Appropriate file format (PIF.GZ or MCScan anchors)

---

## Track Types

### 1. PIF.GZ Tracks (Whole Genome Synteny)

**File Format:** PairwiseIndexedPAF (`.pif.gz` + `.tbi`)

**Generated from:** minimap2 PAF output → sorted → bgzipped → tabix indexed

**Use case:** Display syntenic regions between two whole genomes

### 2. MCScan Anchors (Ortholog Pairs)

**File Format:** MCScan anchors file (`.anchors`) + 2 BED files

**Generated from:** MCScanX or jcvi

**Use case:** Display orthologous gene pairs between genomes

---

## Google Sheet Format

### Special Columns for Synteny

| Column | Required | Description | Example |
|--------|----------|-------------|---------|
| `ASSEMBLY1` | Yes | First genome (target) | `Nvec200` |
| `ASSEMBLY2` | Yes | Second genome (query) | `Nvec100` |
| `TRACK_PATH` | Yes | Path to main file | `/data/synteny/genomes.pif.gz` |
| `BED1_PATH` | Anchors only | BED for assembly 1 | `/data/synteny/genome1.bed` |
| `BED2_PATH` | Anchors only | BED for assembly 2 | `/data/synteny/genome2.bed` |

### Row Examples

#### PIF.GZ Synteny Track

```
track_id,name,category,ASSEMBLY1,ASSEMBLY2,TRACK_PATH,ACCESS_LEVEL
nvec_synteny,Nvec200 vs Nvec100 Synteny,Synteny,Nvec200,Nvec100,/data/synteny/Nvec200_Nvec100.pif.gz,public
```

#### MCScan Anchors Track

```
track_id,name,category,ASSEMBLY1,ASSEMBLY2,TRACK_PATH,BED1_PATH,BED2_PATH,ACCESS_LEVEL
nvec_orthologs,Nvec100 Orthologs on Nvec200,Synteny,Nvec200,Nvec100,/data/synteny/Nvec200.Nvec100.anchors,/data/synteny/Nvec200.bed,/data/synteny/Nvec100.bed,public
```

---

## File Format Detection

The script auto-detects track type by file extension:

| Extension | Track Type | Handler |
|-----------|------------|---------|
| `.pif.gz` | PairwiseIndexedPAF | `add_synteny_track.sh` |
| `.anchors` | MCScan | `add_mcscan_track.sh` |

---

## Prerequisites

### Both Assemblies Must Exist

Before adding synteny tracks, ensure both genomes are loaded:

```bash
# Check if assemblies exist
grep "\"name\": \"Nvec200\"" /data/moop/jbrowse2/config.json
grep "\"name\": \"Nvec100\"" /data/moop/jbrowse2/config.json
```

### File Requirements

#### PIF.GZ Files

```bash
# From PAF (minimap2 output)
minimap2 -x asm5 genome1.fa genome2.fa > alignment.paf

# Sort and compress
sort -k6,6 -k8,8n alignment.paf | bgzip > genome1_genome2.pif.gz

# Index
tabix -p bed genome1_genome2.pif.gz
```

**Required files:**
- `genome1_genome2.pif.gz`
- `genome1_genome2.pif.gz.tbi`

#### MCScan Anchors Files

**Generated by MCScanX or jcvi:**

```bash
# Using jcvi
python -m jcvi.compara.catalog ortholog genome1 genome2

# Outputs:
# - genome1.genome2.anchors
# - genome1.bed
# - genome2.bed
```

**Required files:**
- `genome1.genome2.anchors` (ortholog pairs)
- `genome1.bed` (gene coordinates for genome1)
- `genome2.bed` (gene coordinates for genome2)

---

## Complete Google Sheet Example

```csv
track_id,name,category,ASSEMBLY1,ASSEMBLY2,TRACK_PATH,BED1_PATH,BED2_PATH,ACCESS_LEVEL,#notes
nvec200_nvec100_wgs,Nvec200 vs Nvec100 WGS,Synteny,Nvec200,Nvec100,/data/synteny/minimap/Nvec200_Nvec100.pif.gz,,,public,Whole genome synteny
nvec200_nvec100_ortho,Nvec100 Orthologs,Synteny,Nvec200,Nvec100,/data/synteny/mcscan/Nvec200.Nvec100.anchors,/data/synteny/mcscan/Nvec200.bed,/data/synteny/mcscan/Nvec100.bed,public,Gene-level orthologs
nvec200_hsap_ortho,Human Orthologs,Synteny,Nvec200,Hsap39,/data/synteny/mcscan/Nvec200.Hsap39.anchors,/data/synteny/mcscan/Nvec200.bed,/data/synteny/mcscan/Hsap39.bed,admin,Internal only
```

**Notes:**
- Columns starting with `#` are ignored (like `#notes`)
- Empty cells for `BED1_PATH`/`BED2_PATH` = not needed (PIF.GZ track)
- `ASSEMBLY1` and `ASSEMBLY2` order matters (defines target vs query)

---

## Assembly Name Convention

**Important:** Use the **exact assembly name** as it appears in JBrowse2 config.

### Find Your Assembly Names

```bash
# List all assemblies
grep -A2 '"assemblies"' /data/moop/jbrowse2/config.json | grep '"name"'
```

Example output:
```
"name": "Nematostella_vectensis_GCA_033964005.1"
"name": "Homo_sapiens_GRCh38"
```

Use these **exact names** in `ASSEMBLY1` and `ASSEMBLY2` columns.

---

## Target vs Query Assembly

### PIF.GZ Tracks

```
ASSEMBLY1 = Target genome (horizontal axis in synteny view)
ASSEMBLY2 = Query genome (vertical axis)
```

### MCScan Tracks

```
ASSEMBLY1 = Base genome (where track appears)
ASSEMBLY2 = Ortholog genome (genes mapped from here)
```

**Example:**
```
ASSEMBLY1=Nvec200, ASSEMBLY2=Hsap39
→ Track appears on Nvec200 genome
→ Shows human orthologs for each Nvec gene
```

---

## Batch Loading Multiple Comparisons

### All-vs-All Synteny

Use spreadsheet formulas or script to generate all pairwise comparisons:

```csv
track_id,name,ASSEMBLY1,ASSEMBLY2,TRACK_PATH
nvec200_nvec100,Nvec200 vs Nvec100,Nvec200,Nvec100,/data/synteny/Nvec200_Nvec100.pif.gz
nvec200_hsap,Nvec200 vs Human,Nvec200,Hsap39,/data/synteny/Nvec200_Hsap39.pif.gz
nvec100_hsap,Nvec100 vs Human,Nvec100,Hsap39,/data/synteny/Nvec100_Hsap39.pif.gz
```

### Automated Generation Script

See your original script: `CCA3.load.Nov2024.sh`

Similar workflow:
1. List all organisms
2. Generate pairwise file paths
3. Check if files exist
4. Add rows to Google Sheet

---

## Validation

The script validates:

✅ Both assemblies exist in JBrowse2  
✅ `TRACK_PATH` file exists  
✅ Index files exist (`.tbi` for PIF.GZ)  
✅ BED files exist (for MCScan)  
✅ File extensions match expected format

**Error messages:**
```
ERROR: Assembly Nvec200 not found in JBrowse config
ERROR: Assembly Nvec100 not found in JBrowse config
ERROR: PIF.GZ file not found: /data/synteny/genomes.pif.gz
ERROR: Tabix index (.tbi) not found
ERROR: BED1 file not found: /data/synteny/genome1.bed
```

---

## Troubleshooting

### Track Not Appearing

1. **Check both assemblies loaded:**
   ```bash
   grep '"name"' /data/moop/jbrowse2/config.json
   ```

2. **Check file paths:**
   ```bash
   ls -lh /data/synteny/Nvec200_Nvec100.pif.gz
   ls -lh /data/synteny/Nvec200_Nvec100.pif.gz.tbi
   ```

3. **Check track added:**
   ```bash
   grep "nvec_synteny" /data/moop/jbrowse2/config.json
   ```

### Assembly Names Don't Match

**Problem:** Used `Nvec200` but JBrowse has `Nematostella_vectensis_GCA_033964005.1`

**Solution:** Use exact name from config:
```bash
# Find exact name
grep -A2 assemblies /data/moop/jbrowse2/config.json | grep name

# Update Google Sheet with exact name
```

### Index Missing

**Problem:** `.pif.gz.tbi` file not found

**Solution:**
```bash
cd /data/synteny
tabix -p bed Nvec200_Nvec100.pif.gz
```

---

## Advanced: Remote Synteny Files

You can host synteny files on a separate server:

```csv
track_id,name,ASSEMBLY1,ASSEMBLY2,TRACK_PATH
nvec_synteny,Nvec Synteny,Nvec200,Nvec100,https://data.server.edu/synteny/Nvec200_Nvec100.pif.gz
```

**Requirements:**
- Both `.pif.gz` and `.pif.gz.tbi` accessible via HTTP
- CORS headers configured on server
- Files use consistent naming

---

## Integration with Original Workflow

Your original script:

```bash
jbrowse add-track $PAFPATH \
  --assemblyNames $QUERY,$TARGET \
  --name "$NAME" \
  --trackId "$ID" \
  --out $JBDIR \
  --load copy
```

**New workflow:**

1. **Add files to data directory** (as before)
2. **Add row to Google Sheet** with both assembly names
3. **Run automation script:**
   ```bash
   php /data/moop/tools/jbrowse/generate_tracks_from_sheet.php \
     --sheet-url "https://docs.google.com/spreadsheets/d/YOUR_ID/edit"
   ```

**Benefits:**
- Centralized configuration in Google Sheet
- Automatic validation
- Consistent formatting
- Easy to see all synteny tracks

---

## Reference Commands

### Generate PIF.GZ

```bash
# Align genomes
minimap2 -x asm5 target.fa query.fa > alignment.paf

# Sort, compress, index
sort -k6,6 -k8,8n alignment.paf | bgzip > target_query.pif.gz
tabix -p bed target_query.pif.gz
```

### Generate MCScan Files

```bash
# Install jcvi
pip install jcvi

# Prepare inputs
# - genome1.fa, genome1.gff
# - genome2.fa, genome2.gff

# Run ortholog detection
python -m jcvi.compara.catalog ortholog genome1 genome2

# Outputs:
# - genome1.genome2.anchors
# - genome1.bed
# - genome2.bed
```

---

## See Also

- `docs/JBrowse2/GOOGLE_SHEETS_AUTOMATION.md` - Main automation guide
- `docs/JBrowse2/EXAMPLE_GOOGLE_SHEET.md` - Complete sheet examples
- `tools/jbrowse/add_synteny_track.sh` - PIF.GZ track script
- `tools/jbrowse/add_mcscan_track.sh` - MCScan track script
- Your original script: `CCA3.load.Nov2024.sh`
