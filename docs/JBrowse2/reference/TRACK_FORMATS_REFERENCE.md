# Track Formats Reference

**Complete guide to supported track types, file formats, and configuration in MOOP**

---

## Quick Reference Table

| Type | Extension | Index | Use Case | Status |
|------|-----------|-------|----------|--------|
| **BigWig** | `.bw`, `.bigwig` | — | RNA-seq, ChIP-seq coverage | ✅ |
| **BAM** | `.bam` | `.bai` | Aligned sequencing reads | ✅ |
| **CRAM** | `.cram` | `.crai` | Compressed alignments (smaller than BAM) | ✅ |
| **VCF** | `.vcf.gz` | `.tbi` | Genetic variants (SNPs, indels) | ✅ |
| **GFF3** | `.gff.gz` | `.tbi` | Gene annotations | ✅ |
| **GTF** | `.gtf` | — | Gene annotations (Ensembl format) | ✅ |
| **BED** | `.bed.gz` | `.tbi` | Generic genomic features | ✅ |
| **PAF** | `.paf` | — | Long-read alignments (minimap2) | ✅ |
| **PIF.GZ** | `.pif.gz` | `.tbi` | Whole genome synteny | ✅ |
| **MAF** | `.maf.gz` | `.gzi` | Multiple alignment (Cactus) | ⚠️ |
| **MCScan** | `.anchors` | 2 `.bed` | Ortholog pairs | ⚠️ |
| **Multi-BigWig** | Multiple `.bw` | — | Grouped signal tracks | ✅ |

---

## Supported Formats by Category

### Quantitative/Coverage Tracks

#### BigWig (✅ Working)
**Extensions:** `.bw`, `.bigwig`  
**Adapter:** `BigWigAdapter`  
**Use case:** RNA-seq coverage, ChIP-seq peaks, any quantitative signal  
**Index required:** No (self-indexed)

**Example:**
```bash
# Add via script
/data/moop/tools/jbrowse/add_bigwig_track.sh \
  sample.bw Organism Assembly \
  --name "RNA-seq Coverage" \
  --track-id rnaseq_coverage
```

**Google Sheet:**
```csv
track_id,name,category,TRACK_PATH,ACCESS_LEVEL
rnaseq,RNA-seq Coverage,Expression,/data/tracks/rnaseq.bw,public
```

#### Multi-BigWig / Combo Tracks (✅ Working)
**Format:** Multiple BigWig files grouped together  
**Use case:** Compare multiple samples/conditions side-by-side  
**Color groups:** blues, reds, greens, purples, oranges, cyans, pinks, etc.

**Google Sheet Format:**
```csv
# Tissue Expression Atlas
## blues: Brain Samples
track_id,name,TRACK_PATH
brain1,Brain Rep1,/data/tracks/brain1.bw
brain2,Brain Rep2,/data/tracks/brain2.bw
## reds: Heart Samples
heart1,Heart Rep1,/data/tracks/heart1.bw
heart2,Heart Rep2,/data/tracks/heart2.bw
### end
```

**Available color groups:**
- `blues`, `reds`, `greens`, `purples`, `oranges`, `cyans`, `pinks`, `browns`
- `grays`, `magentas`, `olives`, `teals`, `lavenders`, `corals`, `salmons`
- `aquas`, `limes`, `violets`, `indigos`, `maroons`, `diffs` (rainbow)

**Special syntax:**
- `exact=Red` - Use exact color name
- `blues3` - Use 4th color from blues palette (0-indexed)

---

### Alignment Tracks

#### BAM (✅ Working)
**Extensions:** `.bam` + `.bai` index  
**Adapter:** `BamAdapter`  
**Use case:** Short-read alignments (Illumina, etc.)

**Prepare files:**
```bash
samtools sort -o sorted.bam unsorted.bam
samtools index sorted.bam  # Creates .bai
```

**Google Sheet:**
```csv
track_id,name,category,TRACK_PATH,ACCESS_LEVEL
aligned_bam,Aligned Reads,Alignments,/data/tracks/sorted.bam,public
```

#### CRAM (✅ Working)
**Extensions:** `.cram` + `.crai` index  
**Adapter:** `CramAdapter`  
**Use case:** Compressed alignments (30-60% smaller than BAM)  
**Requires:** Reference genome

**Prepare files:**
```bash
samtools view -C -T reference.fa input.bam -o output.cram
samtools index output.cram  # Creates .crai
```

**Google Sheet:**
```csv
track_id,name,category,TRACK_PATH,ACCESS_LEVEL
aligned_cram,Aligned Reads,Alignments,/data/tracks/aligned.cram,public
```

#### PAF (✅ Working)
**Extensions:** `.paf` (no index)  
**Adapter:** `PAFAdapter`  
**Use case:** Long-read alignments (PacBio, Nanopore)  
**Generated by:** minimap2

**Prepare files:**
```bash
minimap2 -x map-ont reference.fa reads.fastq > alignments.paf
```

**Google Sheet:**
```csv
track_id,name,category,TRACK_PATH,ACCESS_LEVEL
nanopore,Nanopore Reads,Long-read,/data/tracks/nanopore.paf,public
```

---

### Annotation Tracks

#### GFF3 (✅ Working)
**Extensions:** `.gff`, `.gff.gz` + `.tbi`  
**Adapter:** `Gff3TabixAdapter`  
**Use case:** Gene annotations, features

**Prepare files:**
```bash
bgzip annotations.gff  # Creates .gff.gz
tabix -p gff annotations.gff.gz  # Creates .tbi
```

**Google Sheet:**
```csv
track_id,name,category,TRACK_PATH,ACCESS_LEVEL
genes,Gene Annotations,Annotations,/data/tracks/genes.gff.gz,public
```

#### GTF (✅ Working)
**Extensions:** `.gtf` (no index needed for smaller files)  
**Adapter:** `GtfAdapter`  
**Use case:** Gene annotations (Ensembl format)

**Google Sheet:**
```csv
track_id,name,category,TRACK_PATH,ACCESS_LEVEL
genes_gtf,Gene Models,Annotations,/data/tracks/genes.gtf,public
```

#### Multiple GFF Annotations
**Use case:** Different annotation sources with different access levels

**Example:** Public NCBI annotations + private lab annotations

```csv
track_id,name,category,TRACK_PATH,ACCESS_LEVEL
ncbi_genes,NCBI RefSeq,Annotations,/data/tracks/ncbi.gff.gz,public
lab_genes,Lab Annotations,Annotations,/data/tracks/lab.gff.gz,admin
```

---

### Variant Tracks

#### VCF (✅ Working)
**Extensions:** `.vcf.gz` + `.tbi` index  
**Adapter:** `VcfTabixAdapter`  
**Use case:** SNPs, indels, structural variants

**Prepare files:**
```bash
bgzip variants.vcf  # Creates .vcf.gz
tabix -p vcf variants.vcf.gz  # Creates .tbi
```

**Google Sheet:**
```csv
track_id,name,category,TRACK_PATH,ACCESS_LEVEL
snps,SNP Variants,Variants,/data/tracks/variants.vcf.gz,public
```

---

### Feature Tracks

#### BED (✅ Working)
**Extensions:** `.bed.gz` + `.tbi` index  
**Adapter:** `BedTabixAdapter`  
**Use case:** Generic genomic features, peaks, regulatory elements

**Prepare files:**
```bash
sort -k1,1 -k2,2n features.bed | bgzip > features.bed.gz
tabix -p bed features.bed.gz  # Creates .tbi
```

**Google Sheet:**
```csv
track_id,name,category,TRACK_PATH,ACCESS_LEVEL
peaks,ChIP Peaks,Features,/data/tracks/peaks.bed.gz,public
```

---

### Synteny/Comparative Tracks

#### PIF.GZ - Whole Genome Synteny (✅ Working)
**Extensions:** `.pif.gz` + `.tbi` index  
**Adapter:** `PairwiseIndexedPAFAdapter`  
**Use case:** Whole genome alignments between two assemblies  
**Requires:** Both assemblies loaded in JBrowse2

**Prepare files:**
```bash
# Align genomes with minimap2
minimap2 -x asm5 target.fa query.fa > alignment.paf

# Sort by reference (target) coordinates, compress, index
sort -k6,6 -k8,8n alignment.paf | bgzip > target_query.pif.gz
tabix -s 6 -b 8 -e 9 target_query.pif.gz  # Creates .tbi
```

**Google Sheet:**
```csv
track_id,name,category,ASSEMBLY1,ASSEMBLY2,TRACK_PATH,ACCESS_LEVEL
syn_wgs,Genome Alignment,Synteny,Nvec200,Nvec100,/data/synteny/align.pif.gz,public
```

#### MAF - Multiple Alignment (⚠️ In Progress)
**Extensions:** `.maf.gz` + `.gzi` index  
**Adapter:** `MafAdapter`  
**Plugin:** `jbrowse-plugin-mafviewer`  
**Use case:** Multiple genome alignments from Cactus  
**Status:** Needs testing with real data

**Prepare files:**
```bash
# From Cactus output
bgzip alignment.maf  # Creates .maf.gz
samtools faidx alignment.maf.gz  # Creates .gzi
```

**Google Sheet (needs samples list):**
```csv
track_id,name,category,track_path,organism,assembly,samples,ACCESS_LEVEL
maf_align,Multi-species Alignment,Conservation,/data/cactus/align.maf.gz,Homo_sapiens,hg38,"hg38,Human;panTro6,Chimp;gorGor6,Gorilla",public
```

**See:** [SYNTENY_AND_COMPARATIVE.md](../SYNTENY_AND_COMPARATIVE.md) for details

#### MCScan Anchors (⚠️ Not Fully Implemented)
**Extensions:** `.anchors` + 2 `.bed` files  
**Use case:** Orthologous gene pairs between assemblies  
**Requires:** Both assemblies loaded + gene BED files

**Prepare files:**
```bash
# Using jcvi
pip install jcvi
python -m jcvi.compara.catalog ortholog genome1 genome2
# Outputs: genome1.genome2.anchors, genome1.bed, genome2.bed
```

**Google Sheet:**
```csv
track_id,name,category,ASSEMBLY1,ASSEMBLY2,TRACK_PATH,BED1_PATH,BED2_PATH,ACCESS_LEVEL
orthologs,Ortholog Pairs,Synteny,Nvec200,Nvec100,/data/syn/genes.anchors,/data/syn/n200.bed,/data/syn/n100.bed,public
```

---

## Google Sheets Integration

### Required Columns
```
track_id      | Unique identifier (no spaces)
name          | Display name
category      | Organizational category
TRACK_PATH    | File path or URL
```

### Optional Columns
```
ACCESS_LEVEL  | public, ip_range, admin (default: public)
description   | Track description
technique     | Technique used (e.g., RNA-seq)
condition     | Experimental condition
tissue        | Tissue/organ type
```

### Synteny Track Columns
```
ASSEMBLY1     | First assembly name (target)
ASSEMBLY2     | Second assembly name (query)
BED1_PATH     | (MCScan only) BED for assembly 1
BED2_PATH     | (MCScan only) BED for assembly 2
samples       | (MAF only) Sample list: "id,label;id2,label2"
```

### File Paths

```bash
# Absolute path
TRACK_PATH=/data/moop/data/tracks/sample.bw

# Relative path (prepends MOOP_ROOT)
TRACK_PATH=data/tracks/sample.bw

# Remote URL
TRACK_PATH=https://server.edu/tracks/sample.bw
```

---

## Creating Index Files

| Track Type | Command |
|------------|---------|
| BAM | `samtools index file.bam` |
| CRAM | `samtools index file.cram` |
| VCF | `tabix -p vcf file.vcf.gz` |
| GFF | `tabix -p gff file.gff.gz` |
| BED | `tabix -p bed file.bed.gz` |
| PIF | `tabix -s 6 -b 8 -e 9 file.pif.gz` |
| MAF | `samtools faidx file.maf.gz` |

---

## Adding Tracks via CLI

### Individual Scripts

```bash
# BigWig
/data/moop/tools/jbrowse/add_bigwig_track.sh FILE ORG ASM \
  --name NAME --track-id ID

# CRAM
/data/moop/tools/jbrowse/add_cram_track.sh \
  -a ASM -t ID -n NAME -f FILE

# PAF
/data/moop/tools/jbrowse/add_paf_track.sh \
  -a ASM -t ID -n NAME -f FILE

# GTF
/data/moop/tools/jbrowse/add_gtf_track.sh \
  -a ASM -t ID -n NAME -f FILE -i

# BED
/data/moop/tools/jbrowse/add_bed_track.sh \
  -a ASM -t ID -n NAME -f FILE

# Synteny (PIF)
/data/moop/tools/jbrowse/add_synteny_track.sh \
  -1 ASM1 -2 ASM2 -t ID -n NAME -f FILE
```

### Bulk Import from Google Sheet

```bash
php /data/moop/tools/jbrowse/generate_tracks_from_sheet.php \
  --sheet-url "https://docs.google.com/spreadsheets/d/YOUR_ID/edit" \
  --organism Organism_name \
  --assembly AssemblyID
```

---

## Adding New Track Types

### 1. Create Handler Script

```bash
# Example: tools/jbrowse/add_newformat_track.sh
#!/bin/bash
# Parse args, validate file, generate JSON config
```

### 2. Add Format Detection

**In:** `tools/jbrowse/generate_tracks_from_sheet.py`

```python
elif track_path.endswith('.newformat'):
    call_script(['add_newformat_track.sh', '-a', assembly, ...])
```

### 3. Test

```bash
# Dry run
php tools/jbrowse/generate_tracks_from_sheet.php \
  --sheet-url URL --organism ORG --assembly ASM --dry-run

# Real run
php tools/jbrowse/generate_tracks_from_sheet.php \
  --sheet-url URL --organism ORG --assembly ASM
```

---

## Troubleshooting

### Track Not Appearing

```bash
# Check metadata exists
ls /data/moop/metadata/jbrowse2-configs/tracks/Org/Asm/

# Validate JSON
jq . /data/moop/metadata/jbrowse2-configs/tracks/Org/Asm/type/track.json

# Check file exists
ls -lh /data/moop/data/tracks/...
```

### Index Missing

```bash
# Check for index file
ls -lh /data/moop/data/tracks/file.*

# Recreate index (see table above)
samtools index file.bam  # or tabix, etc.
```

### Synteny Track Issues

```bash
# Verify both assemblies loaded
ls /data/moop/metadata/jbrowse2-configs/assemblies/ | grep -E "Asm1|Asm2"

# Check assembly names match exactly (case-sensitive!)
```

---

## All JBrowse2 Supported Formats

For reference, JBrowse2 supports many formats beyond what we've implemented:

### Sequence Formats
- IndexedFastaAdapter (`.fa` + `.fai`) ✅
- BgzipFastaAdapter (`.fa.gz` + `.gzi`)
- TwoBitAdapter (`.2bit`)
- ChromSizesAdapter

### Alignment Formats
- BamAdapter (`.bam` + `.bai`) ✅
- CramAdapter (`.cram` + `.crai`) ✅
- PAFAdapter (`.paf`) ✅
- HtsgetBamAdapter (streaming)

### Variant Formats
- VcfTabixAdapter (`.vcf.gz` + `.tbi`) ✅
- VcfAdapter (`.vcf`)

### Annotation Formats
- Gff3TabixAdapter (`.gff.gz` + `.tbi`) ✅
- GtfAdapter (`.gtf`) ✅
- BedTabixAdapter (`.bed.gz` + `.tbi`) ✅
- BigBedAdapter (`.bb`, `.bigbed`)
- NCListAdapter (JBrowse 1 legacy)

### Quantitative Formats
- BigWigAdapter (`.bw`) ✅
- MultiWiggleAdapter (multiple `.bw`) ✅
- WiggleAdapter (`.wig`)

### Synteny Formats
- PairwiseIndexedPAFAdapter (`.pif.gz` + `.tbi`) ✅
- MafAdapter (`.maf.gz` + `.gzi`) ⚠️
- (MCScan via custom adapter) ⚠️

---

## See Also

- [SYNTENY_AND_COMPARATIVE.md](../SYNTENY_AND_COMPARATIVE.md) - Dual-assembly tracks
- [workflows/GOOGLE_SHEETS_WORKFLOW.md](../workflows/GOOGLE_SHEETS_WORKFLOW.md) - Bulk import
- [API_REFERENCE.md](API_REFERENCE.md) - API documentation
- [../ADMIN_GUIDE.md](../ADMIN_GUIDE.md) - Admin guide

---

**Status:** Most formats working ✅ | MAF/MCScan in progress ⚠️
