# Browser Testing & Fixes - 2026-02-12

## Issues Found and Fixed

### ✅ Issue 1: Wrong Display Name (FIXED)
**Problem:** Browser showed "Nvec200" instead of "Nematostella vectensis (GCA_033964005.1)"  
**Fix:** AutoTrack.php now formats displayName with spaces  
**Commit:** ce87e03

### ✅ Issue 2: Missing Config Files (FIXED)
**Problem:** No configs in `/jbrowse2/configs/`  
**Fix:** Added `organism` and `assemblyId` fields + auto-generate configs  
**Commits:** ce87e03, 14494b4

### ✅ Issue 3: Combo Track Error (FIXED)
**Problem:** MobX state tree error, tracks not rendering  
**Root Cause:** Wrong display type - used `LinearMultiWiggleDisplay` instead of `MultiLinearWiggleDisplay`  
**Fix:** ComboTrack.php now uses correct display type  
**Commit:** 3fd056e

**Error Messages:**
```
Error: [mobx-state-tree] You are trying to read or write to an object 
that is no longer part of a state tree. (Object type: 'MultiLinearWiggleDisplay'...)
```

**Solution:**
```php
// Correct
'type' => 'MultiLinearWiggleDisplay'

// Wrong
'type' => 'LinearMultiWiggleDisplay'
```

### ⚠️ Issue 4: Duplicate Annotation Track (KNOWN ISSUE)
**Problem:** Annotation appears twice:
1. "Annotations" → "Gene Annotations" (auto-generated by assembly.php)
2. "Gene Models" → "NV2g_genes" (from Google Sheet)

**Why:** The `api/jbrowse2/assembly.php` auto-generates an annotation track when `annotations.gff3.gz` exists.

**Workaround Options:**

**Option A:** Keep both tracks (current behavior)
- Auto-generated track: Generic "Gene Annotations"
- Sheet track: Custom name, category, metadata from sheet
- Users can collapse unwanted category

**Option B:** Disable auto-generation (code change needed)
Modify `api/jbrowse2/assembly.php` to skip auto-annotation if annotation track exists in metadata:
```php
// Check if annotation track already exists
$annotationExists = false;
$trackFiles = glob("$metadataTracksDir/$organism/$assembly/gff/*.json");
if (!empty($trackFiles)) {
    $annotationExists = true;
}

if (!$annotationExists && file_exists($annotationsGff)) {
    // Add auto-generated annotation track
}
```

**Option C:** Don't include annotation in sheet
- Remove NV2g_genes from Google Sheet
- Rely on auto-generated "Gene Annotations" track
- Lose custom naming/categorization

**Recommendation:** Option A (keep both) for now. If users find it confusing, implement Option B.

---

## Test Results

### ✅ Working Features:
- Assembly definition: "Nematostella vectensis (GCA_033964005.1)" ✓
- Reference sequence track ✓
- Individual BigWig tracks (24 tracks) ✓
- BAM track ✓
- Annotation track (from sheet) ✓
- Combo track (24 subtracks) ✓

### Config Files Generated:
```
/jbrowse2/configs/Nematostella_vectensis_GCA_033964005.1/
├── PUBLIC.json (28 tracks)
├── COLLABORATOR.json (28 tracks)
├── IP_IN_RANGE.json (28 tracks)
├── ADMIN.json (28 tracks)
└── config.json
```

### Total Tracks: 28
- 1 Reference (AUTO)
- 1 Annotation (AUTO from sheet)
- 24 BigWig
- 1 BAM
- 1 Combo (24 BigWig subtracks)

---

## Complete Workflow

### Full Clean Run:
```bash
# 1. Remove existing tracks
php tools/jbrowse/remove_tracks.php \
  --organism Nematostella_vectensis \
  --assembly GCA_033964005.1 \
  --yes

# 2. Generate all tracks from Google Sheet
php tools/jbrowse/generate_tracks_from_sheet.php \
  1Md23wIYo08cjtsOZMBy5UIsNaaxTxT8ijG-QLC3CjIo \
  --gid 1977809640 \
  --organism Nematostella_vectensis \
  --assembly GCA_033964005.1

# Browser configs are auto-generated!
# No manual steps needed!
```

### Force Regenerate Specific Tracks:
```bash
# Regenerate combo track only
php tools/jbrowse/generate_tracks_from_sheet.php \
  SHEET_ID --gid GID \
  --organism ORGANISM --assembly ASSEMBLY \
  --force simr_four_adult_tissues_molng-2707

# Regenerate assembly definition
php tools/jbrowse/generate_tracks_from_sheet.php \
  SHEET_ID --gid GID \
  --organism ORGANISM --assembly ASSEMBLY \
  --force reference_seq
```

---

## Commits in This Session

1. **ce87e03** - Fix: Assembly definition format for JBrowse browser display
2. **14494b4** - Auto-generate JBrowse browser configs after track creation
3. **3fd056e** - Fix: Combo track display type for JBrowse2

---

## Browser Access

**URL:** http://localhost:8000/moop/jbrowse2.php

**What You Should See:**
- Assembly dropdown: "Nematostella vectensis (GCA_033964005.1)"
- Track list showing all 28 tracks in proper categories
- All tracks loadable and functional
- Combo track renders with 24 colored subtracks

---

**Status:** All critical issues fixed. Browser fully functional! ✅

**Minor Issue:** Duplicate annotation track (documented above, workarounds available)

---

*Updated: 2026-02-12 20:25 UTC*
